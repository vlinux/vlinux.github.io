<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg"><script>const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,colorSchemeSetting=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===colorSchemeSetting||prefersDark&&"light"!==colorSchemeSetting)&&document.documentElement.classList.toggle("dark",!0)</script><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async="" crossorigin="" src="/assets/app-b571ddfd.js"></script><style>@charset "UTF-8";.back-to-top{position:fixed;right:-1.5rem;bottom:1rem;z-index:var(--yun-z-go-up-btn);opacity:0;pointer-events:none;color:var(--va-c-primary);transform:translate(0) rotate(270deg);transition:transform var(--va-transition-duration),opacity var(--va-transition-duration-fast)!important}.progress-circle{transition:.3s stroke-dashoffset;transform:rotate(-90deg);transform-origin:50% 50%}.progress-circle-container{position:absolute}.menu-btn{display:inline-flex;position:fixed;left:.8rem;top:.6rem;line-height:1;z-index:var(--yun-z-menu-btn);cursor:pointer}.sidebar .links{display:flex;justify-content:center}.sidebar .link-item{display:inline-flex}.sidebar .link-item .icon{width:2rem;height:2rem}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .icon{width:1.5rem;height:1.5rem}.links-of-author-item{line-height:1;font-size:.9rem}.site-nav{display:flex;justify-content:center;overflow:hidden;line-height:1.5;white-space:nowrap;text-align:center;margin-top:1rem}.site-link-item{display:flex;padding:0 15px;align-items:center;border-left:1px solid var(--va-c-gray);flex-direction:column;color:var(--va-c-text)}.site-link-item:first-child,.site-link-item:last-child{line-height:1;padding:0}.site-link-item:first-child{border-left:none;border-right:1px solid var(--va-c-gray)}.site-link-item:last-child{border-left:1px solid var(--va-c-gray)}.site-link-item:nth-child(2){border:none}.site-link-item .count{color:var(--va-c-text);font-family:var(--va-font-sans);display:block;text-align:center;font-size:1rem}.site-link-item .icon{width:1.5rem;height:1.5rem}.site-link-item .icon:hover{color:var(--va-c-primary-light)}.sidebar-panel{padding:.5rem}.site-author-avatar{display:inline-block;line-height:0;position:relative}.site-author-avatar img{height:96px;width:96px;max-width:100%;margin:0;padding:4px;background-color:#fff;box-shadow:0 0 10px #0003;transition:.4s}.site-author-avatar img:hover{box-shadow:0 0 30px rgba(var(--va-c-primary-rgb),.2)}.site-author-name{margin-top:0;margin-bottom:1rem;line-height:1.5}.site-author-status{position:absolute;height:1.8rem;width:1.8rem;bottom:0;right:0;line-height:1.8rem;border-radius:50%;box-shadow:0 1px 2px #0003;background-color:var(--va-c-bg-light);border:1px solid rgba(255,255,255,.1)}.site-name{color:var(--va-c-text);font-family:var(--va-font-serif);font-weight:900}.site-subtitle{color:var(--va-c-gray);display:block}.site-description{color:var(--va-c-text);font-size:.8rem}.va-bg{position:fixed;width:100%;height:100%;z-index:-1;background-image:var(--va-bg-img);background-size:cover;background-position:center;background-repeat:no-repeat;background-attachment:fixed;animation-name:bgFadeIn;animation-duration:2s;opacity:var(--va-bg-img-opacity,1)}@supports (-webkit-touch-callout:none){.va-bg{background-attachment:scroll}}@keyframes bgFadeIn{0%{opacity:0}to{opacity:var(--va-bg-img-opacity,1)}}canvas.fireworks{position:fixed;left:0;top:0;z-index:1;pointer-events:none}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2,h4{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=button],button{-webkit-appearance:button;background-color:transparent;background-image:none}h1,h2,h4,hr,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}canvas,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}body{counter-reset:katexEqnNo mmlEqnNo}html{-webkit-tap-highlight-color:transparent}a{color:var(--va-c-link);font-weight:500}*{outline:0}hr{opacity:.2;margin:1rem}.va-card{background-color:var(--va-c-bg-light)}.flex-center{display:flex;justify-content:center;align-items:center}.inline-flex-center{display:inline-flex;justify-content:center;align-items:center}#app,body,html{margin:0;padding:0;line-height:2}body{background-color:var(--va-c-bg)}a{cursor:pointer}@media screen and (max-width:640px){.markdown-body div[class*=language-]{margin:0 var(--va-code-mobile-margin-x,-1rem)}}@media (min-width:640px){.markdown-body div[class*=language-]{border-radius:6px;margin:16px 0}}.markdown-body code{font-size:.85em}.markdown-body div[class*=language-]{position:relative;background-color:var(--va-code-block-bg);overflow-x:auto}.markdown-body div[class*=language-] code{padding:0 24px;line-height:var(--va-code-line-height);font-size:var(--va-code-font-size);color:var(--va-code-block-color);transition:color .5s;width:fit-content;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}.markdown-body div[class*=language-] pre{position:relative;z-index:1;margin:0;padding:1rem 0;background:0 0;overflow-x:auto}.markdown-body div[class*=language-] pre code{display:block}.markdown-body [class*=language-]>span.copy{position:absolute;top:8px;right:8px;z-index:2;display:block;justify-content:center;align-items:center;border-radius:4px;width:40px;height:40px;background-color:var(--va-code-block-bg);opacity:0;cursor:pointer;background-image:var(--va-icon-copy);background-position:50%;background-size:20px;background-repeat:no-repeat;transition:opacity .25s}.markdown-body [class*=language-]:hover>span.copy{opacity:1}.markdown-body [class*=language-]>span.copy:hover{background-color:var(--va-code-copy-code-hover-bg)}.markdown-body [class*=language-]:before{position:absolute;top:6px;right:12px;z-index:2;font-size:12px;font-weight:500;color:var(--va-c-text-dark-3);transition:color .5s,opacity .5s}.markdown-body [class*=language-]:hover:before{opacity:0}:root{--va-c-text-warning:#544500}.vt-hamburger{display:flex;justify-content:center;align-items:center}.vt-hamburger:hover .vt-hamburger-top{transform:translate(-5.5px)}.vt-hamburger:hover .vt-hamburger-middle{transform:translate(0)}.vt-hamburger:hover .vt-hamburger-bottom{transform:translate(-11px)}.vt-hamburger-container{position:relative;width:22px;height:20px;overflow:hidden}.vt-hamburger-bottom,.vt-hamburger-middle,.vt-hamburger-top{left:0;position:absolute;width:22px;height:2px;background-color:var(--va-c-primary);transition:top .25s,background-color .5s,transform .25s}.vt-hamburger-top{top:0;transform:translate(0)}.vt-hamburger-middle{top:9px;transform:translate(-11px)}.vt-hamburger-bottom{top:18px;transform:translate(-5.5px)}.sidebar{position:fixed;overflow-y:auto;top:0;bottom:0;left:0;width:calc(100vw - 64px);max-width:var(--va-sidebar-width);background-image:var(--yun-sidebar-bg-img);background-color:var(--yun-sidebar-bg-color);background-size:contain;background-repeat:no-repeat;background-position:bottom 1rem center;text-align:center;z-index:var(--yun-z-sidebar);transform:translate(-100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)!important}h1:focus .header-anchor,h1:hover .header-anchor,h2:focus .header-anchor,h2:hover .header-anchor{visibility:visible;opacity:1}a.header-anchor{float:left;margin-top:.125em;margin-left:-.87em;padding-right:.23em;font-size:.85em;visibility:hidden;opacity:0;transition:opacity var(--va-transition-duration)}a.header-anchor:before{content:none}a.header-anchor:focus,a.header-anchor:hover{text-decoration:none}:root{--va-aside-width:256px;--va-sidebar-width:300px;--va-border-width:1px;--va-font-serif:"Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace;--va-transition-duration-fast:.2s;--va-transition-duration:.4s;--va-transition-duration-slow:.6s;--va-transition:all var(--va-transition-duration-fast) ease-in-out}:root{--va-c-white:#ffffff;--va-c-black:#1a1a1a;--va-c-gray:#8e8e8e;--va-c-danger:#db2828;--va-c-warning:#f2711c;--va-c-text-light-1:#213547;--va-c-text-light-2:rgba(60, 60, 60, .7);--va-c-text-light-3:rgba(60, 60, 60, .33);--va-c-text-light-4:rgba(60, 60, 60, .18);--va-c-text-dark-1:rgba(255, 255, 255, .87);--va-c-text-dark-2:rgba(235, 235, 235, .6);--va-c-text-dark-3:rgba(235, 235, 235, .38);--va-c-text-dark-4:rgba(235, 235, 235, .18);--va-c-primary-light:#359eff;--va-c-primary-lighter:#81c2ff;--va-c-primary-dark:#006bce;--va-c-primary:#0078E7}:root{color-scheme:light;--va-c-brand:#0078E7;--va-border-color:#222;--va-c-bg:white;--va-c-bg-light:white;--va-c-bg-dark:#fafafa;--va-c-bg-opacity:rgba(255, 255, 255, .8);--va-c-bg-soft:#f9f9f9;--va-c-bg-alt:#f9f9f9;--va-c-bg-mute:#f1f1f1;--va-c-text:#333;--va-c-text-light:#555;--va-c-text-lighter:#666;--va-c-text-dark:#111;--va-c-primary-rgb:0,120,231;--va-c-link:var(--va-c-primary-dark);--va-c-divider:rgba(60, 60, 60, .2)}:root{--va-code-line-height:1.7;--va-code-font-size:.875em;--va-code-block-color:var(--va-c-text-dark-1);--va-code-block-bg:#282c34;--va-code-line-highlight-color:rgba(0, 0, 0, .5);--va-code-line-number-color:var(--va-c-text-dark-3);--va-code-copy-code-hover-bg:rgba(255, 255, 255, .05);--va-code-copy-code-active-text:var(--va-c-text-dark-2)}:root{--va-icon-copy:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2'/%3E%3C/svg%3E");--va-icon-copied:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' height='20' width='20' stroke='rgba(128,128,128,1)' stroke-width='2' class='h-6 w-6' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4'/%3E%3C/svg%3E")}.post-category{color:var(--va-c-text)}.post-tag{white-space:nowrap;color:var(--yun-tag-color)}.post-tag:hover{color:var(--va-c-primary)}html{overflow-y:scroll}.yun-main{padding-left:var(--va-sidebar-width);transition:padding-left var(--va-transition-duration);box-sizing:border-box}.yun-icon-btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border:none;width:3rem;height:3rem;border-radius:50%;transition:background-color var(--va-transition-duration)}.yun-icon-btn div{font-size:1.2rem}.yun-icon-btn:hover{background-color:rgba(var(--va-c-primary-rgb),.08)}.yun-icon-btn:active{background-color:rgba(var(--va-c-primary-rgb),.16)}:root{--smc-font-sans:Raleway,-apple-system,"PingFang SC","Microsoft YaHei",Arial,sans-serif;--smc-font-serif:"Songti SC","Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--smc-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}:root{--smc-c-primary-light:#4eaaff;--smc-c-primary-lighter:#9bcfff;--smc-c-primary:#0078E7;--smc-theme-name:yun;--smc-line-height:1.8;--smc-c-primary-rgb:0,120,231;--smc-c-text:#24292e;--smc-c-text-light:#555;--smc-c-text-lighter:#666;--smc-header-bottom-color:#eaecef;--smc-border-color:var(--smc-c-primary-light);--smc-code-bg-color:#f6f8fa;--smc-link-color:#005eb4}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--smc-bg-color);color:var(--smc-c-text);font-family:var(--smc-font-sans);font-size:1rem;line-height:var(--smc-line-height);overflow-wrap:break-word}.markdown-body *{box-sizing:border-box}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body code,.markdown-body pre{font-family:Source Code Pro,Consolas,Monaco,SFMono-Regular,Ubuntu Mono,Menlo,monospace}.markdown-body code{padding:3px 6px;font-size:.85rem;color:var(--smc-c-text-light);background:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre{margin-top:0;margin-bottom:0;overflow-wrap:normal;padding:1rem;overflow:auto;background-color:var(--smc-code-bg-color);border-radius:3px}.markdown-body pre>code{font-size:.85rem;white-space:pre}.markdown-body pre code{display:block;padding:0;margin:0;overflow:visible;line-height:inherit;word-break:normal;background-color:transparent;border:0}.markdown-body img{display:block;margin:1rem auto;max-width:92%;max-height:600px;border-radius:.2rem;transition:.4s;--tw-shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color);-webkit-box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.markdown-body img:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.markdown-body img:before{content:"「 LOADING ERROR 」"}@media screen and (min-width:1600px){.markdown-body img{max-width:800px}}.markdown-body a{color:var(--smc-c-primary);text-decoration:none;border-bottom:1px solid transparent;transition:all .2s ease-in-out}.markdown-body a:hover{color:var(--smc-link-color);border-bottom:1px solid var(--smc-link-color)}.markdown-body ul{padding-left:2em}.markdown-body li{overflow-wrap:break-all;margin-top:.25em}.markdown-body strong{font-family:var(--smc-font-serif);font-weight:900}.markdown-body p{margin-top:1rem;margin-bottom:1rem;overflow-x:auto;overflow-y:hidden}.markdown-body h1,.markdown-body h2{margin-top:1.5rem;margin-bottom:1rem;font-weight:300;line-height:1.5}.markdown-body h1{font-size:2.5rem;border-bottom:1px solid var(--smc-header-bottom-color)}.markdown-body h2{font-size:2.2rem;border-bottom:1px solid var(--smc-header-bottom-color)}@media screen and (max-width:768px){.markdown-body h1{font-size:2rem}.markdown-body h2{font-size:1.8rem}}.markdown-body{--smc-font-family:var(--va-font-sans);--c-toc-link:var(--va-c-text-light)}.markdown-body{word-wrap:break-word}.markdown-body h1,.markdown-body h2{font-family:var(--va-font-serif);font-weight:900}.markdown-body ul{list-style:initial}.markdown-body img{margin:auto}.markdown-body p{overflow:unset}:root{--yun-post-card-max-width:900px;--yun-c-cloud:white;--yun-z-toc-btn:7;--yun-z-cloud:7;--yun-z-go-down:9;--yun-z-backdrop:9;--yun-z-sidebar:10;--yun-z-fireworks:11;--yun-z-menu-btn:20;--yun-z-go-up-btn:20;--yun-z-search-popup:30;--yun-z-search-btn:31;--va-z-overlay:var(--yun-z-backdrop)}:root{--yun-bg-img:url(https://cdn.yunyoujun.cn/img/bg/stars-timing-0-blur-30px.jpg);--yun-sidebar-bg-color:var(--va-c-bg-light);--yun-sidebar-bg-img:url(https://cdn.yunyoujun.cn/img/bg/alpha-stars-timing-1.webp)}:root{--va-font-serif:"Noto Serif SC",STZhongsong,STKaiti,KaiTi,Roboto,serif;--va-font-sans:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;--va-font-mono:Menlo,Monaco,Consolas,"Courier New",monospace}*,:after,:before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,.5)}.i-ri-alipay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M18.408 16.79c-2.173-.95-3.72-1.646-4.64-2.086c-1.4 1.696-2.872 2.72-5.08 2.72S5 16.064 5.176 14.392c.12-1.096.872-2.888 4.128-2.576c1.72.16 2.504.48 3.912.944c.36-.664.664-1.4.888-2.176H7.88v-.616h3.072V8.864H7.2v-.68h3.752V6.592s.032-.248.312-.248H12.8v1.848h4v.68h-4v1.104h3.264a12.41 12.41 0 0 1-1.32 3.32c.51.182 2.097.676 4.76 1.482a8 8 0 1 0-1.096 2.012ZM12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10Zm-3.568-5.632c1.44 0 2.824-.872 3.96-2.352c-1.608-.776-2.944-1.16-4.44-1.16c-1.304 0-1.984.8-2.104 1.416c-.12.616.248 2.096 2.584 2.096Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-archive-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 10H2V4.003C2 3.449 2.455 3 2.992 3h18.016A.99.99 0 0 1 22 4.003V10h-1v10.002a.996.996 0 0 1-.993.998H3.993A.996.996 0 0 1 3 20.002V10Zm16 0H5v9h14v-9ZM4 5v3h16V5H4Zm5 7h6v2H9v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-left-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.828 12l4.95 4.95l-1.414 1.415L8 12l6.364-6.364l1.414 1.414l-4.95 4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-right-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m13.171 12l-4.95-4.95l1.415-1.413L16 12l-6.364 6.364l-1.414-1.415l4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-arrow-up-s-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m12 10.828l-4.95 4.95l-1.414-1.414L12 8l6.364 6.364l-1.415 1.414l-4.95-4.95Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM8 13v2H6v-2h2Zm5 0v2h-2v-2h2Zm5 0v2h-2v-2h2ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-calendar-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9 1v2h6V1h2v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4V1h2Zm11 10H4v8h16v-8ZM7 5H4v4h16V5h-3v2h-2V5H9v2H7V5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-clipboard-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M7 4V2h10v2h3.007c.548 0 .993.445.993.993v16.014a.994.994 0 0 1-.993.993H3.993A.993.993 0 0 1 3 21.007V4.993C3 4.445 3.445 4 3.993 4H7Zm0 2H5v14h14V6h-2v2H7V6Zm2-2v2h6V4H9Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-cloud-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 2a7 7 0 0 1 6.992 7.339A6 6 0 0 1 17 21H7A6 6 0 0 1 5.008 9.339A7 7 0 0 1 12 2Zm0 2a5 5 0 0 0-4.994 5.243l.07 1.488l-1.404.494A4.002 4.002 0 0 0 7 19h10a4 4 0 1 0-3.796-5.265l-1.898-.633A6.003 6.003 0 0 1 17 9a5 5 0 0 0-5-5Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-download-cloud-2-fill{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M13 13v5.585l1.828-1.828l1.415 1.415L12 22.414l-4.243-4.242l1.415-1.415L11 18.585V13h2ZM12 2a7.001 7.001 0 0 1 6.954 6.194A5.5 5.5 0 0 1 18 18.978V17a6 6 0 0 0-11.996-.225L6 17v1.978a5.5 5.5 0 0 1-.954-10.784A7 7 0 0 1 12 2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-list-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1Zm-1-2V4H5v16h14ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h8v2H8v-2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-file-word-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M16 8v8h-2l-2-2l-2 2H8V8h2v5l2-2l2 2V8h1V4H5v16h14V8h-3ZM3 2.992C3 2.444 3.447 2 3.998 2H16l5 5v13.992A1 1 0 0 1 20.007 22H3.993A1 1 0 0 1 3 21.008V2.992Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-folder-2-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2ZM20 11H4v8h16v-8Zm0-2V7h-8.414l-2-2H4v4h16Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-gamepad-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M17 4a6 6 0 0 1 6 6v4a6 6 0 0 1-6 6H7a6 6 0 0 1-6-6v-4a6 6 0 0 1 6-6h10Zm0 2H7a4 4 0 0 0-3.995 3.8L3 10v4a4 4 0 0 0 3.8 3.995L7 18h10a4 4 0 0 0 3.995-3.8L21 14v-4a4 4 0 0 0-3.8-3.995L17 6Zm-7 3v2h2v2H9.999L10 15H8l-.001-2H6v-2h2V9h2Zm8 4v2h-2v-2h2Zm-2-4v2h-2V9h2Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-genderless-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M13 7.066A7.501 7.501 0 0 1 12 22a7.5 7.5 0 0 1-1-14.934V1h2v6.066ZM12 20a5.5 5.5 0 1 0 0-11a5.5 5.5 0 0 0 0 11Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-github-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5.884 18.653c-.3-.2-.558-.456-.86-.816a50.59 50.59 0 0 1-.466-.579c-.463-.575-.755-.841-1.056-.95a1 1 0 1 1 .675-1.882c.752.27 1.261.735 1.947 1.588c-.094-.117.34.427.433.539c.19.227.33.365.44.438c.204.137.588.196 1.15.14c.024-.382.094-.753.202-1.096c-2.968-.725-4.648-2.64-4.648-6.396c0-1.238.37-2.355 1.058-3.291c-.218-.894-.185-1.975.302-3.192a1 1 0 0 1 .63-.583c.081-.024.127-.034.208-.047c.803-.123 1.937.17 3.415 1.097a11.731 11.731 0 0 1 2.687-.308c.912 0 1.819.103 2.684.308c1.477-.933 2.614-1.227 3.422-1.097c.085.014.158.032.218.051a1 1 0 0 1 .616.58c.487 1.215.52 2.296.302 3.19c.691.936 1.058 2.045 1.058 3.292c0 3.758-1.674 5.666-4.642 6.393c.125.415.19.878.19 1.38c0 .664-.002 1.299-.007 2.01c0 .19-.002.394-.005.706a1 1 0 0 1-.018 1.957c-1.14.228-1.984-.532-1.984-1.524l.002-.447l.005-.705c.005-.707.008-1.338.008-1.997c0-.697-.184-1.152-.426-1.361c-.661-.57-.326-1.654.541-1.751c2.966-.334 4.336-1.483 4.336-4.66c0-.955-.312-1.745-.913-2.405a1 1 0 0 1-.189-1.044c.166-.415.236-.957.095-1.614l-.01.002c-.491.14-1.11.44-1.858.95a1 1 0 0 1-.833.135a9.626 9.626 0 0 0-2.592-.35c-.89 0-1.772.12-2.592.35a1 1 0 0 1-.829-.133c-.753-.507-1.374-.807-1.87-.947c-.143.653-.072 1.194.093 1.607a1 1 0 0 1-.189 1.044c-.597.656-.913 1.459-.913 2.404c0 3.172 1.371 4.33 4.322 4.66c.865.098 1.202 1.178.545 1.749c-.193.167-.43.732-.43 1.364v3.149c0 .986-.834 1.726-1.96 1.529a1 1 0 0 1-.04-1.963v-.99c-.91.062-1.661-.087-2.254-.484Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464Zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a4 4 0 0 0-5.686 5.605L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-home-4-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M19 21H5a1 1 0 0 1-1-1v-9H1l10.327-9.388a1 1 0 0 1 1.346 0L23 11h-3v9a1 1 0 0 1-1 1Zm-6-2h5V9.158l-6-5.455l-6 5.455V19h5v-6h2v6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-mail-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Zm17 4.238l-7.928 7.1L4 7.216V19h16V7.238ZM4.511 5l7.55 6.662L19.502 5H4.511Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-money-cny-circle-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.005 22.003c-5.523 0-10-4.477-10-10s4.477-10 10-10s10 4.477 10 10s-4.477 10-10 10Zm0-2a8 8 0 1 0 0-16a8 8 0 0 0 0 16Zm1-7h3v2h-3v2h-2v-2h-3v-2h3v-1h-3v-2h2.586L8.469 7.882l1.415-1.415l2.12 2.122l2.122-2.122l1.414 1.415l-2.12 2.12h2.585v2h-3v1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-price-tag-3-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m10.904 2.1l9.9 1.414l1.414 9.9l-9.193 9.192a1 1 0 0 1-1.414 0l-9.9-9.9a1 1 0 0 1 0-1.413L10.905 2.1Zm.707 2.121L3.833 12l8.485 8.485l7.779-7.778l-1.061-7.425l-7.425-1.06Zm2.122 6.364a2 2 0 1 1 2.828-2.828a2 2 0 0 1-2.828 2.828Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-qq-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.536 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.85 7.088 15.447 4 12 4c-3.446 0-4.848 3.088-4.848 6.16c0 .183.009.537.01.557l-.696 1.797c-.19.514-.38 1.05-.517 1.51c-.657 2.189-.444 3.095-.282 3.115c.348.043 1.354-1.648 1.354-1.648c0 .98.487 2.258 1.542 3.18c-.394.127-.878.32-1.188.557c-.28.214-.245.431-.194.52c.22.385 3.79.245 4.82.125c1.03.12 4.599.26 4.82-.126c.05-.088.085-.305-.194-.519c-.311-.237-.795-.43-1.19-.556c1.055-.923 1.542-2.202 1.542-3.181c0 0 1.007 1.691 1.355 1.648c.162-.02.378-.928-.283-3.116a26.91 26.91 0 0 0-.516-1.509Zm1.021 8.227c-.373.652-.833.892-1.438 1.057a4.91 4.91 0 0 1-.794.138c-.44.045-.986.065-1.613.064a33.217 33.217 0 0 1-2.71-.116c-.692.065-1.785.114-2.71.116a16.048 16.048 0 0 1-1.614-.064a4.917 4.917 0 0 1-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274 0 0 1-.239-1.652c-.592-.132-1.001-.482-1.279-.911a2.43 2.43 0 0 1-.309-.71a4.027 4.027 0 0 1-.116-1.106c.013-.785.187-1.762.532-2.912c.14-.466.327-1.008.567-1.655l.554-1.43a15.362 15.362 0 0 1-.002-.203C5.153 5.605 7.589 2 12 2c4.413 0 6.848 3.605 6.848 8.16l-.001.203l.553 1.43l.01.026c.225.606.413 1.153.556 1.626c.348 1.15.522 2.128.535 2.916c.007.407-.03.776-.118 1.108c-.066.246-.161.48-.31.708c-.276.427-.684.776-1.277.91c.13.554.055 1.14-.24 1.654Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-speaker-fill{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4 2h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1Zm8 18a5 5 0 1 0 0-10a5 5 0 0 0 0 10Zm0-12a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3Zm0 10a3 3 0 1 1 0-6a3 3 0 0 1 0 6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-timer-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m17.618 5.968l1.453-1.453l1.414 1.414l-1.453 1.453A9 9 0 1 1 12 4c2.125 0 4.078.736 5.618 1.968ZM12 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14ZM11 8h2v6h-2V8ZM8 1h8v2H8V1Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i-ri-translate=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 15v2a2 2 0 0 0 1.85 1.994L7 19h3v2H7a4 4 0 0 1-4-4v-2h2Zm13-5l4.4 11h-2.155l-1.201-3h-4.09l-1.199 3h-2.154L16 10h2Zm-1 2.885L15.753 16h2.492L17 12.885ZM8 2v2h4v7H8v3H6v-3H2V4h4V2h2Zm9 1a4 4 0 0 1 4 4v2h-2V7a2 2 0 0 0-2-2h-3V3h3ZM6 6H4v3h2V6Zm4 0H8v3h2V6Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-2-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M8.667 11.512a1.276 1.276 0 0 1-1.285-1.286c0-.718.568-1.286 1.285-1.286c.718 0 1.285.568 1.285 1.286c0 .717-.567 1.286-1.285 1.286Zm6.667 0a1.276 1.276 0 0 1-1.285-1.286c0-.718.568-1.286 1.285-1.286s1.285.568 1.285 1.286c0 .717-.568 1.286-1.285 1.286Zm-8.511 7.704l.715-.437a4 4 0 0 1 2.706-.536c.211.033.385.059.52.077c.406.053.819.08 1.237.08c4.42 0 7.9-3.022 7.9-6.6c0-3.577-3.48-6.6-7.9-6.6c-4.421 0-7.9 3.023-7.9 6.6c0 1.366.5 2.673 1.431 3.781c.049.058.12.137.215.235a4 4 0 0 1 1.1 3.102l-.024.298Zm-.63 2.726a1 1 0 0 1-1.527-.93l.189-2.26a2 2 0 0 0-.55-1.551a6.935 6.935 0 0 1-.303-.332C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6c-.51 0-1.01-.033-1.5-.098c-.152-.02-.342-.048-.568-.084a2 2 0 0 0-1.353.269l-2.387 1.456Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-wechat-pay-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m19.146 8.993l-9.799 5.608l-.07.046a.647.647 0 0 1-.3.069a.655.655 0 0 1-.58-.345l-.046-.092l-1.831-3.95c-.023-.046-.023-.092-.023-.138c0-.183.139-.321.324-.321c.07 0 .139.023.209.069l2.155 1.515c.162.092.347.161.556.161a.938.938 0 0 0 .348-.069l8.274-3.648C16.935 6.273 14.635 5.2 12.001 5.2c-4.421 0-7.9 3.023-7.9 6.6c0 1.366.5 2.673 1.431 3.781c.049.058.12.137.215.235a4 4 0 0 1 1.1 3.102l-.024.298l.715-.437a4 4 0 0 1 2.706-.536c.211.033.385.059.52.077c.406.053.819.08 1.237.08c4.42 0 7.9-3.022 7.9-6.6c0-.996-.27-1.95-.755-2.807ZM6.193 21.943a1 1 0 0 1-1.527-.931l.189-2.26a2 2 0 0 0-.55-1.551a6.935 6.935 0 0 1-.303-.332C2.806 15.447 2.1 13.695 2.1 11.8c0-4.75 4.432-8.6 9.9-8.6c5.467 0 9.9 3.85 9.9 8.6s-4.433 8.6-9.9 8.6c-.51 0-1.01-.033-1.5-.098c-.152-.02-.342-.048-.568-.084a2 2 0 0 0-1.353.269l-2.387 1.456Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.i-ri-women-line{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M11 15.934A7.501 7.501 0 0 1 12 1a7.5 7.5 0 0 1 1 14.934V18h5v2h-5v4h-2v-4H6v-2h5v-2.066ZM12 14a5.5 5.5 0 1 0 0-11a5.5 5.5 0 0 0 0 11Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}[i~=ri-sun-line]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' width='1.2em' height='1.2em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93ZM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121Zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121ZM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z'/%3E%3C/svg%3E");-webkit-mask:var(--un-icon) no-repeat;mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;mask-size:100% 100%;background-color:currentColor;color:inherit;width:1.2em;height:1.2em}.yun-card{margin:auto;--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow);transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;transition-duration:var(--va-transition-duration)}.va-card{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.va-card:hover,.yun-card:hover{--un-shadow:var(--un-shadow-inset) 0 10px 15px -3px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 4px 6px -4px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}@media (max-width:767.9px){.yun-main{padding-left:0}}.fixed{position:fixed}.relative{position:relative}[bottom~="19"]{bottom:4.75rem}[right~="2"]{right:.5rem}.z-1{z-index:1}.z-350{z-index:350}[m~="0"]{margin:0}[m~="2"]{margin:.5rem}[m~=y-4]{margin-top:1rem;margin-bottom:1rem}.my-1{margin-top:.25rem;margin-bottom:.25rem}[m~=x-1]{margin-left:.25rem;margin-right:.25rem}[mx~="2"],[m~=x-2]{margin-left:.5rem;margin-right:.5rem}[m~=y-2]{margin-top:.5rem;margin-bottom:.5rem}[mb~="4"]{margin-bottom:1rem}.mb-2,[m~=b-2]{margin-bottom:.5rem}[m~=l-1]{margin-left:.25rem}[m~=t-4]{margin-top:1rem}[mt-6=""],[m~=t-6]{margin-top:1.5rem}[m~=l-4]{margin-left:1rem}[m~=r-1]{margin-right:.25rem}[mt~="2"]{margin-top:.5rem}.block{display:block}.inline-block{display:inline-block}[h~="8"]{height:2rem}[w~="8"]{width:2rem}[w~=full]{width:100%}.flex,[flex~="~"]{display:flex}.inline-flex,[inline-flex=""]{display:inline-flex}.flex-grow,[flex~=grow]{flex-grow:1}.flex-col,[flex~=col]{flex-direction:column}.transform{transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.animate-fade-in{animation:fade-in 1s linear 1}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}.animate-iteration-1{animation-iteration-count:1}.items-center,[items~=center]{align-items:center}.justify-center,[justify~=center]{justify-content:center}.justify-around{justify-content:space-around}.gap-2{grid-gap:.5rem;gap:.5rem}[overflow~=auto]{overflow:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}[border~="~"]{border-width:1px}[border~=rounded]{border-radius:.25rem}.rounded-full{border-radius:9999px}[stroke-width~="2"]{stroke-width:2px}.p-4,[p~="4"]{padding:1rem}[p~="1"]{padding:.25rem}[p~="2"]{padding:.5rem}[p~=x-4]{padding-left:1rem;padding-right:1rem}[py~="1"]{padding-top:.25rem;padding-bottom:.25rem}[p~=b-8]{padding-bottom:2rem}[p~=l-4]{padding-left:1rem}[text~=center]{text-align:center}[text~="2xl"]{font-size:1.5rem;line-height:2rem}[text-xl=""],[text~=xl]{font-size:1.25rem;line-height:1.75rem}[text~=xs]{font-size:.75rem;line-height:1rem}[text~=sm]{font-size:.875rem;line-height:1.25rem}[font~=black]{font-weight:900}.leading-none{line-height:1}.text-\$va-c-text-light{color:var(--va-c-text-light)}[text~=red-400]{--un-text-opacity:1;color:rgba(248,113,113,var(--un-text-opacity))}.hover\:shadow-md:hover{--un-shadow:var(--un-shadow-inset) 0 4px 6px -1px var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 2px 4px -2px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.shadow{--un-shadow:var(--un-shadow-inset) 0 1px 3px 0 var(--un-shadow-color, rgba(0,0,0,.1)),var(--un-shadow-inset) 0 1px 2px -1px var(--un-shadow-color, rgba(0,0,0,.1));box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}[font~=serif]{font-family:var(--va-font-serif)}@media (max-width:767.9px){.lt-md\:ml-0{margin-left:0}[p~="lt-md:0"]{padding:0}}@media (min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:768px){.md\:hidden{display:none}.md\:translate-x-0{--un-translate-x:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}}@media (min-width:1024px){.lg\:px-12{padding-left:3rem;padding-right:3rem}}@media (min-width:1280px){.xl\:hidden{display:none}.xl\:px-16{padding-left:4rem;padding-right:4rem}}.post-copyright{font-size:.9rem;padding:.5rem 1rem;border-left:4px solid #ff5252;background-color:var(--va-c-bg-dark);list-style:none;word-break:break-all;position:relative;overflow:hidden}.post-copyright:after{pointer-events:none;position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:" ";height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}.sponsor-button{background-color:#ffffff1a}.sponsor-button div{transform:scale(1.1);transition:transform var(--va-transition-duration) ease-in-out}.sponsor-button:hover{background-color:#ffffffe6}.sponsor-button:hover div{transform:scale(1.2)}.qrcode-container{overflow:hidden;height:0;transition:height var(--va-transition-duration) ease-in-out}.sponsor-description{color:var(--va-c-gray)}.sponsor-method-img{width:12rem;max-width:90%;aspect-ratio:1}.va-toc[data-v-e1350763]{text-align:left}.content[data-v-e1350763]{position:relative;padding-left:16px;font-size:14px;text-align:left}.outline-marker[data-v-e1350763]{position:absolute;top:32px;left:-2px;z-index:0;opacity:0;width:4px;height:18px;background-color:var(--va-c-brand);transition:top .25s cubic-bezier(0,1,.5,1),background-color .5s,opacity .25s;border-top-right-radius:2px;border-bottom-right-radius:2px}.outline-title[data-v-e1350763]{letter-spacing:.4px;line-height:28px;font-size:14px;font-weight:600}.visually-hidden[data-v-e1350763]{position:absolute;width:1px;height:1px;white-space:nowrap;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden}.yun-aside{position:fixed;right:0;top:0;bottom:0;width:var(--va-sidebar-width,300px);transform:translate(100%);transition:box-shadow var(--va-transition-duration),background-color var(--va-transition-duration),opacity .25s,transform var(--va-transition-duration) cubic-bezier(.19,1,.22,1)}@media screen and (min-width:1280px){.yun-aside{transform:translate(0)}}.toc-btn{color:var(--va-c-primary);background-color:#fff;z-index:var(--yun-z-toc-btn)}.post-nav{display:flex;justify-content:space-between;align-items:center}.post-nav-item{display:inline-flex;justify-content:center;align-items:center;color:var(--va-c-primary);outline:0;font-size:1.5rem;font-weight:700;text-transform:uppercase;height:3rem;transition:.4s}.post-nav-item:hover{background-color:rgba(var(--va-c-primary-rgb),.1);box-shadow:0 0 15px #0000001a}.post-nav-prev{padding:0 .6rem 0 .1rem}.post-nav-next{padding:0 .1rem 0 .6rem}.post-nav-next,.post-nav-prev{display:inline-flex;align-items:center;height:3rem;font-size:1rem}.post-nav-next .title,.post-nav-prev .title{overflow:hidden;max-width:10rem}.post-nav-next .icon,.post-nav-prev .icon{width:1.2rem;height:1.2rem}@media screen and (min-width:1024px){.post-nav-next .title,.post-nav-prev .title{max-width:18rem}}@media screen and (min-width:1280px){.content{max-width:calc(100vw - 2 * var(--va-sidebar-width) - 1rem - 8px)}}</style><link rel="preload" href="/assets/index-d62c0a7e.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/post-e4cbe9e4.js"><link rel="preload" href="/assets/post-b195884f.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/Consul使用中文手册-dea49001.js"><link rel="modulepreload" crossorigin="" href="/assets/ValaxyMain.vue_vue_type_style_index_0_lang-bbcdf630.js"><link rel="preload" href="/assets/ValaxyMain-3beb7542.css" as="style"><title>Consul使用中文手册 - 运维之境</title><link rel="icon" href="/favicon.svg" type="image/svg+xml"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#ffffff"><meta name="generator" content="Valaxy 0.14.28"><meta name="description" content="那你终将成为别人的一条裤衩"><meta property="og:description" content="那你终将成为别人的一条裤衩"><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="运维之境"><meta property="og:title" content="Consul使用中文手册"><meta property="og:image" content="/favicon.svg"><meta property="og:url" content="https://www.vlinux.cn/"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_AMS-Regular-0cdd387c.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Bold-de7701e4.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Caligraphic-Regular-5d53e70a.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Bold-74444efd.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Fraktur-Regular-51814d27.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Bold-0f60d1b8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-BoldItalic-99cd42a3.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Italic-97479ca6.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Main-Regular-c2342cd8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-BoldItalic-dc47344d.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Math-Italic-7af58c5e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Bold-e99ae511.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Italic-00b26ac8.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_SansSerif-Regular-68e8c73e.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Script-Regular-036d4e95.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size1-Regular-6b47c401.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size2-Regular-d04c5421.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="data:font/woff2;base64,d09GMgABAAAAAA4oAA4AAAAAHbQAAA3TAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAgRQIDgmcDBEICo1oijYBNgIkA14LMgAEIAWJAAeBHAyBHBvbGiMRdnO0IkRRkiYDgr9KsJ1NUAf2kILNxgUmgqIgq1P89vcbIcmsQbRps3vCcXdYOKSWEPEKgZgQkprQQsxIXUgq0DqpGKmIvrgkeVGtEQD9DzAO29fM9jYhxZEsL2FeURH2JN4MIcTdO049NCVdxQ/w9NrSYFEBKTDKpLKfNkCGDc1RwjZLQcm3vqJ2UW9Xfa3tgAHz6ivp6vgC2yD4/6352ndnN0X0TL7seypkjZlMsjmZnf0Mm5Q+JykRWQBKCVCVPbARPXWyQtb5VgLB6Biq7/Uixcj2WGqdI8tGSgkuRG+t910GKP2D7AQH0DB9FMDW/obJZ8giFI3Wg8Cvevz0M+5m0rTh7XDBlvo9Y4vm13EXmfttwI4mBo1EG15fxJhUiCLbiiyCf/ZA6MFAhg3pGIZGdGIVjtPn6UcMk9A/UUr9PhoNsCENw1APAq0gpH73e+M+0ueyHbabc3vkbcdtzcf/fiy+NxQEjf9ud/ELBHAXJ0nk4z+MXH2Ev/kWyV4k7SkvpPc9Qr38F6RPWnM9cN6DJ0AdD1BhtgABtmoRoFCvPsBAumNm6soZG2Gk5GyVTo2sJncSyp0jQTYoR6WDvTwaaEcHsxHfvuWhHA3a6bN7twRKtcGok6NsCi7jYRrM2jExsUFMxMQYuJbMhuWNOumEJy9hi29Dmg5zMp/A5+hhPG19j1vBrq8JTLr8ki5VLPmG/PynJHVul440bxg5xuymHUFPBshC+nA9I1FmwbRBTNHAcik3Oae0cxKoI3MOriM42UrPe51nsaGxJ+WfXubAsP84aabUlQSJ1IiE0iPETLUU4CATgfXSCSpuRFRmCGbO+wSpAnzaeaCYW1VNEysRtuXCEL1kUFUbbtMv3Tilt/1c11jt3Q5bbMa84cpWipp8Elw3MZhOHsOlwwVUQM3lAR35JiFQbaYCRnMF2lxAWoOg2gyoIV4PouX8HytNIfLhqpJtXB4vjiViUI8IJ7bkC4ikkQvKksnOTKICwnqWSZ9YS5f0WCxmpgjbIq7EJcM4aI2nmhLNY2JIUgOjXZFWBHb+x5oh6cwb0Tv1ackHdKi0I9OO2wE9aogIOn540CCCziyhN+IaejtgAONKznHlHyutPrHGwCx9S6B8kfS4Mfi4Eyv7OU730bT1SCBjt834cXsf43zVjPUqqJjgrjeGnBxSG4aYAKFuVbeCfkDIjAqMb6yLNIbCuvXhMH2/+k2vkNpkORhR59N1CkzoOENvneIosjYmuTxlhUzaGEJQ/iWqx4dmwpmKjrwTiTGTCVozNAYqk/zXOndWxuWSmJkQpJw3pK5KX6QrLt5LATMqpmPAQhkhK6PUjzHUn7E0gHE0kPE0iKkolgkUx9SZmVAdDgpffdyJKg3k7VmzYGCwVXGz/tXmkOIp+vcWs+EMuhhvN0h9uhfzWJziBQmCREGSIFmQIkgVpAnSBRmC//6hkLZwaVhwxlrJSOdqlFtOYxlau9F2QN5Y98xmIAsiM1HVp2VFX+DHHGg6Ecjh3vmqtidX3qHI2qycTk/iwxSt5UzTmEP92ZBnEWTk4Mx8Mpl78ZDokxg/KWb+Q0QkvdKVmq3TMW+RXEgrsziSAfNXFMhDc60N5N9jQzjfO0kBKpUZl0ZmwJ41j/B9Hz6wmRaJB84niNmQrzp9eSlQCDDzazGDdVi3P36VZQ+Jy4f9UBNp+3zTjqI4abaFAm+GShVaXlsGdF3FYzZcDI6cori4kMxUECl9IjJZpzkvitAoxKue+90pDMvcKRxLl53TmOKCmV/xRolNKSqqUxc6LStOETmFOiLZZptlZepcKiAzteG8PEdpnQpbOMNcMsR4RR2Bs0cKFEvSmIjAFcnarqwUL4lDhHmnVkwu1IwshbiCcgvOheZuYyOteufZZwlcTlLgnZ3o/WcYdzZHW/WGaqaVfmTZ1aWCceJjkbZqsfbkOtcFlUZM/jy+hXHDbaUobWqqXaeWobbLO99yG5N3U4wxco0rQGGcOLASFMXeJoham8M+/x6O2WywK2l4HGbq1CoUyC/IZikQhdq3SiuNrvAEj0AVu9x2x3lp/xWzahaxidezFVtdcb5uEnzyl0ZmYiuKI0exvCd4Xc9CV1KB0db00z92wDPde0kukbvZIWN6jUWFTmPIC/Y4UPCm8UfDTFZpZNon1qLFTkBhxzB+FjQRA2Q/YRJT8pQigslMaUpFyAG8TMlXigiqmAZX4xgijKjRlGpLE0GdplRfCaJo0JQaSxNBk6ZmMzcya0FmrcisDdn0Q3HI2sWSppYigmlM1XT/kLQZSNpMJG0WkjYbSZuDpM1F0uYhFc1HxU4m1QJjDK6iL0S5uSj5rgXc3RejEigtcRBtqYPQsiTskmO5vosV+q4VGIKbOkDg0jtRrq+Em1YloaTFar3EGr1EUC8R0kus1Uus00usL97ABr2BjXoDm/QGNhuWtMVBKOwg/i78lT7hBsAvDmwHc/ao3vmUbBmhjeYySZNWvGkfZAgISDSaDo1SVpzGDsAEkF8B+gEapViUoZgUWXcRIGFZNm6gWbAKk0bp0k1MHG9fLYtV4iS2SmLEQFARzRcnf9PUS0LVn05/J9MiRRBU3v2IrvW974v4N00L7ZMk0wXP1409CHo/an8zTRHD3eSJ6m8D4YMkZNl3M79sqeuAsr/m3f+8/yl7A50aiAEJgeBeMWzu7ui9UfUBCe2TIqZIoOd/3/udRBOQidQZUERzb2/VwZN1H/Sju82ew2H2Wfr6qvfVf3hqwDvAIpkQVFy4B9Pe9e4/XvPeceu7h3dvO56iJPf0+A6cqA2ip18ER+iFgggiuOkvj24bby0N9j2UHIkgqIt+sVgfodC4YghLSMjSZbH0VR/6dMDrYJeKHilKTemt6v6kvzvn3/RrdWtr0GoN/xL+Sex/cPYLUpepx9cz/D46UPU5KXgAQa+NDps1v6J3xP1i2HtaDB0M9aX2deA7SYff//+gUCovMmIK/qfsFcOk+4Y5ZN97XlG6zebqtMbKgeRFi51vnxTQYBUik2rS/Cn6PC8ADR8FGxsRPB82dzfND90gIcshOcYUkfjherBz53odpm6TP8txlwOZ71xmfHHOvq053qFF/MRlS3jP0ELudrf2OeN8DHvp6ZceLe8qKYvWz/7yp0u4dKPfli3CYq0O13Ih71mylJ80tOi10On8wi+F4+LWgDPeJ30msSQt9/vkmHq9/Lvo2b461mP801v3W4xTcs6CbvF9UDdrSt+A8OUbpSh55qAUFXWznBBfdeJ8a4d7ugT5tvxUza3h9m4H7ptTqiG4z0g5dc0X29OcGlhpGFMpQo9ytTS+NViZpNdvU4kWx+LKxNY10kQ1yqGXrhe4/1nvP7E+nd5A92TtaRplbHSqoIdOqtRWti+fkB5/n1+/VvCmz12pG1kpQWsfi1ftlBobm0bpngs16CHkbIwdLnParxtTV3QYRlfJ0KFskH7pdN/YDn+yRuSd7sNH3aO0DYPggk6uWuXrfOc+fa3VTxFVvKaNxHsiHmsXyCLIE5yuOeN3/Jdf8HBL/5M6shjyhxHx9BjB1O0+4NLOnjLLSxwO7ukN4jMbOIcD879KLSi6Pk61Oqm2377n8079PXEEQ7cy7OKEC9nbpet118fxweTafpt69x/Bt8UqGzNQt7aelpc44dn5cqhwf71+qKp/Zf/+a0zcizOUWpl/iBcSXip0pplkatCchoH5c5aUM8I7/dWxAej8WicPL1URFZ9BDJelUwEwTkGqUhgSlydVes95YdXvhh9Gfz/aeFWvgVb4tuLbcv4+wLdutVZv/cUonwBD/6eDlE0aSiKK/uoH3+J1wDE/jMVqY2ysGufN84oIXB0sPzy8ollX/LegY74DgJXJR57sn+VGza0x3DnuIgABFM15LmajjjsNlYj+JEZGbuRYcAMOWxFkPN2w6Wd46xo4gVWQR/X4lyI/R6K/YK0110GzudPRW7Y+UOBGTfNNzHeYT0fiH0taunBpq9HEW8OKSaBGj21L0MqenEmNRWBAWDWAk4CpNoEZJ2tTaPFgbQYj8HxtFilErs3BTRwT8uO1NXQaWfIotchmPkAF5mMBAliEmZiOGVgCG9LgRzpscMAOOwowlT3JhusdazXGSC/hxR3UlmWVwWHpOIKheqONvjyhSiTHIkVUco5bnji8m//zL7PKaT1Vl5I6UE609f+gkr6MZKVyKc7zJRmCahLsdlyA5fdQkRSan9LgnnLEyGSkaKJCJog0wAgvepWBt80+1yKln1bMVtCljfNWDueKLsWwaEbBSfSPTEmVRsUcYYMnEjcjeyCZzBXK9E9BYBXLKjOSpUDR+nEV3TFSUdQaz+ot98QxgXwx0GQ+EEUAKB2qZPkQQ0GqFD8UPFMqyaCHM24BZmSGic9EYMagKizOw9Hz50DMrDLrqqLkTAhplMictiCAx5S3BIUQdeJeLnBy2CNtMfz6cV4u8XKoFZQesbf9YZiIERiHjaNodDW6LgcirX/mPnJIkBGDUpTBhSa0EIr38D5hCIszhCM8URGBqImoWjpvpt1ebu/v3Gl3qJfMnNM+9V+kiRFyROTPHQWOcs1dNW94/ukKMPZBvDi55i5CttdeJz84DLngLqjcdwEZ87bFFR8CIG35OAkDVN6VRDZ7aq67NteYqZ2lpT8oYB2CytoBd6VuAx4WgiAsnuj3WohG+LugzXiQRDeM3XYXlULv4dp5VFYC"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Size4-Regular-a4af7d41.woff2"><link rel="preload" as="font" crossorigin="anonymous" href="/assets/KaTeX_Typewriter-Regular-71d517d6.woff2"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><canvas class="fireworks"></canvas><!--[--><div class="va-bg"></div><!--]--><!----><!--]--><!--[--><!--]--><!----><!--[--><!--[--><!----><button type="button" class="vt-hamburger menu-btn sidebar-toggle yun-icon-btn md:hidden" aria-label="mobile navigation" aria-expanded="false"><span class="vt-hamburger-container"><span class="vt-hamburger-top"></span><span class="vt-hamburger-middle"></span><span class="vt-hamburger-bottom"></span></span></button><aside class="md:translate-x-0 va-card transition sidebar"><!--[--><!--[--><!--[--><!----><div class=""><!--[--><div class="sidebar-panel"><div class="site-info" m="t-6"><a href="/about" class="site-author-avatar"><img class="rounded-full" src="https://cos.vlinux.cn/vlinux-logo/user.jpg" alt="avatar"><span class="site-author-status">🥺</span></a><div class="site-author-name"><a href="/about" class="">卷饼</a></div><a href="/about/site" class="site-name">运维之境</a><h4 class="site-subtitle block" text="xs">如果你太在意别人的话</h4><div class="site-description my-1">那你终将成为别人的一条裤衩</div></div><nav class="site-nav" text-xl="" mt-6=""><a href="/" class="site-link-item yun-icon-btn" title="首页"><div i-ri-home-4-line=""></div></a><a href="/archives/" class="site-link-item" title="归档"><div class="icon" i-ri-archive-line=""></div><span class="count">96</span></a><a href="/categories/" class="site-link-item" title="分类"><div class="icon" i-ri-folder-2-line=""></div><span class="count">17</span></a><a href="/tags/" class="site-link-item" title="标签"><div class="icon" i-ri-price-tag-3-line=""></div><span class="count">125</span></a><a href="/about" class="site-link-item yun-icon-btn" title="关于"><!--[--><div class="i-ri-clipboard-line"></div><!--]--></a></nav><hr m="t-4 b-2"><div class="links-of-author"><!--[--><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=38867033&amp;site=qq&amp;menu=yes&amp;jumpflag=1" title="QQ 38867033" target="_blank" style="color:#12b7f5"><div class="i-ri-qq-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://github.com/vlinux" title="GitHub" target="_blank" style="color:#6e5494"><div class="i-ri-github-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://repo.vlinux.cn/" title="杂物堆 Repo" target="_blank" style="color:#08c"><div class="i-ri-download-cloud-2-fill icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG18.jpeg" title="微信公众号" target="_blank" style="color:#1aad19"><div class="i-ri-wechat-2-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.vlinux.cn/music/" title="Music" target="_blank" style="color:#e6162d"><div class="i-ri-speaker-fill icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="mailto:ilinux@88.com" title="E-Mail" target="_blank" style="color:#8e71c1"><div class="i-ri-mail-line icon"></div></a><a class="links-of-author-item yun-icon-btn" rel="noopener" href="https://www.vlinux.cn/play" title="Games" target="_blank" style="color:var(--va-c-text)"><div class="i-ri-gamepad-line icon"></div></a><!--]--></div><hr m="y-2"><div class="links"><!--[--><a href="/links/" class="link-item yun-icon-btn" title="我的小伙伴们" style="color:#1e90ff"><!--[--><div class="i-ri-genderless-line icon"></div><!--]--></a><a href="/bill" class="link-item yun-icon-btn" title="我的小账单" style="color:gold"><!--[--><div class="i-ri-money-cny-circle-line icon"></div><!--]--></a><a href="/girls/" class="link-item yun-icon-btn" title="喜欢的女孩子" style="color:#ff69b4"><!--[--><div class="i-ri-women-line icon"></div><!--]--></a><!--]--></div><br></div><div><button class="yun-icon-btn" title="切换深色模式" style="color:#f1cb64"><div i="ri-sun-line dark:ri-moon-line"></div></button><button class="yun-icon-btn" title="切换语言" style="color:var(--va-c-text)"><div i-ri-translate="" class="transition transform"></div></button></div><!--]--></div><!--]--><!--]--><!--]--></aside><!--]--><main class="yun-main lt-md:ml-0" flex="~"><div w="full" flex="~"><!--[--><div class="content" flex="~ col grow" w="full" p="l-4 lt-md:0"><div class="yun-card relative" m="0" style=""><!----><!----><!--[--><!--[--><header class="post-header mb-2" m="t-4"><h1 class="post-title flex-center" p="2" text="2xl center" font="serif black" style=""><!----><span inline-flex="" class="leading-none">Consul使用中文手册</span></h1></header><!--]--><!--[--><!--[--><!--[--><!--[--><!----><!----><!----><div class="post-meta" flex="~ col" justify="center" items="center" text="sm" py="1"><div class="post-time flex items-center"><span class="inline-flex-center" title="发表于"><div class="inline-block" i-ri-calendar-line=""></div><time m="l-1">2021-01-28</time></span><span class="inline-flex-center" title="更新于"><span m="x-2">-</span><div i-ri-calendar-2-line=""></div><time m="l-1">2023-02-08</time></span></div><div class="post-counter flex items-center" mt="2"><span class="inline-flex-center" title="本文字数"><div class="inline-block" i-ri-file-word-line=""></div><time m="l-1">17.2k</time></span><span class="inline-flex-center" title="阅读时长"><span m="x-2">-</span><div i-ri-timer-line=""></div><time m="l-1">70m</time></span></div></div><!--[--><!--]--><!--]--><div flex="~" text="sm" py="1"><!----><!----></div><div class="inline-flex" text="sm" py="1"><a href="/categories/?category=%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C" class="post-category inline-flex-center"><div m="x-1" inline-flex="" i-ri-folder-2-line=""></div><span>自动注册</span></a><span mx="2">-</span><!--[--><a href="/tags/?tag=Consul" class="post-tag inline-flex-center" m="x-1"><div m="r-1" i-ri-price-tag-3-line=""></div><span>Consul</span></a><!--]--></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><article class="markdown-body"><!--[--><!----><!--[--><h1 id="使用consul" tabindex="-1">使用consul <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#使用consul" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><h2 id="介绍" tabindex="-1">介绍 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#介绍" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>Consul包含多个组件,但是作为一个整体,为你的基础设施提供服务发现和服务配置的工具.他提供以下关键特性:</p><p><strong>服务发现</strong> Consul的客户端可用提供一个服务,比如 api 或者mysql ,另外一些客户端可用使用Consul去发现一个指定服务的提供者.通过DNS或者HTTP应用程序可用很容易的找到他所依赖的服务. <strong>健康检查</strong> Consul客户端可用提供任意数量的健康检查,指定一个服务(比如:webserver是否返回了200 OK 状态码)或者使用本地节点(比如:内存使用是否大于90%). 这个信息可由operator用来监视集群的健康.被服务发现组件用来避免将流量发送到不健康的主机. <strong>Key/Value存储</strong> 应用程序可用根据自己的需要使用Consul的层级的Key/Value存储.比如动态配置,功能标记,协调,领袖选举等等,简单的HTTP API让他更易于使用. <strong>多数据中心</strong> Consul支持开箱即用的多数据中心.这意味着用户不需要担心需要建立额外的抽象层让业务扩展到多个区域. Consul面向DevOps和应用开发者友好.是他适合现代的弹性的基础设施. <img src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/cluster.png" alt="consul-cluster"></p><h2 id="基础架构" tabindex="-1">基础架构 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#基础架构" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>Consul是一个分布式高可用的系统. 这节将包含一些基础,我们忽略掉一些细节这样你可以快速了解Consul是如何工作的.如果要了解更多细节,请参考深入的架构描述.</p><p>每个提供服务给Consul的阶段都运行了一个Consul agent . 发现服务或者设置和获取 key/value存储的数据不是必须运行agent.这个agent是负责对节点自身和节点上的服务进行健康检查的.</p><p>Agent与一个和多个Consul Server 进行交互.Consul Server 用于存放和复制数据.server自行选举一个领袖.虽然Consul可以运行在一台server , 但是建议使用3到5台来避免失败情况下数据的丢失.每个数据中心建议配置一个server集群.</p><p>你基础设施中需要发现其他服务的组件可以查询任何一个Consul 的server或者 agent.Agent会自动转发请求到server .</p><p>每个数据中运行了一个Consul server集群.当一个跨数据中心的服务发现和配置请求创建时.本地Consul Server转发请求到远程的数据中心并返回结果.</p><p>更多介绍查看官网<a target="_blank" rel="noreferrer" href="https://www.consul.io/"><!--[-->点击前往<!--]--><!----></a></p><h2 id="安装consul" tabindex="-1">安装Consul <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#安装consul" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>安装Consul,找到适合你系统的包下载他.Consul打包为一个’Zip’文件.<a target="_blank" rel="noreferrer" href="https://www.consul.io/downloads.html"><!--[-->前往下载<!--]--><!----></a></p><p>下载后解开压缩包.拷贝Consul到你的PATH路径中,在Unix系统中<code>~/bin</code>和<code>/usr/local/bin</code>是通常的安装目录.根据你是想为单个用户安装还是给整个系统安装来选择.在Windows系统中有可以安装到<code>%PATH%</code>的路径中.</p><h2 id="验证安装" tabindex="-1">验证安装 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#验证安装" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>完成安装后,通过打开一个新终端窗口检查<code>consul</code>安装是否成功.通过执行 <code>consul</code>你应该看到类似下面的输出</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-248 ~]# consul</span></span>
<span class="line"><span style="color:#a6accd">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span></span>
<span class="line"><span style="color:#a6accd">Available commands are:</span></span>
<span class="line"><span style="color:#a6accd">    agent          Runs a Consul agent</span></span>
<span class="line"><span style="color:#a6accd">    configtest     Validate config file</span></span>
<span class="line"><span style="color:#a6accd">    event          Fire a new event</span></span>
<span class="line"><span style="color:#a6accd">    exec           Executes a command on Consul nodes</span></span>
<span class="line"><span style="color:#a6accd">    force-leave    Forces a member of the cluster to enter the "left" state</span></span>
<span class="line"><span style="color:#a6accd">    info           Provides debugging information for operators</span></span>
<span class="line"><span style="color:#a6accd">    join           Tell Consul agent to join cluster</span></span>
<span class="line"><span style="color:#a6accd">    keygen         Generates a new encryption key</span></span>
<span class="line"><span style="color:#a6accd">    keyring        Manages gossip layer encryption keys</span></span>
<span class="line"><span style="color:#a6accd">    kv             Interact with the key-value store</span></span>
<span class="line"><span style="color:#a6accd">    leave          Gracefully leaves the Consul cluster and shuts down</span></span>
<span class="line"><span style="color:#a6accd">    lock           Execute a command holding a lock</span></span>
<span class="line"><span style="color:#a6accd">    maint          Controls node or service maintenance mode</span></span>
<span class="line"><span style="color:#a6accd">    members        Lists the members of a Consul cluster</span></span>
<span class="line"><span style="color:#a6accd">    monitor        Stream logs from a Consul agent</span></span>
<span class="line"><span style="color:#a6accd">    operator       Provides cluster-level tools for Consul operators</span></span>
<span class="line"><span style="color:#a6accd">    reload         Triggers the agent to reload configuration files</span></span>
<span class="line"><span style="color:#a6accd">    rtt            Estimates network round trip time between nodes</span></span>
<span class="line"><span style="color:#a6accd">    snapshot       Saves, restores and inspects snapshots of Consul server state</span></span>
<span class="line"><span style="color:#a6accd">    version        Prints the Consul version</span></span>
<span class="line"><span style="color:#a6accd">    watch          Watch for changes in Consul</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果你得到一个<code>consul not be found</code>的错误,你的<code>PATH</code>可能没有正确设置.请返回检查你的consul的安装路径是否包含在<code>PATH</code>中.</p><h2 id="运行agent" tabindex="-1">运行Agent <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#运行agent" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>完成Consul的安装后,必须运行agent. agent可以运行为<code>server</code>或<code>client</code>模式.每个数据中心至少必须拥有一台server . 建议在一个集群中有3或者5个server.部署单一的server,在出现失败时会不可避免的造成数据丢失.</p><p>其他的agent运行为client模式.一个client是一个非常轻量级的进程.用于注册服务,运行健康检查和转发对server的查询.agent必须在集群中的每个主机上运行.</p><p>查看启动数据中心的细节请查看<a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/guides/bootstrapping.html"><!--[-->这里<!--]--><!----></a>.</p><h2 id="启动-consul-server" tabindex="-1">启动 Consul Server <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#启动-consul-server" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>运行cosnul agent以<code>server</code>模式，</p><ul><li><code>-server</code> ： 定义agent运行在server模式</li><li><code>-bootstrap-expect</code> ：在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群，该标记不能和bootstrap共用</li><li><code>-bind</code>：该地址用来在集群内部的通讯，集群内的所有节点到地址都必须是可达的，默认是0.0.0.0</li><li><code>-node</code>：节点在集群中的名称，在一个集群中必须是唯一的，默认是该节点的主机名</li><li><code>-ui-dir</code>： 提供存放web ui资源的路径，该目录必须是可读的</li><li><code>-rejoin</code>：使consul忽略先前的离开，在再次启动后仍旧尝试加入集群中。</li><li><code>-config-dir</code>：配置文件目录，里面所有以.json结尾的文件都会被加载</li><li><code>-client</code>：consul服务侦听地址，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1所以不对外提供服务，如果你要对外提供服务改成0.0.0.0</li></ul><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 consul]# consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span>
<span class="line"><span style="color:#a6accd">==&gt; WARNING: Expect Mode enabled, expecting 3 servers</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Starting Consul agent...</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Starting Consul agent RPC...</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Consul agent running!</span></span>
<span class="line"><span style="color:#a6accd">           Version: 'v0.7.4'</span></span>
<span class="line"><span style="color:#a6accd">           Node ID: '422ec677-74ef-8f29-2f22-01effeed6334'</span></span>
<span class="line"><span style="color:#a6accd">         Node name: 's1'</span></span>
<span class="line"><span style="color:#a6accd">        Datacenter: 'dc1'</span></span>
<span class="line"><span style="color:#a6accd">            Server: true (bootstrap: false)</span></span>
<span class="line"><span style="color:#a6accd">       Client Addr: 0.0.0.0 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span></span>
<span class="line"><span style="color:#a6accd">      Cluster Addr: 10.201.102.198 (LAN: 8301, WAN: 8302)</span></span>
<span class="line"><span style="color:#a6accd">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span></span>
<span class="line"><span style="color:#a6accd">             Atlas: &lt;disabled&gt;</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Log data will now stream in as it occurs:</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] raft: Restored from snapshot 139-352267-1489707086023</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] raft: Initial configuration (index=6982): [{Suffrage:Voter ID:10.201.102.199:8300 Address:10.201.102.199:8300} {Suffrage:Voter ID:10.201.102.200:8300 Address:10.201.102.200:8300} {Suffrage:Voter ID:10.201.102.198:8300 Address:10.201.102.198:8300}]</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] raft: Node at 10.201.102.198:8300 [Follower] entering Follower state (Leader: "")</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: Attempting re-join to previously known node: s2: 10.201.102.199:8301</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] consul: Raft data found, disabling bootstrap mode</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: Re-joined to previously known node: s2: 10.201.102.199:8301</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1.dc1 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [INFO] consul: Adding WAN server s1.dc1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:08 [WARN] serf: Failed to re-join any previously known node</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:14 [INFO] agent: Synced service 'consul'</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:14 [INFO] agent: Deregistered service 'consul01'</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:14 [INFO] agent: Deregistered service 'consul02'</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 18:03:14 [INFO] agent: Deregistered service 'consul03'</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>查看集群成员</strong> 新开一个终端窗口运行<code>consul members</code>, 你可以看到Consul集群的成员.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# consul members</span></span>
<span class="line"><span style="color:#a6accd">Node  Address              Status  Type    Build  Protocol  DC</span></span>
<span class="line"><span style="color:#a6accd">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="启动-consul-client" tabindex="-1">启动 Consul Client <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#启动-consul-client" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>运行cosnul agent以client模式，<code>-join</code> 加入到已有的集群中去。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-248 ~]# consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Starting Consul agent...</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Starting Consul agent RPC...</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Joining cluster...</span></span>
<span class="line"><span style="color:#a6accd">    Join completed. Synced with 1 initial agents</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Consul agent running!</span></span>
<span class="line"><span style="color:#a6accd">           Version: 'v0.7.4'</span></span>
<span class="line"><span style="color:#a6accd">           Node ID: '564dc0c7-7f4f-7402-a301-cebe7f024294'</span></span>
<span class="line"><span style="color:#a6accd">         Node name: 'c1'</span></span>
<span class="line"><span style="color:#a6accd">        Datacenter: 'dc1'</span></span>
<span class="line"><span style="color:#a6accd">            Server: false (bootstrap: false)</span></span>
<span class="line"><span style="color:#a6accd">       Client Addr: 127.0.0.1 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span></span>
<span class="line"><span style="color:#a6accd">      Cluster Addr: 10.201.102.248 (LAN: 8301, WAN: 8302)</span></span>
<span class="line"><span style="color:#a6accd">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span></span>
<span class="line"><span style="color:#a6accd">             Atlas: &lt;disabled&gt;</span></span>
<span class="line"><span style="color:#a6accd">==&gt; Log data will now stream in as it occurs:</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: c1 10.201.102.248</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] agent: (LAN) joining: [10.201.102.198]</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] agent: (LAN) joined: 1 Err: &lt;nil&gt;</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] consul: adding server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] consul: adding server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] consul: adding server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span></span>
<span class="line"><span style="color:#a6accd">    2017/03/17 15:35:16 [INFO] agent: Synced node info</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>查看集群成员</strong> 新开一个终端窗口运行<code>consul members</code>, 你可以看到Consul集群的成员.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-248 ~]# consul members</span></span>
<span class="line"><span style="color:#a6accd">Node  Address              Status  Type    Build  Protocol  DC</span></span>
<span class="line"><span style="color:#a6accd">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>加入集群</strong></p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-248 ~]# consul join 10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">Node  Address              Status  Type    Build  Protocol  DC</span></span>
<span class="line"><span style="color:#a6accd">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="停止agent" tabindex="-1">停止Agent <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#停止agent" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>你可以使用<code>Ctrl-C</code> 优雅的关闭Agent. 中断Agent之后你可以看到他离开了集群并关闭.</p><p>在退出中,Consul提醒其他集群成员,这个节点离开了.如果你强行杀掉进程.集群的其他成员应该能检测到这个节点失效了.当一个成员离开,他的服务和检测也会从目录中移除.当一个成员失效了,他的健康状况被简单的标记为危险,但是不会从目录中移除.Consul会自动尝试对失效的节点进行重连.允许他从某些网络条件下恢复过来.离开的节点则不会再继续联系.</p><p>此外,如果一个agent作为一个服务器,一个优雅的离开是很重要的,可以避免引起潜在的可用性故障影响达成<a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/internals/consensus.html"><!--[-->一致性协议<!--]--><!----></a>.</p><p>查看<a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/internals/consensus.html"><!--[-->这里<!--]--><!----></a>了解添加和移除server.</p><h2 id="更新服务" tabindex="-1">更新服务 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#更新服务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>服务定义可以通过配置文件并发送<code>SIGHUP</code>给agent来进行更新.这样你可以让你在不关闭服务或者保持服务请求可用的情况下进行更新.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul reload</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>另外 HTTP API可以用来动态的添加,移除和修改服务.</p><p>注册服务 搭建好conusl集群后，用户或者程序就能到consul中去查询或者注册服务。可以通过提供服务定义文件或者调用HTTP API来注册一个服务.</p><p>首先,为Consul配置创建一个目录.Consul会载入配置文件夹里的所有配置文件.在Unix系统中通常类似 <code>/etc/consul.d</code> (.d 后缀意思是这个路径包含了一组配置文件).</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">mkdir /etc/consul.d</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>然后,我们将编写服务定义配置文件.假设我们有一个名叫web的服务运行在 80端口.另外,我们将给他设置一个标签.这样我们可以使用他作为额外的查询方式:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">echo '{"service": {"name": "web", "tags": ["rails"], "port": 80}}' &gt;/etc/consul.d/web.json</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>现在重启agent , 设置配置目录:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">$ consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span>
<span class="line"><span style="color:#a6accd">...</span></span>
<span class="line"><span style="color:#a6accd">    [INFO] agent: Synced service 'web'</span></span>
<span class="line"><span style="color:#a6accd">...</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><ul><li><code>-data-dir</code>：提供一个目录用来存放agent的状态，所有的agent允许都需要该目录，该目录必须是稳定的，系统重启后都继续存在 你可能注意到了输出了 “synced” 了 web这个服务.意思是这个agent从配置文件中载入了服务定义,并且成功注册到服务目录.</li></ul><p>如果你想注册多个服务,你应该在Consul配置目录创建多个服务定义文件.</p><p>HTTP API注册服务,curl命令或者postman 以<code>PUT</code>方式请求consul HTTP API更多细节<a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/agent/http/catalog.html#catalog_register"><!--[-->点击查看<!--]--><!----></a></p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">curl -X PUT -d '{"Datacenter": "dc1", "Node": "c2", "Address": "10.155.0.106", "Service": {"Service": "MAC", "tags": ["lianglian", "Mac"], "Port": 22}}' http://127.0.0.1:8500/v1/catalog/register</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="查询服务" tabindex="-1">查询服务 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#查询服务" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>一旦agent启动并且服务同步了.我们可以通过DNS或者HTTP的API来查询服务.</p><p><strong>DNS API</strong> 让我们首先使用DNS API来查询.在DNS API中,服务的DNS名字是 <code>NAME.service.consul</code>. 虽然是可配置的,但默认的所有DNS名字会都在<code>consul</code>命名空间下.这个子域告诉Consul,我们在查询服务,<code>NAME</code>则是服务的名称.</p><p>对于我们上面注册的Web服务.它的域名是 <code>web.service.consul</code> :</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul</span></span>
<span class="line"><span style="color:#a6accd">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul</span></span>
<span class="line"><span style="color:#a6accd">; (1 server found)</span></span>
<span class="line"><span style="color:#a6accd">;; global options: +cmd</span></span>
<span class="line"><span style="color:#a6accd">;; Got answer:</span></span>
<span class="line"><span style="color:#a6accd">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39468</span></span>
<span class="line"><span style="color:#a6accd">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span></span>
<span class="line"><span style="color:#a6accd">;; WARNING: recursion requested but not available</span></span>
<span class="line"><span style="color:#a6accd">;; QUESTION SECTION:</span></span>
<span class="line"><span style="color:#a6accd">;web.service.consul.            IN      A</span></span>
<span class="line"><span style="color:#a6accd">;; ANSWER SECTION:</span></span>
<span class="line"><span style="color:#a6accd">web.service.consul.     0       IN      A       10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">;; Query time: 0 msec</span></span>
<span class="line"><span style="color:#a6accd">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span></span>
<span class="line"><span style="color:#a6accd">;; WHEN: Tue Mar 28 16:10:24 2017</span></span>
<span class="line"><span style="color:#a6accd">;; MSG SIZE  rcvd: 52</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]#</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如你所见,一个<code>A</code>记录返回了一个可用的服务所在的节点的IP地址.<code>A</code>记录只能设置为IP地址. 有也可用使用 DNS API 来接收包含 地址和端口的 SRV记录:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; (1 server found)</span></span>
<span class="line"><span style="color:#a6accd">;; global options: +cmd</span></span>
<span class="line"><span style="color:#a6accd">;; Got answer:</span></span>
<span class="line"><span style="color:#a6accd">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13331</span></span>
<span class="line"><span style="color:#a6accd">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span>
<span class="line"><span style="color:#a6accd">;; WARNING: recursion requested but not available</span></span>
<span class="line"><span style="color:#a6accd">;; QUESTION SECTION:</span></span>
<span class="line"><span style="color:#a6accd">;web.service.consul.            IN      SRV</span></span>
<span class="line"><span style="color:#a6accd">;; ANSWER SECTION:</span></span>
<span class="line"><span style="color:#a6accd">web.service.consul.     0       IN      SRV     1 1 80 s1.node.dc1.consul.</span></span>
<span class="line"><span style="color:#a6accd">;; ADDITIONAL SECTION:</span></span>
<span class="line"><span style="color:#a6accd">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">;; Query time: 0 msec</span></span>
<span class="line"><span style="color:#a6accd">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span></span>
<span class="line"><span style="color:#a6accd">;; WHEN: Tue Mar 28 16:10:56 2017</span></span>
<span class="line"><span style="color:#a6accd">;; MSG SIZE  rcvd: 84</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]#</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><code>SRV</code>记录告诉我们 web 这个服务运行于节点<code>dhcp-10-201-102-198</code> 的<code>80</code>端口. DNS额外返回了节点的A记录.</p><p>最后,我们也可以用 DNS API 通过标签来过滤服务.基于标签的服务查询格式为<code>TAG.NAME.service.consul</code>. 在下面的例子中,我们请求Consul返回有 <code>rails</code>标签的 <code>web</code>服务.我们成功获取了我们注册为这个标签的服务:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 rails.web.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 rails.web.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; (1 server found)</span></span>
<span class="line"><span style="color:#a6accd">;; global options: +cmd</span></span>
<span class="line"><span style="color:#a6accd">;; Got answer:</span></span>
<span class="line"><span style="color:#a6accd">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 37307</span></span>
<span class="line"><span style="color:#a6accd">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span>
<span class="line"><span style="color:#a6accd">;; WARNING: recursion requested but not available</span></span>
<span class="line"><span style="color:#a6accd">;; QUESTION SECTION:</span></span>
<span class="line"><span style="color:#a6accd">;rails.web.service.consul.      IN      SRV</span></span>
<span class="line"><span style="color:#a6accd">;; ANSWER SECTION:</span></span>
<span class="line"><span style="color:#a6accd">rails.web.service.consul. 0     IN      SRV     1 1 80 s1.node.dc1.consul.</span></span>
<span class="line"><span style="color:#a6accd">;; ADDITIONAL SECTION:</span></span>
<span class="line"><span style="color:#a6accd">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">;; Query time: 0 msec</span></span>
<span class="line"><span style="color:#a6accd">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span></span>
<span class="line"><span style="color:#a6accd">;; WHEN: Tue Mar 28 16:11:45 2017</span></span>
<span class="line"><span style="color:#a6accd">;; MSG SIZE  rcvd: 90</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]#</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>HTTP API</strong> 除了DNS API之外,HTTP API也可以用来进行服务查询:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web | python -m json.tool</span></span>
<span class="line"><span style="color:#a6accd">[</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "Address": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 492843,</span></span>
<span class="line"><span style="color:#a6accd">        "ID": "422ec677-74ef-8f29-2f22-01effeed6334",</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 492843,</span></span>
<span class="line"><span style="color:#a6accd">        "Node": "s1",</span></span>
<span class="line"><span style="color:#a6accd">        "NodeMeta": {},</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceAddress": "",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceEnableTagOverride": false,</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceID": "web",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceName": "web",</span></span>
<span class="line"><span style="color:#a6accd">        "ServicePort": 80,</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceTags": [</span></span>
<span class="line"><span style="color:#a6accd">            "rails"</span></span>
<span class="line"><span style="color:#a6accd">        ],</span></span>
<span class="line"><span style="color:#a6accd">        "TaggedAddresses": {</span></span>
<span class="line"><span style="color:#a6accd">            "lan": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">            "wan": "10.201.102.198"</span></span>
<span class="line"><span style="color:#a6accd">        }</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>目录API给出所有节点提供的服务.稍后我们会像通常的那样带上健康检查进行查询.就像DNS内部处理的那样.这是只查看健康的实例的查询方法:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web?passing | python -m json.tool</span></span>
<span class="line"><span style="color:#a6accd">[</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "Address": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 492843,</span></span>
<span class="line"><span style="color:#a6accd">        "ID": "422ec677-74ef-8f29-2f22-01effeed6334",</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 492843,</span></span>
<span class="line"><span style="color:#a6accd">        "Node": "s1",</span></span>
<span class="line"><span style="color:#a6accd">        "NodeMeta": {},</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceAddress": "",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceEnableTagOverride": false,</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceID": "web",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceName": "web",</span></span>
<span class="line"><span style="color:#a6accd">        "ServicePort": 80,</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceTags": [</span></span>
<span class="line"><span style="color:#a6accd">            "rails"</span></span>
<span class="line"><span style="color:#a6accd">        ],</span></span>
<span class="line"><span style="color:#a6accd">        "TaggedAddresses": {</span></span>
<span class="line"><span style="color:#a6accd">            "lan": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">            "wan": "10.201.102.198"</span></span>
<span class="line"><span style="color:#a6accd">        }</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="web管理界面" tabindex="-1">WEB管理界面 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#web管理界面" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>Consul同时提供了一个漂亮的功能齐全的WEB界面,开箱即用.界面可以用来查看所有的节点,可以查看健康检查和他们的当前状态.可以读取和设置K/V 存储的数据.UI自动支持多数据中心.<a target="_blank" rel="noreferrer" href="https://www.consul.io/downloads.html"><!--[-->点击前往下载<!--]--><!----></a></p><p><img src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/ui_download.png" alt="UI_Download"></p><p>下载完后上传至服务器，建议所有server角色都使用WebUI，。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><ul><li><code>-ui-dir</code>： 提供存放web ui资源的路径，指向该目录必须是可读的</li><li><code>-client</code>：consul服务侦听地址，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1所以不对外提供服务，如果你要对外提供服务改成0.0.0.0 可通过<a target="_blank" rel="noreferrer" href="http://10.201.102.198:8500/"><!--[-->http://10.201.102.198:8500<!--]--><!----></a>访问WEB管理界面。</li></ul><p><img src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/ui.png" alt="UI_Download"></p><h2 id="健康检查" tabindex="-1">健康检查 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#健康检查" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>我们现在看到Consul运行时如此简单.添加节点和服务,查询节点和服务.在这一节.我们将继续添加健康检查到节点和服务.健康检查是服务发现的关键组件.预防使用到不健康的服务.</p><p>这一步建立在前一节的Consul集群创建之上.目前你应该有一个包含多个节点的Consul集群.</p><p><strong>自定义检查</strong> 和服务注册类似,一个检查可以通过检查定义或HTTP API请求来注册.</p><p>我们将使用和检查定义来注册检查.和服务类似,因为这是建立检查最常用的方式.</p><p>在第二个节点的配置目录建立定义文件:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/etc/consul.d/web.json1</span></span>
<span class="line"><span style="color:#a6accd">{"service": {</span></span>
<span class="line"><span style="color:#a6accd">    "name": "Faceid",</span></span>
<span class="line"><span style="color:#a6accd">    "tags": ["extract", "verify", "compare", "idcard"],</span></span>
<span class="line"><span style="color:#a6accd">    "address": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">    "port": 9000,</span></span>
<span class="line"><span style="color:#a6accd">    "check": {</span></span>
<span class="line"><span style="color:#a6accd">        "name": "ping",</span></span>
<span class="line"><span style="color:#a6accd">        "script": "curl -s localhost:9000",</span></span>
<span class="line"><span style="color:#a6accd">        "interval": "3s"</span></span>
<span class="line"><span style="color:#a6accd">        }</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>or</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/etc/consul.d/web.json1</span></span>
<span class="line"><span style="color:#a6accd">{"service": {</span></span>
<span class="line"><span style="color:#a6accd">    "name": "Faceid",</span></span>
<span class="line"><span style="color:#a6accd">    "tags": ["extract", "verify", "compare", "idcard"],</span></span>
<span class="line"><span style="color:#a6accd">    "address": "10.201.102.199",</span></span>
<span class="line"><span style="color:#a6accd">    "port": 9000,</span></span>
<span class="line"><span style="color:#a6accd">    "check": {</span></span>
<span class="line"><span style="color:#a6accd">        "id": "api",</span></span>
<span class="line"><span style="color:#a6accd">           "name": "HTTP API on port 9000",</span></span>
<span class="line"><span style="color:#a6accd">        "http": "http://localhost:9000",</span></span>
<span class="line"><span style="color:#a6accd">        "interval": "10s",</span></span>
<span class="line"><span style="color:#a6accd">        "timeout": "1s"</span></span>
<span class="line"><span style="color:#a6accd">        }</span></span>
<span class="line"><span style="color:#a6accd">   }</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>more</p><h2 id="检查健康状态" tabindex="-1">检查健康状态 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#检查健康状态" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>我们能适应HTTP API来检查他们.首先我们检查有哪些失败的检查.使用这个命令(注意:这个命令可以运行在任何节点)</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/health/state/critical | python -m json.tool</span></span>
<span class="line"><span style="color:#a6accd">[</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "CheckID": "service:Faceid",</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 493398,</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 493846,</span></span>
<span class="line"><span style="color:#a6accd">        "Name": "Service 'Faceid' check",</span></span>
<span class="line"><span style="color:#a6accd">        "Node": "s1",</span></span>
<span class="line"><span style="color:#a6accd">        "Notes": "",</span></span>
<span class="line"><span style="color:#a6accd">        "Output": "",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceID": "Faceid",</span></span>
<span class="line"><span style="color:#a6accd">        "ServiceName": "Faceid",</span></span>
<span class="line"><span style="color:#a6accd">        "Status": "critical"</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>我们可以看到,只有一个检查我们的<code>web</code>服务在<code>critical</code>状态</p><p>另外,我们可以尝试用DNS查询web服务,Consul将不会返回结果.因为服务不健康.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 Faceid.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 Faceid.service.consul SRV</span></span>
<span class="line"><span style="color:#a6accd">; (1 server found)</span></span>
<span class="line"><span style="color:#a6accd">;; global options: +cmd</span></span>
<span class="line"><span style="color:#a6accd">;; Got answer:</span></span>
<span class="line"><span style="color:#a6accd">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 40884</span></span>
<span class="line"><span style="color:#a6accd">;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3</span></span>
<span class="line"><span style="color:#a6accd">;; WARNING: recursion requested but not available</span></span>
<span class="line"><span style="color:#a6accd">;; QUESTION SECTION:</span></span>
<span class="line"><span style="color:#a6accd">;Faceid.service.consul.         IN      SRV</span></span>
<span class="line"><span style="color:#a6accd">;; ANSWER SECTION:</span></span>
<span class="line"><span style="color:#a6accd">Faceid.service.consul.  0       IN      SRV     1 1 9000 s3.node.dc1.consul.</span></span>
<span class="line"><span style="color:#a6accd">Faceid.service.consul.  0       IN      SRV     1 1 9000 s1.node.dc1.consul.</span></span>
<span class="line"><span style="color:#a6accd">Faceid.service.consul.  0       IN      SRV     1 1 9000 s2.node.dc1.consul.</span></span>
<span class="line"><span style="color:#a6accd">;; ADDITIONAL SECTION:</span></span>
<span class="line"><span style="color:#a6accd">s3.node.dc1.consul.     0       IN      A       10.201.102.200</span></span>
<span class="line"><span style="color:#a6accd">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span></span>
<span class="line"><span style="color:#a6accd">s2.node.dc1.consul.     0       IN      A       10.201.102.199</span></span>
<span class="line"><span style="color:#a6accd">;; Query time: 0 msec</span></span>
<span class="line"><span style="color:#a6accd">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span></span>
<span class="line"><span style="color:#a6accd">;; WHEN: Tue Mar 28 18:20:15 2017</span></span>
<span class="line"><span style="color:#a6accd">;; MSG SIZE  rcvd: 165</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="k-／v" tabindex="-1">K ／V <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#k-／v" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>除了提供服务发现和健康检查的集成.Consul提供了一个易用的键/值存储.这可以用来保持动态配置,协助服务协调,领袖选举,做开发者可以想到的任何事情.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -v http://localhost:8500/v1/kv/?recurse</span></span>
<span class="line"><span style="color:#a6accd">* About to connect() to localhost port 8500 (#0)</span></span>
<span class="line"><span style="color:#a6accd">*   Trying ::1... 拒绝连接</span></span>
<span class="line"><span style="color:#a6accd">*   Trying 127.0.0.1... connected</span></span>
<span class="line"><span style="color:#a6accd">* Connected to localhost (127.0.0.1) port 8500 (#0)</span></span>
<span class="line"><span style="color:#a6accd">&gt; GET /v1/kv/?recurse HTTP/1.1</span></span>
<span class="line"><span style="color:#a6accd">&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2</span></span>
<span class="line"><span style="color:#a6accd">&gt; Host: localhost:8500</span></span>
<span class="line"><span style="color:#a6accd">&gt; Accept: */*</span></span>
<span class="line"><span style="color:#a6accd">&gt;</span></span>
<span class="line"><span style="color:#a6accd">&lt; HTTP/1.1 404 Not Found</span></span>
<span class="line"><span style="color:#a6accd">&lt; X-Consul-Index: 1</span></span>
<span class="line"><span style="color:#a6accd">&lt; X-Consul-Knownleader: true</span></span>
<span class="line"><span style="color:#a6accd">&lt; X-Consul-Lastcontact: 0</span></span>
<span class="line"><span style="color:#a6accd">&lt; Date: Thu, 18 Aug 2016 08:21:39 GMT</span></span>
<span class="line"><span style="color:#a6accd">&lt; Content-Length: 0</span></span>
<span class="line"><span style="color:#a6accd">&lt; Content-Type: text/plain; charset=utf-8</span></span>
<span class="line"><span style="color:#a6accd">&lt;</span></span>
<span class="line"><span style="color:#a6accd">* Connection #0 to host localhost left intact</span></span>
<span class="line"><span style="color:#a6accd">* Closing connection #0</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>因为没有key所以我们得到了一个404响应.现在我们<code>PUT</code>一些示例的Key:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d 'test' http://localhost:8500/v1/kv/web/key1</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d 'test' http://localhost:8500/v1/kv/web/key2?flags=42</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d 'test'  http://localhost:8500/v1/kv/web/sub/key3</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>我们创建了值为”test”的3个Key,注意返回的值是经过了<code>base64</code>编码的.用来支持非UTF8编码字符.对Key <code>web/key2</code>我们设置了一个标志值为 <code>42</code>.所有的key支持设置一个64位的整形数字标志.Consul内部不适用这个值.但是他可以被客户端适用来做一些元数据.</p><p>完成设置后,我们发起了一个<code>GET</code>请求来接收多个key的值,使用<code>?recurse</code>参数.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/?recurse | python -m json.tool</span></span>
<span class="line"><span style="color:#a6accd">[</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 502660,</span></span>
<span class="line"><span style="color:#a6accd">        "Flags": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "Key": "web/key1",</span></span>
<span class="line"><span style="color:#a6accd">        "LockIndex": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 502660,</span></span>
<span class="line"><span style="color:#a6accd">        "Value": "dGVzdA=="</span></span>
<span class="line"><span style="color:#a6accd">    },</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 502663,</span></span>
<span class="line"><span style="color:#a6accd">        "Flags": 42,</span></span>
<span class="line"><span style="color:#a6accd">        "Key": "web/key2",</span></span>
<span class="line"><span style="color:#a6accd">        "LockIndex": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 502663,</span></span>
<span class="line"><span style="color:#a6accd">        "Value": "dGVzdA=="</span></span>
<span class="line"><span style="color:#a6accd">    },</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 502665,</span></span>
<span class="line"><span style="color:#a6accd">        "Flags": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "Key": "web/sub/key3",</span></span>
<span class="line"><span style="color:#a6accd">        "LockIndex": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 502665,</span></span>
<span class="line"><span style="color:#a6accd">        "Value": "dGVzdA=="</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>你可以获取<strong>单个</strong>的key</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/key1 | python -m json.tool</span></span>
<span class="line"><span style="color:#a6accd">[</span></span>
<span class="line"><span style="color:#a6accd">    {</span></span>
<span class="line"><span style="color:#a6accd">        "CreateIndex": 502660,</span></span>
<span class="line"><span style="color:#a6accd">        "Flags": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "Key": "web/key1",</span></span>
<span class="line"><span style="color:#a6accd">        "LockIndex": 0,</span></span>
<span class="line"><span style="color:#a6accd">        "ModifyIndex": 502660,</span></span>
<span class="line"><span style="color:#a6accd">        "Value": "dGVzdA=="</span></span>
<span class="line"><span style="color:#a6accd">    }</span></span>
<span class="line"><span style="color:#a6accd">]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>删除key也很简单.通过<code>DELETE</code>动作来完成.我们可以通过指定完整路径来删除一个单独的key.或者我们可以使用<code>?recurse</code><strong>递归</strong>的删除主路径下所有key.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl -X DELETE http://localhost:8500/v1/kv/web/sub?recurse</span></span>
<span class="line"><span style="color:#a6accd">true</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>可以通过发送相同的URL并提供不同的消息体的<code>PUT</code>请求去修改一个Key.另外,Consul提供一个检查并设置的操作,实现原子的Key修改.通过<code>?cas=参数</code>加上<code>GET</code>中最近的<code>ModifyIndex</code>来达到. 例如我们想修改 “web/key1”:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">curl -X PUT -d 'newval' http://localhost:8500/v1/kv/web/key1?cas=502660</span></span>
<span class="line"><span style="color:#a6accd">true</span></span>
<span class="line"><span style="color:#a6accd">curl -X PUT -d 'newval' http://localhost:8500/v1/kv/web/key1?cas=502660</span></span>
<span class="line"><span style="color:#a6accd">false</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>在这种情况下,第一次<code>CAS</code> 更新成功因为<code>ModifyIndex</code>是<code>502660</code>.而第二次失败是因为<code>ModifyIndex</code>在第一次更新后已经不是<code>502660</code>了 .</p><p>我们也可以使用<code>ModifyIndex</code>来等待key值的改变.例如我们想等待<code>key2</code>被修改:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl "http://localhost:8500/v1/kv/web/key2"</span></span>
<span class="line"><span style="color:#a6accd">[{"LockIndex":0,"Key":"web/key2","Flags":42,"Value":"dGVzdA==","CreateIndex":502663,"ModifyIndex":502663}]</span></span>
<span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# curl "http://localhost:8500/v1/kv/web/key2?index=502663&amp;wait=5s"</span></span>
<span class="line"><span style="color:#a6accd">[{"LockIndex":0,"Key":"web/key2","Flags":42,"Value":"dGVzdA==","CreateIndex":502663,"ModifyIndex":502663}]</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>通过提供 <code>?index=</code>,我们请求等待key值有一个比<code>502663</code>更大的<code>ModifyIndex</code>.虽然<code>?wait=5s</code>参数限制了这个请求最多5秒,否则返回当前的未改变的值. 这样可以有效的等待key的改变.另外,这个功能可以用于等待一组key.直到其中的某个key有修改.</p><h1 id="conusl-命令行" tabindex="-1">Conusl 命令行 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#conusl-命令行" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>见识了consul的强大，consul可以通过一个简单的CLI来控制，consul只有一个命令行应用，就是consul命令，consul命令可以包含agent、members等参数进行使用，这一篇来具体看看consul CLI的具体用法，consul -h即可看到consul cli所支持的参数，而每个参数里面又支持其他参数，下面我们就来具体看看。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">[root@dhcp-10-201-102-198 ~]# consul</span></span>
<span class="line"><span style="color:#a6accd">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span></span>
<span class="line"><span style="color:#a6accd">Available commands are:</span></span>
<span class="line"><span style="color:#a6accd">    agent          Runs a Consul agent  运行一个consul agent</span></span>
<span class="line"><span style="color:#a6accd">    configtest     Validate config file</span></span>
<span class="line"><span style="color:#a6accd">    event          Fire a new event</span></span>
<span class="line"><span style="color:#a6accd">    exec           Executes a command on Consul nodes  在consul节点上执行一个命令</span></span>
<span class="line"><span style="color:#a6accd">    force-leave    Forces a member of the cluster to enter the "left" state   强制节点成员在集群中的状态转换到left状态</span></span>
<span class="line"><span style="color:#a6accd">    info           Provides debugging information for operators  提供操作的debug级别的信息</span></span>
<span class="line"><span style="color:#a6accd">    join           Tell Consul agent to join cluster   加入consul节点到集群中</span></span>
<span class="line"><span style="color:#a6accd">    keygen         Generates a new encryption key  生成一个新的加密key</span></span>
<span class="line"><span style="color:#a6accd">    keyring        Manages gossip layer encryption keys</span></span>
<span class="line"><span style="color:#a6accd">    kv             Interact with the key-value store</span></span>
<span class="line"><span style="color:#a6accd">    leave          Gracefully leaves the Consul cluster and shuts down</span></span>
<span class="line"><span style="color:#a6accd">    lock           Execute a command holding a lock</span></span>
<span class="line"><span style="color:#a6accd">    maint          Controls node or service maintenance mode</span></span>
<span class="line"><span style="color:#a6accd">    members        Lists the members of a Consul cluster    列出集群中成员</span></span>
<span class="line"><span style="color:#a6accd">    monitor        Stream logs from a Consul agent  打印consul节点的日志信息</span></span>
<span class="line"><span style="color:#a6accd">    operator       Provides cluster-level tools for Consul operators</span></span>
<span class="line"><span style="color:#a6accd">    reload         Triggers the agent to reload configuration files   触发节点重新加载配置文件</span></span>
<span class="line"><span style="color:#a6accd">    rtt            Estimates network round trip time between nodes</span></span>
<span class="line"><span style="color:#a6accd">    snapshot       Saves, restores and inspects snapshots of Consul server state</span></span>
<span class="line"><span style="color:#a6accd">    version        Prints the Consul version    打印consul的版本信息</span></span>
<span class="line"><span style="color:#a6accd">    watch          Watch for changes in Consul   监控consul的改变</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>更详细见<a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/commands/index.html"><!--[-->官网<!--]--><!----></a></p><h2 id="agent" tabindex="-1">Agent <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#agent" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>agent</code>指令是consul的核心，它运行agent来维护成员的重要信息、运行检查、服务宣布、查询处理等等。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">==&gt; Usage: consul agent [options]</span></span>
<span class="line"><span style="color:#a6accd">  Starts the Consul agent and runs until an interrupt is received. The</span></span>
<span class="line"><span style="color:#a6accd">  agent represents a single node in a cluster.</span></span>
<span class="line"><span style="color:#a6accd">Options:</span></span>
<span class="line"><span style="color:#a6accd">  -advertise=addr                  Sets the advertise address to use</span></span>
<span class="line"><span style="color:#a6accd">  -advertise-wan=addr              Sets address to advertise on wan instead of</span></span>
<span class="line"><span style="color:#a6accd">                                   advertise addr</span></span>
<span class="line"><span style="color:#a6accd">  -bootstrap                       Sets server to bootstrap mode</span></span>
<span class="line"><span style="color:#a6accd">  -bind=0.0.0.0                    Sets the bind address for cluster</span></span>
<span class="line"><span style="color:#a6accd">                                   communication</span></span>
<span class="line"><span style="color:#a6accd">  -http-port=8500                  Sets the HTTP API port to listen on</span></span>
<span class="line"><span style="color:#a6accd">  -bootstrap-expect=0              Sets server to expect bootstrap mode.</span></span>
<span class="line"><span style="color:#a6accd">  -client=127.0.0.1                Sets the address to bind for client access.</span></span>
<span class="line"><span style="color:#a6accd">                                   This includes RPC, DNS, HTTP and HTTPS (if</span></span>
<span class="line"><span style="color:#a6accd">                                   configured)</span></span>
<span class="line"><span style="color:#a6accd">  -config-file=foo                 Path to a JSON file to read configuration</span></span>
<span class="line"><span style="color:#a6accd">                                   from. This can be specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -config-dir=foo                  Path to a directory to read configuration</span></span>
<span class="line"><span style="color:#a6accd">                                   files from. This will read every file ending</span></span>
<span class="line"><span style="color:#a6accd">                                   in ".json" as configuration in this</span></span>
<span class="line"><span style="color:#a6accd">                                   directory in alphabetical order. This can be</span></span>
<span class="line"><span style="color:#a6accd">                                   specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -data-dir=path                   Path to a data directory to store agent</span></span>
<span class="line"><span style="color:#a6accd">                                   state</span></span>
<span class="line"><span style="color:#a6accd">  -dev                             Starts the agent in development mode.</span></span>
<span class="line"><span style="color:#a6accd">  -recursor=1.2.3.4                Address of an upstream DNS server.</span></span>
<span class="line"><span style="color:#a6accd">                                   Can be specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -dc=east-aws                     Datacenter of the agent (deprecated: use</span></span>
<span class="line"><span style="color:#a6accd">                                   'datacenter' instead).</span></span>
<span class="line"><span style="color:#a6accd">  -datacenter=east-aws             Datacenter of the agent.</span></span>
<span class="line"><span style="color:#a6accd">  -encrypt=key                     Provides the gossip encryption key</span></span>
<span class="line"><span style="color:#a6accd">  -join=1.2.3.4                    Address of an agent to join at start time.</span></span>
<span class="line"><span style="color:#a6accd">                                   Can be specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -join-wan=1.2.3.4                Address of an agent to join -wan at start</span></span>
<span class="line"><span style="color:#a6accd">                                   time. Can be specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join=1.2.3.4              Address of an agent to join at start time</span></span>
<span class="line"><span style="color:#a6accd">                                   with retries enabled. Can be specified</span></span>
<span class="line"><span style="color:#a6accd">                                   multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-interval=30s              Time to wait between join attempts.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-max=0                     Maximum number of join attempts. Defaults to</span></span>
<span class="line"><span style="color:#a6accd">                                   0, which will retry indefinitely.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-ec2-region           EC2 Region to use for discovering servers to</span></span>
<span class="line"><span style="color:#a6accd">                                   join.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-ec2-tag-key          EC2 tag key to filter on for server</span></span>
<span class="line"><span style="color:#a6accd">                                   discovery</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-ec2-tag-value        EC2 tag value to filter on for server</span></span>
<span class="line"><span style="color:#a6accd">                                   discovery</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-gce-project-name     Google Compute Engine project to discover</span></span>
<span class="line"><span style="color:#a6accd">                                   servers in</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-gce-zone-pattern     Google Compute Engine region or zone to</span></span>
<span class="line"><span style="color:#a6accd">                                   discover servers in (regex pattern)</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-gce-tag-value        Google Compute Engine tag value to filter</span></span>
<span class="line"><span style="color:#a6accd">                                   for server discovery</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-gce-credentials-file Path to credentials JSON file to use with</span></span>
<span class="line"><span style="color:#a6accd">                                   Google Compute Engine</span></span>
<span class="line"><span style="color:#a6accd">  -retry-join-wan=1.2.3.4          Address of an agent to join -wan at start</span></span>
<span class="line"><span style="color:#a6accd">                                   time with retries enabled. Can be specified</span></span>
<span class="line"><span style="color:#a6accd">                                   multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-interval-wan=30s          Time to wait between join -wan attempts.</span></span>
<span class="line"><span style="color:#a6accd">  -retry-max-wan=0                 Maximum number of join -wan attempts.</span></span>
<span class="line"><span style="color:#a6accd">                                   Defaults to 0, which will retry</span></span>
<span class="line"><span style="color:#a6accd">                                   indefinitely.</span></span>
<span class="line"><span style="color:#a6accd">  -log-level=info                  Log level of the agent.</span></span>
<span class="line"><span style="color:#a6accd">  -node=hostname                   Name of this node. Must be unique in the</span></span>
<span class="line"><span style="color:#a6accd">                                   cluster</span></span>
<span class="line"><span style="color:#a6accd">  -node-meta=key:value             An arbitrary metadata key/value pair for</span></span>
<span class="line"><span style="color:#a6accd">                                   this node.</span></span>
<span class="line"><span style="color:#a6accd">                                   This can be specified multiple times.</span></span>
<span class="line"><span style="color:#a6accd">  -protocol=N                      Sets the protocol version. Defaults to</span></span>
<span class="line"><span style="color:#a6accd">                                   latest.</span></span>
<span class="line"><span style="color:#a6accd">  -rejoin                          Ignores a previous leave and attempts to</span></span>
<span class="line"><span style="color:#a6accd">                                   rejoin the cluster.</span></span>
<span class="line"><span style="color:#a6accd">  -server                          Switches agent to server mode.</span></span>
<span class="line"><span style="color:#a6accd">  -syslog                          Enables logging to syslog</span></span>
<span class="line"><span style="color:#a6accd">  -ui                              Enables the built-in static web UI server</span></span>
<span class="line"><span style="color:#a6accd">  -ui-dir=path                     Path to directory containing the Web UI</span></span>
<span class="line"><span style="color:#a6accd">                                   resources</span></span>
<span class="line"><span style="color:#a6accd">  -pid-file=path                   Path to file to store agent PID</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="event" tabindex="-1">event <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#event" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>event</code>命令提供了一种机制，用来fire自定义的用户事件，这些事件对consul来说是不透明的，但它们可以用来构建自动部署、重启服务或者其他行动的脚本。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span></span>
<span class="line"><span style="color:#a6accd">-datacenter：数据中心。</span></span>
<span class="line"><span style="color:#a6accd">-name：事件的名称</span></span>
<span class="line"><span style="color:#a6accd">-node：一个正则表达式，用来过滤节点</span></span>
<span class="line"><span style="color:#a6accd">-service：一个正则表达式，用来过滤节点上匹配的服务</span></span>
<span class="line"><span style="color:#a6accd">-tag：一个正则表达式，用来过滤节点上符合tag的服务，必须和-service一起使用。</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="exec" tabindex="-1">exec <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#exec" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>exec</code>指令提供了一种远程执行机制，比如你要在所有的机器上执行uptime命令，远程执行的工作通过job来指定，存储在KV中，agent使用event系统可以快速的知道有新的job产生，消息是通过gossip协议来传递的，因此消息传递是最佳的，但是并不保证命令的执行。事件通过gossip来驱动，远程执行依赖KV存储系统(就像消息代理一样)。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span></span>
<span class="line"><span style="color:#a6accd">-datacenter：数据中心。</span></span>
<span class="line"><span style="color:#a6accd">-prefix：key在KV系统中的前缀，用来存储请求数据，默认是_rexec</span></span>
<span class="line"><span style="color:#a6accd">-node：一个正则表达式，用来过滤节点，评估事件</span></span>
<span class="line"><span style="color:#a6accd">-service：一个正则表达式，用来过滤节点上匹配的服务</span></span>
<span class="line"><span style="color:#a6accd">-tag：一个正则表达式，用来过滤节点上符合tag的服务，必须和-service一起使用。</span></span>
<span class="line"><span style="color:#a6accd">-wait：在节点多长时间没有响应后，认为job已经完成。</span></span>
<span class="line"><span style="color:#a6accd">-wait-repl：</span></span>
<span class="line"><span style="color:#a6accd">-verbose：输出更多信息</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="force-leave" tabindex="-1">force-leave <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#force-leave" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>force-leave</code>治疗可以强制consul集群中的成员进入left状态(空闲状态)，记住，即使一个成员处于活跃状态，它仍旧可以再次加入集群中，这个方法的真实目的是强制移除failed的节点。如果failed的节点还是网络的一部分，则consul会周期性的重新链接failed的节点，如果经过一段时间后(默认是72小时)，consul则会宣布停止尝试链接failed的节点。force-leave指令可以快速的把failed节点转换到left状态。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-rpc-addr:一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="info" tabindex="-1">info <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#info" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>info</code>指令提供了各种操作时可以用到的debug信息，对于client和server，info有返回不同的子系统信息，目前有以下几个KV信息：agent(提供agent信息)，consul(提供consul库的信息)，raft(提供raft库的信息)，serf_lan(提供LAN gossip pool),serf_wan(提供WAN gossip pool)</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="join" tabindex="-1">join <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#join" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>join</code>指令告诉consul agent加入一个已经存在的集群中，一个新的consul agent必须加入一个已经有至少一个成员的集群中，这样它才能加入已经存在的集群中，如果你不加入一个已经存在的集群，则agent是它自身集群的一部分，其他agent则可以加入进来。agents可以加入其他agent多次。consul join [options] address。如果你想加入多个集群，则可以写多个地址，consul会加入所有的地址。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-wan：agent运行在server模式，xxxxxxx</span></span>
<span class="line"><span style="color:#a6accd">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="keygen" tabindex="-1">keygen <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#keygen" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>keygen</code>指令生成加密的密钥，可以用在consul agent通讯加密</p><p>生成一个key</p><h2 id="leave" tabindex="-1">leave <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#leave" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>leave</code>指令触发一个优雅的离开动作并关闭agent，节点离开后不会尝试重新加入集群中。运行在server状态的节点，节点会被优雅的删除，这是很严重的，在某些情况下一个不优雅的离开会影响到集群的可用性。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-rpc-addr:一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="members" tabindex="-1">members <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#members" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>members</code>指令输出consul agent目前所知道的所有的成员以及它们的状态，节点的状态只有alive、left、failed三种状态。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-detailed：输出每个节点更详细的信息。</span></span>
<span class="line"><span style="color:#a6accd">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。</span></span>
<span class="line"><span style="color:#a6accd">-status：过滤出符合正则规则的节点</span></span>
<span class="line"><span style="color:#a6accd">-wan：xxxxxx</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="monitor" tabindex="-1">monitor <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#monitor" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>monitor</code>指令用来链接运行的agent，并显示日志。monitor会显示最近的日志，并持续的显示日志流，不会自动退出，除非你手动或者远程agent自己退出。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-log-level：显示哪个级别的日志，默认是info</span></span>
<span class="line"><span style="color:#a6accd">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="reload" tabindex="-1">reload <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#reload" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>reload</code>指令可以重新加载agent的配置文件。SIGHUP指令在重新加载配置文件时使用，任何重新加载的错误都会写在agent的log文件中，并不会打印到屏幕。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="version" tabindex="-1">version <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#version" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>打印consul的版本</p><h2 id="watch" tabindex="-1">watch <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#watch" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><code>watch</code>指令提供了一个机制，用来监视实际数据视图的改变(节点列表、成员服务、KV)，如果没有指定进程，当前值会被dump出来</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span></span>
<span class="line"><span style="color:#a6accd">-datacenter：数据中心查询。</span></span>
<span class="line"><span style="color:#a6accd">-token：ACL token</span></span>
<span class="line"><span style="color:#a6accd">-key：监视key，只针对key类型</span></span>
<span class="line"><span style="color:#a6accd">-name：监视event，只针对event类型</span></span>
<span class="line"><span style="color:#a6accd">-prefix：监视key prefix，只针对keyprefix类型</span></span>
<span class="line"><span style="color:#a6accd">-service：监控service，只针对service类型</span></span>
<span class="line"><span style="color:#a6accd">-state：过略check state</span></span>
<span class="line"><span style="color:#a6accd">-tag：过滤service tag</span></span>
<span class="line"><span style="color:#a6accd">-type：监控类型，一般有key、keyprefix、service、nodes、checks、event</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h1 id="consul-配置" tabindex="-1">Consul 配置 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#consul-配置" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>agent有各种各样的配置项可以在命令行或者配置文件进行定义，所有的配置项都是可选择的，当加载配置文件的时候，consul从配置文件或者配置目录加载配置。后面定义的配置会合并前面定义的配置，但是大多数情况下，合并的意思是后面定义的配置会覆盖前面定义的配置，但是有些情况，例如event句柄，合并仅仅是添加到前面定义的句柄后面。consul重新加载配置文件也支持以信号的方式接收update信号。</p><p>下面看看命令行参数：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-advertise：通知展现地址用来改变我们给集群中的其他节点展现的地址，一般情况下-bind地址就是展现地址</span></span>
<span class="line"><span style="color:#a6accd">-bootstrap：用来控制一个server是否在bootstrap模式，在一个datacenter中只能有一个server处于bootstrap模式，当一个server处于bootstrap模式时，可以自己选举为raft leader。</span></span>
<span class="line"><span style="color:#a6accd">-bootstrap-expect：在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群，该标记不能和bootstrap公用</span></span>
<span class="line"><span style="color:#a6accd">-bind：该地址用来在集群内部的通讯，集群内的所有节点到地址都必须是可达的，默认是0.0.0.0</span></span>
<span class="line"><span style="color:#a6accd">-client：consul绑定在哪个client地址上，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1</span></span>
<span class="line"><span style="color:#a6accd">-config-file：明确的指定要加载哪个配置文件</span></span>
<span class="line"><span style="color:#a6accd">-config-dir：配置文件目录，里面所有以.json结尾的文件都会被加载</span></span>
<span class="line"><span style="color:#a6accd">-data-dir：提供一个目录用来存放agent的状态，所有的agent允许都需要该目录，该目录必须是稳定的，系统重启后都继续存在</span></span>
<span class="line"><span style="color:#a6accd">-dc：该标记控制agent允许的datacenter的名称，默认是dc1</span></span>
<span class="line"><span style="color:#a6accd">-encrypt：指定secret key，使consul在通讯时进行加密，key可以通过consul keygen生成，同一个集群中的节点必须使用相同的key</span></span>
<span class="line"><span style="color:#a6accd">-join：加入一个已经启动的agent的ip地址，可以多次指定多个agent的地址。如果consul不能加入任何指定的地址中，则agent会启动失败，默认agent启动时不会加入任何节点。</span></span>
<span class="line"><span style="color:#a6accd">-retry-join：和join类似，但是允许你在第一次失败后进行尝试。</span></span>
<span class="line"><span style="color:#a6accd">-retry-interval：两次join之间的时间间隔，默认是30s</span></span>
<span class="line"><span style="color:#a6accd">-retry-max：尝试重复join的次数，默认是0，也就是无限次尝试</span></span>
<span class="line"><span style="color:#a6accd">-log-level：consul agent启动后显示的日志信息级别。默认是info，可选：trace、debug、info、warn、err。</span></span>
<span class="line"><span style="color:#a6accd">-node：节点在集群中的名称，在一个集群中必须是唯一的，默认是该节点的主机名</span></span>
<span class="line"><span style="color:#a6accd">-protocol：consul使用的协议版本</span></span>
<span class="line"><span style="color:#a6accd">-rejoin：使consul忽略先前的离开，在再次启动后仍旧尝试加入集群中。</span></span>
<span class="line"><span style="color:#a6accd">-server：定义agent运行在server模式，每个集群至少有一个server，建议每个集群的server不要超过5个</span></span>
<span class="line"><span style="color:#a6accd">-syslog：开启系统日志功能，只在linux/osx上生效</span></span>
<span class="line"><span style="color:#a6accd">-ui-dir:提供存放web ui资源的路径，该目录必须是可读的</span></span>
<span class="line"><span style="color:#a6accd">-pid-file:提供一个路径来存放pid文件，可以使用该文件进行SIGINT/SIGHUP(关闭/更新)agent</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>除了命令行参数外，配置也可以写入文件中，在某些情况下配置文件会更简单一些，例如：利用consul被用来管理系统。配置文件是json格式的，很容易编写。配置文件不仅被用来设置agent的启动，也可以用来提供健康检测和服务发现的定义。配置文件的一般样例如下：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{</span></span>
<span class="line"><span style="color:#a6accd">  "datacenter": "dc1",</span></span>
<span class="line"><span style="color:#a6accd">  "data_dir": "/opt/consul",</span></span>
<span class="line"><span style="color:#a6accd">  "log_level": "INFO",</span></span>
<span class="line"><span style="color:#a6accd">  "node_name": "s1",</span></span>
<span class="line"><span style="color:#a6accd">  "server": true,</span></span>
<span class="line"><span style="color:#a6accd">  "bootstrap_expect": 3,</span></span>
<span class="line"><span style="color:#a6accd">  "bind_addr": "10.201.102.198",</span></span>
<span class="line"><span style="color:#a6accd">  "client_addr": "0.0.0.0",</span></span>
<span class="line"><span style="color:#a6accd">  "ui_dir": "/root/consul_ui",</span></span>
<span class="line"><span style="color:#a6accd">  "retry_join": ["10.201.102.198","10.201.102.199","10.201.102.200","10.201.102.248"],</span></span>
<span class="line"><span style="color:#a6accd">  "retry_interval": "30s",</span></span>
<span class="line"><span style="color:#a6accd">  "enable_debug": false,</span></span>
<span class="line"><span style="color:#a6accd">  "rejoin_after_leave": true,</span></span>
<span class="line"><span style="color:#a6accd">  "start_join": ["10.201.102.198","10.201.102.199","10.201.102.200","10.201.102.248"],</span></span>
<span class="line"><span style="color:#a6accd">  "enable_syslog": true,</span></span>
<span class="line"><span style="color:#a6accd">  "syslog_facility": "local5"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>下面看看详细的配置文件参数：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">acl_datacenter：只用于server，指定的datacenter的权威ACL信息，所有的servers和datacenter必须同意ACL datacenter</span></span>
<span class="line"><span style="color:#a6accd">acl_default_policy：默认是allow</span></span>
<span class="line"><span style="color:#a6accd">acl_down_policy：</span></span>
<span class="line"><span style="color:#a6accd">acl_master_token：</span></span>
<span class="line"><span style="color:#a6accd">acl_token：agent会使用这个token和consul server进行请求</span></span>
<span class="line"><span style="color:#a6accd">acl_ttl：控制TTL的cache，默认是30s</span></span>
<span class="line"><span style="color:#a6accd">addresses：一个嵌套对象，可以设置以下key：dns、http、rpc</span></span>
<span class="line"><span style="color:#a6accd">advertise_addr：等同于-advertise</span></span>
<span class="line"><span style="color:#a6accd">bootstrap：等同于-bootstrap</span></span>
<span class="line"><span style="color:#a6accd">bootstrap_expect：等同于-bootstrap-expect</span></span>
<span class="line"><span style="color:#a6accd">bind_addr：等同于-bind</span></span>
<span class="line"><span style="color:#a6accd">ca_file：提供CA文件路径，用来检查客户端或者服务端的链接</span></span>
<span class="line"><span style="color:#a6accd">cert_file：必须和key_file一起</span></span>
<span class="line"><span style="color:#a6accd">check_update_interval：</span></span>
<span class="line"><span style="color:#a6accd">client_addr：等同于-client</span></span>
<span class="line"><span style="color:#a6accd">datacenter：等同于-dc</span></span>
<span class="line"><span style="color:#a6accd">data_dir：等同于-data-dir</span></span>
<span class="line"><span style="color:#a6accd">disable_anonymous_signature：在进行更新检查时禁止匿名签名</span></span>
<span class="line"><span style="color:#a6accd">disable_remote_exec：禁止支持远程执行，设置为true，agent会忽视所有进入的远程执行请求</span></span>
<span class="line"><span style="color:#a6accd">disable_update_check：禁止自动检查安全公告和新版本信息</span></span>
<span class="line"><span style="color:#a6accd">dns_config：是一个嵌套对象，可以设置以下参数：allow_stale、max_stale、node_ttl 、service_ttl、enable_truncate</span></span>
<span class="line"><span style="color:#a6accd">domain：默认情况下consul在进行DNS查询时，查询的是consul域，可以通过该参数进行修改</span></span>
<span class="line"><span style="color:#a6accd">enable_debug：开启debug模式</span></span>
<span class="line"><span style="color:#a6accd">enable_syslog：等同于-syslog</span></span>
<span class="line"><span style="color:#a6accd">encrypt：等同于-encrypt</span></span>
<span class="line"><span style="color:#a6accd">key_file：提供私钥的路径</span></span>
<span class="line"><span style="color:#a6accd">leave_on_terminate：默认是false，如果为true，当agent收到一个TERM信号的时候，它会发送leave信息到集群中的其他节点上。</span></span>
<span class="line"><span style="color:#a6accd">log_level：等同于-log-level</span></span>
<span class="line"><span style="color:#a6accd">node_name:等同于-node</span></span>
<span class="line"><span style="color:#a6accd">ports：这是一个嵌套对象，可以设置以下key：dns(dns地址：8600)、http(http api地址：8500)、rpc(rpc:8400)、serf_lan(lan port:8301)、serf_wan(wan port:8302)、server(server rpc:8300)</span></span>
<span class="line"><span style="color:#a6accd">protocol：等同于-protocol</span></span>
<span class="line"><span style="color:#a6accd">recursor：</span></span>
<span class="line"><span style="color:#a6accd">rejoin_after_leave：等同于-rejoin</span></span>
<span class="line"><span style="color:#a6accd">retry_join：等同于-retry-join</span></span>
<span class="line"><span style="color:#a6accd">retry_interval：等同于-retry-interval</span></span>
<span class="line"><span style="color:#a6accd">server：等同于-server</span></span>
<span class="line"><span style="color:#a6accd">server_name：会覆盖TLS CA的node_name，可以用来确认CA name和hostname相匹配</span></span>
<span class="line"><span style="color:#a6accd">skip_leave_on_interrupt：和leave_on_terminate比较类似，不过只影响当前句柄</span></span>
<span class="line"><span style="color:#a6accd">start_join：一个字符数组提供的节点地址会在启动时被加入</span></span>
<span class="line"><span style="color:#a6accd">statsd_addr：</span></span>
<span class="line"><span style="color:#a6accd">statsite_addr：</span></span>
<span class="line"><span style="color:#a6accd">syslog_facility：当enable_syslog被提供后，该参数控制哪个级别的信息被发送，默认Local0</span></span>
<span class="line"><span style="color:#a6accd">ui_dir：等同于-ui-dir</span></span>
<span class="line"><span style="color:#a6accd">verify_incoming：默认false，如果为true，则所有进入链接都需要使用TLS，需要客户端使用ca_file提供ca文件，只用于consul server端，因为client从来没有进入的链接</span></span>
<span class="line"><span style="color:#a6accd">verify_outgoing：默认false，如果为true，则所有出去链接都需要使用TLS，需要服务端使用ca_file提供ca文件，consul server和client都需要使用，因为两者都有出去的链接</span></span>
<span class="line"><span style="color:#a6accd">watches：watch一个详细名单</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h1 id="http-api" tabindex="-1">HTTP API <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#http-api" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>consul的主要接口是RESTful HTTP API，该API可以用来增删查改nodes、services、checks、configguration。所有的endpoints主要分为以下类别：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">kv - Key/Value存储</span></span>
<span class="line"><span style="color:#a6accd">agent - Agent控制</span></span>
<span class="line"><span style="color:#a6accd">catalog - 管理nodes和services</span></span>
<span class="line"><span style="color:#a6accd">health - 管理健康监测</span></span>
<span class="line"><span style="color:#a6accd">session - Session操作</span></span>
<span class="line"><span style="color:#a6accd">acl - ACL创建和管理</span></span>
<span class="line"><span style="color:#a6accd">event - 用户Events</span></span>
<span class="line"><span style="color:#a6accd">status - Consul系统状态</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>下面我们就单独看看每个模块的具体内容。</p><h2 id="agent-1" tabindex="-1">agent <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#agent-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>agent endpoints用来和本地agent进行交互，一般用来服务注册和检查注册，支持以下接口</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/agent/checks : 返回本地agent注册的所有检查(包括配置文件和HTTP接口)</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/services : 返回本地agent注册的所有 服务</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/members : 返回agent在集群的gossip pool中看到的成员</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/self : 返回本地agent的配置和成员信息</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/join/&lt;address&gt; : 触发本地agent加入node</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/force-leave/&lt;node&gt;&gt;: 强制删除node</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/check/register : 在本地agent增加一个检查项，使用PUT方法传输一个json格式的数据</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/check/deregister/&lt;checkID&gt; : 注销一个本地agent的检查项</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/check/pass/&lt;checkID&gt; : 设置一个本地检查项的状态为passing</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/check/warn/&lt;checkID&gt; : 设置一个本地检查项的状态为warning</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/check/fail/&lt;checkID&gt; : 设置一个本地检查项的状态为critical</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/service/register : 在本地agent增加一个新的服务项，使用PUT方法传输一个json格式的数据</span></span>
<span class="line"><span style="color:#a6accd">/v1/agent/service/deregister/&lt;serviceID&gt; : 注销一个本地agent的服务项</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="catalog" tabindex="-1">catalog <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#catalog" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>catalog endpoints用来注册/注销nodes、services、checks</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/catalog/register : Registers a new node, service, or check</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/deregister : Deregisters a node, service, or check</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/datacenters : Lists known datacenters</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/nodes : Lists nodes in a given DC</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/services : Lists services in a given DC</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/service/&lt;service&gt; : Lists the nodes in a given service</span></span>
<span class="line"><span style="color:#a6accd">/v1/catalog/node/&lt;node&gt; : Lists the services provided by a node</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="health" tabindex="-1">health <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#health" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>health endpoints用来查询健康状况相关信息，该功能从catalog中单独分离出来</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/healt/node/&lt;node&gt;: 返回node所定义的检查，可用参数?dc=</span></span>
<span class="line"><span style="color:#a6accd">/v1/health/checks/&lt;service&gt;: 返回和服务相关联的检查，可用参数?dc=</span></span>
<span class="line"><span style="color:#a6accd">/v1/health/service/&lt;service&gt;: 返回给定datacenter中给定node中service</span></span>
<span class="line"><span style="color:#a6accd">/v1/health/state/&lt;state&gt;: 返回给定datacenter中指定状态的服务，state可以是"any", "unknown", "passing", "warning", or "critical"，可用参数?dc=</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="session" tabindex="-1">session <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#session" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>session endpoints用来create、update、destory、query sessions</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/session/create: Creates a new session</span></span>
<span class="line"><span style="color:#a6accd">/v1/session/destroy/&lt;session&gt;: Destroys a given session</span></span>
<span class="line"><span style="color:#a6accd">/v1/session/info/&lt;session&gt;: Queries a given session</span></span>
<span class="line"><span style="color:#a6accd">/v1/session/node/&lt;node&gt;: Lists sessions belonging to a node</span></span>
<span class="line"><span style="color:#a6accd">/v1/session/list: Lists all the active sessions</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="acl" tabindex="-1">acl <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#acl" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>acl endpoints用来create、update、destory、query acl</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/acl/create: Creates a new token with policy</span></span>
<span class="line"><span style="color:#a6accd">/v1/acl/update: Update the policy of a token</span></span>
<span class="line"><span style="color:#a6accd">/v1/acl/destroy/&lt;id&gt;: Destroys a given token</span></span>
<span class="line"><span style="color:#a6accd">/v1/acl/info/&lt;id&gt;: Queries the policy of a given token</span></span>
<span class="line"><span style="color:#a6accd">/v1/acl/clone/&lt;id&gt;: Creates a new token by cloning an existing token</span></span>
<span class="line"><span style="color:#a6accd">/v1/acl/list: Lists all the active tokens</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="event-1" tabindex="-1">event <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#event-1" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>event endpoints用来fire新的events、查询已有的events</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/event/fire/&lt;name&gt;: 触发一个新的event，用户event需要name和其他可选的参数，使用PUT方法</span></span>
<span class="line"><span style="color:#a6accd">/v1/event/list: 返回agent知道的events</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="status" tabindex="-1">status <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#status" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>status endpoints用来或者consul 集群的信息</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">/v1/status/leader : 返回当前集群的Raft leader</span></span>
<span class="line"><span style="color:#a6accd">/v1/status/peers : 返回当前集群中同事</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h1 id="consul-template" tabindex="-1">Consul-Template <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#consul-template" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p>在consul-template没出现之前，大家构建服务发现系统，大多采用的是zookeeper、etcd+confd这样类似的系统，之前写过一篇consul+confd的文，讲的是如何动态生成配置文件的，如今consul官方推出了自己的模板系统，就是consul-template，这样的话动态的配置系统可以分化为etcd+confd和consul+consul-template两大阵营。consul是一个和etcd类似但又强于etcd的系统，关于etcd和consul可以翻阅以前的文章，consul-template的定位就和confd差不多一样了，confd的后端可以是etcd或者consul，相信consul搭配consul-template能发挥更大的效果。consul-template提供了一个便捷的方式从consul中获取存储的值，consul-template守护进程会查询consul实例，来更新系统上指定的任何模板，当更新完成后，模板可以选择运行一些任意的命令。</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">    consul template的使用场景：consul template可以查询consul中的服务目录、key、key-values等。这种强大的抽象功能和查询语言模板可以使consul template特别适合动态的创建配置文件。例如：创建apache/nginx proxy balancers、haproxy backends、varnish servers、application configurations。</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>consul template的特性：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">    quiescence：consul template内制静止平衡功能，可以智能的发现consul实例中的更改信息。这个功能可以防止频繁的更新模板而引起系统的波动。</span></span>
<span class="line"><span style="color:#a6accd">    dry mode：不确定当前架构的状态？担心模板的变化会破坏子系统？无须担心，因为consul template还有-dry模式。在dry模式，consul template会将结果呈现在STDOUT，所以操作员可以检查输出是否正常，以决定更换模板是否安全</span></span>
<span class="line"><span style="color:#a6accd">    CLI and Config：如果你喜欢在命令行上指定一切，consul template都可以hold住。随着内置HCL的支持，consul template接收一个配置文件，命令行参数，或者两者的混合。通过这种方式你可以继续使用你现在已有的配置管理工具和consul template来配合。</span></span>
<span class="line"><span style="color:#a6accd">    verbose debugging：即使每件事你都做的近乎完美，但是有时候还是会有失败发生。consul template可以提供更详细的debug日志信息。</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="安装" tabindex="-1">安装 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#安装" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>你可以在<a target="_blank" rel="noreferrer" href="https://releases.hashicorp.com/consul-template/"><!--[-->发布页<!--]--><!----></a>下载发布包.如果你希望自己编译请查看<a target="_blank" rel="noreferrer" href="https://github.com/hashicorp/consul-template#contributing"><!--[-->说明文档<!--]--><!----></a>.</p><h2 id="使用" tabindex="-1">使用 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#使用" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">-auth=&lt;user[:pass]&gt;      设置基本的认证用户名和密码</span></span>
<span class="line"><span style="color:#a6accd">  -consul-addr=&lt;address&gt;   设置Consul实例的地址</span></span>
<span class="line"><span style="color:#a6accd">  -max-stale=&lt;duration&gt;    查询过期的最大频率，默认是1s</span></span>
<span class="line"><span style="color:#a6accd">  -dedup                   启用重复数据删除，当许多consul template实例渲染一个模板的时候可以降低consul的负载</span></span>
<span class="line"><span style="color:#a6accd">  -ssl                     使用https连接Consul使用SSL</span></span>
<span class="line"><span style="color:#a6accd">  -ssl-verify              通过SSL连接的时候检查证书</span></span>
<span class="line"><span style="color:#a6accd">  -ssl-cert                SSL客户端证书发送给服务器</span></span>
<span class="line"><span style="color:#a6accd">  -ssl-key                 客户端认证时使用的SSL/TLS私钥</span></span>
<span class="line"><span style="color:#a6accd">  -ssl-ca-cert             验证服务器的CA证书列表</span></span>
<span class="line"><span style="color:#a6accd">  -token=&lt;token&gt;           设置Consul API的token</span></span>
<span class="line"><span style="color:#a6accd">  -syslog                  把标准输出和标准错误重定向到syslog，syslog的默认级别是local0。</span></span>
<span class="line"><span style="color:#a6accd">  -syslog-facility=&lt;f&gt;     设置syslog级别，默认是local0，必须和-syslog配合使用</span></span>
<span class="line"><span style="color:#a6accd">  -template=&lt;template&gt;     增加一个需要监控的模板，格式是：'templatePath:outputPath(:command)'，多个模板则可以设置多次</span></span>
<span class="line"><span style="color:#a6accd">  -wait=&lt;duration&gt;         当呈现一个新的模板到系统和触发一个命令的时候，等待的最大最小时间。如果最大值被忽略，默认是最小值的4倍。</span></span>
<span class="line"><span style="color:#a6accd">  -retry=&lt;duration&gt;        当在和consul api交互的返回值是error的时候，等待的时间，默认是5s。</span></span>
<span class="line"><span style="color:#a6accd">  -config=&lt;path&gt;           配置文件或者配置目录的路径</span></span>
<span class="line"><span style="color:#a6accd">  -pid-file=&lt;path&gt;         PID文件的路径</span></span>
<span class="line"><span style="color:#a6accd">  -log-level=&lt;level&gt;       设置日志级别，可以是"debug","info", "warn" (default), and "err"</span></span>
<span class="line"><span style="color:#a6accd">  -dry                     Dump生成的模板到标准输出，不会生成到磁盘</span></span>
<span class="line"><span style="color:#a6accd">  -once                    运行consul-template一次后退出，不以守护进程运行</span></span>
<span class="line"><span style="color:#a6accd">  -reap                    子进程自动收割123456789101112131415161718192021</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>查看全部选项,使用以下命令</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -h</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><h2 id="命令行" tabindex="-1">命令行 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#命令行" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>1、查询本地consl实例，生成模板后重启nginx，如果consul不可用，如果api故障则每30s尝试检测一次值，consul-template运行一次后退出</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template "test.ctmpl:test.out"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>test.ctmpl</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range service "Faceid"}}</span></span>
<span class="line"><span style="color:#a6accd">{{.ID}} {{.Address}}:{{.Port}} check inter 5000 fall 1 rise 2 weight 2{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>test.out</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd">Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd">Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>2、运行consul-temple作为一个服务</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -consul-addr=10.201.102.198:8500 -template "test.ctmpl:test.out"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>3、查询一个实例，渲染多个模板，然后重启相关服务</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template "test.ctmpl:test.out"\</span></span>
<span class="line"><span style="color:#a6accd"> -template "/tmp/redis.ctmpl:/var/redis/redis.conf:service redis restart" \</span></span>
<span class="line"><span style="color:#a6accd"> -template "/tmp/haproxy.ctmpl:/var/haproxy/haproxy.conf"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>4、查询一个实例，dump模板到标准输出，参数中的-template则会被忽略</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -dry -consul-addr=10.201.102.198:8500 -template "test.ctmpl:test.out"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>以上参数除了在命令行使用，也可以直接配置在文件中，下面看看Consul-Template的配置文件，简称HCL(HashiCorp Configuration Language)，它是和JSON兼容的，下面看个例子：</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">#### 配置文件</span></span>
<span class="line"><span style="color:#a6accd">​```Consul-Template```配置文件是使用[HashiCorp Configuration Language (HCL)](https://github.com/hashicorp/hcl)编写的.这意味着```Consul Template```是和JSON兼容的,查看更多信息请查看 [HCL 规范](https://github.com/hashicorp/hcl)</span></span>
<span class="line"><span style="color:#a6accd">配置文件语法支持上面的所有的选项,除非在表格中进行标明.</span></span>
<span class="line"><span style="color:#a6accd">​```json</span></span>
<span class="line"><span style="color:#a6accd">// 这是要连接的Consul Agent的地址.默认为127.0.0.1:8500.这是Consul的默认绑定地址和端口.</span></span>
<span class="line"><span style="color:#a6accd">// 不建议你直接与 Consul的 Server直接进行交互,请与本地的Consul Agent进行交互.这样做是有一些原因</span></span>
<span class="line"><span style="color:#a6accd">// 最重要的是本地agent可以复用与server的连接.减少HTTP的连接数.另外这个地址更好记.</span></span>
<span class="line"><span style="color:#a6accd">consul = "127.0.0.1:8500"</span></span>
<span class="line"><span style="color:#a6accd">// 这是用于连接Consul的ACL token. 如果你的集群未启用就不需要设置.</span></span>
<span class="line"><span style="color:#a6accd">//</span></span>
<span class="line"><span style="color:#a6accd">// 这个选项也可以通过环境变量 CONSUL_TOKEN 来进行设置</span></span>
<span class="line"><span style="color:#a6accd">token = "abcd1234"</span></span>
<span class="line"><span style="color:#a6accd">// 这是监听出发reload事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听reload事件</span></span>
<span class="line"><span style="color:#a6accd">reload_signal = "SIGHUP"</span></span>
<span class="line"><span style="color:#a6accd">// 这是监听出发core dump事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听core dump信号</span></span>
<span class="line"><span style="color:#a6accd">dump_signal = "SIGQUIT"</span></span>
<span class="line"><span style="color:#a6accd">// 这是监听出发graceful stop事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听graceful stop信号</span></span>
<span class="line"><span style="color:#a6accd">kill_signal = "SIGINT"</span></span>
<span class="line"><span style="color:#a6accd">// 这是连接Consul的重试时间.Consul Template是高容错的设计.这意味着,出现失败他不会退出.而按照</span></span>
<span class="line"><span style="color:#a6accd">// 分布式系统的惯例进行指数补偿和重试来等待集群恢复.</span></span>
<span class="line"><span style="color:#a6accd">retry = "10s"</span></span>
<span class="line"><span style="color:#a6accd">// This is the maximum interval to allow "stale" data. By default, only the</span></span>
<span class="line"><span style="color:#a6accd">// Consul leader will respond to queries; any requests to a follower will</span></span>
<span class="line"><span style="color:#a6accd">// forward to the leader. In large clusters with many requests, this is not as</span></span>
<span class="line"><span style="color:#a6accd">// scalable, so this option allows any follower to respond to a query, so long</span></span>
<span class="line"><span style="color:#a6accd">// as the last-replicated data is within these bounds. Higher values result in</span></span>
<span class="line"><span style="color:#a6accd">// less cluster load, but are more likely to have outdated data.</span></span>
<span class="line"><span style="color:#a6accd">// 这是允许陈旧数据的最大时间.Consul默认只有领袖对请求进行相应.所有对追随者的请求将被转发给领袖.</span></span>
<span class="line"><span style="color:#a6accd">// 在有大量请求的大型集群中,这显得不够有扩展性.所以这个选项允许任何追随者响应查询,只要最后复制的数据</span></span>
<span class="line"><span style="color:#a6accd">// 在这个范围内.数值越高,越减少集群负载,但是更容易接受到过期数据.</span></span>
<span class="line"><span style="color:#a6accd">max_stale = "10m"</span></span>
<span class="line"><span style="color:#a6accd">// 这是log的等级,如果你找到了bug,请打开debug 日志,这样我们可以更好的定位问题.这个选项也可用在命令行.</span></span>
<span class="line"><span style="color:#a6accd">log_level = "warn"</span></span>
<span class="line"><span style="color:#a6accd">// 这是存放Consul Template 进程的PID文件的路径,如果你计划发送定制的信号到这个进程这会比较有用.</span></span>
<span class="line"><span style="color:#a6accd">pid_file = "/path/to/pid"</span></span>
<span class="line"><span style="color:#a6accd">// 这是一个静止定时器,他定义了在模板渲染之前等待集群达到一致状态的最小和最大时间.</span></span>
<span class="line"><span style="color:#a6accd">// 这对于一些变化较大的系统中比较有用,可以减少模板渲染的次数</span></span>
<span class="line"><span style="color:#a6accd">wait = "5s:10s"</span></span>
<span class="line"><span style="color:#a6accd">// 这是 Vault配置的开始</span></span>
<span class="line"><span style="color:#a6accd">// Vault是HashiCorp的另外一个产品</span></span>
<span class="line"><span style="color:#a6accd">vault {</span></span>
<span class="line"><span style="color:#a6accd">  // This is the address of the Vault leader. The protocol (http(s)) portion</span></span>
<span class="line"><span style="color:#a6accd">  // of the address is required.</span></span>
<span class="line"><span style="color:#a6accd">  address = "https://vault.service.consul:8200"</span></span>
<span class="line"><span style="color:#a6accd">  // This is the token to use when communicating with the Vault server.</span></span>
<span class="line"><span style="color:#a6accd">  // Like other tools that integrate with Vault, Consul Template makes the</span></span>
<span class="line"><span style="color:#a6accd">  // assumption that you provide it with a Vault token; it does not have the</span></span>
<span class="line"><span style="color:#a6accd">  // incorporated logic to generate tokens via Vault's auth methods.</span></span>
<span class="line"><span style="color:#a6accd">  //</span></span>
<span class="line"><span style="color:#a6accd">  // This value can also be specified via the environment variable VAULT_TOKEN.</span></span>
<span class="line"><span style="color:#a6accd">  token = "abcd1234"</span></span>
<span class="line"><span style="color:#a6accd">  // This option tells Consul Template to automatically renew the Vault token</span></span>
<span class="line"><span style="color:#a6accd">  // given. If you are unfamiliar with Vault's architecture, Vault requires</span></span>
<span class="line"><span style="color:#a6accd">  // tokens be renewed at some regular interval or they will be revoked. Consul</span></span>
<span class="line"><span style="color:#a6accd">  // Template will automatically renew the token at half the lease duration of</span></span>
<span class="line"><span style="color:#a6accd">  // the token. The default value is true, but this option can be disabled if</span></span>
<span class="line"><span style="color:#a6accd">  // you want to renew the Vault token using an out-of-band process.</span></span>
<span class="line"><span style="color:#a6accd">  //</span></span>
<span class="line"><span style="color:#a6accd">  // Note that secrets specified in a template (using {{secret}} for example)</span></span>
<span class="line"><span style="color:#a6accd">  // are always renewed, even if this option is set to false. This option only</span></span>
<span class="line"><span style="color:#a6accd">  // applies to the top-level Vault token itself.</span></span>
<span class="line"><span style="color:#a6accd">  renew = true</span></span>
<span class="line"><span style="color:#a6accd">  // This section details the SSL options for connecting to the Vault server.</span></span>
<span class="line"><span style="color:#a6accd">  // Please see the SSL options below for more information (they are the same).</span></span>
<span class="line"><span style="color:#a6accd">  ssl {</span></span>
<span class="line"><span style="color:#a6accd">    // ...</span></span>
<span class="line"><span style="color:#a6accd">  }</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// 这部分配置请求的基本的权限验证信息</span></span>
<span class="line"><span style="color:#a6accd">auth {</span></span>
<span class="line"><span style="color:#a6accd">  enabled  = true</span></span>
<span class="line"><span style="color:#a6accd">  username = "test"</span></span>
<span class="line"><span style="color:#a6accd">  password = "test"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// 这部分配置连接到Consul服务器的SSL信息.</span></span>
<span class="line"><span style="color:#a6accd">ssl {</span></span>
<span class="line"><span style="color:#a6accd">  // 使用SSL需要先打开这个开关</span></span>
<span class="line"><span style="color:#a6accd">  enabled = true</span></span>
<span class="line"><span style="color:#a6accd">  // This enables SSL peer verification. The default value is "true", which</span></span>
<span class="line"><span style="color:#a6accd">  // will check the global CA chain to make sure the given certificates are</span></span>
<span class="line"><span style="color:#a6accd">  // valid. If you are using a self-signed certificate that you have not added</span></span>
<span class="line"><span style="color:#a6accd">  // to the CA chain, you may want to disable SSL verification. However, please</span></span>
<span class="line"><span style="color:#a6accd">  // understand this is a potential security vulnerability.</span></span>
<span class="line"><span style="color:#a6accd">  verify = false</span></span>
<span class="line"><span style="color:#a6accd">  // This is the path to the certificate to use to authenticate. If just a</span></span>
<span class="line"><span style="color:#a6accd">  // certificate is provided, it is assumed to contain both the certificate and</span></span>
<span class="line"><span style="color:#a6accd">  // the key to convert to an X509 certificate. If both the certificate and</span></span>
<span class="line"><span style="color:#a6accd">  // key are specified, Consul Template will automatically combine them into an</span></span>
<span class="line"><span style="color:#a6accd">  // X509 certificate for you.</span></span>
<span class="line"><span style="color:#a6accd">  cert = "/path/to/client/cert"</span></span>
<span class="line"><span style="color:#a6accd">  key = "/path/to/client/key"</span></span>
<span class="line"><span style="color:#a6accd">  // This is the path to the certificate authority to use as a CA. This is</span></span>
<span class="line"><span style="color:#a6accd">  // useful for self-signed certificates or for organizations using their own</span></span>
<span class="line"><span style="color:#a6accd">  // internal certificate authority.</span></span>
<span class="line"><span style="color:#a6accd">  ca_cert = "/path/to/ca"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// 设置连接到syslog服务器的配置</span></span>
<span class="line"><span style="color:#a6accd">// 用于进行日志记录syslog {</span></span>
<span class="line"><span style="color:#a6accd">  // 打开开关</span></span>
<span class="line"><span style="color:#a6accd">  enabled = true</span></span>
<span class="line"><span style="color:#a6accd">  // 设备名称</span></span>
<span class="line"><span style="color:#a6accd">  facility = "LOCAL5"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// This block defines the configuration for de-duplication mode. Please see the</span></span>
<span class="line"><span style="color:#a6accd">// de-duplication mode documentation later in the README for more information</span></span>
<span class="line"><span style="color:#a6accd">// on how de-duplication mode operates.</span></span>
<span class="line"><span style="color:#a6accd">deduplicate {</span></span>
<span class="line"><span style="color:#a6accd">  // This enables de-duplication mode. Specifying any other options also enables</span></span>
<span class="line"><span style="color:#a6accd">  // de-duplication mode.</span></span>
<span class="line"><span style="color:#a6accd">  enabled = true</span></span>
<span class="line"><span style="color:#a6accd">  // This is the prefix to the path in Consul's KV store where de-duplication</span></span>
<span class="line"><span style="color:#a6accd">  // templates will be pre-rendered and stored.</span></span>
<span class="line"><span style="color:#a6accd">  prefix = "consul-template/dedup/"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// This block defines the configuration for exec mode. Please see the exec mode</span></span>
<span class="line"><span style="color:#a6accd">// documentation at the bottom of this README for more information on how exec</span></span>
<span class="line"><span style="color:#a6accd">// mode operates and the caveats of this mode.</span></span>
<span class="line"><span style="color:#a6accd">exec {</span></span>
<span class="line"><span style="color:#a6accd">  // This is the command to exec as a child process. There can be only one</span></span>
<span class="line"><span style="color:#a6accd">  // command per Consul Template process.</span></span>
<span class="line"><span style="color:#a6accd">  command = "/usr/bin/app"</span></span>
<span class="line"><span style="color:#a6accd">  // This is a random splay to wait before killing the command. The default</span></span>
<span class="line"><span style="color:#a6accd">  // value is 0 (no wait), but large clusters should consider setting a splay</span></span>
<span class="line"><span style="color:#a6accd">  // value to prevent all child processes from reloading at the same time when</span></span>
<span class="line"><span style="color:#a6accd">  // data changes occur. When this value is set to non-zero, Consul Template</span></span>
<span class="line"><span style="color:#a6accd">  // will wait a random period of time up to the splay value before reloading</span></span>
<span class="line"><span style="color:#a6accd">  // or killing the child process. This can be used to prevent the thundering</span></span>
<span class="line"><span style="color:#a6accd">  // herd problem on applications that do not gracefully reload.</span></span>
<span class="line"><span style="color:#a6accd">  splay = "5s"</span></span>
<span class="line"><span style="color:#a6accd">  // This defines the signal that will be sent to the child process when a</span></span>
<span class="line"><span style="color:#a6accd">  // change occurs in a watched template. The signal will only be sent after</span></span>
<span class="line"><span style="color:#a6accd">  // the process is started, and the process will only be started after all</span></span>
<span class="line"><span style="color:#a6accd">  // dependent templates have been rendered at least once. The default value</span></span>
<span class="line"><span style="color:#a6accd">  // is "" (empty or nil), which tells Consul Template to restart the child</span></span>
<span class="line"><span style="color:#a6accd">  // process instead of sending it a signal. This is useful for legacy</span></span>
<span class="line"><span style="color:#a6accd">  // applications or applications that cannot properly reload their</span></span>
<span class="line"><span style="color:#a6accd">  // configuration without a full reload.</span></span>
<span class="line"><span style="color:#a6accd">  reload_signal = "SIGUSR1"</span></span>
<span class="line"><span style="color:#a6accd">  // This defines the signal sent to the child process when Consul Template is</span></span>
<span class="line"><span style="color:#a6accd">  // gracefully shutting down. The application should begin a graceful cleanup.</span></span>
<span class="line"><span style="color:#a6accd">  // If the application does not terminate before the `kill_timeout`, it will</span></span>
<span class="line"><span style="color:#a6accd">  // be terminated (effectively "kill -9"). The default value is "SIGTERM".</span></span>
<span class="line"><span style="color:#a6accd">  kill_signal = "SIGINT"</span></span>
<span class="line"><span style="color:#a6accd">  // This defines the amount of time to wait for the child process to gracefully</span></span>
<span class="line"><span style="color:#a6accd">  // terminate when Consul Template exits. After this specified time, the child</span></span>
<span class="line"><span style="color:#a6accd">  // process will be force-killed (effectively "kill -9"). The default value is</span></span>
<span class="line"><span style="color:#a6accd">  // "30s".</span></span>
<span class="line"><span style="color:#a6accd">  kill_timeout = "2s"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd">// 这部分定义了对模板的配置,和其他配置块不同.这部分可以针对不同模板配置多次.也可以在CLI命令</span></span>
<span class="line"><span style="color:#a6accd">// 直接进行配置</span></span>
<span class="line"><span style="color:#a6accd">template {</span></span>
<span class="line"><span style="color:#a6accd">  // 这是输入模板的配置文件路径,必选项</span></span>
<span class="line"><span style="color:#a6accd">  source = "/path/on/disk/to/template.ctmpl"</span></span>
<span class="line"><span style="color:#a6accd">  // 这是源模板渲染之后存放的路径,如果父目录不存在Consul Template会尝试进行创建</span></span>
<span class="line"><span style="color:#a6accd">  destination = "/path/on/disk/where/template/will/render.txt"</span></span>
<span class="line"><span style="color:#a6accd">  // This is the optional command to run when the template is rendered. The</span></span>
<span class="line"><span style="color:#a6accd">  // command will only run if the resulting template changes. The command must</span></span>
<span class="line"><span style="color:#a6accd">  // return within 30s (configurable), and it must have a successful exit code.</span></span>
<span class="line"><span style="color:#a6accd">  // Consul Template is not a replacement for a process monitor or init system.</span></span>
<span class="line"><span style="color:#a6accd">  // 这是当模板渲染完成后可选的要执行的命令.这个命令只会在模板发生改变后才会运行.这个命令必须要在30秒</span></span>
<span class="line"><span style="color:#a6accd">  // 内进行返回(可配置),必须返回一个成功的退出码.Consul Template不能替代进程监视或者init 系统</span></span>
<span class="line"><span style="color:#a6accd">  // 的功能</span></span>
<span class="line"><span style="color:#a6accd">  command = "restart service foo"</span></span>
<span class="line"><span style="color:#a6accd">  // 这是最大的等待命令返回的时间,默认是30秒</span></span>
<span class="line"><span style="color:#a6accd">  command_timeout = "60s"</span></span>
<span class="line"><span style="color:#a6accd">  // 这是渲染后的文件的权限,如果不设置,Consul Template将去匹配之前已经存在的文件的权限.</span></span>
<span class="line"><span style="color:#a6accd">  // 如果文件不存在,权限会被设置为 0644</span></span>
<span class="line"><span style="color:#a6accd">  perms = 0600</span></span>
<span class="line"><span style="color:#a6accd">  // 这个选项对渲染之前的文件进行备份.他保持一个备份.</span></span>
<span class="line"><span style="color:#a6accd">  // 这个选项在发生意外更高时,有一个回滚策略.</span></span>
<span class="line"><span style="color:#a6accd">  backup = true</span></span>
<span class="line"><span style="color:#a6accd">  // 模板的分隔符,默认是 "{{"和"}}".但是对于一些模板用其他的分隔符可能更好</span></span>
<span class="line"><span style="color:#a6accd">  // 可以避免与本身的冲突</span></span>
<span class="line"><span style="color:#a6accd">  left_delimiter  = "{{"</span></span>
<span class="line"><span style="color:#a6accd">  right_delimiter = "}}"</span></span>
<span class="line"><span style="color:#a6accd">  // 这是最小和最大等待渲染一个新模板和执行命令的时间.使用 分号 个号.如果忽略最大值,最大</span></span>
<span class="line"><span style="color:#a6accd">  // 值会被设置为最小值的4倍.这个选项没有默认值.这个值相对全局所以的等待时间有最高优先级</span></span>
<span class="line"><span style="color:#a6accd">  wait = "2s:6s"</span></span>
<span class="line"><span style="color:#a6accd">}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>注意</strong>: 不是所有的选项都是必选的.例如: 如果你没有使用Vault你不用设置这一块. 类似的你没有使用syslog系统你也不需要指定syslog配置.</p><p>为了更加安全,<code>token</code>也可以从环境变量里读取,使用 <code>CONSUL_TOKEN</code> 和 <code>VAULT_TOKEN</code>.强烈建议你不要把token放到未加密的文本配置文件中.</p><h2 id="模版语法" tabindex="-1">模版语法 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#模版语法" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>Consul Template 使用了Go的模板语法.如果你对他的语法不熟悉建议你读下文档.他的语法看起来与 Mustache, Handlebars, 或者 Liquid 类似.</p><p>在Go 提供的模板函数之外,Consul Template暴露了以下的函数:</p><h2 id="api-函数" tabindex="-1">API 函数 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#api-函数" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p><strong>datacenters</strong> 查询目录中的所有数据中心.使用以下语法:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{datacenters}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>file</strong> 读取并输出磁盘上的本地文件,如果无法读取产生一个错误.使用如下语法</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{file "/path/to/local/file"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这个例子将输出 <code>/path/to/local/file</code> 文件内容到模板. 注意:这不会在嵌套模板中被处理</p><p><strong>key</strong> 查询Consul指定key的值,如果key的值不能转换为字符串,将产生错误.使用如下语法:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{key "service/redis/maxconns@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>上面的例子查询了在<code>east-aws</code>数据中心的 <code>service/redis/maxconns</code>的值.如果忽略数据中心参数,将会查询本地数据中心的值:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{key "service/redis/maxconns"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>Consul键值结构的美妙在于,这完全取决于你!</p><p><strong>key_or_default</strong> 查询Consul中指定的key的值,如果key不存在,则返回默认值.使用方式如下</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{key_or_default "service/redis/maxconns@east-aws" "5"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>注意Consul Template使用了多个阶段的运算.在第一阶段的运算如果Consul没有返回值,则会一直使用默认值.后续模板解析中如果值存在了则会读取真实的值.这很重要,运维Consul Templae不会因为<code>key_or_default</code>没找到key而阻塞模板的的渲染.即使key存在如果Consul没有按时返回这个数据,也会使用默认值来进行替代.</p><p><strong>ls</strong> 查看Consul的所有以指定前缀开头的key-value对.如果有值无法转换成字符串则会产生一个错误:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range ls "service/redis@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd">{{.Key}} {{.Value}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果Consul实例在<code>east-aws</code>数据中心存在这个结构<code>service/redis</code>,渲染后的模板应该类似这样:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">minconns 2</span></span>
<span class="line"><span style="color:#a6accd">maxconns 12</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果你忽略数据中心属性,则会返回本地数据中心的查询结果.</p><p><strong>node</strong> 查询目录中的一个节点信息</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{node "node1"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果未指定任何参数,则当前agent所在节点将会被返回:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{node}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>你可以指定一个可选的参数来指定数据中心:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{node "node1" "@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果指定的节点没有找到则会返回<code>nil</code>.如果节点存在就会列出节点的信息和节点提供的服务.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{with node}}{{.Node.Node}} ({{.Node.Address}}){{range .Services}}</span></span>
<span class="line"><span style="color:#a6accd">  {{.Service}} {{.Port}} ({{.Tags | join ","}}){{end}}</span></span>
<span class="line"><span style="color:#a6accd">{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>nodes</strong> 查询目录中的全部节点,使用如下语法</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{nodes}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这个例子会查询Consul的默认数据中心.你可以使用可选参数指定一个可选参数来指定数据中心:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{nodes "@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这个例子会查询east-aws数据中心的所有几点.</p><p><strong>secret</strong> 查询<code>Vault</code>中指定路径的密匙.如果指定的路径不存在或者<code>Vault</code>的<code>Token</code>没有足够权限去读取指定的路径,将会产生一个错误.如果路径存在但是key不存在则返回“.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{with secret "secret/passwords"}}{{.Data.password}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>可以使用如下字段:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">LeaseID - the unique lease identifier</span></span>
<span class="line"><span style="color:#a6accd">LeaseDuration - the number of seconds the lease is valid</span></span>
<span class="line"><span style="color:#a6accd">Renewable - if the secret is renewable</span></span>
<span class="line"><span style="color:#a6accd">Data - the raw data - this is a map[string]interface{}, so it can be queried using Go's templating "dot notation"</span></span>
<span class="line"><span style="color:#a6accd">If the map key has dots "." in it, you need to access the value using the index function:</span></span>
<span class="line"><span style="color:#a6accd">{{index .Data "my.key.with.dots"}}</span></span>
<span class="line"><span style="color:#a6accd">If additional arguments are passed to the function, then the operation is assumed to be a write operation instead of a read operation. The write operation must return data in order to be valid. This is especially useful for the PKI secret backend, for example.</span></span>
<span class="line"><span style="color:#a6accd">{{ with secret "pki/issue/my-domain-dot-com" "common_name=foo.example.com" }}</span></span>
<span class="line"><span style="color:#a6accd">{{ .Data.certificate }}</span></span>
<span class="line"><span style="color:#a6accd">{{ end }}</span></span>
<span class="line"><span style="color:#a6accd">The parameters must be key=value pairs, and each pair must be its own argument to the function:</span></span>
<span class="line"><span style="color:#a6accd">{{ secret "path/" "a=b" "c=d" "e=f" }}</span></span>
<span class="line"><span style="color:#a6accd">Please always consider the security implications of having the contents of a secret in plain-text on disk. If an attacker is able to get access to the file, they will have access to plain-text secrets.</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>Please note that Vault does not support blocking queries. As a result, Consul Template will not immediately reload in the event a secret is changed as it does with Consul’s key-value store. Consul Template will fetch a new secret at half the lease duration of the original secret. For example, most items in Vault’s generic secret backend have a default 30 day lease. This means Consul Template will renew the secret every 15 days. As such, it is recommended that a smaller lease duration be used when generating the initial secret to force Consul Template to renew more often.</p><p><strong>secrets</strong> Query Vault to list the secrets at the given path. Please note this requires Vault 0.5+ and the endpoint you want to list secrets must support listing. Not all endpoints support listing. The result is the list of secret names as strings.</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range secrets "secret/"}}{{.}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>The trailing slash is optional in the template, but the generated secret dependency will always have a trailing slash in log output.</p><p>To iterate and list over every secret in the generic secret backend in Vault, for example, you would need to do something like this:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range secrets "secret/"}}</span></span>
<span class="line"><span style="color:#a6accd">{{with secret (printf "secret/%s" .)}}</span></span>
<span class="line"><span style="color:#a6accd">{{range $k, $v := .Data}}</span></span>
<span class="line"><span style="color:#a6accd">{{$k}}: {{$v}}</span></span>
<span class="line"><span style="color:#a6accd">{{end}}</span></span>
<span class="line"><span style="color:#a6accd">{{end}}</span></span>
<span class="line"><span style="color:#a6accd">{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>You should probably never do this. Please also note that Vault does not support blocking queries. To understand the implications, please read the note at the end of the secret function.</p><p><strong>service</strong> 查询Consul中匹配表达式的服务.语法如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "release.web@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>上面的例子查询Consul中,在<code>east-aws</code>数据中心存在的健康的 <code>web</code>服务.tag和数据中心参数是可选的.从当前数据中心查询所有节点的<code>web</code>服务而不管tag,查询语法如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "web"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这个函数返回<code>[]*HealthService</code>结构.可按照如下方式应用到模板:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range service "web@data center"}}</span></span>
<span class="line"><span style="color:#a6accd">server {{.Name}} {{.Address}}:{{.Port}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>产生如下输出:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">server nyc_web_01 123.456.789.10:8080</span></span>
<span class="line"><span style="color:#a6accd">server nyc_web_02 456.789.101.213:8080</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>默认值会返回健康的服务,如果你想获取所有服务,可以增加<code>any</code>选项,如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "web" "any"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这样就会返回注册过的所有服务,而不论他的状态如何.</p><p>如果你想过滤指定的一个或者多个健康状态,你可以通过逗号隔开多个健康状态:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "web" "passing, warning"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这样将会返回被他们的节点和服务级别的检查定义标记为 “passing” 或者 “warning”的服务. 请注意逗号是 <code>OR</code>而不是<code>AND</code>的意思.</p><p>指定了超过一个状态过滤,并包含<code>any</code>将会返回一个错误.因为<code>any</code>是比所有状态更高级的过滤.</p><p>后面这2种方式有些架构上的不同:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "web"}}</span></span>
<span class="line"><span style="color:#a6accd">{{service "web" "passing"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>前者会返回Consul认为<code>healthy</code>和<code>passing</code>的所有服务.后者将返回所有已经在Consul注册的服务.然后会执行一个客户端的过滤.通常如果你想获取健康的服务,你应该不要使用<code>passing</code>参数,直接忽略第三个参数即可.然而第三个参数在你想查询 passing或者<code>warning</code>的服务会比较有用,如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{service "web" "passing, warning"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>服务的状态也是可见的,如果你想自己做一些额外的过滤,语法如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range service "web" "any"}}</span></span>
<span class="line"><span style="color:#a6accd">{{if eq .Status "critical"}}</span></span>
<span class="line"><span style="color:#a6accd">// Critical state!{{end}}</span></span>
<span class="line"><span style="color:#a6accd">{{if eq .Status "passing"}}</span></span>
<span class="line"><span style="color:#a6accd">// Ok{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>执行命令时,在Consul将服务设置为维护模式,只需要在你的命令上包上Consul的 <code>maint</code> 调用:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">#!/bin/sh</span></span>
<span class="line"><span style="color:#a6accd">set -e</span></span>
<span class="line"><span style="color:#a6accd">consul maint -enable -service web -reason "Consul Template updated"</span></span>
<span class="line"><span style="color:#a6accd">service nginx reload</span></span>
<span class="line"><span style="color:#a6accd">consul maint -disable -service web</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>另外如果你没有安装Consul agent,你可以直接调用API请求:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">#!/bin/sh</span></span>
<span class="line"><span style="color:#a6accd">set -e</span></span>
<span class="line"><span style="color:#a6accd">curl -X PUT "http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=true&amp;reason=Consul+Template+Updated"</span></span>
<span class="line"><span style="color:#a6accd">service nginx reload</span></span>
<span class="line"><span style="color:#a6accd">curl -X PUT "http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=false"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>services</strong> 查询Consul目录中的所有服务,使用如下语法:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{services}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>这个例子将查询Consul的默认数据中心,你可以指定一个可选参数来指定数据中心:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{services "@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>请注意: services函数与service是不同的,service接受更多参数并且查询监控的服务列表.这个查询Consul目录并返回一个服务的tag的Map,如下:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range services}}</span></span>
<span class="line"><span style="color:#a6accd">{{.Name}}</span></span>
<span class="line"><span style="color:#a6accd">{{range .Tags}}</span></span>
<span class="line"><span style="color:#a6accd">  {{.}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd">{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p><strong>tree</strong> 查询所有指定前缀的key-value值对,如果其中的值有无法转换为字符串的则引发错误:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">{{range tree "service/redis@east-aws"}}</span></span>
<span class="line"><span style="color:#a6accd">{{.Key}} {{.Value}}{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>如果Consul实例在<code>east-aws</code>数据中心有一个<code>service/redis</code>结构,模板的渲染结果类似下面:</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">minconns 2</span></span>
<span class="line"><span style="color:#a6accd">maxconns 12</span></span>
<span class="line"><span style="color:#a6accd">nested/config/value "value"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>和<code>ls</code>不同,<code>tree</code>返回前缀下的所有key.和Unix的tree命令比较像.如果忽略数据中心参数,则会使用本地数据中心</p><p><a target="_blank" rel="noreferrer" href="https://book-consul-guide.vnzmi.com/11_consul_template.html"><!--[-->查看更多<!--]--><!----></a></p><p><a target="_blank" rel="noreferrer" href="https://book-consul-guide.vnzmi.com/11_consul_template.html"><!--[-->项目Github地址<!--]--><!----></a></p><h2 id="haproxy-实例" tabindex="-1">Haproxy 实例 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#haproxy-实例" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h2><p>根据haproxy服务的配置文件创建一个consul-template模版渲染文件：<code>haproxy.ctmpl</code></p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd"># Consul Haproxy configured</span></span>
<span class="line"><span style="color:#a6accd">global</span></span>
<span class="line"><span style="color:#a6accd">        maxconn         20480</span></span>
<span class="line"><span style="color:#a6accd">        ulimit-n        65535</span></span>
<span class="line"><span style="color:#a6accd">        log             127.0.0.1 local5</span></span>
<span class="line"><span style="color:#a6accd">        uid             200</span></span>
<span class="line"><span style="color:#a6accd">        gid             200</span></span>
<span class="line"><span style="color:#a6accd">        chroot          /usr/local/haproxy</span></span>
<span class="line"><span style="color:#a6accd">        nbproc          1</span></span>
<span class="line"><span style="color:#a6accd">        daemon</span></span>
<span class="line"><span style="color:#a6accd">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span></span>
<span class="line"><span style="color:#a6accd">defaults</span></span>
<span class="line"><span style="color:#a6accd">        log             global</span></span>
<span class="line"><span style="color:#a6accd">        mode            http</span></span>
<span class="line"><span style="color:#a6accd">        option          httplog</span></span>
<span class="line"><span style="color:#a6accd">        option          dontlognull</span></span>
<span class="line"><span style="color:#a6accd">        option          forwardfor</span></span>
<span class="line"><span style="color:#a6accd">        option          abortonclose</span></span>
<span class="line"><span style="color:#a6accd">        retries         3</span></span>
<span class="line"><span style="color:#a6accd">        maxconn         3000</span></span>
<span class="line"><span style="color:#a6accd">        stats           enable</span></span>
<span class="line"><span style="color:#a6accd">        stats           hide-version</span></span>
<span class="line"><span style="color:#a6accd">        stats   uri     /admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   auth    admin:admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   refresh 10s</span></span>
<span class="line"><span style="color:#a6accd">        balance         roundrobin</span></span>
<span class="line"><span style="color:#a6accd">        timeout connect 5000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout client 50000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout server 50000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout check 2000ms</span></span>
<span class="line"><span style="color:#a6accd">listen web_haproxy</span></span>
<span class="line"><span style="color:#a6accd">        bind 0.0.0.0:8080</span></span>
<span class="line"><span style="color:#a6accd">        mode http</span></span>
<span class="line"><span style="color:#a6accd">        log     127.0.0.1 local5 err</span></span>
<span class="line"><span style="color:#a6accd">        stats   refresh 5s</span></span>
<span class="line"><span style="color:#a6accd">        stats   uri /admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   realm liang lian</span></span>
<span class="line"><span style="color:#a6accd">        stats   auth admin:admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   hide-version</span></span>
<span class="line"><span style="color:#a6accd">        stats   admin if TRUE</span></span>
<span class="line"><span style="color:#a6accd">frontend consul</span></span>
<span class="line"><span style="color:#a6accd">        bind    0.0.0.0:8500</span></span>
<span class="line"><span style="color:#a6accd">        mode    http</span></span>
<span class="line"><span style="color:#a6accd">        log     global</span></span>
<span class="line"><span style="color:#a6accd">        default_backend consul-cluster</span></span>
<span class="line"><span style="color:#a6accd">backend consul-cluster</span></span>
<span class="line"><span style="color:#a6accd">        mode http</span></span>
<span class="line"><span style="color:#a6accd">        {{range service "Faceid"}}</span></span>
<span class="line"><span style="color:#a6accd">        server {{.ID}} {{.Address}}:{{.Port}} check inter 5000 fall 1 rise 2 weight 2{{end}}</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>运行consul-template作为一个服务,通过上面的渲染模版渲染一个haproxy.cfg的配置文件，然后重启haproxy服务</p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd">consul-template -consul-addr=10.201.102.185:8500 -template "/root/haproxy.ctmpl:/etc/haproxy.cfg:service haproxy restart"</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>10.201.102.185 看我上篇文章<a target="_blank" rel="noreferrer" href="http://www.liangxiansen.cn/2017/03/06/haproxy/"><!--[-->Haproxy<!--]--><!----></a>，这是consul集群的VIP，为了避免单独调某一台服务器服务器出现故障后consul-template无法工作。</p><p>渲染后的<code>haproxy.cfg</code></p><div class="language-"><span class="copy"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#a6accd"># Consul Haproxy configured</span></span>
<span class="line"><span style="color:#a6accd">global</span></span>
<span class="line"><span style="color:#a6accd">        maxconn         20480</span></span>
<span class="line"><span style="color:#a6accd">        ulimit-n        65535</span></span>
<span class="line"><span style="color:#a6accd">        log             127.0.0.1 local5</span></span>
<span class="line"><span style="color:#a6accd">        uid             200</span></span>
<span class="line"><span style="color:#a6accd">        gid             200</span></span>
<span class="line"><span style="color:#a6accd">        chroot          /usr/local/haproxy</span></span>
<span class="line"><span style="color:#a6accd">        nbproc          1</span></span>
<span class="line"><span style="color:#a6accd">        daemon</span></span>
<span class="line"><span style="color:#a6accd">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span></span>
<span class="line"><span style="color:#a6accd">defaults</span></span>
<span class="line"><span style="color:#a6accd">        log             global</span></span>
<span class="line"><span style="color:#a6accd">        mode            http</span></span>
<span class="line"><span style="color:#a6accd">        option          httplog</span></span>
<span class="line"><span style="color:#a6accd">        option          dontlognull</span></span>
<span class="line"><span style="color:#a6accd">        option          forwardfor</span></span>
<span class="line"><span style="color:#a6accd">        option          abortonclose</span></span>
<span class="line"><span style="color:#a6accd">        retries         3</span></span>
<span class="line"><span style="color:#a6accd">        maxconn         3000</span></span>
<span class="line"><span style="color:#a6accd">        stats           enable</span></span>
<span class="line"><span style="color:#a6accd">        stats           hide-version</span></span>
<span class="line"><span style="color:#a6accd">        stats   uri     /admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   auth    admin:admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   refresh 10s</span></span>
<span class="line"><span style="color:#a6accd">        balance         roundrobin</span></span>
<span class="line"><span style="color:#a6accd">        timeout connect 5000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout client 50000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout server 50000ms</span></span>
<span class="line"><span style="color:#a6accd">        timeout check 2000ms</span></span>
<span class="line"><span style="color:#a6accd">listen web_haproxy</span></span>
<span class="line"><span style="color:#a6accd">        bind 0.0.0.0:8080</span></span>
<span class="line"><span style="color:#a6accd">        mode http</span></span>
<span class="line"><span style="color:#a6accd">        log     127.0.0.1 local5 err</span></span>
<span class="line"><span style="color:#a6accd">        stats   refresh 5s</span></span>
<span class="line"><span style="color:#a6accd">        stats   uri /admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   realm liang lian</span></span>
<span class="line"><span style="color:#a6accd">        stats   auth admin:admin</span></span>
<span class="line"><span style="color:#a6accd">        stats   hide-version</span></span>
<span class="line"><span style="color:#a6accd">        stats   admin if TRUE</span></span>
<span class="line"><span style="color:#a6accd">frontend consul</span></span>
<span class="line"><span style="color:#a6accd">        bind    0.0.0.0:8500</span></span>
<span class="line"><span style="color:#a6accd">        mode    http</span></span>
<span class="line"><span style="color:#a6accd">        log     global</span></span>
<span class="line"><span style="color:#a6accd">        default_backend consul-cluster</span></span>
<span class="line"><span style="color:#a6accd">backend consul-cluster</span></span>
<span class="line"><span style="color:#a6accd">        mode http</span></span>
<span class="line"><span style="color:#a6accd">        server Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd">        server Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd">        server Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 2</span></span>
<span class="line"><span style="color:#a6accd"></span></span></code></pre></div><p>整个就是搭建consul集群，平台中的服务会注册到consul集群中，haproxy避免consul-template调consul时出现单点故障consul-template无法工作做的高可用，Consul-template就是能在整个平台的各个系统和应用中使用，查询consul集群来获取平台上各个应用的存活状态和IP。</p><p>整套下来实现了两个重点：</p><p>实现了中心服务注册查询 平台中其他节点的查询服务和配置文件自动更新</p><h1 id="参考资料" tabindex="-1">参考资料 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#参考资料" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p><a target="_blank" rel="noreferrer" href="https://my.oschina.net/guol/blog/675281"><!--[-->https://my.oschina.net/guol/blog/675281<!--]--><!----></a><a target="_blank" rel="noreferrer" href="https://www.consul.io/docs/guides/index.html"><!--[-->https://www.consul.io/docs/guides/index.html<!--]--><!----></a><a target="_blank" rel="noreferrer" href="https://www.gitbook.com/book/vincentmi/consul-guide/details"><!--[-->https://www.gitbook.com/book/vincentmi/consul-guide/details<!--]--><!----></a></p><p><a target="_blank" rel="noreferrer" href="https://my.oschina.net/abcfy2/blog/675665"><!--[-->https://my.oschina.net/abcfy2/blog/675665<!--]--><!----></a></p><h1 id="下载" tabindex="-1">下载 <a aria-current="page" href="/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#下载" class="router-link-active router-link-exact-active header-anchor" aria-hidden="true"><!--[-->#<!--]--></a></h1><p><a target="_blank" rel="noreferrer" href="http://www.liangxiansen.cn/files/consul.pdf"><!--[-->点击下载PDF文件<!--]--><!----></a></p><p>原:<a target="_blank" rel="noreferrer" href="http://www.liangxiansen.cn/2017/04/06/consul/"><!--[-->http://www.liangxiansen.cn/2017/04/06/consul/<!--]--><!----></a></p><!--]--><!--[--><!--]--><!--]--><div text="center"><!----></div><!----></article><!--]--><!--[--><!--[--><!--[--><div class="yun-sponsor-container flex-center flex-col" m="t-6"><button class="sponsor-button yun-icon-btn shadow hover:shadow-md" title="我很可爱，请给我钱！" text="red-400"><div i-ri-heart-line=""></div></button><div m="y-4" class="qrcode-container qrcode flex-center flex-col"><div class="sponsor-description" mb="4" text="sm">这是关于赞助的一些描述</div><div class="flex justify-around"><!--[--><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG203.jpeg" target="_blank" style="color:#00a3ee"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG203.jpeg" title="支付宝"><div text="xl" m="2" class="i-ri-alipay-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG205.jpeg" target="_blank" style="color:#12b7f5"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG205.jpeg" title="QQ 支付"><div text="xl" m="2" class="i-ri-qq-line"></div></a><a class="flex-center flex-col animate-iteration-1 animate-fade-in" href="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG204.jpeg" target="_blank" style="color:#2dc100"><img class="sponsor-method-img" border="~ rounded" p="1" loading="lazy" src="https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG204.jpeg" title="微信支付"><div text="xl" m="2" class="i-ri-wechat-pay-line"></div></a><!--]--></div></div></div><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>卷饼</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C">https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/posts/k8s%E5%88%A0%E9%99%A4pv%E4%B8%80%E7%9B%B4%E5%A4%84%E4%BA%8Eterminating" class="post-nav-prev" title="k8s删除pv一直处于terminating"><div class="icon" i-ri-arrow-left-s-line=""></div><span class="title truncate" text="sm">k8s删除pv一直处于terminating</span></a></div><div class="post-nav-item"><a href="/posts/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8coscmd%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3" class="post-nav-next" title="腾讯云对象存储COSCMD工具安装配置与使用命令详解"><span class="title truncate" text="sm">腾讯云对象存储COSCMD工具安装配置与使用命令详解</span><div class="icon" i-ri-arrow-right-s-line=""></div></a></div></div><!--]--><!--[--><!--]--><!--[--><div class="yun-card comment sm:p-6 lg:px-12 xl:px-16" w="full" p="4"><!----><!----><!--[--><!----><!--]--><!----></div><!--]--><!--[--><!--]--><footer class="va-footer p-4 text-$va-c-text-light" text="center sm"><div class="beian" m="y-2"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">豫ICP备20001100号-3</a></div><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!--[--> 2016 -<!--]--> 2025</span><a class="animate-pulse inline-flex" href="https://sponsors.yunyoujun.cn" target="_blank" title="Sponsor YunYouJun"><div class="i-ri-cloud-line"></div></a><span>卷饼</span></div><div class="powered" m="2"><span>由 <a href="https://github.com/YunYouJun/valaxy" target="_blank" rel="noopener">Valaxy</a> v0.14.28 驱动</span> | <span>主题 - <a href="https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun" title="valaxy-theme-yun" target="_blank">Yun</a> v0.14.28</span></div><!--[--> 由 <a href="https://www.netdun.net" target="_blank" title="网盾星球">网盾星球</a> 提供 CDN 支持<!--]--></footer><!--[--><!--]--></div><!--]--><!--[--><!--[--><button class="xl:hidden toc-btn shadow fixed yun-icon-btn z-350" opacity="75" right="2" bottom="19"><div i-ri-file-list-line=""></div></button><!----><!--  --><aside class="va-card yun-aside" m="l-4" text="center"><div class="aside-container" flex="~ col" overflow="auto"><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-e1350763=""><div class="content" data-v-e1350763=""><div class="outline-title" data-v-e1350763="">On this page</div><div class="outline-marker" data-v-e1350763=""></div><nav aria-labelledby="doc-outline-aria-label" data-v-e1350763=""><span id="doc-outline-aria-label" class="visually-hidden" data-v-e1350763="">Table of Contents for current page</span><ul class="root va-toc relative z-1" data-v-e1350763="" data-v-e736e6e6=""><!--[--><!--]--></ul></nav></div></div><div class="flex-grow"></div><div class="custom-container"><!--[--><!--]--></div></div></aside><!--]--><!--]--></div></main><a href="#" class="back-to-top yun-icon-btn"><div w="8" h="8" i-ri-arrow-up-s-line=""></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" class="progress-circle" cx="50" cy="50" r="48" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></circle></svg></a><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"app":{"isSidebarOpen":false,"isRightSidebarOpen":false},"site":{}}}'</script><script type="application/ld+json" id="schema-org-graph" data-h-3437552="">{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@id": "https://www.vlinux.cn/#identity",
      "@type": "Person",
      "name": "卷饼",
      "url": "https://www.vlinux.cn/",
      "image": {
        "@id": "https://www.vlinux.cn/#/schema/image/b8ad69b"
      },
      "sameAs": [
        "https://wpa.qq.com/msgrd?v=3&uin=38867033&site=qq&menu=yes&jumpflag=1",
        "https://github.com/vlinux",
        "https://repo.vlinux.cn/",
        "https://cos.vlinux.cn/www-vlinux-cn-blog-img/WechatIMG18.jpeg",
        "https://www.vlinux.cn/music/",
        "mailto:ilinux@88.com",
        "https://www.vlinux.cn/play"
      ]
    },
    {
      "@id": "https://www.vlinux.cn/#website",
      "@type": "WebSite",
      "dateModified": "2023-02-08T13:09:47+08:00",
      "datePublished": "2021-01-28T22:49:00+08:00",
      "inLanguage": "zh-CN",
      "name": "Consul使用中文手册",
      "url": "https://www.vlinux.cn/",
      "publisher": {
        "@id": "https://www.vlinux.cn/#identity"
      }
    },
    {
      "@id": "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C/#webpage",
      "@type": "WebPage",
      "description": "那你终将成为别人的一条裤衩",
      "name": "Consul使用中文手册",
      "url": "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C",
      "about": {
        "@id": "https://www.vlinux.cn/#identity"
      },
      "isPartOf": {
        "@id": "https://www.vlinux.cn/#website"
      },
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C"
          ]
        }
      ]
    },
    {
      "@id": "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C/#article",
      "description": "那你终将成为别人的一条裤衩",
      "headline": "Consul使用中文手册",
      "inLanguage": "zh-CN",
      "thumbnailUrl": "https://www.vlinux.cn/favicon.svg",
      "@type": [
        "Article",
        "BlogPosting"
      ],
      "author": {
        "@id": "https://www.vlinux.cn/#/schema/person/e914eae"
      },
      "image": {
        "@id": "https://www.vlinux.cn/#/schema/image/a0d155d"
      },
      "isPartOf": {
        "@id": "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.vlinux.cn/posts/consul%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C/#webpage"
      },
      "publisher": {
        "@id": "https://www.vlinux.cn/#identity"
      }
    },
    {
      "@id": "https://www.vlinux.cn/#/schema/person/e914eae",
      "@type": "Person",
      "name": "卷饼",
      "url": "https://valaxy.site"
    },
    {
      "@id": "https://www.vlinux.cn/#/schema/image/b8ad69b",
      "@type": "ImageObject",
      "contentUrl": "https://cos.vlinux.cn/vlinux-logo/user.jpg",
      "inLanguage": "zh-CN",
      "url": "https://cos.vlinux.cn/vlinux-logo/user.jpg"
    },
    {
      "@id": "https://www.vlinux.cn/#/schema/image/a0d155d",
      "@type": "ImageObject",
      "contentUrl": "https://www.vlinux.cn/favicon.svg",
      "inLanguage": "zh-CN",
      "url": "https://www.vlinux.cn/favicon.svg"
    }
  ]
}</script><link rel="stylesheet" href="/assets/ValaxyMain-3beb7542.css"><link rel="stylesheet" href="/assets/post-b195884f.css"><link rel="stylesheet" href="/assets/index-d62c0a7e.css"></body></html>