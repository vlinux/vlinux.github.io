import{_ as C}from"./ValaxyMain.vue_vue_type_style_index_0_lang-ad5e9c82.js";import{_ as y,c as D,w as o,o as A,b as s,d as l,e as t,r as a,f as i,p as F}from"./app-8df0fa73.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-204785b8.js";import"./YunCard.vue_vue_type_style_index_0_lang-a0362047.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-87671209.js";const vs=JSON.parse('{"title":"Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件","description":"","frontmatter":{"title":"Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件","categories":"自动注册","tags":["Registrator+Consul+Consul-template+HaProxy"],"date":"2020-09-16T16:26:00.000Z"},"headers":[],"relativePath":"pages/posts/Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件.md","lastUpdated":1671090556000}'),r=JSON.parse('{"title":"Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件","description":"","frontmatter":{"title":"Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件","categories":"自动注册","tags":["Registrator+Consul+Consul-template+HaProxy"],"date":"2020-09-16T16:26:00.000Z"},"headers":[],"relativePath":"pages/posts/Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件.md","lastUpdated":1671090556000}'),u={name:"pages/posts/Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件.md",data(){return{data:r,frontmatter:r.frontmatter}},setup(){F("pageData",r)}},d={id:"registrator-consul-consul-template-haproxy实现动态修改haproty配置文件",tabindex:"-1"},h=s("p",null,[s("strong",null,"实现需求：")],-1),_=s("p",null,"用Haproxy做负载均衡，手动方式在配置文件中添加或删除节点服务器信息，比较麻烦。",-1),m=s("p",null,"通过Registrator收集需要注册到Consul作为Haproxy节点服务器的信息，然后注册到Consul key/value。",-1),g=s("p",null,"Consul-template去Consul key/value中读取信息,然后自动修改Haproxy配置文件，并重载Haproxy。不需要修改haproxy.cfg。",-1),B=s("p",null,[s("strong",null,"集群环境：")],-1),E=s("p",null,[s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKioL1ePH8TyP4vwAAA_diaQRtU606.png",alt:"wKioL1ePH8TyP4vwAAA_diaQRtU606"})],-1),v=s("p",null,"Postil：Mesos集群搭建过程此处省略",-1),f=s("p",null,"关闭selinux和防火墙",-1),k=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"setenforce"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"0")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"sed"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"-i"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"'"),s("span",{style:{color:"#C3E88D"}},"s/SELINUX=enforcing/SELINUX=disabled/"),s("span",{style:{color:"#89DDFF"}},"'"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/etc/selinux/config")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"systemctl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"stop"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"firewalld"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"&&"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"systemctl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"disable"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"firewalld")]),l(`
`),s("span",{class:"line"})])])],-1),x=s("p",null,"ZK-server",-1),b=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"容器来做consul：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"获取Consul-server镜像")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# docker pull docker.io/gliderlabs/consul-server")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"启动Consul-server")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# docker run -d --name"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"consul"),s("span",{style:{color:"#A6ACCD"}}," --net"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"host"),s("span",{style:{color:"#A6ACCD"}}," docker.io/gliderlabs/consul-server -bootstrap -bind"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"192.168.200.8")]),l(`
`),s("span",{class:"line"})])])],-1),H=s("p",null,"宿主机来做consul",-1),w=s("p",null,"下载consul包，并解压",-1),P=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# wget https://releases.hashicorp.com/consul/0.6.4/consul_0.6.4_linux_386.zip")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# unzip consul_0.6.4_linux_386.zip")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# mv consul /usr/bin/")]),l(`
`),s("span",{class:"line"})])])],-1),z=s("p",null,"下载consul-template包，并解压",-1),K=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# wget https://releases.hashicorp.com/consul-template/0.15.0/consul-template_0.15.0_linux_386.zip")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# unzip consul-template_0.15.0_linux_386.zip")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# mv consul-template /usr/bin/")]),l(`
`),s("span",{class:"line"})])])],-1),N=s("p",null,"安装HaProxy并启动",-1),$=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# yum -y install haproxy")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# systemctl start haproxy")]),l(`
`),s("span",{class:"line"})])])],-1),R=s("p",null,"创建consul服务器配置目录",-1),M=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# mkdir /config")]),l(`
`),s("span",{class:"line"})])])],-1),j=s("p",null,"编写agent和server的json文件",-1),I=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# vi /config/agent.json ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"添加内容如下：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"client_addr"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},":"),s("span",{style:{color:"#89DDFF"}},' "'),s("span",{style:{color:"#C3E88D"}},"0.0.0.0"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"data_dir"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},":"),s("span",{style:{color:"#89DDFF"}},' "'),s("span",{style:{color:"#C3E88D"}},"/data"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"leave_on_terminate"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"true"),s("span",{style:{color:"#A6ACCD"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"dns_config"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'                "'),s("span",{style:{color:"#C3E88D"}},"allow_stale"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"true"),s("span",{style:{color:"#A6ACCD"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'                "'),s("span",{style:{color:"#C3E88D"}},"max_stale"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},":"),s("span",{style:{color:"#89DDFF"}},' "'),s("span",{style:{color:"#C3E88D"}},"1s"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# vi /config/server.json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"添加内容如下：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"ui"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"true"),s("span",{style:{color:"#A6ACCD"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'        "'),s("span",{style:{color:"#C3E88D"}},"dns_config"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'                "'),s("span",{style:{color:"#C3E88D"}},"allow_stale"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},": "),s("span",{style:{color:"#89DDFF"}},"false")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),S=s("p",null,"启动consul单节点服务器，当然，你consul服务器节点多的话也可以做consul集群。",-1),L=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# consul agent -server -config-dir"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"/config"),s("span",{style:{color:"#A6ACCD"}}," -bootstrap -bind"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"192.168.200.8"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"&")]),l(`
`),s("span",{class:"line"})])])],-1),Z=s("p",null,"Postil：可用consul members 查看consul集群节点",-1),T=s("p",null,"Slave1-server",-1),U=s("p",null,"获取Registrator镜像",-1),q=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@slave1 "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# docker pull gliderlabs/registrator:latest")]),l(`
`),s("span",{class:"line"})])])],-1),O=s("p",null,"启动Registrator",-1),G=s("p",null,"Postil：这种启动方式是注册到Consul的key/value",-1),Y=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@slave1 "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# docker run -d --restart"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"always"),s("span",{style:{color:"#A6ACCD"}}," --name"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"registrator"),s("span",{style:{color:"#A6ACCD"}}," --net"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"host"),s("span",{style:{color:"#A6ACCD"}}," --volume"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"/var/run/docker.sock:/tmp/docker.sock"),s("span",{style:{color:"#A6ACCD"}}," docker.io/gliderlabs/registrator -ip 192.168.200.10 consulkv://192.168.200.8:"),s("span",{style:{color:"#F78C6C"}},"8500"),s("span",{style:{color:"#A6ACCD"}},"/hello")]),l(`
`),s("span",{class:"line"})])])],-1),V=s("p",null,"Postil：-ip后面跟registration 所属的主机 IP, 一定要设置此属性, 否则服务IP会显示为127.0.0.1",-1),J=s("p",null,"测试Registrator是否把本机容器注册到Consul key/value",-1),Q=s("p",null,"启动个容器",-1),X=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@slave1 "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# docker run -d -P --name"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"test"),s("span",{style:{color:"#A6ACCD"}}," --net"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#C3E88D"}},"bridge"),s("span",{style:{color:"#A6ACCD"}}," p_w_picpath/nginx")]),l(`
`),s("span",{class:"line"})])])],-1),W=s("p",null,"进入Consul UI界面查看",-1),ss=s("p",null,[s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKioL1eN2n-BKahmAAAlbgipA10864.png",alt:"wKioL1eN2n-BKahmAAAlbgipA10864"})],-1),ls=s("p",null,"ZK-server",-1),os=s("p",null,"创建consul配置目录",-1),ns=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# mkdir -p /data/cfg/consul")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# vi /data/cfg/consul/tmpl.json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"添加内容如下：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"consul"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"127.0.0.1:8500"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"template"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#82AAFF"}},"source"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/etc/haproxy/haproxy.ctmpl"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"destination"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/etc/haproxy/haproxy.cfg"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#82AAFF"}},"command"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"systemctl reload haproxy"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),as=s("p",null,"编写haproxy模版",-1),es=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"# vi /etc/haproxy/haproxy.ctmpl")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"添加内容如下：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"global")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"log"),s("span",{style:{color:"#A6ACCD"}},"         "),s("span",{style:{color:"#C3E88D"}},"127.0.0.1"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"local2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"chroot"),s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#C3E88D"}},"/var/lib/haproxy")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"pidfile"),s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#C3E88D"}},"/var/run/haproxy.pid")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"maxconn"),s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#F78C6C"}},"4000")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"user"),s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C3E88D"}},"haproxy")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"group"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"haproxy")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"daemon")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"# turn on stats unix socket")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"stats"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"socket"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/var/lib/haproxy/stats")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"defaults")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"mode"),s("span",{style:{color:"#A6ACCD"}},"                    "),s("span",{style:{color:"#C3E88D"}},"http")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"log"),s("span",{style:{color:"#A6ACCD"}},"                     "),s("span",{style:{color:"#C3E88D"}},"global")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"option"),s("span",{style:{color:"#A6ACCD"}},"                  "),s("span",{style:{color:"#C3E88D"}},"httplog")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"option"),s("span",{style:{color:"#A6ACCD"}},"                  "),s("span",{style:{color:"#C3E88D"}},"dontlognull")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"option"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"http-server-close")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"option"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"forwardfor"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"except"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"127.0.0.0/"),s("span",{style:{color:"#F78C6C"}},"8")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"option"),s("span",{style:{color:"#A6ACCD"}},"                  "),s("span",{style:{color:"#C3E88D"}},"redispatch")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"retries"),s("span",{style:{color:"#A6ACCD"}},"                 "),s("span",{style:{color:"#F78C6C"}},"3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"http-request"),s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C3E88D"}},"10s")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"queue"),s("span",{style:{color:"#A6ACCD"}},"           "),s("span",{style:{color:"#C3E88D"}},"1m")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"connect"),s("span",{style:{color:"#A6ACCD"}},"         "),s("span",{style:{color:"#C3E88D"}},"10s")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"client"),s("span",{style:{color:"#A6ACCD"}},"          "),s("span",{style:{color:"#C3E88D"}},"1m")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"server"),s("span",{style:{color:"#A6ACCD"}},"          "),s("span",{style:{color:"#C3E88D"}},"1m")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"http-keep-alive"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"10s")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"timeout"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"check"),s("span",{style:{color:"#A6ACCD"}},"           "),s("span",{style:{color:"#C3E88D"}},"10s")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"maxconn"),s("span",{style:{color:"#A6ACCD"}},"                 "),s("span",{style:{color:"#F78C6C"}},"3000")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"frontend"),s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C3E88D"}},"main"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD"}},"*"),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#F78C6C"}},"80")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"acl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"url_static"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"path_beg"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"-i"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/p_w_picpaths"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/javascript"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/stylesheets")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"acl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"url_static"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"path_end"),s("span",{style:{color:"#A6ACCD"}},"       "),s("span",{style:{color:"#C3E88D"}},"-i"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},".jpg"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},".gif"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},".png"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},".css"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},".js")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"use_backend"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"static"),s("span",{style:{color:"#A6ACCD"}},"          "),s("span",{style:{color:"#C3E88D"}},"if"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"url_static")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"default_backend"),s("span",{style:{color:"#A6ACCD"}},"             "),s("span",{style:{color:"#C3E88D"}},"app")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"backend"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"static")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"balance"),s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#C3E88D"}},"roundrobin")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"server"),s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#C3E88D"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"127.0.0.1:"),s("span",{style:{color:"#F78C6C"}},"4331"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"check")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"backend"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"app")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"balance"),s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#C3E88D"}},"roundrobin")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#89DDFF"}},"{{"),s("span",{style:{color:"#FFCB6B"}},"range"),s("span",{style:{color:"#A6ACCD"}}," $key"),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}}," $pairs "),s("span",{style:{color:"#C3E88D"}},":="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"tree"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hello/"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"|"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"byKey"),s("span",{style:{color:"#89DDFF"}},"}}{{"),s("span",{style:{color:"#FFCB6B"}},"range"),s("span",{style:{color:"#A6ACCD"}}," $serverid"),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}}," $pair "),s("span",{style:{color:"#C3E88D"}},":="),s("span",{style:{color:"#A6ACCD"}}," $pairs"),s("span",{style:{color:"#C3E88D"}},"}}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#FFCB6B"}},"server"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"app"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"``"),s("span",{style:{color:"#82AAFF"}},"."),s("span",{style:{color:"#89DDFF"}},"`"),s("span",{style:{color:"#FFCB6B"}},"Value"),s("span",{style:{color:"#89DDFF"}},"`"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"check"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"inter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"2000"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"fall"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"3"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"weight"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"`"),s("span",{style:{color:"#C3E88D"}},"end"),s("span",{style:{color:"#89DDFF"}},"``"),s("span",{style:{color:"#C3E88D"}},"end"),s("span",{style:{color:"#89DDFF"}},"`")]),l(`
`),s("span",{class:"line"})])])],-1),ts=s("p",null,"启动consul-template",-1),rs=s("div",{class:"language-bash"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#A6ACCD"}},"root@zk-server "),s("span",{style:{color:"#89DDFF"}},"~]"),s("span",{style:{color:"#A6ACCD"}},"#consul-template -config /data/cfg/consul/tmpl.json "),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," consul-template.out "),s("span",{style:{color:"#F78C6C"}},"2"),s("span",{style:{color:"#89DDFF"}},">&1"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"&")]),l(`
`),s("span",{class:"line"})])])],-1),cs=s("p",null,"用marathon启动一个nginx容器，看registrator是否注册到consul,然后看consul-template是否自动添加了这个后端服务器到/etc/haproxy/haproxy.cfg",-1),ps=s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKiom1eN29Ch92f1AAAn-FZu8sk782.png",alt:"wKiom1eN29Ch92f1AAAn-FZu8sk782.png"},null,-1),Cs=s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKioL1eN29DSwwZMAABEjcHBKnE132.png",alt:"wKioL1eN29DSwwZMAABEjcHBKnE132.png"},null,-1),ys=s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKiom1eN29HBhfyIAAFS6Sq96qE500.png",alt:"wKiom1eN29HBhfyIAAFS6Sq96qE500.png"},null,-1),Ds=s("p",null,"访问HaProxy_IP",-1),As=s("img",{src:"https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/wKioL1eN2_DwH-usAABMZxBsa6s864.png",alt:"wKioL1eN2_DwH-usAABMZxBsa6s864.png"},null,-1);function is(n,Fs,us,ds,c,hs){const e=i,p=C;return A(),D(p,{frontmatter:c.frontmatter,data:c.data},{"main-content-md":o(()=>[s("h1",d,[l("Registrator+Consul+Consul-template+HaProxy实现动态修改Haproty配置文件 "),t(e,{class:"header-anchor",href:"#registrator-consul-consul-template-haproxy实现动态修改haproty配置文件","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),h,_,m,g,B,E,v,f,k,x,b,H,w,P,z,K,N,$,R,M,j,I,S,L,Z,T,U,q,O,G,Y,V,J,Q,X,W,s("p",null,[t(e,{href:"http://192.168.200.8:8500/ui/#/dc1/kv/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://192.168.200.8:8500/ui/#/dc1/kv/")]),_:1})]),ss,ls,os,ns,as,es,ts,rs,cs,s("p",null,[t(e,{href:"https://s5.51cto.com/wyfs02/M01/84/5A/wKiom1eN29Ch92f1AAAn-FZu8sk782.png",target:"_blank",rel:"noreferrer"},{default:o(()=>[ps]),_:1})]),s("p",null,[t(e,{href:"https://s5.51cto.com/wyfs02/M01/84/59/wKioL1eN29DSwwZMAABEjcHBKnE132.png",target:"_blank",rel:"noreferrer"},{default:o(()=>[Cs]),_:1})]),s("p",null,[t(e,{href:"https://s2.51cto.com/wyfs02/M01/84/5A/wKiom1eN29HBhfyIAAFS6Sq96qE500.png",target:"_blank",rel:"noreferrer"},{default:o(()=>[ys]),_:1})]),Ds,s("p",null,[t(e,{href:"https://s4.51cto.com/wyfs02/M02/84/59/wKioL1eN2_DwH-usAABMZxBsa6s864.png",target:"_blank",rel:"noreferrer"},{default:o(()=>[As]),_:1})])]),"main-header":o(()=>[a(n.$slots,"main-header")]),"main-header-after":o(()=>[a(n.$slots,"main-header-after")]),"main-nav":o(()=>[a(n.$slots,"main-nav")]),"main-content":o(()=>[a(n.$slots,"main-content")]),"main-content-after":o(()=>[a(n.$slots,"main-content-after")]),"main-nav-before":o(()=>[a(n.$slots,"main-nav-before")]),"main-nav-after":o(()=>[a(n.$slots,"main-nav-after")]),comment:o(()=>[a(n.$slots,"comment")]),footer:o(()=>[a(n.$slots,"footer")]),aside:o(()=>[a(n.$slots,"aside")]),"aside-custom":o(()=>[a(n.$slots,"aside-custom")]),default:o(()=>[a(n.$slots,"default")]),_:3},8,["frontmatter","data"])}const fs=y(u,[["render",is]]);export{vs as __pageData,fs as default};
