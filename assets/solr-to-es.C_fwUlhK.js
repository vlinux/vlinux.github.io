import{_ as u}from"./ValaxyMain.vue_vue_type_style_index_0_lang.sBTlPyls.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as E,u as m,a as g}from"./chunks/vue-router.BVXKJEUo.js";import{aa as y,ap as a,ag as n,ae as F,af as s,ai as l,P as C,ab as b,a1 as f}from"./framework.GHZxz7jq.js";import"./index.CViAj0zv.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.C1Su68f4.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.BR8m14Zu.js";const B=E("/posts/solr-to-es",async e=>JSON.parse('{"title":"Solr到Elasticsearch的踩坑与优化","description":"","frontmatter":{"title":"Solr到Elasticsearch的踩坑与优化","date":"2025-07-09 09:12:31","updated":"2025-07-09 09:12:31","tags":null,"categories":"ES","end":false},"headers":[],"relativePath":"pages/posts/solr-to-es.md","lastUpdated":null}'),{lazy:(e,r)=>e.name===r.name}),z={__name:"solr-to-es",setup(e,{expose:r}){const{data:h}=B(),k=g(),d=m(),o=Object.assign(d.meta.frontmatter||{},h.value?.frontmatter||{});return k.currentRoute.value.data=h.value,f("valaxy:frontmatter",o),globalThis.$frontmatter=o,r({frontmatter:{title:"Solr到Elasticsearch的踩坑与优化",date:"2025-07-09 09:12:31",updated:"2025-07-09 09:12:31",tags:null,categories:"ES",end:!1}}),(t,i)=>{const p=u;return b(),y(p,{frontmatter:C(o)},{"main-content-md":a(()=>[F(" more "),i[0]||(i[0]=s("h2",{id:"背景",tabindex:"-1"},[l("背景 "),s("a",{class:"header-anchor",href:"#背景","aria-label":'Permalink to "背景"'},"​")],-1)),i[1]||(i[1]=s("p",null,"随着业务的发展，我们决定将搜索引擎从Solr迁移到Elasticsearch（ES）。迁移的数据量如下：",-1)),i[2]||(i[2]=s("ul",null,[s("li",null,"数据条数：2.5亿"),s("li",null,"存储大小：约30GB")],-1)),i[3]||(i[3]=s("p",null,"迁移工具：阿里云推荐的开源工具 solr-to-es",-1)),i[4]||(i[4]=s("p",null,"初始迁移命令：",-1)),i[5]||(i[5]=s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nohup"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," python3.6"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," __main__.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'http://10.160.24.17:8983/solr/alert_summary/select'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'http://elastic:******@es-cn-t8j44.elasticsearch.aliyuncs.com:9200'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rtm-prod-alert-summary "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rtm-prod-alert-summary"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--rows-per-page "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2000"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," &")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[6]||(i[6]=s("h2",{id:"问题发现",tabindex:"-1"},[l("问题发现 "),s("a",{class:"header-anchor",href:"#问题发现","aria-label":'Permalink to "问题发现"'},"​")],-1)),i[7]||(i[7]=s("h3",{id:"_1-迁移速度急剧下降",tabindex:"-1"},[l("1. 迁移速度急剧下降 "),s("a",{class:"header-anchor",href:"#_1-迁移速度急剧下降","aria-label":'Permalink to "1. 迁移速度急剧下降"'},"​")],-1)),i[8]||(i[8]=s("ul",null,[s("li",null,"初始速度：每秒几千条"),s("li",null,"迁移至7千万条时：降至每秒几十条")],-1)),i[9]||(i[9]=s("p",null,[s("strong",null,"原因分析"),l("：")],-1)),i[10]||(i[10]=s("ul",null,[s("li",null,[l("Solr的深分页性能问题（"),s("code",null,"start"),l("参数越大，查询越慢）")]),s("li",null,"ES索引数据量增大后写入变慢")],-1)),i[11]||(i[11]=s("h3",{id:"_2-数据混乱",tabindex:"-1"},[l("2. 数据混乱 "),s("a",{class:"header-anchor",href:"#_2-数据混乱","aria-label":'Permalink to "2. 数据混乱"'},"​")],-1)),i[12]||(i[12]=s("ul",null,[s("li",null,"迁移过程中，生产环境的新数据仍在写入ES"),s("li",null,"迁移中断后，无法确定迁移进度")],-1)),i[13]||(i[13]=s("h3",{id:"_3-迁移中断",tabindex:"-1"},[l("3. 迁移中断 "),s("a",{class:"header-anchor",href:"#_3-迁移中断","aria-label":'Permalink to "3. 迁移中断"'},"​")],-1)),i[14]||(i[14]=s("ul",null,[s("li",null,"Solr查询超时导致工具报错")],-1)),i[15]||(i[15]=s("h3",{id:"_4-未指定唯一键",tabindex:"-1"},[l("4. 未指定唯一键 "),s("a",{class:"header-anchor",href:"#_4-未指定唯一键","aria-label":'Permalink to "4. 未指定唯一键"'},"​")],-1)),i[16]||(i[16]=s("ul",null,[s("li",null,[l("初始迁移未指定"),s("code",null,"--id-field"),l("参数，导致迁移的数据在ES中生成随机的"),s("code",null,"_id")]),s("li",null,[l("生产写入的数据中"),s("code",null,"_id"),l("与"),s("code",null,"alertSummaryId"),l("相等，而迁移的数据则不等")])],-1)),i[17]||(i[17]=s("h2",{id:"解决方案",tabindex:"-1"},[l("解决方案 "),s("a",{class:"header-anchor",href:"#解决方案","aria-label":'Permalink to "解决方案"'},"​")],-1)),i[18]||(i[18]=s("h3",{id:"步骤1-清理脏数据",tabindex:"-1"},[l("步骤1：清理脏数据 "),s("a",{class:"header-anchor",href:"#步骤1-清理脏数据","aria-label":'Permalink to "步骤1：清理脏数据"'},"​")],-1)),i[19]||(i[19]=s("p",null,[l("使用ES的"),s("code",null,"_delete_by_query"),l("API删除迁移产生的脏数据（即"),s("code",null,"_id"),l("不等于"),s("code",null,"alertSummaryId"),l("的文档）：")],-1)),i[20]||(i[20]=s("div",{class:"language-json"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"json"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"POST /rtm-prod-alert-summary/_delete_by_query?scroll_size="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"&requests_per_second="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"&conflicts=proceed&wait_for_completion="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'  "query"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'    "script"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'      "script"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'        "source"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`"doc['_id'].value != doc['alertSummaryId'].value"`),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'        "lang"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"painless"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[21]||(i[21]=s("ul",null,[s("li",null,[s("p",null,[s("strong",null,"耗时"),l("：约3小时（7千万条数据）")])]),s("li",null,[s("p",null,"监控删除任务"),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GET"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," _tasks?actions="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"delete"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"&"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"detailed")])])]),s("button",{class:"code-block-unfold-btn"})])])],-1)),i[22]||(i[22]=s("h3",{id:"步骤2-优化迁移策略",tabindex:"-1"},[l("步骤2：优化迁移策略 "),s("a",{class:"header-anchor",href:"#步骤2-优化迁移策略","aria-label":'Permalink to "步骤2：优化迁移策略"'},"​")],-1)),i[23]||(i[23]=s("h4",{id:"关键改进1-指定唯一键",tabindex:"-1"},[l("关键改进1：指定唯一键 "),s("a",{class:"header-anchor",href:"#关键改进1-指定唯一键","aria-label":'Permalink to "关键改进1：指定唯一键"'},"​")],-1)),i[24]||(i[24]=s("p",null,[l("添加"),s("code",null,"--id-field alertSummaryId"),l("参数，确保迁移数据的"),s("code",null,"_id"),l("等于"),s("code",null,"alertSummaryId"),l("，这样重复迁移时会自动覆盖。")],-1)),i[25]||(i[25]=s("h4",{id:"关键改进2-按时间范围分批迁移",tabindex:"-1"},[l("关键改进2：按时间范围分批迁移 "),s("a",{class:"header-anchor",href:"#关键改进2-按时间范围分批迁移","aria-label":'Permalink to "关键改进2：按时间范围分批迁移"'},"​")],-1)),i[26]||(i[26]=s("p",null,[l("使用Solr的"),s("code",null,"fq"),l("参数按年（或月）迁移数据，避免深分页问题。示例命令：")],-1)),i[27]||(i[27]=s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"python3.6"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," __main__.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'http://10.160.24.17:8983/solr/alert_summary/select?q=*:*&fq=alertTime:[1741968000000 TO 1743436800000]'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'http://es-cn-t8j44.elasticsearch.aliyuncs.com:9200'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rtm-prod-alert-summary "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--es-user "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"elastic"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--es-password "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*****"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--id-field "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"alertSummaryId")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[28]||(i[28]=s("h3",{id:"步骤3-避免迁移期间新数据写入-可选",tabindex:"-1"},[l("步骤3：避免迁移期间新数据写入（可选） "),s("a",{class:"header-anchor",href:"#步骤3-避免迁移期间新数据写入-可选","aria-label":'Permalink to "步骤3：避免迁移期间新数据写入（可选）"'},"​")],-1)),i[29]||(i[29]=s("ul",null,[s("li",null,"在迁移期间暂停生产写入（根据业务情况决定）"),s("li",null,"或者迁移完成后，补充迁移暂停期间的新数据")],-1)),i[30]||(i[30]=s("h2",{id:"迁移优化后的效果",tabindex:"-1"},[l("迁移优化后的效果 "),s("a",{class:"header-anchor",href:"#迁移优化后的效果","aria-label":'Permalink to "迁移优化后的效果"'},"​")],-1)),i[31]||(i[31]=s("ol",null,[s("li",null,[s("strong",null,"迁移速度稳定"),l("：分批迁移避免了Solr深分页问题，速度保持在每秒数千条。")]),s("li",null,[s("strong",null,"数据一致性保证"),l("：使用"),s("code",null,"--id-field"),l("确保即使迁移中断重启也不会产生重复数据。")]),s("li",null,[s("strong",null,"可追踪进度"),l("：按时间范围迁移，清楚知道每个批次是否成功。")])],-1)),i[32]||(i[32]=s("h2",{id:"总结与建议",tabindex:"-1"},[l("总结与建议 "),s("a",{class:"header-anchor",href:"#总结与建议","aria-label":'Permalink to "总结与建议"'},"​")],-1)),i[33]||(i[33]=s("ul",null,[s("li",null,[s("strong",null,"核心教训"),l("：大数据迁移务必指定唯一键，避免数据混乱。")]),s("li",null,[s("strong",null,"分批策略"),l("：按时间范围（或其他有序字段）分批次迁移，避免深分页。 "),s("ul",null,[s("li",null,[l("使用ES的"),s("code",null,"_tasks"),l("API监控迁移和删除任务。")]),s("li",null,"推荐使用Elasticsearch Curator管理索引。")])]),s("li",null,[s("strong",null,"工具改进"),l("：如果迁移工具不支持断点续传，可考虑开发脚本记录最后迁移的时间戳。")])],-1))]),"main-header":a(()=>[n(t.$slots,"main-header")]),"main-header-after":a(()=>[n(t.$slots,"main-header-after")]),"main-nav":a(()=>[n(t.$slots,"main-nav")]),"main-content-before":a(()=>[n(t.$slots,"main-content-before")]),"main-content":a(()=>[n(t.$slots,"main-content")]),"main-content-after":a(()=>[n(t.$slots,"main-content-after")]),"main-nav-before":a(()=>[n(t.$slots,"main-nav-before")]),"main-nav-after":a(()=>[n(t.$slots,"main-nav-after")]),comment:a(()=>[n(t.$slots,"comment")]),footer:a(()=>[n(t.$slots,"footer")]),aside:a(()=>[n(t.$slots,"aside")]),"aside-custom":a(()=>[n(t.$slots,"aside-custom")]),default:a(()=>[n(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{z as default,B as usePageData};
