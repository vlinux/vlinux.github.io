import{_ as p}from"./ValaxyMain.vue_vue_type_style_index_0_lang.Bth_JSAQ.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as E,u as g,a as c}from"./chunks/vue-router.DpP0leKZ.js";import{aa as m,ap as e,ag as n,ae as y,af as s,ai as i,P as b,ab as F,a1 as C}from"./framework.GHZxz7jq.js";import"./index.Di1n2b66.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BWywLGB4.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.DoKt6roH.js";const f=E("/posts/k8s-zhengshuxuqian-other",async t=>JSON.parse('{"title":"Kubernetes 证书续签问题分析与解决","description":"","frontmatter":{"title":"Kubernetes 证书续签问题分析与解决","date":"2025-07-19 12:10:14","updated":"2025-07-19 12:10:14","tags":"kube-controller-manager","categories":"Kubernetes","end":false},"headers":[],"relativePath":"pages/posts/k8s-zhengshuxuqian-other.md","lastUpdated":null}'),{lazy:(t,r)=>t.name===r.name}),q={__name:"k8s-zhengshuxuqian-other",setup(t,{expose:r}){const{data:h}=f(),o=c(),d=g(),k=Object.assign(d.meta.frontmatter||{},h.value?.frontmatter||{});return o.currentRoute.value.data=h.value,C("valaxy:frontmatter",k),globalThis.$frontmatter=k,r({frontmatter:{title:"Kubernetes 证书续签问题分析与解决",date:"2025-07-19 12:10:14",updated:"2025-07-19 12:10:14",tags:"kube-controller-manager",categories:"Kubernetes",end:!1}}),(a,l)=>{const u=p;return F(),m(u,{frontmatter:b(k)},{"main-content-md":e(()=>[y(" more "),l[0]||(l[0]=s("h1",{id:"kubernetes-证书续签问题分析与解决笔记",tabindex:"-1"},[i("Kubernetes 证书续签问题分析与解决笔记 "),s("a",{class:"header-anchor",href:"#kubernetes-证书续签问题分析与解决笔记","aria-label":'Permalink to "Kubernetes 证书续签问题分析与解决笔记"'},"​")],-1)),l[1]||(l[1]=s("h2",{id:"问题描述",tabindex:"-1"},[i("问题描述 "),s("a",{class:"header-anchor",href:"#问题描述","aria-label":'Permalink to "问题描述"'},"​")],-1)),l[2]||(l[2]=s("p",null,"在续签 Kubernetes 证书时遇到了以下错误：",-1)),l[3]||(l[3]=s("div",{class:"language-markdown"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"markdown"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},'I0718 14:04:10.452667       1 tlsconfig.go:240] "Starting DynamicServingCertificateController"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},'E0718 14:04:11.397015       1 leaderelection.go:330] error retrieving resource lock kube-system/kube-controller-manager: leases.coordination.k8s.io "kube-controller-manager" is forbidden: User "system:kube-controller-manager" cannot get resource "leases" in API group "coordination.k8s.io" in the namespace "kube-system"')])])]),s("button",{class:"code-block-unfold-btn"})],-1)),l[4]||(l[4]=s("p",null,[i("错误表明 "),s("code",null,"system:kube-controller-manager"),i(" 用户没有权限获取 "),s("code",null,"kube-system"),i(" 命名空间下的 "),s("code",null,"leases"),i(" 资源。")],-1)),l[5]||(l[5]=s("h2",{id:"问题分析",tabindex:"-1"},[i("问题分析 "),s("a",{class:"header-anchor",href:"#问题分析","aria-label":'Permalink to "问题分析"'},"​")],-1)),l[6]||(l[6]=s("ol",null,[s("li",null,[s("strong",null,"背景知识"),i("： "),s("ul",null,[s("li",null,"Kubernetes 使用 leader election 机制来确保控制器管理器等高可用组件只有一个实例处于活跃状态"),s("li",null,[i("这种选举机制依赖于 "),s("code",null,"coordination.k8s.io"),i(" API 组中的 "),s("code",null,"leases"),i(" 资源")]),s("li",null,[s("code",null,"kube-controller-manager"),i(" 需要权限来创建和更新这些 lease 资源")])])]),s("li",null,[s("strong",null,"根本原因"),i("： "),s("ul",null,[s("li",null,[i("默认情况下，"),s("code",null,"system:kube-controller-manager"),i(" 用户可能缺少对 leases 资源的必要权限")]),s("li",null,"这可能是由于集群初始配置不完整或证书续签后权限重置导致的")])])],-1)),l[7]||(l[7]=s("h2",{id:"解决方案",tabindex:"-1"},[i("解决方案 "),s("a",{class:"header-anchor",href:"#解决方案","aria-label":'Permalink to "解决方案"'},"​")],-1)),l[8]||(l[8]=s("p",null,"我采取了以下步骤解决问题：",-1)),l[9]||(l[9]=s("ol",null,[s("li",null,[s("p",null,[s("strong",null,"创建 ClusterRole 和 ClusterRoleBinding"),i("：")]),s("div",{class:"language-yaml"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"yaml"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"apiVersion"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rbac.authorization.k8s.io/v1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"kind"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ClusterRoleBinding")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"metadata"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"system:kube-controller-manager-binding")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"roleRef"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  apiGroup"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rbac.authorization.k8s.io")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  kind"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ClusterRole")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"system:kube-controller-manager")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"subjects"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"- "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"apiGroup"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rbac.authorization.k8s.io")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  kind"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"User")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"system:kube-controller-manager")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"---")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"apiVersion"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rbac.authorization.k8s.io/v1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"kind"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ClusterRole")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"metadata"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"system:kube-controller-manager-leases")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"rules"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"- "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"apiGroups"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"coordination.k8s.io")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  resources"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"leases")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  verbs"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"get")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"create")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"update")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"patch")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,[s("strong",null,"创建 ServiceAccount"),i("：")]),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-system"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," serviceaccount"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-controller-manager")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,[s("strong",null,"重启 kube-controller-manager 服务"),i("：")]),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-controller-manager")])])]),s("button",{class:"code-block-unfold-btn"})])])],-1)),l[10]||(l[10]=s("h2",{id:"解决原理",tabindex:"-1"},[i("解决原理 "),s("a",{class:"header-anchor",href:"#解决原理","aria-label":'Permalink to "解决原理"'},"​")],-1)),l[11]||(l[11]=s("ol",null,[s("li",null,[s("strong",null,"ClusterRole"),i("： "),s("ul",null,[s("li",null,[i("创建了专门的 "),s("code",null,"system:kube-controller-manager-leases"),i(" ClusterRole")]),s("li",null,[i("授予了对 "),s("code",null,"leases"),i(" 资源的 get、create、update 和 patch 权限")])])]),s("li",null,[s("strong",null,"ClusterRoleBinding"),i("： "),s("ul",null,[s("li",null,[i("将 "),s("code",null,"system:kube-controller-manager"),i(" 用户绑定到 "),s("code",null,"system:kube-controller-manager"),i(" ClusterRole")]),s("li",null,"确保用户拥有执行其功能所需的权限")])]),s("li",null,[s("strong",null,"ServiceAccount"),i("： "),s("ul",null,[s("li",null,[i("创建了 "),s("code",null,"kube-controller-manager"),i(" ServiceAccount")]),s("li",null,"虽然错误中涉及的是 User 而非 ServiceAccount，但创建它有助于确保权限体系的完整性")])])],-1)),l[12]||(l[12]=s("h2",{id:"经验总结",tabindex:"-1"},[i("经验总结 "),s("a",{class:"header-anchor",href:"#经验总结","aria-label":'Permalink to "经验总结"'},"​")],-1)),l[13]||(l[13]=s("ol",null,[s("li",null,"Kubernetes 组件需要特定的 RBAC 权限才能正常工作"),s("li",null,"证书续签或集群升级后，权限配置可能会发生变化，需要验证"),s("li",null,"控制器管理器这类核心组件需要 leases 资源权限来实现 leader election"),s("li",null,"查看组件日志是诊断权限问题的第一步"),s("li",null,"使用 RBAC 资源可以精确控制 Kubernetes 组件的访问权限")],-1)),l[14]||(l[14]=s("h2",{id:"预防措施",tabindex:"-1"},[i("预防措施 "),s("a",{class:"header-anchor",href:"#预防措施","aria-label":'Permalink to "预防措施"'},"​")],-1)),l[15]||(l[15]=s("ol",null,[s("li",null,"在集群初始化时确保所有核心组件都有正确的 RBAC 配置"),s("li",null,"定期检查核心组件的日志以发现潜在问题"),s("li",null,"将关键 RBAC 配置纳入基础设施即代码(IaC)管理"),s("li",null,"在升级或证书轮换前备份关键配置")],-1)),l[16]||(l[16]=s("p",null,"通过这次问题解决，我对 Kubernetes 的 RBAC 系统和控制器管理器的工作原理有了更深入的理解。希望这个记录能帮助遇到类似问题的同行快速定位和解决问题。",-1))]),"main-header":e(()=>[n(a.$slots,"main-header")]),"main-header-after":e(()=>[n(a.$slots,"main-header-after")]),"main-nav":e(()=>[n(a.$slots,"main-nav")]),"main-content-before":e(()=>[n(a.$slots,"main-content-before")]),"main-content":e(()=>[n(a.$slots,"main-content")]),"main-content-after":e(()=>[n(a.$slots,"main-content-after")]),"main-nav-before":e(()=>[n(a.$slots,"main-nav-before")]),"main-nav-after":e(()=>[n(a.$slots,"main-nav-after")]),comment:e(()=>[n(a.$slots,"comment")]),footer:e(()=>[n(a.$slots,"footer")]),aside:e(()=>[n(a.$slots,"aside")]),"aside-custom":e(()=>[n(a.$slots,"aside-custom")]),default:e(()=>[n(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{q as default,f as usePageData};
