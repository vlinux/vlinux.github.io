import{_ as m}from"./ValaxyMain.vue_vue_type_style_index_0_lang.gfo-rUCP.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as f,u as b,a as h}from"./chunks/vue-router.DQHxU7r6.js";import{aa as k,ap as n,ag as l,af as s,ai as e,P as g,ab as v,a1 as y}from"./framework.GHZxz7jq.js";import"./index.CFgbcban.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.CU_FKKcY.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.zk_xPNhE.js";const S=f("/posts/Kubernetes使用NFS作为动态存储（提供下载YAML）",async t=>JSON.parse('{"title":"Kubernetes使用NFS作为动态存储（提供下载YAML）","description":"","frontmatter":{"title":"Kubernetes使用NFS作为动态存储（提供下载YAML）","categories":"Kubernetes","tags":["NFS-client"],"date":"2021-01-19 11:30:00"},"headers":[],"relativePath":"pages/posts/Kubernetes使用NFS作为动态存储（提供下载YAML）.md","lastUpdated":null}'),{lazy:(t,i)=>t.name===i.name}),_={__name:"Kubernetes使用NFS作为动态存储（提供下载YAML）",setup(t,{expose:i}){const{data:r}=S(),c=h(),u=b(),o=Object.assign(u.meta.frontmatter||{},r.value?.frontmatter||{});return c.currentRoute.value.data=r.value,y("valaxy:frontmatter",o),globalThis.$frontmatter=o,i({frontmatter:{title:"Kubernetes使用NFS作为动态存储（提供下载YAML）",categories:"Kubernetes",tags:["NFS-client"],date:"2021-01-19 11:30:00"}}),(a,p)=>{const d=m;return v(),k(d,{frontmatter:g(o)},{"main-content-md":n(()=>[...p[0]||(p[0]=[s("blockquote",null,[s("p",null,"记录一下小实验，以免以后忘记")],-1),s("h2",{id:"一、nfs服务器安装nfs与配置",tabindex:"-1"},[e("一、nfs服务器安装nfs与配置 "),s("a",{class:"header-anchor",href:"#一、nfs服务器安装nfs与配置","aria-label":'Permalink to "一、nfs服务器安装nfs与配置"'},"​")],-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"yum -y install nfs-utils rpcbind")]),e(`
`),s("span",{class:"line"},[s("span",null,"systemctl  start rpcbind.service ")]),e(`
`),s("span",{class:"line"},[s("span",null,"systemctl  start nfs")]),e(`
`),s("span",{class:"line"},[s("span")]),e(`
`),s("span",{class:"line"},[s("span",null,"#配置")]),e(`
`),s("span",{class:"line"},[s("span",null,"mkdir /data/nfs -p")]),e(`
`),s("span",{class:"line"},[s("span",null,"chow nfsnobody.nfsnobody /data/nfs")]),e(`
`),s("span",{class:"line"},[s("span")]),e(`
`),s("span",{class:"line"},[s("span",null,"cat>>/etc/exports<<EOF")]),e(`
`),s("span",{class:"line"},[s("span",null,"/data/nfs 172.16.208.0/20(rw,sync,no_root_squash,no_all_squash)")]),e(`
`),s("span",{class:"line"},[s("span",null,"EOF")]),e(`
`),s("span",{class:"line"},[s("span",null,"exportfs  -arv")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("h2",{id:"二、其它客户端服务器安装nfs-utils",tabindex:"-1"},[e("二、其它客户端服务器安装nfs-utils "),s("a",{class:"header-anchor",href:"#二、其它客户端服务器安装nfs-utils","aria-label":'Permalink to "二、其它客户端服务器安装nfs-utils"'},"​")],-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"yum install -y  nfs-utils")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("h2",{id:"三、部署nfs实现自动创建pv插件",tabindex:"-1"},[e("三、部署NFS实现自动创建PV插件： "),s("a",{class:"header-anchor",href:"#三、部署nfs实现自动创建pv插件","aria-label":'Permalink to "三、部署NFS实现自动创建PV插件："'},"​")],-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"git clone https://github.com/kubernetes-incubator/external-storage")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"上面的Clone下来的仓库由于是官网的所以可能导致内部有些资源是外网资源，无法正常部署跟启动，于是乎博主自己使用科学上网的方式已经把外网资源给PUll下来替换进去了，现在你只需要下载博主提供的就可以了，下载链接在下面@(你懂的)不用谢",-1),s("p",null,[e('[file href="'),s("a",{href:"https://wwa.lanzoui.com/i2mohkkammj",target:"_blank",rel:"noreferrer"},"https://wwa.lanzoui.com/i2mohkkammj"),e('"]NFS动态存储类[/file]')],-1),s("blockquote",null,[s("p",null,"部署流程如下")],-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"unzip nfs-client.zip")]),e(`
`),s("span",{class:"line"},[s("span",null,"cd nfs-client/")]),e(`
`),s("span",{class:"line"},[s("span",null,"kubectl apply -f rbac.yaml # 授权访问apiserver")]),e(`
`),s("span",{class:"line"},[s("span",null,"kubectl apply -f deployment.yaml # 部署插件，需修改里面NFS服务器地址与共享目录")]),e(`
`),s("span",{class:"line"},[s("span",null,"kubectl apply -f class.yaml # 创建存储类")]),e(`
`),s("span",{class:"line"},[s("span",null,"kubectl get cs # 查看存储类")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"当你出现报错",-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"pod has unbound immediate PersistentVolumeClaims")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"多半是你的k8s版本高于1.20的问题",-1),s("p",null,'第一种解决方法 [tip type="danger" title="使用k8s版本高于v1.20.0的注意"] 修改**/etc/kubernetes/manifests/kube-apiserver.yaml** 文件',-1),s("p",null,"添加添加**- --feature-gates=RemoveSelfLink=false**",-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"[root@master ~]# grep -B 5 'feature-gates' /etc/kubernetes/manifests/kube-apiserver.yaml")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --service-account-key-file=/etc/kubernetes/pki/sa.pub")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --service-cluster-ip-range=10.96.0.0/12")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key")]),e(`
`),s("span",{class:"line"},[s("span",null,"    - --feature-gates=RemoveSelfLink=false #添加内容")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"[/tip]",-1),s("p",null,"第二种解决方法 修改nfs-client的deployment参数：",-1),s("div",{class:"language-"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"kubectl -n kube-system edit deploy <nfs-client-deploy名>")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"将其中的.spec.template.spec.containers[0].image参数修改为：k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2 等待nfs-client pod启动即可。",-1)])]),"main-header":n(()=>[l(a.$slots,"main-header")]),"main-header-after":n(()=>[l(a.$slots,"main-header-after")]),"main-nav":n(()=>[l(a.$slots,"main-nav")]),"main-content-before":n(()=>[l(a.$slots,"main-content-before")]),"main-content":n(()=>[l(a.$slots,"main-content")]),"main-content-after":n(()=>[l(a.$slots,"main-content-after")]),"main-nav-before":n(()=>[l(a.$slots,"main-nav-before")]),"main-nav-after":n(()=>[l(a.$slots,"main-nav-after")]),comment:n(()=>[l(a.$slots,"comment")]),footer:n(()=>[l(a.$slots,"footer")]),aside:n(()=>[l(a.$slots,"aside")]),"aside-custom":n(()=>[l(a.$slots,"aside-custom")]),default:n(()=>[l(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{_ as default,S as usePageData};
