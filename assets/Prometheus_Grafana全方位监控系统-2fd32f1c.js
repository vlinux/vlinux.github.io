import{_ as r}from"./ValaxyMain-fde20bcc.js";import{_ as p,p as D,c as y,w as o,o as i,r as n,b as l,R as s}from"./app-73107480.js";import"./YunFooter-091e638c.js";import"./YunCard-a5dab7a4.js";import"./YunPageHeader-0348731d.js";const Pa=JSON.parse('{"title":"Prometheus+Grafana全方位监控系统","description":"","frontmatter":{"title":"Prometheus+Grafana全方位监控系统","categories":"DevOps","tags":["Prometheus"],"date":"2020-08-30T16:38:00.000Z"},"headers":[{"level":2,"title":"Prometheus概述","slug":"prometheus概述","link":"#prometheus概述","children":[{"level":3,"title":"Prometheus是什么","slug":"prometheus是什么","link":"#prometheus是什么","children":[]},{"level":3,"title":"Prometheus特点","slug":"prometheus特点","link":"#prometheus特点","children":[]},{"level":3,"title":"Prometheus 组成与架构","slug":"prometheus-组成与架构","link":"#prometheus-组成与架构","children":[]},{"level":3,"title":"数据模型","slug":"数据模型","link":"#数据模型","children":[]},{"level":3,"title":"指标类型","slug":"指标类型","link":"#指标类型","children":[]},{"level":3,"title":"作业和实例","slug":"作业和实例","link":"#作业和实例","children":[]}]},{"level":2,"title":"Prometheus部署","slug":"prometheus部署","link":"#prometheus部署","children":[]},{"level":2,"title":"全局配置文件介绍","slug":"全局配置文件介绍","link":"#全局配置文件介绍","children":[{"level":3,"title":"全局配置文件","slug":"全局配置文件","link":"#全局配置文件","children":[]},{"level":3,"title":"scrape_configs","slug":"scrape-configs","link":"#scrape-configs","children":[]},{"level":3,"title":"relabel_configs","slug":"relabel-configs","link":"#relabel-configs","children":[]},{"level":3,"title":"基于文件的服务发现","slug":"基于文件的服务发现","link":"#基于文件的服务发现","children":[]}]},{"level":2,"title":"监控栗子","slug":"监控栗子","link":"#监控栗子","children":[{"level":3,"title":"监控linux服务器","slug":"监控linux服务器","link":"#监控linux服务器","children":[]},{"level":3,"title":"使用PromSQL","slug":"使用promsql","link":"#使用promsql","children":[]},{"level":3,"title":"部署grafana","slug":"部署grafana","link":"#部署grafana","children":[]},{"level":3,"title":"监控docker","slug":"监控docker","link":"#监控docker","children":[]},{"level":3,"title":"监控mysql","slug":"监控mysql","link":"#监控mysql","children":[]}]},{"level":2,"title":"alertmanager","slug":"alertmanager","link":"#alertmanager","children":[{"level":3,"title":"部署alertmanager","slug":"部署alertmanager","link":"#部署alertmanager","children":[]},{"level":3,"title":"配置告警规则并邮件通知","slug":"配置告警规则并邮件通知","link":"#配置告警规则并邮件通知","children":[]},{"level":3,"title":"告警状态","slug":"告警状态","link":"#告警状态","children":[]},{"level":3,"title":"告警的分配","slug":"告警的分配","link":"#告警的分配","children":[]},{"level":3,"title":"告警收敛","slug":"告警收敛","link":"#告警收敛","children":[]}]},{"level":2,"title":"编写告警规则栗子","slug":"编写告警规则栗子","link":"#编写告警规则栗子","children":[]}],"relativePath":"pages/posts/Prometheus+Grafana全方位监控系统.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/Prometheus+Grafana全方位监控系统.md","lastUpdated":1673425512000}'),a=JSON.parse('{"title":"Prometheus+Grafana全方位监控系统","description":"","frontmatter":{"title":"Prometheus+Grafana全方位监控系统","categories":"DevOps","tags":["Prometheus"],"date":"2020-08-30T16:38:00.000Z"},"headers":[{"level":2,"title":"Prometheus概述","slug":"prometheus概述","link":"#prometheus概述","children":[{"level":3,"title":"Prometheus是什么","slug":"prometheus是什么","link":"#prometheus是什么","children":[]},{"level":3,"title":"Prometheus特点","slug":"prometheus特点","link":"#prometheus特点","children":[]},{"level":3,"title":"Prometheus 组成与架构","slug":"prometheus-组成与架构","link":"#prometheus-组成与架构","children":[]},{"level":3,"title":"数据模型","slug":"数据模型","link":"#数据模型","children":[]},{"level":3,"title":"指标类型","slug":"指标类型","link":"#指标类型","children":[]},{"level":3,"title":"作业和实例","slug":"作业和实例","link":"#作业和实例","children":[]}]},{"level":2,"title":"Prometheus部署","slug":"prometheus部署","link":"#prometheus部署","children":[]},{"level":2,"title":"全局配置文件介绍","slug":"全局配置文件介绍","link":"#全局配置文件介绍","children":[{"level":3,"title":"全局配置文件","slug":"全局配置文件","link":"#全局配置文件","children":[]},{"level":3,"title":"scrape_configs","slug":"scrape-configs","link":"#scrape-configs","children":[]},{"level":3,"title":"relabel_configs","slug":"relabel-configs","link":"#relabel-configs","children":[]},{"level":3,"title":"基于文件的服务发现","slug":"基于文件的服务发现","link":"#基于文件的服务发现","children":[]}]},{"level":2,"title":"监控栗子","slug":"监控栗子","link":"#监控栗子","children":[{"level":3,"title":"监控linux服务器","slug":"监控linux服务器","link":"#监控linux服务器","children":[]},{"level":3,"title":"使用PromSQL","slug":"使用promsql","link":"#使用promsql","children":[]},{"level":3,"title":"部署grafana","slug":"部署grafana","link":"#部署grafana","children":[]},{"level":3,"title":"监控docker","slug":"监控docker","link":"#监控docker","children":[]},{"level":3,"title":"监控mysql","slug":"监控mysql","link":"#监控mysql","children":[]}]},{"level":2,"title":"alertmanager","slug":"alertmanager","link":"#alertmanager","children":[{"level":3,"title":"部署alertmanager","slug":"部署alertmanager","link":"#部署alertmanager","children":[]},{"level":3,"title":"配置告警规则并邮件通知","slug":"配置告警规则并邮件通知","link":"#配置告警规则并邮件通知","children":[]},{"level":3,"title":"告警状态","slug":"告警状态","link":"#告警状态","children":[]},{"level":3,"title":"告警的分配","slug":"告警的分配","link":"#告警的分配","children":[]},{"level":3,"title":"告警收敛","slug":"告警收敛","link":"#告警收敛","children":[]}]},{"level":2,"title":"编写告警规则栗子","slug":"编写告警规则栗子","link":"#编写告警规则栗子","children":[]}],"relativePath":"pages/posts/Prometheus+Grafana全方位监控系统.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/Prometheus+Grafana全方位监控系统.md","lastUpdated":1673425512000}'),C={name:"pages/posts/Prometheus+Grafana全方位监控系统.md",data(){return{data:a,frontmatter:a.frontmatter}},setup(){D("pageData",a)}},F=l("h1",{id:"prometheus-grafana全方位监控系统",tabindex:"-1"},[s("Prometheus+Grafana全方位监控系统 "),l("a",{class:"header-anchor",href:"#prometheus-grafana全方位监控系统","aria-hidden":"true"},"#")],-1),A=l("p",null,[l("code",null,"emmm"),s("，前段时间写了一篇关于使用"),l("code",null,"Prometheus+grafana+node-exporter"),s("监控"),l("code",null,"k8s"),s("的文章，那篇写的很简单，只是单纯的搭建出来了，目前我对这东西一点都不了解，所以先来了解一下"),l("code",null,"Prometheus"),s("和他常用的组件吧，包括"),l("code",null,"Prometheus/Grafana/node-exports/Alertmanager"),s("，开始吧。")],-1),u=l("p",null,[s("本文包括"),l("code",null,"Prometheus"),s("概述、部署、配置、监控、告警、之前我做监控用的都是"),l("code",null,"zabbix"),s("，"),l("code",null,"zabbix"),s("也算是一个全面型的监控系统，但是他不太适合容器监控，他对容器监控集成欠缺很多，他比较偏向于非容器监控。")],-1),d=l("p",null,[l("code",null,"Prometheus"),s("算是一个全能型选手，原生支持容器监控，当然监控传统应用也不是吃干饭的，所以就是容器和非容器他都支持，所有的监控系统都具备这个流程，数据采集→数据处理→数据存储→数据展示→告警，本文就是针对"),l("code",null,"Prometheus"),s("展开的，所以先看看"),l("code",null,"Prometheus"),s("概述")],-1),m=l("h2",{id:"prometheus概述",tabindex:"-1"},[s("Prometheus概述 "),l("a",{class:"header-anchor",href:"#prometheus概述","aria-hidden":"true"},"#")],-1),g=l("p",null,[s("先来看一下"),l("code",null,"Prometheus"),s("是个啥")],-1),h=l("h3",{id:"prometheus是什么",tabindex:"-1"},[s("Prometheus是什么 "),l("a",{class:"header-anchor",href:"#prometheus是什么","aria-hidden":"true"},"#")],-1),_=l("p",null,[s("中文名普罗米修斯，最初在"),l("code",null,"SoundCloud"),s("上构建的监控系统，自"),l("code",null,"2012"),s("年成为社区开源项目，用户非常活跃的开发人员和用户社区，2016年加入"),l("code",null,"CNCF"),s("，成为继"),l("code",null,"kubernetes"),s("之后的第二个托管项目，"),l("a",{href:"https://prometheus.io/",target:"_blank",rel:"noreferrer"},"官方网站")],-1),E=l("h3",{id:"prometheus特点",tabindex:"-1"},[s("Prometheus特点 "),l("a",{class:"header-anchor",href:"#prometheus特点","aria-hidden":"true"},"#")],-1),b=l("p",null,"官方扒过来的",-1),f=l("ul",null,[l("li",null,"多维数据模型：由度量名称和键值对标识的时间序列数据"),l("li",null,"PromSQL: —种灵活的查询语言，可以利用多维数据完成复杂的查询"),l("li",null,"不依赖分布式存储，单个服务器节点可直接工作"),l("li",null,"基于HTTP的pull方式釆集时间序列数据"),l("li",null,"推送时间序列数据通过PushGateway组件支持"),l("li",null,"通过服务发现或静态配罝发现目标"),l("li",null,"多种图形模式及仪表盘支持(grafana)")],-1),v=l("h3",{id:"prometheus-组成与架构",tabindex:"-1"},[s("Prometheus 组成与架构 "),l("a",{class:"header-anchor",href:"#prometheus-组成与架构","aria-hidden":"true"},"#")],-1),x=l("p",null,"来看一张图，官方扒到的",-1),w=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190702133835.png#mirages-width=774&mirages-height=462&mirages-cdn-type=5",alt:"20190702133835"})],-1),k=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"名称"),l("th",null,"说明")])]),l("tbody",null,[l("tr",null,[l("td",null,"Prometheus Server"),l("td",null,"收集指标和存储时间序列数据，并提供查询接口")]),l("tr",null,[l("td",null,"Push Gateway"),l("td",null,"短期存储指标数据，主要用于临时性任务")]),l("tr",null,[l("td",null,"Exporters"),l("td",null,"采集已有的三方服务监控指标并暴露metrics")]),l("tr",null,[l("td",null,"Alertmanager"),l("td",null,"告警")]),l("tr",null,[l("td",null,"Web UI"),l("td",null,"简单的WEB控制台")])])],-1),P=l("p",null,"集成了数据的采集，处理，存储，展示，告警一系列流程都已经具备了",-1),q=l("h3",{id:"数据模型",tabindex:"-1"},[s("数据模型 "),l("a",{class:"header-anchor",href:"#数据模型","aria-hidden":"true"},"#")],-1),B=l("p",null,[l("code",null,"Prometheus"),s("将所有数据存储为时间序列，具有相同度量名称以及标签属于同个指标，也就是说"),l("code",null,"Prometheus"),s("从数据源拿到数据之后都会存到内置的"),l("code",null,"TSDB"),s("中，这里存储的就是时间序列数据，它存储的数据会有一个度量名称，譬如你现在监控一个"),l("code",null,"nginx"),s("，首先你要给他起个名字，这个名称也就是度量名，还会有"),l("code",null,"N"),s("个标签，你可以理解名称为表名，标签为字段，所以，每个时间序列都由度量标准名称和一组键值对(也称为标签)唯一标识。")],-1),j=l("p",null,"时间序列的格式是这样的，",-1),S=l("div",{class:"language-"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"<metrice name> {<label name>=<label value>,...}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}})])])])],-1),$=l("p",null,[l("code",null,"metrice name"),s("指的就是度量标准名称，"),l("code",null,"label name"),s("也就是标签名，这个标签可以有多个，栗子")],-1),U=l("div",{class:"language-"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},'nginx_http_access{method="GET",uri="/index.html"}')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}})])])])],-1),T=l("p",null,[s("这个度量名称为"),l("code",null,"nginx_http_access"),s("，后面是两个标签，和他们各对应的值，当然你还可以继续指定标签，你指定的标签越多查询的维度就越多。")],-1),I=l("h3",{id:"指标类型",tabindex:"-1"},[s("指标类型 "),l("a",{class:"header-anchor",href:"#指标类型","aria-hidden":"true"},"#")],-1),O=l("p",null,"看表格吧",-1),N=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"类型名称"),l("th",null,"说明")])]),l("tbody",null,[l("tr",null,[l("td",null,"Counter"),l("td",null,"递增计数器，适合收集接口请求次数")]),l("tr",null,[l("td",null,"Guage"),l("td",null,"可以任意变化的数值，适用CPU使用率")]),l("tr",null,[l("td",null,"Histogram"),l("td",null,"对一段时间内数据进行采集，并对有所数值求和于统计数量")]),l("tr",null,[l("td",null,"Summary"),l("td",null,"与Histogram类型类似")])])],-1),G=l("h3",{id:"作业和实例",tabindex:"-1"},[s("作业和实例 "),l("a",{class:"header-anchor",href:"#作业和实例","aria-hidden":"true"},"#")],-1),z=l("p",null,[s("实例指的就是你可以抓取的目标，这个会在"),l("code",null,"Prometheus "),s("配置文件中提现，作业是具有相同目标的实例集合称为作业，你可以理解为是一个组，一会写配置文件的时候会详细解析，下面开始安装"),l("code",null,"Prometheus"),s("。")],-1),M=l("h2",{id:"prometheus部署",tabindex:"-1"},[s("Prometheus部署 "),l("a",{class:"header-anchor",href:"#prometheus部署","aria-hidden":"true"},"#")],-1),L=l("p",null,[s("先通过二进制来部署"),l("code",null,"Prometheus"),s("吧，"),l("a",{href:"https://github.com/prometheus/prometheus/releases",target:"_blank",rel:"noreferrer"},"下载地址"),s("，我们要下载服务端，也就是这个包")],-1),R=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190702152359.png#mirages-width=1214&mirages-height=339&mirages-cdn-type=5",alt:"20190702152359"})],-1),Q=l("p",null,"我在服务器上直接下载了，下载完后解压移动到别的目录。",-1),W=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# wget https://github.com/prometheus/prometheus/releases/download/v2."),l("span",{style:{color:"#F78C6C"}},"10.0"),l("span",{style:{color:"#A6ACCD"}},"/prometheus-2.10.0.linux-amd64.tar.gz")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# tar zxf prometheus-2.10.0.linux-amd64.tar.gz ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# mv prometheus-2.10.0.linux-amd64 /usr/local/prometheus")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# cd /usr/local/prometheus/ "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"ls")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"console_libraries"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"consoles"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"LICENSE"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"NOTICE"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"prometheus.yml"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"promtool")]),s(`
`),l("span",{class:"line"})])])],-1),H=l("p",null,[s("先配置一下监控本机吧，它默认的配置文件是"),l("code",null,"prometheus.yml"),s("，已经配置好了，也就是这一段，")],-1),K=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"# metrics_path defaults to '/metrics'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"# scheme defaults to 'http'.")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),V=l("p",null,[l("code",null,"targets"),s("就是一个作业，也就是被监控端，监控本机的"),l("code",null,"9090"),s("端口，启动选项也有很多，了解一下，主要是关注两点，分别如下。")],-1),J=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#FFCB6B"}},'--storage.tsdb.path="data/"'),l("span",{style:{color:"#A6ACCD"}},"   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##存储数据的目录，默认/data")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#FFCB6B"}},"--storage.tsdb.retention.time"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##数据存储时间，默认15天")]),s(`
`),l("span",{class:"line"})])])],-1),Y=l("p",null,[s("这里提一下存储的问题，"),l("code",null,"TSDB"),s("不太适合长期去存储数据，数据量大了支持并不是很好，官方声明也是不会对这一块存储进行改善，给你的建议是使用外部存储，譬如使用"),l("code",null,"InfluxDB"),s("，这里暂时就不改他的默认存储了，把他进入系统服务吧，写一个"),l("code",null,"systemd"),s("的配置文件，直接启动了")],-1),Z=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," /usr/lib/systemd/system/prometheus.service "),l("span",{style:{color:"#89DDFF"}},"<<OEF"),l("span",{style:{color:"#C3E88D"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Unit]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Description=prometheus server daemon")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Service]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Restart=on-failure")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Install]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> WantedBy=multi-user.target")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> OEF")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"[root@rj-bai /usr/local/prometheus]# systemctl daemon-reload && systemctl start prometheus.service")]),s(`
`),l("span",{class:"line"})])])],-1),X=l("p",null,[s("这样就启动了撒，去访问"),l("code",null,"9090"),s("端口就可以看到页面了，这个页面能看到的东西很多，自己点点看吧，能看到这个页面就表示莫得问题。")],-1),ll=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190702163712.png#mirages-width=1845&mirages-height=454&mirages-cdn-type=5",alt:"20190702163712"})],-1),sl=l("p",null,"目前使用二进制部署主要是因为方便改配置文件，下面开始看配置文件。",-1),ol=l("h2",{id:"全局配置文件介绍",tabindex:"-1"},[s("全局配置文件介绍 "),l("a",{class:"header-anchor",href:"#全局配置文件介绍","aria-hidden":"true"},"#")],-1),el=l("p",null,[l("code",null,"prometheus"),s(" 已经安装起来了，下面看一下配置文件与核心功能，很多功能都是通过配置文件去实现的，比较多，所以先熟悉一下他的配置文件。")],-1),nl=l("h3",{id:"全局配置文件",tabindex:"-1"},[s("全局配置文件 "),l("a",{class:"header-anchor",href:"#全局配置文件","aria-hidden":"true"},"#")],-1),al=l("p",null,[s("也就是"),l("code",null,"prometheus.yml"),s("，官方说明"),l("a",{href:"https://prometheus.io/docs/prometheus/latest/configuration/configuration/",target:"_blank",rel:"noreferrer"},"地址"),s("，大概分为这几块，我把注释去掉了，全局配置选项")],-1),tl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"scrape_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<duration> | default = 1m"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##采集间隔")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"scrape_timeout"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<duration> | default = 10s"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##采集超时时间")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"evaluation_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<duration> | default = 1m"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##告警评估周期")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"external_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##外部标签             ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"<labelname>"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<labelvalue> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),cl=l("p",null,"指定告警规则",-1),rl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"rule_files"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<filepath_glob> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),pl=l("p",null,"配置被监控端",-1),Dl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<scrape_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),yl=l("p",null,"配置告警方式",-1),il=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"alerting"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"alert_relabel_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<relabel_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"alertmanagers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<alertmanager_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Cl=l("p",null,"指定远程存储",-1),Fl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"remote_write"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<remote_write> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"remote_read"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<remote_read> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Al=l("p",null,[s("这就是一个整体的配置文件，现在再看默认的配置文件就能看懂某一段是干啥的了，现在开始配置"),l("code",null,"scrape_configs")],-1),ul=l("h3",{id:"scrape-configs",tabindex:"-1"},[s("scrape_configs "),l("a",{class:"header-anchor",href:"#scrape-configs","aria-hidden":"true"},"#")],-1),dl=l("p",null,"这块就是来配置我们要监控的东西，在这一块中配置的东西又有很多了，看一下官方的，一堆，我还是去掉注释分段贴出来吧。",-1),ml=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<job_name>"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##指定job名字")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"scrape_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<duration> | default = <global_config.scrape_interval>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"scrape_timeout"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<duration> | default = <global_config.scrape_timeout>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##这两段指定采集时间，默认继承全局")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"metrics_path"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<path> | default = /metrics"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##metrics路径，默认metrics")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"honor_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<boolean> | default = false"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##默认附加的标签，默认不覆盖")]),s(`
`),l("span",{class:"line"})])])],-1),gl=l("p",null,[s("它默认暴露监控数据的接口就是"),l("code",null,"ip:9090/metrics"),s("，你可以去指定这个名称，访问一下这里看看，")],-1),hl=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190702171903.png#mirages-width=647&mirages-height=399&mirages-cdn-type=5",alt:"20190702171903"})],-1),_l=l("p",null,[s("在"),l("code",null,"ip:9090/targets"),s("能看到当前监控的主机，现在只有本机一个，标签显示也在这里。")],-1),El=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190702171956.png#mirages-width=1450&mirages-height=277&mirages-cdn-type=5",alt:"20190702171956"})],-1),bl=l("p",null,"在看下一段，这里定义的是要如何去访问采集目标",-1),fl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"scheme"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<scheme> | default = http"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 默认使用http方式去访问")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"params"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"<string>"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"<string>"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"..."),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 配置访问时携带的参数")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"basic_auth"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"username"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<string>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"password"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<secret>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"password_file"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<string>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 配置访问接口的用户名密码")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"bearer_token"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<secret>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"bearer_token_file"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/path/to/bearer/token/file"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##指定认证token")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"tls_config"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<tls_config>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"                     "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 指定CA证书")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"proxy_url"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<string>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 使用代理模式访问目标")]),s(`
`),l("span",{class:"line"})])])],-1),vl=l("p",null,"下一段，服务发现配置，贴了几个，不是完整的",-1),xl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"consul_sd_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##通过consul去发现")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<consul_sd_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"dns_sd_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##通过DNS去发现")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<dns_sd_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"file_sd_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##通过文件去发现")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<file_sd_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"kubernetes_sd_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"               "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##通过kubernetes去发现")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<kubernetes_sd_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),wl=l("p",null,"静态配置被监控端",-1),kl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<static_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Pl=l("p",null,"刚刚监控本机的就是静态配置去监控的，也是就这一段，",-1),ql=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Bl=l("p",null,"最后标签配置",-1),jl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"relabel_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<relabel_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##在数据采集前对标签进行重新标记")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"metric_relabel_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," - "),l("span",{style:{color:"#C3E88D"}},"<relabel_config> ..."),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##在数据采集之后对标签进行重新标记")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"sample_limit"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<int> | default = 0"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##采集样本数量，默认0")]),s(`
`),l("span",{class:"line"})])])],-1),Sl=l("p",null,[s("下面看一下"),l("code",null,"relabel_configs")],-1),$l=l("h3",{id:"relabel-configs",tabindex:"-1"},[s("relabel_configs "),l("a",{class:"header-anchor",href:"#relabel-configs","aria-hidden":"true"},"#")],-1),Ul=l("p",null,[s("就是用来重新打标记的，对于"),l("code",null,"prometheus"),s(" 数据模型最关键点就是一个指标名称和一组标签来组成一个多维度的数据模型，你想完成一个复杂的查询就需要你有很多维度，"),l("code",null,"relabel_configs"),s(" 就是对标签进行处理的，他能帮你在数据采集之前对任何目标的标签进行修改，重打标签的意义就是如果标签有重复的可以帮你重命名，看一哈现在的，上面铁锅")],-1),Tl=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708111918.png#mirages-width=1855&mirages-height=455&mirages-cdn-type=5",alt:"20190708111918"})],-1),Il=l("p",null,[s("现在"),l("code",null,"instance"),s("是他默认给我加的标签，想改的话就需要"),l("code",null,"relabel_configs"),s("去帮你重打标签，他也可以删除标签，如果某个标签用不到了也可以删掉，再就是过滤标签，再看一下"),l("code",null,"relabel_configs"),s("的配置有哪些，也就是这一段")],-1),Ol=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"relabel_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"source_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<labelname>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"[,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"..."),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"]"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##源标签，指定对哪个现有标签进行操作")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"separator"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<string> | default = ;"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##多个源标签时连接的分隔符")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"target_label"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<labelname>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##要将源标签换成什么名字")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"regex"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<regex> | default = (.*)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"              "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##怎么来匹配源标签，默认匹配所有")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"modulus"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<uint64>"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"                            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##不怎么会用到")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"replacement"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<string> | default = $1"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##替换正则表达式匹配到的分组，分组引用$1,$2,$3")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"<relabel_action> | default = replace"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##基于正则表达式匹配执行的操作，默认替换")]),s(`
`),l("span",{class:"line"})])])],-1),Nl=l("p",null,[s("这东西到底怎么用，做个演示，根据两台服务器聚合查看"),l("code",null,"CPU"),s("使用率，说白了就是同时去查看这两台服务器的"),l("code",null,"CPU"),s("利用率，用这个标签就可以实现了。")],-1),Gl=l("h4",{id:"添加标签",tabindex:"-1"},[s("添加标签 "),l("a",{class:"header-anchor",href:"#添加标签","aria-hidden":"true"},"#")],-1),zl=l("p",null,[s("去"),l("code",null,"WEB"),s("界面看一下当前被监控端"),l("code",null,"CPU"),s("使用率，用"),l("code",null,"sql"),s("去查，也就是这个值。")],-1),Ml=l("p",null,[l("img",{src:"https://res.rj-bai.com/201907/20190708111918.png",alt:"20190708111918"})],-1),Ll=l("p",null,[s("可以看到一个度量名称和两个默认附加的标签，我现在想统计两台服务器的"),l("code",null,"CPU"),s("使用率，就需要加一个标签了，说白了就是添加一个维度去获取这两台服务器"),l("code",null,"CPU"),s("使用率，接下来去改配置文件吧，给他加个标签，如下，")],-1),Rl=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"labels"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#F07178"}},"server"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"local"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"})])])],-1),Ql=l("p",null,"热更新一下，",-1),Wl=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# ps aux "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"prometheus.yml"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-v"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"grep"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"{"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"print $2"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kill"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-hup")]),s(`
`),l("span",{class:"line"})])])],-1),Hl=l("p",null,"看一下有没有生效，刷新一下页面就能看到了，",-1),Kl=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708113120.png#mirages-width=694&mirages-height=480&mirages-cdn-type=5",alt:"20190708113120"})],-1),Vl=l("p",null,"然后可以根据这个标签去查了，语法是这样的，内置函数，",-1),Jl=l("div",{class:"language-"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},'sum(process_cpu_seconds_total{server="local"})')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}})])])])],-1),Yl=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708113824.png#mirages-width=1214&mirages-height=413&mirages-cdn-type=5",alt:"201907081124"})],-1),Zl=l("p",null,[s("所以就算你有"),l("code",null,"N"),s("个被监控的服务器打上这个标签之后在这里就可以看到总数了，添加标签很简单，下面看一下重命名标签，就是将现有的标签进行重命名。")],-1),Xl=l("h4",{id:"标签重命名",tabindex:"-1"},[s("标签重命名 "),l("a",{class:"header-anchor",href:"#标签重命名","aria-hidden":"true"},"#")],-1),ls=l("p",null,[s("就是将一个已有的标签重命名一个新的标签，实际操作一下，之前的标签去掉了，现在要把"),l("code",null,"job_name"),s("改个名字，也就是这一块的配置，")],-1),ss=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),os=l("p",null,[s("目前"),l("code",null,"job_name"),s("为"),l("code",null,"prometheus"),s("，当前这个虚拟机是跑在"),l("code",null,"IP"),s("地址为"),l("code",null,"21"),s("的物理机上，所以现在把他的"),l("code",null,"job_name"),s("改成"),l("code",null,"server21"),s("，")],-1),es=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"server21"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),ns=l("p",null,"重启一下，刷新页面就可以看到了，",-1),as=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708160319.png#mirages-width=1543&mirages-height=371&mirages-cdn-type=5",alt:"20190708160319"})],-1),ts=l("p",null,[s("我现在要将"),l("code",null,"job"),s("这个标签标记为"),l("code",null,"local"),s("，也就是将"),l("code",null,'job="server21'),s("改为"),l("code",null,'local="server21'),s("，下面开始用"),l("code",null,"relabel"),s("进行重命名，改完之后的配置是这样的，")],-1),cs=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"server21"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"relabel_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"replace")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"source_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"job"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##源标签")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"regex"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"(.*)"),l("span",{style:{color:"#A6ACCD"}},"             "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##正则，会匹配到job值，也就是server21")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"replacement"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"$1"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##引用正则匹配到的内容，也就是server21")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"target_label"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"local"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##赋予新的标签，名为local")]),s(`
`),l("span",{class:"line"})])])],-1),rs=l("p",null,"这样就可以了撒，重新加载一下，看页面，",-1),ps=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708161317.png#mirages-width=617&mirages-height=368&mirages-cdn-type=5",alt:"20190708161317"})],-1),Ds=l("p",null,"新的数据已经有了，之前的标签还会保留，因为没有配置删除他，这样就可以了，现在就可以聚合了，",-1),ys=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708161530.png#mirages-width=1136&mirages-height=419&mirages-cdn-type=5",alt:"20190708161530"})],-1),is=l("p",null,"这样他就会将所有实例使用率相加求和。",-1),Cs=l("h4",{id:"action重新打标签动作",tabindex:"-1"},[s("action重新打标签动作 "),l("a",{class:"header-anchor",href:"#action重新打标签动作","aria-hidden":"true"},"#")],-1),Fs=l("p",null,"如表所示，上面就是用了一个默认的。",-1),As=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"值"),l("th",null,"描述")])]),l("tbody",null,[l("tr",null,[l("td",null,"replace"),l("td",null,"默认，通过正则匹配source_label的值，使用replacement来引用表达式匹配的分组")]),l("tr",null,[l("td",null,"keep"),l("td",null,"删除regex于链接不匹配的目标source_labels")]),l("tr",null,[l("td",null,"drop"),l("td",null,"删除regex与连接匹配的目标source_labels")]),l("tr",null,[l("td",null,"labeldrop"),l("td",null,"匹配Regex所有标签名称")]),l("tr",null,[l("td",null,"labelkeep"),l("td",null,"匹配regex所有标签名称")]),l("tr",null,[l("td",null,"hashmod"),l("td",null,"设置target_label为modulus连接的哈希值source_lanels")]),l("tr",null,[l("td",null,"labelmap"),l("td",null,[s("匹配regex所有标签名称，复制匹配标签的值分组，replacement分组引用("),l("span",{class:"katex"},[l("span",{class:"katex-mathml"},[l("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[l("semantics",null,[l("mrow",null,[l("mn",null,"1"),l("mo",{separator:"true"},",")]),l("annotation",{encoding:"application/x-tex"},"{1},")])])]),l("span",{class:"katex-html","aria-hidden":"true"},[l("span",{class:"base"},[l("span",{class:"strut",style:{height:"0.8389em","vertical-align":"-0.1944em"}}),l("span",{class:"mord"},[l("span",{class:"mord"},"1")]),l("span",{class:"mpunct"},",")])])]),s("{2})替代")])])])],-1),us=l("p",null,"比如说我现在不想采集本机的数据了，就可以用上面的标签进行操作了，加点东西就行了，",-1),ds=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"server21"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"relabel_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"replace")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"source_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"job"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"regex"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"(.*)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"replacement"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"$1")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"target_label"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"local")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"drop")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"source_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"job"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),ms=l("p",null,[s("删除标签为"),l("code",null,"job"),s("的节点，目前只有一个节点，所以这个跑了之后就看不到数据了，如果真的要用这个给不需要监控的节点打一个标签，然后在这里匹配就行了，所以现在重新载入的话就没数据了，")],-1),gs=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708164048.png#mirages-width=515&mirages-height=325&mirages-cdn-type=5",alt:"20190708164048"})],-1),hs=l("p",null,"最后看一下删除标签。",-1),_s=l("h4",{id:"删除标签",tabindex:"-1"},[s("删除标签 "),l("a",{class:"header-anchor",href:"#删除标签","aria-hidden":"true"},"#")],-1),Es=l("p",null,[s("刚刚我新打了一个标签，也就是"),l("code",null,"local"),s("标签，所以之前的"),l("code",null,"job"),s("标签可以不要了，下面直接给他删了吧，")],-1),bs=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"server21"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"relabel_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"replace")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"source_labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"job"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"regex"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"(.*)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"replacement"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"$1")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"target_label"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"local")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"action"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"labeldrop"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"regex"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"job")]),s(`
`),l("span",{class:"line"})])])],-1),fs=l("p",null,[s("重载一下就看到"),l("code",null,"job"),s("的标签了。")],-1),vs=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708164600.png#mirages-width=467&mirages-height=413&mirages-cdn-type=5",alt:"20190708164600"})],-1),xs=l("p",null,"这样就可以了撒，下面看看基于文件的服务发现功能",-1),ws=l("h3",{id:"基于文件的服务发现",tabindex:"-1"},[s("基于文件的服务发现 "),l("a",{class:"header-anchor",href:"#基于文件的服务发现","aria-hidden":"true"},"#")],-1),ks=l("p",null,[s("下面会涉及到基于文件的服务发现，还有就是基于"),l("code",null,"kubernetes"),s("的服务发现，这个到监控"),l("code",null,"k8s"),s("集群的时候再说吧，先看基于文件的吧，现在还没准备别的服务器，还是发现本身吧，先把配置文件改成这样，重载之后就看不到本机了。")],-1),Ps=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat prometheus.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"scrape_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"evaluation_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"alerting"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"alertmanagers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"rule_files"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),qs=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708171041.png#mirages-width=942&mirages-height=299&mirages-cdn-type=5",alt:"20190708171041"})],-1),Bs=l("p",null,"然后就可以去改配置文件了，通过服务发现将自身加入进去，",-1),js=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat prometheus.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"scrape_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"evaluation_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"alerting"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"alertmanagers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"rule_files"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"scrape_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"prometheus"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"file_sd_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"files"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"/usr/local/prometheus/files_sd_configs/*.yaml"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##指定服务发现文件位置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#F07178"}},"refresh_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5s"),l("span",{style:{color:"#A6ACCD"}},"                                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##刷新间隔改为5秒")]),s(`
`),l("span",{class:"line"})])])],-1),Ss=l("p",null,[s("重载服务，然后去写服务发现的"),l("code",null,"YAML"),s("文件吧，")],-1),$s=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus/files_sd_configs"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat configs.yml"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost:9090"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"labels"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"server21")]),s(`
`),l("span",{class:"line"})])])],-1),Us=l("p",null,"这样就可以了，文件保存五秒后就能看到发现的主机了，查数据也没问题",-1),Ts=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708173554.png#mirages-width=1234&mirages-height=334&mirages-cdn-type=5",alt:"20190708173554"})],-1),Is=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708173611.png#mirages-width=1432&mirages-height=254&mirages-cdn-type=5",alt:"20190708173611"})],-1),Os=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190708173654.png#mirages-width=940&mirages-height=419&mirages-cdn-type=5",alt:"20190708173654"})],-1),Ns=l("p",null,[s("就是这种原理，下面开始监控"),l("code",null,"linux"),s("和一些服务吧")],-1),Gs=l("h2",{id:"监控栗子",tabindex:"-1"},[s("监控栗子 "),l("a",{class:"header-anchor",href:"#监控栗子","aria-hidden":"true"},"#")],-1),zs=l("h3",{id:"监控linux服务器",tabindex:"-1"},[s("监控linux服务器 "),l("a",{class:"header-anchor",href:"#监控linux服务器","aria-hidden":"true"},"#")],-1),Ms=l("p",null,[l("code",null,"emmmm"),s("，在被监控端需要装一个名为"),l("code",null,"node_exporter"),s("的导出器，他会帮你收集系统指标和一些软件运行的指标，把指标暴露出去，这样"),l("code",null,"prometheus"),s("就可以去采集了，具体"),l("code",null,"node_exporter"),s("能采集哪些东西，看官方的"),l("a",{href:"https://github.com/prometheus/node_exporter",target:"_blank",rel:"noreferrer"},[l("code",null,"github")]),s("吧，还是蛮多的，现在随便找个服务器下载一下"),l("code",null,"node_exporter"),s("运行起来就行了。")],-1),Ls=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# wget https://github.com/prometheus/node_exporter/releases/download/v0."),l("span",{style:{color:"#F78C6C"}},"18.1"),l("span",{style:{color:"#A6ACCD"}},"/node_exporter-0.18.1.linux-amd64.tar.gz")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# tar zxf node_exporter-0.18.1.linux-amd64.tar.gz ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# mv node_exporter-0.18.1.linux-amd64 /usr/local/node_exporter")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# cd /usr/local/node_exporter")]),s(`
`),l("span",{class:"line"})])])],-1),Rs=l("p",null,"在启动之前看一下他的启动参数，",-1),Qs=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node /usr/local/node_exporter"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# ./node_exporter --help")]),s(`
`),l("span",{class:"line"})])])],-1),Ws=l("p",null,[s("可以看到一堆，她就是一个收集器，配置你要收集或不收集哪些信息，看"),l("code",null,"default"),s("就能看出来撒，加到系统服务中吧，用"),l("code",null,"systemctl"),s("去管理。")],-1),Hs=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node /usr/local/node_exporter"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," /usr/lib/systemd/system/node_exporter.service "),l("span",{style:{color:"#89DDFF"}},"<<OEF"),l("span",{style:{color:"#C3E88D"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Unit]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Description=node_exporter")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Service]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Restart=on-failure")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ExecStart=/usr/local/node_exporter/node_exporter")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Install]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> WantedBy=multi-user.target")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> OEF")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"[root@kubeadm-node /usr/local/node_exporter]# systemctl daemon-reload ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"[root@kubeadm-node /usr/local/node_exporter]# systemctl start node_exporter.service")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"[root@kubeadm-node /usr/local/node_exporter]# curl -s 127.0.0.1:9100/metrics | head ")]),s(`
`),l("span",{class:"line"})])])],-1),Ks=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709105800.png#mirages-width=766&mirages-height=390&mirages-cdn-type=5",alt:"20190709105800"})],-1),Vs=l("p",null,[s("正常启动了撒，现在要配置"),l("code",null,"prometheus"),s("来监控这个主机了，之前配置过动态发现了，现在再加一个，把服务端和被监控端分开，所以新加了这个。")],-1),Js=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat prometheus.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#FFCB6B"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"job_name:"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"nodes"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#FFCB6B"}},"file_sd_configs:"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#FFCB6B"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"files:"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"/usr/local/prometheus/nodes_sd_configs/*.yml"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#FFCB6B"}},"refresh_interval:"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# mkdir nodes_sd_configs "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"cd"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"nodes_sd_configs")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# ps aux "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"prometheus.yml"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-v"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"grep"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"{"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"print $2"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kill"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-hup")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/prometheus/nodes_sd_configs"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat nodes.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"targets:"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"192.168.1.248:9100"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#FFCB6B"}},"labels:")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#FFCB6B"}},"name:"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"server20")]),s(`
`),l("span",{class:"line"})])])],-1),Ys=l("p",null,"直接去看页面吧，应该已经添加进去了，顺便查一下数据",-1),Zs=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709111843.png#mirages-width=1390&mirages-height=400&mirages-cdn-type=5",alt:"20190709111843"})],-1),Xs=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709112040.png#mirages-width=851&mirages-height=441&mirages-cdn-type=5",alt:"20190709112040"})],-1),lo=l("p",null,[s("这样就可以了，莫得问题，下面用"),l("code",null,"PromSQL"),s("获取"),l("code",null,"CPU&"),s("内存硬盘使用率")],-1),so=l("h3",{id:"使用promsql",tabindex:"-1"},[s("使用PromSQL "),l("a",{class:"header-anchor",href:"#使用promsql","aria-hidden":"true"},"#")],-1),oo=l("p",null,[s("想查数据就需要写"),l("code",null,"PromSQL"),s("去查询了，")],-1),eo=l("h4",{id:"查询cpu使用率",tabindex:"-1"},[s("查询CPU使用率 "),l("a",{class:"header-anchor",href:"#查询cpu使用率","aria-hidden":"true"},"#")],-1),no=l("p",null,[s("比如果我想查看刚刚加进来的"),l("code",null,"nodes CPU"),s("利用率，以"),l("code",null,"node"),s("开头的"),l("code",null,"sql"),s("都是"),l("code",null,"node_expores"),s("采集的指标，度量很多，看"),l("code",null,"CPU"),s("使用率看着一个指标就够了，")],-1),ao=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709112714.png#mirages-width=1723&mirages-height=923&mirages-cdn-type=5",alt:""})],-1),to=l("p",null,[s("总"),l("code",null,"CPU"),s("使用情况，会列出你处理器多少核，每个核的使用情况，这个CPU是干什么使用的，用户态还是内核态还是操作"),l("code",null,"IO"),s("等待的时间，还有优先级调度使用的"),l("code",null,"CPU"),s("，他会通过一个名为"),l("code",null,"mode"),s("的标签去区分这些，一般不会这么去统计，现在统计一下刚刚加进去的那个"),l("code",null,"nodes"),s("五分钟之内"),l("code",null,"CPU"),s("平均使用率是多少，还是得写"),l("code",null,"PromSQL"),s("，大概是这样，")],-1),co=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," irate(node_cpu_seconds_total{mode"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"idle"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"}[5m])"),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#F78C6C"}},"100")]),s(`
`),l("span",{class:"line"})])])],-1),ro=l("p",null,[l("code",null,"emmm"),s("，"),l("code",null,'node_cpu_seconds_total{mode="idle"}[5m]'),s("这一段是统计出了服务器最近5分钟"),l("code",null,"CPU"),s("的空闲率，执行之后是这种效果，")],-1),po=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709114438.png#mirages-width=1682&mirages-height=808&mirages-cdn-type=5",alt:"20190709114438"})],-1),Do=l("p",null,[s("这是五分钟之内所有值，然后使用了"),l("code",null,"irate"),s("函数来统计它的平均值，转化成了百分比，乘了一百，所以执行结果如下。")],-1),yo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709114935.png#mirages-width=1761&mirages-height=439&mirages-cdn-type=5",alt:"20190709114935"})],-1),io=l("p",null,[s("这就是所有"),l("code",null,"CPU"),s("的空闲率了，我要取的是所有CPU的使用率，所以又一百减去了空闲率的值就是使用率了，所以上面第一条"),l("code",null,"sql"),s("执行发回的结果如下。")],-1),Co=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709115136.png#mirages-width=1667&mirages-height=420&mirages-cdn-type=5",alt:"20190709115136"})],-1),Fo=l("p",null,[s("这就是五分钟之内总的"),l("code",null,"CPU"),s("的平均使用率了，我的那个节点就是四核"),l("code",null,"CPU"),s("，每个都被列出来了，真鸡儿麻烦，再看一下内存使用率，和上面其实一样，值都有了，求出他的百分比就行了，")],-1),Ao=l("h4",{id:"查询内存使用率",tabindex:"-1"},[s("查询内存使用率 "),l("a",{class:"header-anchor",href:"#查询内存使用率","aria-hidden":"true"},"#")],-1),uo=l("p",null,[l("code",null,"linux"),s("内核有一个内存缓存机制，所以"),l("code",null,"buff/cache"),s("的占用不算是已被使用的物理内存，所以计算方式就是将这三个值加到一起就是剩余内存了，")],-1),mo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709134042.png#mirages-width=611&mirages-height=61&mirages-cdn-type=5",alt:"20190709134042"})],-1),go=l("p",null,[l("code",null,"sql"),s("的话这样写，直接查一下，")],-1),ho=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"node_memory_MemFree_bytes"),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"node_memory_Cached_bytes"),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"node_memory_Buffers_bytes")]),s(`
`),l("span",{class:"line"})])])],-1),_o=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709134504.png#mirages-width=1600&mirages-height=341&mirages-cdn-type=5",alt:"20190709134504"})],-1),Eo=l("p",null,[s("这就是总共剩余的内存，单位是"),l("code",null,"bite"),s("，现在我要计算使用内存百分比，和上面看"),l("code",null,"CPU"),s("使用率的方法一致，"),l("code",null,"sql"),s("如下")],-1),bo=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," (node_memory_MemFree_bytes"),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"node_memory_Cached_bytes"),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"node_memory_Buffers_bytes) "),l("span",{style:{color:"#89DDFF"}},"/"),l("span",{style:{color:"#A6ACCD"}}," node_memory_MemTotal_bytes "),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#F78C6C"}},"100")]),s(`
`),l("span",{class:"line"})])])],-1),fo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709135149.png#mirages-width=1505&mirages-height=408&mirages-cdn-type=5",alt:"20190709135149"})],-1),vo=l("p",null,"下面看看硬盘使用率",-1),xo=l("h4",{id:"查询硬盘使用率",tabindex:"-1"},[s("查询硬盘使用率 "),l("a",{class:"header-anchor",href:"#查询硬盘使用率","aria-hidden":"true"},"#")],-1),wo=l("p",null,"你的磁盘和挂载点可能不止一个，先看一下目前收集到的信息，",-1),ko=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709145758.png#mirages-width=1470&mirages-height=478&mirages-cdn-type=5",alt:"20190709145758"})],-1),Po=l("p",null,"所以就要指定分区进行计算了，所以匹配这里写了一个正则去匹配你挂载的磁盘，如下",-1),qo=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," (node_filesystem_free_bytes{mountpoint"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},",fstype"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"~"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"ext4|xfs"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"} "),l("span",{style:{color:"#89DDFF"}},"/"),l("span",{style:{color:"#A6ACCD"}}," node_filesystem_size_bytes{mountpoint"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},",fstype"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"~"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"ext4|xfs"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"} "),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#A6ACCD"}},")")]),s(`
`),l("span",{class:"line"})])])],-1),Bo=l("p",null,[l("code",null,"node_filesystem_size_bytes"),s("查的是"),l("code",null,"/"),s("总大小，"),l("code",null,"node_filesystem_free_bytes"),s("查的是剩余大小，只匹配"),l("code",null,"ext4&xfs"),s("类型的，像是什么"),l("code",null,"tmpfs&shm"),s("类型的都不匹配，还是算出了剩余的百分比，所以执行后的结果是这样，")],-1),jo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709150539.png#mirages-width=1907&mirages-height=326&mirages-cdn-type=5",alt:"20190709150539"})],-1),So=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709150559.png#mirages-width=1185&mirages-height=254&mirages-cdn-type=5",alt:"20190709150559"})],-1),$o=l("p",null,"计算方式大概就是这样，现在还没涉及到图形展示这一块，下面看一下获取系统服务运行状态。",-1),Uo=l("h4",{id:"查询系统服务运行状态",tabindex:"-1"},[s("查询系统服务运行状态 "),l("a",{class:"header-anchor",href:"#查询系统服务运行状态","aria-hidden":"true"},"#")],-1),To=l("p",null,[s("就是监控系统服务运行状态，说白了就是监控以"),l("code",null,"systemctl"),s("启动的服务，现在监控一下这个，"),l("code",null,"node_exports"),s("就支持对这种服务进行监控，目前还没有启用这个功能，现在启动一下撒，直接去改"),l("code",null,"node_exports"),s("的启动文件，加两条参数即可。")],-1),Io=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# cat /usr/lib/systemd/system/node_exporter.service ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"Unit"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"Description"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"node_exporter")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"Service"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"Restart"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"on-failure")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"ExecStart"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"/usr/local/node_exporter/node_exporter"),l("span",{style:{color:"#A6ACCD"}}," --collector.systemd --collector.systemd.unit-whitelist"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"("),l("span",{style:{color:"#C3E88D"}},"docker"),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#C3E88D"}},"sshd"),l("span",{style:{color:"#A6ACCD"}},")"),l("span",{style:{color:"#C3E88D"}},".service")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"Install"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"WantedBy"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"multi-user.target")]),s(`
`),l("span",{class:"line"})])])],-1),Oo=l("p",null,[s("第二段就是制定我要监控哪些系统服务，我写了"),l("code",null,"docker&sshd"),s("，重启后可以去查询了，")],-1),No=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# systemctl daemon-reload         ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# systemctl restart node_exporter.service ")]),s(`
`),l("span",{class:"line"})])])],-1),Go=l("p",null,[s("我查一下当前"),l("code",null,"docker&sshd"),s("的运行状态是什么，可以直接这样写了，")],-1),zo=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"node_systemd_unit_state{exported_name"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"~"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"(docker|sshd).service"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Mo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709153503.png#mirages-width=1908&mirages-height=601&mirages-cdn-type=5",alt:"20190709153503"})],-1),Lo=l("p",null,[s("目前"),l("code",null,"state=active"),s("的值为"),l("code",null,"0"),s("，说明正常运行，所以之后写告警规则的时候就去判断这个值是不是"),l("code",null,"1"),s("，如果不是就要进行某些操作了，下面装一下"),l("code",null,"grafana"),s("吧")],-1),Ro=l("h3",{id:"部署grafana",tabindex:"-1"},[s("部署grafana "),l("a",{class:"header-anchor",href:"#部署grafana","aria-hidden":"true"},"#")],-1),Qo=l("p",null,[l("code",null,"grafana"),s("就是一个图形展示系统，他主要是对度量指标进行分析可视化，他本身不会存储任何数据，他只会展示数据库里面的数据，支持很多类型的数据库，"),l("a",{href:"https://grafana.com/",target:"_blank",rel:"noreferrer"},"官网"),s("，刚好我装有"),l("code",null,"docker"),s("，其实目前在操作的这两台服务是一个"),l("code",null,"k8s"),s("集群，用"),l("code",null,"kubeadm"),s("启动的，所以我直接用"),l("code",null,"docker"),s("启动了，还是写个"),l("code",null,"deployment"),s("，算了直接用"),l("code",null,"docker"),s("命令启吧，")],-1),Wo=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@kubeadm-node "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# docker run \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," -u "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," -d \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," -p "),l("span",{style:{color:"#F78C6C"}},"3000"),l("span",{style:{color:"#A6ACCD"}},":"),l("span",{style:{color:"#F78C6C"}},"3000"),l("span",{style:{color:"#A6ACCD"}},"  \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," --name"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"grafana"),l("span",{style:{color:"#A6ACCD"}},"   \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," -v /var/lib/grafana:/var/lib/grafana \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," grafana/grafana")]),s(`
`),l("span",{class:"line"})])])],-1),Ho=l("p",null,[s("这样就行了，直接访问"),l("code",null,"3000"),s("端口就好了，用户名密码默认"),l("code",null,"admin/admin"),s("，初次登陆会让你修改密码，就可以看到主页了，然后直接添加数据源，把"),l("code",null,"prometheus"),s("加进去，保存就行了，")],-1),Ko=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709163321.png#mirages-width=556&mirages-height=777&mirages-cdn-type=5",alt:"20190709163321"})],-1),Vo=l("p",null,[s("然后直接导入一个仪表盘进来吧，"),l("code",null,"ID"),s("是"),l("code",null,"9276"),s("，大概是这种效果，")],-1),Jo=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709173630.png#mirages-width=1786&mirages-height=883&mirages-cdn-type=5",alt:"img"})],-1),Yo=l("p",null,[s("然后网络带宽那里没数据，我看了一下他的"),l("code",null,"sql"),s("，只需要将"),l("code",null,"$nic"),s("改为你的网卡名就有数据了，所以现在监控"),l("code",null,"linux"),s("服务器是没问题了，下面试试监控"),l("code",null,"docker"),s("。")],-1),Zo=l("h3",{id:"监控docker",tabindex:"-1"},[s("监控docker "),l("a",{class:"header-anchor",href:"#监控docker","aria-hidden":"true"},"#")],-1),Xo=l("p",null,[s("想要监控"),l("code",null,"docker"),s("需要用到名为"),l("code",null,"cadvisor"),s("的工具，是谷歌开源的，它用于收集正在运行的容器资源使用和性能信息，"),l("a",{href:"https://github.com/google/cadvisor",target:"_blank",rel:"noreferrer"},"github"),s("地址，你需要在要监控的服务器上部署"),l("code",null,"cadvisor"),s("，直接用"),l("code",null,"docker"),s("去启动就完了，命令如下")],-1),le=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"docker"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"run"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--volume=/:/rootfs:ro"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--volume=/var/run:/var/run:ro"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--volume=/sys:/sys:ro"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--volume=/var/lib/docker/:/var/lib/docker:ro"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--volume=/dev/disk/:/dev/disk:ro"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--publish=8080:8080"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--detach=true"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"--name=cadvisor"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"google/cadvisor:latest")]),s(`
`),l("span",{class:"line"})])])],-1),se=l("p",null,[s("容器启动后也是会暴露一个指标接口，默认是"),l("code",null,"8080/metrics"),s("，这里就不访问了，下一步就是加入到普罗米修斯中进行监控了，去改他的配置文件，静态配置一个吧，")],-1),oe=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"docker"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"192.168.1.248:8080"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),ee=l("p",null,[s("加完直接重载，页面直接导入一个图表吧，"),l("code",null,"ID"),s("是"),l("code",null,"193"),s("或者11277再或者11600！！！，效果是这样的，")],-1),ne=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709181607.png#mirages-width=1787&mirages-height=969&mirages-cdn-type=5",alt:"20190709181607"})],-1),ae=l("p",null,[s("主要就是监控容器的"),l("code",null,"CPU"),s("内存网络流量的，都可看到，目前我"),l("code",null,"248"),s("就运行了六个容器，就是这样，下面在看看监控"),l("code",null,"mysql")],-1),te=l("h3",{id:"监控mysql",tabindex:"-1"},[s("监控mysql "),l("a",{class:"header-anchor",href:"#监控mysql","aria-hidden":"true"},"#")],-1),ce=l("p",null,[s("监控"),l("code",null,"mysql"),s("就会用到"),l("code",null,"mysql_exporter"),s("，这个也能在官网下到，也就是"),l("a",{href:"https://prometheus.io/download/#mysqld_exporter",target:"_blank",rel:"noreferrer"},"这里"),s("，这个东西需要你安装到运行"),l("code",null,"mysql"),s("的实例上，本地的"),l("code",null,"mysql"),s("比较多，我随便找了一个扔了上去，先去"),l("code",null,"mysql"),s("创建一个用户吧，这个程序需要连接明月三千里才能获取到指标。")],-1),re=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"mysql"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"CREATE"),l("span",{style:{color:"#A6ACCD"}}," USER "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"exporter"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"@"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," IDENTIFIED "),l("span",{style:{color:"#F78C6C"}},"BY"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"exporter"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"Query OK, "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"rows"),l("span",{style:{color:"#A6ACCD"}}," affected ("),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}},"."),l("span",{style:{color:"#F78C6C"}},"02"),l("span",{style:{color:"#A6ACCD"}}," sec)")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"mysql"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"GRANT"),l("span",{style:{color:"#A6ACCD"}}," PROCESS, REPLICATION CLIENT, "),l("span",{style:{color:"#F78C6C"}},"SELECT"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"ON"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#A6ACCD"}},"."),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"TO"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"exporter"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"@"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"localhost"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"Query OK, "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"rows"),l("span",{style:{color:"#A6ACCD"}}," affected ("),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}},"."),l("span",{style:{color:"#F78C6C"}},"00"),l("span",{style:{color:"#A6ACCD"}}," sec)")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"mysql"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," flush privileges;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"Query OK, "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"rows"),l("span",{style:{color:"#A6ACCD"}}," affected ("),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}},"."),l("span",{style:{color:"#F78C6C"}},"00"),l("span",{style:{color:"#A6ACCD"}}," sec)")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"mysql"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"select"),l("span",{style:{color:"#A6ACCD"}}," user,host "),l("span",{style:{color:"#F78C6C"}},"from"),l("span",{style:{color:"#A6ACCD"}}," mysql.user;")]),s(`
`),l("span",{class:"line"})])])],-1),pe=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709184630.png#mirages-width=476&mirages-height=226&mirages-cdn-type=5",alt:"20190709184630"})],-1),De=l("p",null,"用户创建好了去解压包吧，",-1),ye=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@mysql "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# tar zxf mysqld_exporter-0.11.0.linux-amd64.tar.gz -C /usr/local/ "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"cd"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/usr/local/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@mysql local"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# mv mysqld_exporter-0.11.0.linux-amd64/ mysqld_exporter "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"cd"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"mysqld_exporter")]),s(`
`),l("span",{class:"line"})])])],-1),ie=l("p",null,[s("需要写一个文件，"),l("code",null,"mysqld_exporter"),s("直接读这个文件就可以连接"),l("code",null,"mysql"),s("了，")],-1),Ce=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@mysql mysqld_exporter"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat .my.cnd")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"client"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"user"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"exporter")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"password"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},"exporter")]),s(`
`),l("span",{class:"line"})])])],-1),Fe=l("p",null,"文件有了，在启动的时候指定一下读取这个文件，直接启动",-1),Ae=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@mysql mysqld_exporter"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# ./mysqld_exporter --config.my-cnf"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#C3E88D"}},".my.cnf")]),s(`
`),l("span",{class:"line"})])])],-1),ue=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709185400.png#mirages-width=692&mirages-height=115&mirages-cdn-type=5",alt:"img"})],-1),de=l("p",null,"现在把这个加到普罗米修斯中，",-1),me=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"mysql"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"192.168.1.126:9104"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),ge=l("p",null,[s("然后导入一个仪表盘，"),l("code",null,"ID"),s("为"),l("code",null,"7362"),s("，看页面，")],-1),he=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190709190259.png#mirages-width=1795&mirages-height=900&mirages-cdn-type=5",alt:"img"})],-1),_e=l("p",null,[s("还是有些空值，而且官方也说了"),l("code",null,"5.6"),s("版本有些不支持，我看了一下"),l("code",null,"Buffer Pool Size of Total RAM"),s("的"),l("code",null,"sql"),s("，是这样写的，")],-1),Ee=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"(mysql_global_variables_innodb_buffer_pool_size{instance"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"$host"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"} "),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#A6ACCD"}},") "),l("span",{style:{color:"#89DDFF"}},"/"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"on"),l("span",{style:{color:"#A6ACCD"}}," (instance) node_memory_MemTotal_bytes{instance"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"$host"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),be=l("p",null,[s("现在应该能看的差不多了，他去查了"),l("code",null,"mysql"),s("节点的总内存，但是我明月三千里节点并没有装"),l("code",null,"node_exports"),s("，所以就没数据了，总之支持采集的数据和仪表盘模板很多，自行琢磨吧，上面只是最简单的几个例子，下面来看看告警这一块的东西。")],-1),fe=l("h2",{id:"alertmanager",tabindex:"-1"},[s("alertmanager "),l("a",{class:"header-anchor",href:"#alertmanager","aria-hidden":"true"},"#")],-1),ve=l("p",null,[s("普罗米修斯本身是不支持告警的，告警是由"),l("code",null,"alertmanager"),s("这个组件完成的，普罗米修斯将告警收集起来会推送给"),l("code",null,"alertmanager"),s("，"),l("code",null,"alertmanager"),s("接收到告警后决定怎么去处理这些告警，应该发给谁，下面先部署一下"),l("code",null,"alertmanager"),s("吧，我直接下载了，在普罗米修斯服务器上，")],-1),xe=l("h3",{id:"部署alertmanager",tabindex:"-1"},[s("部署alertmanager "),l("a",{class:"header-anchor",href:"#部署alertmanager","aria-hidden":"true"},"#")],-1),we=l("p",null,[l("code",null,"alertmanager"),s("没必要和普罗米修斯放在一个服务器上，他们之间能通讯就可以了，我目前资源紧张就扔到一起了，直接"),l("code",null,"wget"),s("了，")],-1),ke=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# wget https://github.com/prometheus/alertmanager/releases/download/v0."),l("span",{style:{color:"#F78C6C"}},"18.0"),l("span",{style:{color:"#A6ACCD"}},"/alertmanager-0.18.0.linux-amd64.tar.gz")]),s(`
`),l("span",{class:"line"})])])],-1),Pe=l("p",null,[s("让他先下着，聊一下普罗米修斯和"),l("code",null,"alertmanager"),s("是怎么通讯的，首先你需要在"),l("code",null,"prometheus"),s("中定义你的监控规则，说白了就是写一个触发器，某个值超过了我设置的阈值我就要告警了，触发告警之后"),l("code",null,"prometheus"),s("会推送当前的告警规则到"),l("code",null,"alertmanager"),s("，"),l("code",null,"alertmanager"),s("收到了会进行一系列的流程处理，然后发送到接收人手里，他的处理规则也是很复杂的，后面会说，现在也下载完了，解压")],-1),qe=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# tar zxf alertmanager-0.18.0.linux-amd64.tar.gz ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai "),l("span",{style:{color:"#89DDFF"}},"~]"),l("span",{style:{color:"#A6ACCD"}},"# mv alertmanager-0.18.0.linux-amd64 /usr/local/alertmanager "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"cd"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/usr/local/alertmanager"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"&&"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"ls")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"alertmanager"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"alertmanager.yml"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"amtool"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"LICENSE"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"NOTICE")]),s(`
`),l("span",{class:"line"})])])],-1),Be=l("p",null,"有两个二进制文件，分别是启动程序和一个工具，还有一个主配置文件，先来了解一下他的主配置文件，",-1),je=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"resolve_timeout"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"})])])],-1),Se=l("p",null,"全局配置，设置解析超时时间，",-1),$e=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##alertmanager中的分组，选哪个标签作为分组的依据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s"),l("span",{style:{color:"#A6ACCD"}},"              "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##分组等待时间，拿到第一条告警后等待10s，如果有其他的一起发送出去")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##各个分组之前发搜告警的间隔时间")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1h"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##重复告警时间，默认1小时")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"web.hook"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##接收者")]),s(`
`),l("span",{class:"line"})])])],-1),Ue=l("p",null,"这里是配置告警的，配置告警怎么发送，怎么来分配，",-1),Te=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"receivers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"web.hook"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"webhook_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"url"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"http://127.0.0.1:5001/"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),Ie=l("p",null,"这里是配置告警的接收者，我要发送给谁，",-1),Oe=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"inhibit_rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"source_match"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"critical"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"target_match"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"warning"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"equal"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"dev"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"instance"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Ne=l("p",null,[s("这里用于配置告警收敛的，主要就是减少发送告警，来发送一些关键的，所以先把这段注释了吧，暂时用不到，之后会用到，所以基于这个配置文件改改，暂时先发送"),l("code",null,"email"),s("吧，所以改完的配置文件如下，")],-1),Ge=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/alertmanager"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat alertmanager.yml"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"resolve_timeout"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_smarthost"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"smtp.163.com:25"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#smtp服务地址")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_from"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@163.com"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#发送邮箱")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_auth_username"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@163.com"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#认证用户名")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_auth_password"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxxx"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#认证密码")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_require_tls"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FF9CAC"}},"false"),l("span",{style:{color:"#A6ACCD"}},"                   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#禁用tls")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"email"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#定义接受告警组名")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"receivers"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                  ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"email"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#定义组名")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#配置邮件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xx@xxx.com"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                     "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#收件人")]),s(`
`),l("span",{class:"line"})])])],-1),ze=l("p",null,"保存后检查一下这个文件有没有问题，命令如下，",-1),Me=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/alertmanager"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# ./amtool check-config alertmanager.yml ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"Checking"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertmanager.yml"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"SUCCESS")]),s(`
`),l("span",{class:"line"})])])],-1),Le=l("p",null,"然后去启动吧，还是加到系统服务中吧，",-1),Re=l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"root@rj-bai /usr/local/alertmanager"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# cat "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," /usr/lib/systemd/system/alertmanager.service "),l("span",{style:{color:"#89DDFF"}},"<<OEF"),l("span",{style:{color:"#C3E88D"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Unit]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Description=alertmanager")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Service]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> Restart=on-failure")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ExecStart=/usr/local/alertmanager/alertmanager --config.file=/usr/local/alertmanager/alertmanager.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> [Install]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> WantedBy=multi-user.target")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"> OEF")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C3E88D"}},"[root@rj-bai /usr/local/alertmanager]# systemctl start alertmanager")]),s(`
`),l("span",{class:"line"})])])],-1),Qe=l("p",null,[s("现在"),l("code",null,"alertmanager"),s("是装完了，需要和"),l("code",null,"prometheus"),s("融合一下，需要配置两部分，分别如下，")],-1),We=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"alerting"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"alertmanagers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"       "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"127.0.0.1:9093"),l("span",{style:{color:"#A6ACCD"}},"   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##配置alertmanager地址，我的在本机")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"rule_files"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"rules/*.yml"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##配置告警规则的文件")]),s(`
`),l("span",{class:"line"})])])],-1),He=l("p",null,[s("配置这两项就够了，保存之后创建"),l("code",null,"rules"),s("目录，接下来就可以配置告警规则了。")],-1),Ke=l("h3",{id:"配置告警规则并邮件通知",tabindex:"-1"},[s("配置告警规则并邮件通知 "),l("a",{class:"header-anchor",href:"#配置告警规则并邮件通知","aria-hidden":"true"},"#")],-1),Ve=l("p",null,"我直接在官方复制过来了一个例子顺便改了改，如下，",-1),Je=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus/rules"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat example.yml")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"groups"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"exports.rules"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##定义这组告警的组名，同性质的，都是监控实例exports是否开启的模板")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"alert"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"采集器凉了"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 告警名称")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"expr"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"up == 0"),l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 告警表达式，监控up指标，如果等于0就进行下面的操作")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"for"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m"),l("span",{style:{color:"#A6ACCD"}},"              "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 持续一分钟为0进行告警")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"labels"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"              "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 定义告警级别")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ERROR")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"annotations"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"         "),l("span",{style:{color:"#676E95","font-style":"italic"}},"## 定义了告警通知怎么写，默认调用了{$labels.instance&$labels.job}的值")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"summary"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"实例 {{ $labels.instance }} 采集器凉了撒"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"description"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"实例 {{ $labels.instance }} job 名为 {{ $labels.job }} 的采集器凉了有一分钟了撒"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"})])])],-1),Ye=l("p",null,[s("每个实例都会有一个"),l("code",null,"up"),s("的指标，上面的标签名"),l("code",null,"job"),s("都能看到，用"),l("code",null,"sql"),s("去查一下，")],-1),Ze=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711145721.png#mirages-width=1720&mirages-height=403&mirages-cdn-type=5",alt:"img"})],-1),Xe=l("p",null,[s("采集器在开启状态下返回值就是"),l("code",null,"1"),s("，如果采集器出现问题没启动或是什么别的异常都会返回"),l("code",null,"0"),s("，"),l("code",null,"0"),s("就是代表异常了，所以说白了就是那条规则就是监控所有实例的"),l("code",null,"up"),s("指标，如果指标值为"),l("code",null,"0"),s("且持续时间超过一分钟我就要告警了，保存吧，直接重启"),l("code",null,"prometheus"),s("吧，重启之后可以在"),l("code",null,"web"),s("控制台看到你配置的规则了，")],-1),ln=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711152123.png#mirages-width=1840&mirages-height=360&mirages-cdn-type=5",alt:"img"})],-1),sn=l("p",null,[s("emmmm，既然配置完了，验证一下吧，随便关掉一个采集器，等邮件就行了，我把明月三千里的关掉了，然后发现有一条告警处于"),l("code",null,"PENDING"),s("状态，他已经准备去通知"),l("code",null,"alertmanager"),s("了，")],-1),on=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711153136.png#mirages-width=1834&mirages-height=466&mirages-cdn-type=5",alt:""})],-1),en=l("p",null,"一分钟之后我收到邮件了，长这样，",-1),nn=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711154859.png#mirages-width=1120&mirages-height=578&mirages-cdn-type=5",alt:"20190711154859"})],-1),an=l("p",null,[s("如果问题没解决他每分钟都会给你发一封邮件，刚刚配置了，发送邮件的等待时间一会会细说一下，我再停一个，我再把"),l("code",null,"docker"),s("停了，看看他发出的邮件是什么样的，")],-1),tn=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711155830.png#mirages-width=1118&mirages-height=766&mirages-cdn-type=5",alt:"img"})],-1),cn=l("p",null,[s("这里两条告警被合并到一个邮件里发出来了，这就是做了分组，如果你有同类告警的，也就是根据"),l("code",null,"alertname "),s("去区分的，都会给你合并，"),l("code",null,"mysql&docker"),s("被合并到一起了，再看一下他还是支持哪些方式来告警，看"),l("a",{href:"https://prometheus.io/docs/alerting/configuration/",target:"_blank",rel:"noreferrer"},"这里"),s("吧，拉到最下面可以看到支持微信，丁丁目前是不支持的，有第三方的，我将来会对接企业微信的撒，暂时现用邮件吧，下面看看"),l("code",null,"alertmanager"),s("的告警状态吧。")],-1),rn=l("h3",{id:"告警状态",tabindex:"-1"},[s("告警状态 "),l("a",{class:"header-anchor",href:"#告警状态","aria-hidden":"true"},"#")],-1),pn=l("p",null,[s("目前"),l("code",null,"alertmanager"),s("告警状态分为三种，如下")],-1),Dn=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"值"),l("th",null,"说明")])]),l("tbody",null,[l("tr",null,[l("td",null,"Inactive"),l("td",null,"什么都没有发生")]),l("tr",null,[l("td",null,"Pending"),l("td",null,"已触发阈值，但未满足告警持续时间，for时间")]),l("tr",null,[l("td",null,"Firing"),l("td",null,"已触发阈值且满足告警持续时间，通知alertmanager你可以发送告警了")])])],-1),yn=l("p",null,[s("在这个阶段是有个时间的，并不是出现问题告警会马上发出去，这个时间包含了数据采集时间、告警评估时间，这两个时间是在"),l("code",null,"prometheus"),s("中配置的，也就是这里，")],-1),Cn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"scrape_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"     "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"evaluation_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"15s"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"})])])],-1),Fn=l("p",null,[s("目前是十五秒采集一次数据，评估告警规则时间也是十五秒，这个评估告警规则的时间就是我每隔多长时间要进行一次评估是否到达的阈值了，说白了这东西的目的就是为了减少告警的次数，更加精确的判断当前的状态是不是"),l("code",null,"ok"),s("的，下面在看看告警的分配")],-1),An=l("h3",{id:"告警的分配",tabindex:"-1"},[s("告警的分配 "),l("a",{class:"header-anchor",href:"#告警的分配","aria-hidden":"true"},"#")],-1),un=l("p",null,[s("具体告警要怎么去分配，也是在"),l("code",null,"alertmanager"),s("中配置的，也就是这一段，")],-1),dn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"email"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),mn=l("p",null,[s("这就是设置告警的分发策略了，这个"),l("code",null,"route"),s("可以拆分成多个子路由，目前所有的告警都会发送到名为"),l("code",null,"email"),s("的接收器里面，"),l("code",null,"email"),s("接收器的规则也是在配置文件中指定的，也就是这一段，")],-1),gn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"receivers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"email"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xx@xxx.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),hn=l("p",null,[s("接收器目前只有一个名为"),l("code",null,"email"),s("的，也可以有多个，如果你有什么特殊需求，需要将不同类型的告警发送给不同的人，就需要配置多个接收器去区分了，如下，")],-1),_n=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"global"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"resolve_timeout"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_smarthost"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"smtp.163.com:25"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_from"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@163.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_auth_username"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@163.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_auth_password"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"smtp_require_tls"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FF9CAC"}},"false")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"default-receiver"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##定义默认接收器名，如果其他的匹配不到走这个")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"30s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"4h")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"cluster"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##分组设置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"routes"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                       "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##子路由")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"database-pager"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##定义接收器名字          ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s"),l("span",{style:{color:"#A6ACCD"}},"                             "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##分组设置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"match_re"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##正则匹配")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"service"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"mysql|cassandra"),l("span",{style:{color:"#A6ACCD"}},"                  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##他会接收标签service值为mysql&&cassandra的告警")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"frontend-pager"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##接收器名")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"product"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"environment"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##分组设置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"match"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##直接匹配")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"team"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"frontend"),l("span",{style:{color:"#A6ACCD"}},"                            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##匹配标签team值为frontend的告警")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"receivers"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##定义接收器")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"default-receiver"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##接收器名字")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"                                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##邮件接口")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx.xx.com"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},"                            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"##接收人，下面以此类推")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"database-pager"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx.xx.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"frontend-pager"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@.xx.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),En=l("p",null,"我就不掩饰了，配置其实很简单，演示很麻烦撒，算了算了，过，下面看一哈告警收敛",-1),bn=l("h3",{id:"告警收敛",tabindex:"-1"},[s("告警收敛 "),l("a",{class:"header-anchor",href:"#告警收敛","aria-hidden":"true"},"#")],-1),fn=l("p",null,[s("收敛就是尽量压缩告警邮件的数量，太多了谁都会懵逼，可能有些关键的呗淹没了，"),l("code",null,"alertmanager"),s("中有很多收敛机制，最主要的就是分组抑制静默，"),l("code",null,"alertmanager"),s("收到告警之后他会先进行分组，然后进入通知队列，这个队列会对通知的邮件进行抑制静默，再根据"),l("code",null,"router"),s("将告警路由到不同的接收器，这就是"),l("code",null,"alertmanager"),s("收到一个告警后经历的阶段，只是一个大概的情况，下面深入了解一下这几个阶段到底是什么原理怎么去配置，先来简单看一下他们的定义")],-1),vn=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,"机制"),l("th",null,"说明")])]),l("tbody",null,[l("tr",null,[l("td",null,"分组(group)"),l("td",null,"将类似性质的告警合并为单个进行通知")]),l("tr",null,[l("td",null,"抑制(Inhibition)"),l("td",null,"当告警发生后，停止重复发送由此告警引发的其他告警")]),l("tr",null,[l("td",null,"静默(Silences)"),l("td",null,"是一种简单的特定时间静音提醒的机制")])])],-1),xn=l("h4",{id:"分组",tabindex:"-1"},[s("分组 "),l("a",{class:"header-anchor",href:"#分组","aria-hidden":"true"},"#")],-1),wn=l("p",null,[s("举个栗子，比如说我在阿里云有"),l("code",null,"10"),s("台服务器，但是我忘续费了，结果服务器到期都被停掉了(真实发生过)，这时候"),l("code",null,"node_exports"),s("肯定也无法访问了，服务器都停了，这时候普罗米修斯发现这"),l("code",null,"10"),s("个服务器都凉了，我要准备通知"),l("code",null,"alertmanager"),s("告警了，在不做分组的情况下你的告警媒介会有十条信息发出来，这种情况下我们可以他这些信息合并到一起撒，一条信息列出哪些服务器凉了。")],-1),kn=l("p",null,"其实分组设置最开始的时候我就做了，这一段就是设置分组的，",-1),Pn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m")]),s(`
`),l("span",{class:"line"})])])],-1),qn=l("p",null,[s("这里配置了分组的依据，默认就是"),l("code",null,"alertname"),s("，这个名字可以随便写的，做了分组之后他会去匹配你告警时的名字，告警的名字是在这里配置的，")],-1),Bn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"alert"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"采集器凉了")]),s(`
`),l("span",{class:"line"})])])],-1),jn=l("p",null,[s("如果是相同名字的告警在一定时间内出现多条，这个一定时间指的就是"),l("code",null,"group_wait"),s("的时间，那么多条就会合并成一条告警信息发出来，这个之前就配置了，所以在我停掉"),l("code",null,"mysql&docker"),s("采集器之后他就把这两条告警合并成一条信息发了出来，也就是这张图，上面贴过了。")],-1),Sn=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190711155830.png#mirages-width=1118&mirages-height=766&mirages-cdn-type=5",alt:"img"})],-1),$n=l("p",null,"这两条的告警名字都是采集器凉了撒，而且在十秒钟之内出现了两条，所以就被合并成一条发出来了，分组的目的就是为了减少告警信息的数量，同类告警聚合，所以现在总结一下配置分组的参数。",-1),Un=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#根据标签进行alert分组，可以写多个")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s"),l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#发送告警等待时间，")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s"),l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#分组告警信息间隔时间，譬如两组，第一组发送后等待十秒发送第二组")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m"),l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#重复发送告警时间，时间不要太短，也不要太长")]),s(`
`),l("span",{class:"line"})])])],-1),Tn=l("h4",{id:"抑制",tabindex:"-1"},[s("抑制 "),l("a",{class:"header-anchor",href:"#抑制","aria-hidden":"true"},"#")],-1),In=l("p",null,[s("他的主要作用就是消除冗余告警，我们会受到一个关键的告警信息，这个也是在"),l("code",null,"alertmanager"),s("中配置的，我标签只留了一个，")],-1),On=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"inhibit_rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"source_match"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"          ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"critical"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"target_match"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"warning"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"equal"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"instance"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Nn=l("p",null,[s("这段配置意思就是当我收到一个告警级别为"),l("code",null,"critical"),s("时，他就会抑制掉"),l("code",null,"warning"),s("这个级别的告警，这个告警等级是在你编写规则的时候定义的，最后一行就是要对哪些告警做抑制，通过标签匹配的，我这里只留了一个"),l("code",null,"instance"),s("，举个最简单的例子，当现在"),l("code",null,"alertmanager"),s("先收到一条"),l("code",null,"critical"),s("、又收到一条"),l("code",null,"warning"),s("且"),l("code",null,"instance"),s("值一致的两条告警他的处理逻辑是怎样的。")],-1),Gn=l("p",null,[s("我现在监控"),l("code",null,"nginx"),s("，"),l("code",null,"nginx"),s("宕掉的告警级别为"),l("code",null,"warning"),s("，宿主机宕掉的告警级别为"),l("code",null,"critical"),s("，譬如说现在我跑"),l("code",null,"nginx"),s("的服务器凉了，这时候"),l("code",null,"nginx"),s("肯定也凉了，普罗米修斯发现后通知"),l("code",null,"alertmanager"),s("，普罗米修斯发过来的是两条告警信息，一条是宿主机凉了的，一条是"),l("code",null,"nginx"),s("凉了的，"),l("code",null,"alertmanager"),s("收到之后，发现告警级别一条是"),l("code",null,"critical"),s("，一条是"),l("code",null,"warning"),s("，而且"),l("code",null,"instance"),s("标签值一致，也就是说这是在一台机器上发生的，所以他就会只发一条"),l("code",null,"critical"),s("的告警出来，"),l("code",null,"warning"),s("的就被抑制掉了，我们收到的就是服务器凉了的通知，大概就是这样，暂时不演示了。")],-1),zn=l("h4",{id:"静默",tabindex:"-1"},[s("静默 "),l("a",{class:"header-anchor",href:"#静默","aria-hidden":"true"},"#")],-1),Mn=l("p",null,[s("就是一个简单的特定时间静音提醒的机制，主要是使用标签匹配这一批不发送告警，譬如说我某天要对服务器进行维护，可能会涉及到服务器重启，在这期间肯定会有"),l("code",null,"N"),s("多告警发出来，所以你可以子啊这期间配置一个静默，这类的告警就不要发了，我知道发生了啥子事情，配置静默就很简单了，直接在"),l("code",null,"web"),s("页面配置就行了，"),l("code",null,"9093"),s("端口，")],-1),Ln=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715113322.png#mirages-width=1435&mirages-height=425&mirages-cdn-type=5",alt:"img"})],-1),Rn=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715113602.png#mirages-width=1173&mirages-height=769&mirages-cdn-type=5",alt:"img"})],-1),Qn=l("p",null,[s("选择开始时间结束时间，通过标签匹配去做，我匹配了"),l("code",null,"job=docker"),s("的机器，创建，所以我先在把容器采集器停掉也不会有告警出来了，我就不停了，就是这样配置，比较简单，扯了一堆，是时候自己写一个告警规则了，结合上面一切的东西。")],-1),Wn=l("h2",{id:"编写告警规则栗子",tabindex:"-1"},[s("编写告警规则栗子 "),l("a",{class:"header-anchor",href:"#编写告警规则栗子","aria-hidden":"true"},"#")],-1),Hn=l("p",null,[s("来监控内存吧，内存使用率超过"),l("code",null,"80"),s("我就要告警了，还是先需要写"),l("code",null,"sql"),s("，把我想要的值查出来，所以要查当前内存使用率大于百分之八十的"),l("code",null,"sql"),s("如下，")],-1),Kn=l("div",{class:"language-sql"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"(node_memory_MemTotal_bytes "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," node_memory_MemFree_bytes "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," node_memory_Buffers_bytes "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," node_memory_Cached_bytes) "),l("span",{style:{color:"#89DDFF"}},"/"),l("span",{style:{color:"#A6ACCD"}}," (node_memory_MemTotal_bytes )"),l("span",{style:{color:"#89DDFF"}},"*"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"100"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"80")]),s(`
`),l("span",{class:"line"})])])],-1),Vn=l("p",null,"下面就是要写规则了，我写的规则如下，顺便把之前的规则也改了一下，",-1),Jn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus/rules"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat memory.yml"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"groups"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"memeory_rules")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"alert"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"内存炸了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"expr"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"(node_memory_MemTotal_bytes - node_memory_MemFree_bytes - node_memory_Buffers_bytes - node_memory_Cached_bytes) / (node_memory_MemTotal_bytes )* 100 > 80")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"for"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"labels"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"warning")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"annotations"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"summary"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"{{ $labels.instance }} 内存炸了"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"description"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"{{ $labels.instance }} 内存炸了，当前使用率为 {{ $value }}"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"})])])],-1),Yn=l("p",null,[s("这样就可以了撒，我又把明月三千里加入到监控，也就是安装了"),l("code",null,"node_exports"),s("，现在也能正常获取到使用率了，下面试试上面提到的那个告警分配，我要把明月三千里的告警信息发送到我另一个邮箱，"),l("code",null,"job"),s("名字"),l("code",null,"mysql"),s("，")],-1),Zn=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"job_name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"mysql"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"static_configs"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"192.168.1.126:9104"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"targets"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"192.168.1.126:9100"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),Xn=l("p",null,"重启一下撒，能看到这些，",-1),la=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715142721.png#mirages-width=1225&mirages-height=304&mirages-cdn-type=5",alt:"img"})],-1),sa=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715143146.png#mirages-width=666&mirages-height=692&mirages-cdn-type=5",alt:"img"})],-1),oa=l("p",null,"然后去配置一下告警的分配，我要把关于明月三千里的告警发送到另一个邮箱，所以这里改了一哈，",-1),ea=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"route"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"alertname"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"default-receiver"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"routes"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"group_by"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"mysql"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"group_wait"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"group_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"10s")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"repeat_interval"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"5m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"receiver"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"mysql-pager"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"match_re"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#F07178"}},"job"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"mysql")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"receivers"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"default-receiver"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@xx.com"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"mysql-pager"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"email_configs"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"to"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"xxx@xx.cn"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"inhibit_rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"source_match"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}},"          ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"critical"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"target_match"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"warning"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"equal"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"instance"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"})])])],-1),na=l("p",null,[s("所以一会收到明月三千里的邮件是我"),l("code",null,"cn"),s("的邮箱，这样就可以了撒，重启"),l("code",null,"alertmanager"),s("，为了让他发出告警邮件，我调一下阈值，改为百分之"),l("code",null,"20"),s("，所以我"),l("code",null,"com"),s("收到的邮件如下，")],-1),aa=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715150334.png#mirages-width=971&mirages-height=460&mirages-cdn-type=5",alt:"img"})],-1),ta=l("p",null,[l("code",null,"cn"),s("收到的邮件如下")],-1),ca=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715150419.png#mirages-width=936&mirages-height=437&mirages-cdn-type=5",alt:"img"})],-1),ra=l("p",null,[s("然后再试一下抑制，我再加一个监控项，我要监控"),l("code",null,"TCP"),s("连接数，状态是"),l("code",null,"ESTABLISHED"),s("的，超过"),l("code",null,"300"),s("我就要告警了，定义告警级别为"),l("code",null,"critical"),s("，所以"),l("code",null,"rule"),s("文件如下，")],-1),pa=l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",null,[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#C3E88D"}},"root@rj-bai /usr/local/prometheus/rules"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}},"# "),l("span",{style:{color:"#C3E88D"}},"cat tcp-established.yml"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"groups"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"tcp-established_rules")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"rules"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"alert"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"TCP连接数过高")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"expr"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"node_sockstat_TCP_alloc > 300"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"for"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"1m")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"labels"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"severity"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"critical")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#F07178"}},"annotations"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"summary"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"{{ $labels.instance }} TCP连接数过高"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#F07178"}},"description"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"{{ $labels.instance }} TCP连接数过高，当前连接数 {{ $value }}"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"})])])],-1),Da=l("p",null,"重启后看页面，",-1),ya=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715160750.png#mirages-width=1534&mirages-height=809&mirages-cdn-type=5",alt:"img"})],-1),ia=l("p",null,[s("有三条告警已经进入"),l("code",null,"Pending"),s("状态了，没意外的话"),l("code",null,"cn"),s("邮箱只有一条告诉你连接数过高的告警信息发出来了，内存使用率过高的就会被抑制，看一下，")],-1),Ca=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715161059.png#mirages-width=1861&mirages-height=792&mirages-cdn-type=5",alt:"img"})],-1),Fa=l("p",null,"所以这条已经被抑制了，",-1),Aa=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715161644.png",alt:"img"})],-1),ua=l("p",null,[l("code",null,"248"),s("服务器不受影响，"),l("code",null,"com"),s("邮箱还是会收到内存炸了的告警，")],-1),da=l("p",null,[l("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/20190715161714.png",alt:"img"})],-1),ma=l("p",null,[s("就是这样撒，你想编写其他的告警规则流程和上面是一样的，告警的分配和抑制不是必需的，自行琢磨吧，下一篇准备重写"),l("code",null,"K8S"),s("监控方面的东西，了解这些东西之后之后就应该很简单了撒，本篇就这样，过。")],-1);function ga(e,ha,_a,Ea,t,ba){const c=r;return i(),y(c,{frontmatter:t.frontmatter,data:t.data},{"main-content-md":o(()=>[F,A,u,d,m,g,h,_,E,b,f,v,x,w,k,P,q,B,j,S,$,U,T,I,O,N,G,z,M,L,R,Q,W,H,K,V,J,Y,Z,X,ll,sl,ol,el,nl,al,tl,cl,rl,pl,Dl,yl,il,Cl,Fl,Al,ul,dl,ml,gl,hl,_l,El,bl,fl,vl,xl,wl,kl,Pl,ql,Bl,jl,Sl,$l,Ul,Tl,Il,Ol,Nl,Gl,zl,Ml,Ll,Rl,Ql,Wl,Hl,Kl,Vl,Jl,Yl,Zl,Xl,ls,ss,os,es,ns,as,ts,cs,rs,ps,Ds,ys,is,Cs,Fs,As,us,ds,ms,gs,hs,_s,Es,bs,fs,vs,xs,ws,ks,Ps,qs,Bs,js,Ss,$s,Us,Ts,Is,Os,Ns,Gs,zs,Ms,Ls,Rs,Qs,Ws,Hs,Ks,Vs,Js,Ys,Zs,Xs,lo,so,oo,eo,no,ao,to,co,ro,po,Do,yo,io,Co,Fo,Ao,uo,mo,go,ho,_o,Eo,bo,fo,vo,xo,wo,ko,Po,qo,Bo,jo,So,$o,Uo,To,Io,Oo,No,Go,zo,Mo,Lo,Ro,Qo,Wo,Ho,Ko,Vo,Jo,Yo,Zo,Xo,le,se,oe,ee,ne,ae,te,ce,re,pe,De,ye,ie,Ce,Fe,Ae,ue,de,me,ge,he,_e,Ee,be,fe,ve,xe,we,ke,Pe,qe,Be,je,Se,$e,Ue,Te,Ie,Oe,Ne,Ge,ze,Me,Le,Re,Qe,We,He,Ke,Ve,Je,Ye,Ze,Xe,ln,sn,on,en,nn,an,tn,cn,rn,pn,Dn,yn,Cn,Fn,An,un,dn,mn,gn,hn,_n,En,bn,fn,vn,xn,wn,kn,Pn,qn,Bn,jn,Sn,$n,Un,Tn,In,On,Nn,Gn,zn,Mn,Ln,Rn,Qn,Wn,Hn,Kn,Vn,Jn,Yn,Zn,Xn,la,sa,oa,ea,na,aa,ta,ca,ra,pa,Da,ya,ia,Ca,Fa,Aa,ua,da,ma]),"main-header":o(()=>[n(e.$slots,"main-header")]),"main-header-after":o(()=>[n(e.$slots,"main-header-after")]),"main-nav":o(()=>[n(e.$slots,"main-nav")]),"main-content":o(()=>[n(e.$slots,"main-content")]),"main-content-after":o(()=>[n(e.$slots,"main-content-after")]),"main-nav-before":o(()=>[n(e.$slots,"main-nav-before")]),"main-nav-after":o(()=>[n(e.$slots,"main-nav-after")]),comment:o(()=>[n(e.$slots,"comment")]),footer:o(()=>[n(e.$slots,"footer")]),aside:o(()=>[n(e.$slots,"aside")]),"aside-custom":o(()=>[n(e.$slots,"aside-custom")]),default:o(()=>[n(e.$slots,"default")]),_:3},8,["frontmatter","data"])}const qa=p(C,[["render",ga],["__file","/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/Prometheus+Grafana全方位监控系统.md"]]);export{Pa as __pageData,qa as default};
