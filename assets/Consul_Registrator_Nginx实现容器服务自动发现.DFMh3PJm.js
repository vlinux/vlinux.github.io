import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang.gfo-rUCP.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as h,u as b,a as m}from"./chunks/vue-router.DQHxU7r6.js";import{aa as k,ap as s,ag as e,af as n,ai as l,P as x,ab as f,a1 as v}from"./framework.GHZxz7jq.js";import"./index.CFgbcban.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.CU_FKKcY.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.zk_xPNhE.js";const _=h("/posts/Consul+Registrator+Nginx实现容器服务自动发现",async t=>JSON.parse('{"title":"Consul+Registrator+Nginx实现容器服务自动发现","description":"","frontmatter":{"title":"Consul+Registrator+Nginx实现容器服务自动发现","categories":"微服务","tags":["Consul+Registrator+Nginx","微服务"],"date":"2019-01-01 15:34:00"},"headers":[],"relativePath":"pages/posts/Consul+Registrator+Nginx实现容器服务自动发现.md","lastUpdated":null}'),{lazy:(t,o)=>t.name===o.name}),q={__name:"Consul+Registrator+Nginx实现容器服务自动发现",setup(t,{expose:o}){const{data:c}=_(),u=m(),p=b(),i=Object.assign(p.meta.frontmatter||{},c.value?.frontmatter||{});return u.currentRoute.value.data=c.value,v("valaxy:frontmatter",i),globalThis.$frontmatter=i,o({frontmatter:{title:"Consul+Registrator+Nginx实现容器服务自动发现",categories:"微服务",tags:["Consul+Registrator+Nginx","微服务"],date:"2019-01-01 15:34:00"}}),(a,r)=>{const g=d;return f(),k(g,{frontmatter:x(i)},{"main-content-md":s(()=>[...r[0]||(r[0]=[n("h1",{id:"基于consul-registrator-nginx实现容器服务自动发现的集群框架",tabindex:"-1"},[l("基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架 "),n("a",{class:"header-anchor",href:"#基于consul-registrator-nginx实现容器服务自动发现的集群框架","aria-label":'Permalink to "基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"'},"​")],-1),n("blockquote",null,[n("p",null,"我们先来看一下服务发现常用的框架有哪些："),n("ul",null,[n("li",null,"zookeeper"),n("li",null,"eureka"),n("li",null,"etcd"),n("li",null,"consul")])],-1),n("p",null,[l("这里就不挨个来介绍它们了，本文中主要以consul为主，如果你在大量接触或使用微服务的话，你可能会碰到一个问题？当你创建的服务数量越来越多时，这些服务之间的通信便越难管理，而且维护代价会越来越高。consul可以给你答案，我们一起来了解一下consul： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/41b1033a119139c1375c52d5300eced9.jpg",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("h2",{id:"_1-了解consul",tabindex:"-1"},[l("1.了解consul "),n("a",{class:"header-anchor",href:"#_1-了解consul","aria-label":'Permalink to "1.了解consul"'},"​")],-1),n("p",null,"Consul是一个分布式，高度可用且支持多数据中心的服务发现，配置和编排工具。 Consul支持大规模部署，配置和维护面向服务的体系结构。 欲了解更多官方信息，请参阅：",-1),n("ul",null,[n("li",null,[n("a",{href:"https://www.consul.io/",target:"_blank",rel:"noreferrer"},"consul 文档")]),n("li",null,[n("a",{href:"https://github.com/hashicorp/consul",target:"_blank",rel:"noreferrer"},"consul github")])],-1),n("h3",{id:"_1-1-架构设计",tabindex:"-1"},[l("1.1 架构设计 "),n("a",{class:"header-anchor",href:"#_1-1-架构设计","aria-label":'Permalink to "1.1 架构设计"'},"​")],-1),n("p",null,"在现实中，我们一直渴望着追求提供高质量、高可用的服务架构体系，同时减少不必要的部署和维护代价，减少容错率。面对如此高的要求，可以有两种架构方案：",-1),n("ul",null,[n("li",null,"Docker+Etcd+Confd+Nginx"),n("li",null,"Docker+Consul+Nginx")],-1),n("p",null,[l("本文中我们主要来介绍 Docker+Consul+Nginx方案，此方案更加高效、快捷，并且维护代价和容错率更低，分布式支持力度更强，如下图所示： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/de11c5f722122d7f4f64b27c0d56a7a3.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,"使用Docker将Consul、Consul Template、Registrator和Nginx组装成一个值得信任且可扩展的服务框架，这套架构让你在这个框架中添加和移除服务，不需要重写任何配置，也不需要重启任何服务，一切都能正常运行，工作流程很简单：",-1),n("blockquote",null,[n("p",null,"docker节点 ---------> consul ---------> nginx.conf")],-1),n("h3",{id:"_1-2-架构优势",tabindex:"-1"},[l("1.2 架构优势 "),n("a",{class:"header-anchor",href:"#_1-2-架构优势","aria-label":'Permalink to "1.2 架构优势"'},"​")],-1),n("p",null,"Docker+Consul+Nginx虽然看起来是三个组件的运用，但却证明是一个有机的整体。它们互相联系、互相作用，完全满足我们对高可用、高效服务架构方案的需求，是Docker生态圈中最理想的组合之一，具有以下优势：",-1),n("ol",null,[n("li",null,"自动发现与注册组件consul使用 Raft 算法来保证一致性，比复杂的Paxos 算法更直接。相比较而言，zookeeper 采用的是 Paxos，而 etcd 使用的则是 Raft；"),n("li",null,"支持多数据中心，多数据中心集群可以避免单数据中心的单点故障，zookeeper 和 etcd 均不提供多数据中心功能的支持；"),n("li",null,"自动、实时发现及无感知服务刷新，具备资源弹性，伸缩自如；"),n("li",null,"支持健康检查，负载能动态在可用的服务实例上进行均衡，etcd 不提供此功能；"),n("li",null,"支持足够多台Docker容器(前提架构资源足以保证性能支撑)；"),n("li",null,"支持http 和dns 协议接口，zookeeper 的集成较为复杂，etcd 只支持 http 协议；"),n("li",null,"服务规模方便进行快速调整，官方提供web管理界面，etcd 无此功能；"),n("li",null,"Consul template 搭配consul使用，支持多种接入层，如Nginx、Haproxy。")],-1),n("h2",{id:"_2-环境说明",tabindex:"-1"},[l("2.环境说明 "),n("a",{class:"header-anchor",href:"#_2-环境说明","aria-label":'Permalink to "2.环境说明"'},"​")],-1),n("p",null,"本文所用的环境均按1.1中的架构图来部署，nginx用1台服务器、consul用1台服务器、docker host用2台服务器，共用4台服务器来部署，当然如果你的服务器紧张，用3台也一样，减少1台docker host就行：",-1),n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"服务器IP"),n("th",null,"服务器名"),n("th",null,"角色")])]),n("tbody",null,[n("tr",null,[n("td",null,"172.18.18.32"),n("td",null,"nginx"),n("td",null,"运行nginx服务、consul-template守护进程")]),n("tr",null,[n("td",null,"172.18.18.33"),n("td",null,"consul"),n("td",null,"运行consul服务")]),n("tr",null,[n("td",null,"172.18.18.34"),n("td",null,"docker01"),n("td",null,"运行registrator容器、运行nginx容器（映射端口81、82）")]),n("tr",null,[n("td",null,"172.18.18.35"),n("td",null,"docker02"),n("td",null,"运行registrator容器、运行nginx容器（映射端口83、84）")])])],-1),n("h2",{id:"_3-部署nginx",tabindex:"-1"},[l("3.部署nginx "),n("a",{class:"header-anchor",href:"#_3-部署nginx","aria-label":'Permalink to "3.部署nginx"'},"​")],-1),n("blockquote",null,[n("p",null,"在nginx服务器上操作")],-1),n("h3",{id:"_3-1-安装nginx",tabindex:"-1"},[l("3.1 安装nginx "),n("a",{class:"header-anchor",href:"#_3-1-安装nginx","aria-label":'Permalink to "3.1 安装nginx"'},"​")],-1),n("p",null,"1、下载并解压nginx： 你可以用docker的方案运行nginx、也可以用源码包编译安装nginx。在本文中nginx用源码包的方式安装",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx /]# cd /usr/src/")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx src /]# tar -zxvf nginx-1.12.1.tar.gz")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"2、编译安装nginx：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx src]# yum -y install gcc gcc-c++ make openssl-devel pcre-devel")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx src]# cd nginx-1.12.1/")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx nginx-1.12.1]# ./configure --prefix=/usr/local/nginx   --with-http_stub_status_module --with-http_realip_module --with-pcre  --with-http_ssl_module")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx nginx-1.12.1]# make -j 2")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx nginx-1.12.1]# make install")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("h3",{id:"_3-2-安装consul-template",tabindex:"-1"},[l("3.2 安装consul-template "),n("a",{class:"header-anchor",href:"#_3-2-安装consul-template","aria-label":'Permalink to "3.2 安装consul-template"'},"​")],-1),n("p",null,[l("安装consul-template非常简单，下载二进制包即可使用 1、下载consul-template 下载地址："),n("a",{href:"https://releases.hashicorp.com/consul-template/0.19.3/consul-template_0.19.3_linux_amd64.zip",target:"_blank",rel:"noreferrer"},"https://releases.hashicorp.com/consul-template/0.19.3/consul-template_0.19.3_linux_amd64.zip")],-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx ]# wget https://releases.hashicorp.com/consul-template/0.19.3/consul-template_0.19.3_linux_amd64.zip")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"2、解压并安装到/usr/bin目录",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx ]# unzip consul-template_0.19.3_linux_amd64.zip")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx ]# mv consul-template /usr/bin/")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("h2",{id:"_4-部署consul",tabindex:"-1"},[l("4.部署consul "),n("a",{class:"header-anchor",href:"#_4-部署consul","aria-label":'Permalink to "4.部署consul"'},"​")],-1),n("blockquote",null,[n("p",null,"在consul服务器上操作")],-1),n("h3",{id:"_4-1-安装consul",tabindex:"-1"},[l("4.1 安装consul "),n("a",{class:"header-anchor",href:"#_4-1-安装consul","aria-label":'Permalink to "4.1 安装consul"'},"​")],-1),n("p",null,[l("有两种方式安装consul（容器、二进制包），在本文中选使用二制包的方式。 1、下载consul二进制包 下载地址 "),n("a",{href:"https://www.consul.io/downloads.html",target:"_blank",rel:"noreferrer"},"https://www.consul.io/downloads.html")],-1),n("p",null,"2、解压、安装",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@consul ~]#unzip consul_0.9.2_linux_amd64.zip")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#mv consul /usr/bin/")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"3、部署consul",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@consul ~]#consul agent -server -bootstrap -ui -data-dir=/var/lib/consul-data -bind=172.18.18.33 -client=0.0.0.0 -node=server01")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"参数说明： agent:运行一个consul代理。 -server :切换代理到服务器模式。 -bootstrap :将服务器设置为引导模式。 -ui:启用内置的静态web UI服务器。 -data-dir:路径到数据目录存储代理状态。 -bind:设置集群通信的绑定地址。 -client:设置用于绑定客户端访问的地址。这包括RPC、DNS、HTTP和HTTPS(如果配置)。 -node:此节点的名称。 在集群中必须是唯一的，如果你运行第2台consul，可以写server02、server03等。",-1),n("p",null,"consul启动后它会在前台显示，如果你想让它在后台运行，可以加上nohup &来运行它：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@consul ~]#nohup consul agent -server -bootstrap -ui -data-dir=/var/lib/consul-data -bind=172.18.18.33 -client=0.0.0.0 -node=server01 &")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,[l("4、查看consul启动后的情况： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/cbcdb4563e083359c0beb09e8cd66d3a.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" 启动consul后默认会监听5个端口： 8300： replication、leader farwarding的端口 8301： lan cossip的端口 8302： wan gossip的端口 8500： web ui界面的端口 8600： 使用dns协议查看节点信息的端口 可参考下图查看端口的意思： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/30228798a59a97b32f4018de04ec2f40.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("h3",{id:"_4-2-查看consul集群信息",tabindex:"-1"},[l("4.2 查看consul集群信息 "),n("a",{class:"header-anchor",href:"#_4-2-查看consul集群信息","aria-label":'Permalink to "4.2 查看consul集群信息"'},"​")],-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@consul ~]#consul members")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#consul info |grep leader")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#consul catalog services")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("h3",{id:"_4-3-通过http-api获取集群信息",tabindex:"-1"},[l("4.3 通过http api获取集群信息 "),n("a",{class:"header-anchor",href:"#_4-3-通过http-api获取集群信息","aria-label":'Permalink to "4.3 通过http api获取集群信息"'},"​")],-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"# 集群server成员")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#curl 127.0.0.1:8500/v1/status/peers")]),l(`
`),n("span",{class:"line"},[n("span",null,"# 集群Raft leader")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#curl 127.0.0.1:8500/v1/status/leader")]),l(`
`),n("span",{class:"line"},[n("span",null,"# 注册的所有服务")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#curl 127.0.0.1:8500/v1/catalog/services")]),l(`
`),n("span",{class:"line"},[n("span",null,"# 服务信息")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#curl 127.0.0.1:8500/v1/catalog/services/nginx")]),l(`
`),n("span",{class:"line"},[n("span",null,"# 集群节点详细信息")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@consul ~]#curl 127.0.0.1:8500/v1/catalog/nodes")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,[l("一般我们通过 "),n("a",{href:"http://xn--consul-gf4jr3wwp4b:8500/",target:"_blank",rel:"noreferrer"},"http://consul服务器:8500"),l(" web界面来访问查看： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/90afa2e429dcac75f0b794cd889763b0.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" 从上图可以看到，consul 界面有5个菜单项（SERVICES、NODES、KEY/VALUE、ACL、DC1）。在SERVICES中，目前因为没有任何服务加入进来，只显示了consul它自己的服务状态。")],-1),n("p",null,[l("我们在来看下NODES，从图中很好理解， 在server01这台节点上有个consul :8300的服务： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/fbd5cf540d3daba111834be03eaebbaa.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,"接下来，我们去nginx服务器上配置一下nginx模板，并在两台docker主机上运行registrator服务进行测试。",-1),n("h2",{id:"_5-配置nginx",tabindex:"-1"},[l("5.配置nginx "),n("a",{class:"header-anchor",href:"#_5-配置nginx","aria-label":'Permalink to "5.配置nginx"'},"​")],-1),n("blockquote",null,[n("p",null,"在nginx服务器上操作")],-1),n("p",null,"在步骤3中nginx已经安装好了，这一步只是配置nginx，大概配置的思路为：",-1),n("ul",null,[n("li",null,"在/usr/local/nginx/conf中创建目录consul，目录名自定义；"),n("li",null,"在consul目录中创建nginx.ctmpl模板；"),n("li",null,"在nginx.conf配置中添加include项并指向consul目录 ；"),n("li",null,"重启nginx服务；")],-1),n("h3",{id:"_5-1-创建nginx-ctmpl模板",tabindex:"-1"},[l("5.1 创建nginx.ctmpl模板 "),n("a",{class:"header-anchor",href:"#_5-1-创建nginx-ctmpl模板","aria-label":'Permalink to "5.1 创建nginx.ctmpl模板"'},"​")],-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx /]#mkdir /usr/local/nginx/consul/")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx /]#cd /usr/local/nginx/consul/")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx consul]#vim nginx.ctmpl")]),l(`
`),n("span",{class:"line"},[n("span",null,"upstream http_backend {")]),l(`
`),n("span",{class:"line"},[n("span",null,'    {{range service "nginx"}}')]),l(`
`),n("span",{class:"line"},[n("span",null,"    server {{ .Address }}:{{ .Port }};")]),l(`
`),n("span",{class:"line"},[n("span",null,"    {{ end }}")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"server {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    listen 8000;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    server_name localhost;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    location / {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    proxy_pass http://http_backend;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    }")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"nginx.ctmpl模板中的内容就是两段意思，熟悉nginx的朋友一看也能明白：第1 定义nginx upstream一个简单模板，第2 定义一个server，监听8000端口，反向代理到upstream。",-1),n("h3",{id:"_5-2-修改nginx-conf",tabindex:"-1"},[l("5.2 修改nginx.conf "),n("a",{class:"header-anchor",href:"#_5-2-修改nginx-conf","aria-label":'Permalink to "5.2 修改nginx.conf"'},"​")],-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx consul]# vim /usr/local/nginx/conf/nginx.conf")]),l(`
`),n("span",{class:"line"},[n("span",null,"worker_processes  1;")]),l(`
`),n("span",{class:"line"},[n("span",null,"events {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    worker_connections  1024;")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")]),l(`
`),n("span",{class:"line"},[n("span",null,"http {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    include       mime.types;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    default_type  application/octet-stream;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    sendfile        on;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    keepalive_timeout  65;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    server {")]),l(`
`),n("span",{class:"line"},[n("span",null,"        listen       80;")]),l(`
`),n("span",{class:"line"},[n("span",null,"        server_name  localhost;")]),l(`
`),n("span",{class:"line"},[n("span",null,"        location / {")]),l(`
`),n("span",{class:"line"},[n("span",null,"            root   html;")]),l(`
`),n("span",{class:"line"},[n("span",null,"            index  index.html index.htm;")]),l(`
`),n("span",{class:"line"},[n("span",null,"        }")]),l(`
`),n("span",{class:"line"},[n("span",null,"        error_page   500 502 503 504  /50x.html;")]),l(`
`),n("span",{class:"line"},[n("span",null,"        location = /50x.html {")]),l(`
`),n("span",{class:"line"},[n("span",null,"            root   html;")]),l(`
`),n("span",{class:"line"},[n("span",null,"        }")]),l(`
`),n("span",{class:"line"},[n("span",null,"    }")]),l(`
`),n("span",{class:"line"},[n("span",null,"        #添加这一行")]),l(`
`),n("span",{class:"line"},[n("span",null,"    include /usr/local/nginx/consul/*.conf;")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"添加好了在重载nginx服务：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx consul]# /usr/local/nginx/sbin/nginx  -s reload")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("h3",{id:"_5-3-运行consul-template进程",tabindex:"-1"},[l("5.3 运行consul-template进程 "),n("a",{class:"header-anchor",href:"#_5-3-运行consul-template进程","aria-label":'Permalink to "5.3 运行consul-template进程"'},"​")],-1),n("p",null,"1、启动consul-template",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,'[root@nginx consul]#consul-template --consul-addr 172.18.18.33:8500 --template "./nginx.ctmpl:vhost.conf" --log-level=info')]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.933447 [INFO] consul-template v0.19.3 (ebf2d3d)")]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.933459 [INFO] (runner) creating new runner (dry: false, once: false)")]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.933779 [INFO] (runner) creating watcher")]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.933858 [INFO] (runner) starting")]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.933873 [INFO] (runner) initiating run")]),l(`
`),n("span",{class:"line"},[n("span",null,"2018/03/14 08:08:06.935387 [INFO] (runner) initiating run")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"注意：它这个日志是一直在前台输出，通过ctrl+c停止consul-template进程。")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"参数说明： –consul-addr：指定consul服务的ip和端口； ./nginx.ctmpl：这是用nginx.ctmpl这个模板来启动进程，这是写的相对路径，也可以写绝对路径； vhost.conf：nginx.ctmpl模板生成后的文件名，这也可以写绝对路径，如果不写绝对路径，这个文件就在当前目录生成（/usr/local/nginx/consul/）",-1),n("p",null,"2、验证consul-template 由于consul-template在前台运行，所以我们在打开一个nginx终端验证。",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"#查看下进程")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx ~]# ps -ef | grep consul-template")]),l(`
`),n("span",{class:"line"},[n("span",null,"root     22954 22794  0 16:08 pts/0    00:00:00 consul-template --consul-addr 172.18.18.33:8500 --template ./nginx.ctmpl:vhost.conf --log-level=info")]),l(`
`),n("span",{class:"line"},[n("span",null,"#查看下consul目录下的文件")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx ~]# cd /usr/local/nginx/consul/")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@nginx consul]# ls")]),l(`
`),n("span",{class:"line"},[n("span",null,"nginx.ctmpl  vhost.conf")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"在consul目录下，是不是发现多了一个文件vhost.conf，就是刚才启动consul-template进程时生成的。",-1),n("p",null,"在来查看下vhost.conf的内容，目前upstraem配置为空，还没有docker主机加入进来：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx consul]# cat vhost.conf ")]),l(`
`),n("span",{class:"line"},[n("span",null,"upstream http_backend {")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"server {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    listen 8000;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    server_name localhost;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    location / {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    proxy_pass http://http_backend;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    }")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"接下来去配置下docker主机。",-1),n("h2",{id:"_6-部署docker",tabindex:"-1"},[l("6.部署docker "),n("a",{class:"header-anchor",href:"#_6-部署docker","aria-label":'Permalink to "6.部署docker"'},"​")],-1),n("blockquote",null,[n("p",null,"在docker01和docker02上操作")],-1),n("p",null,"先来说一下在docker服务器上操作的大概思路：",-1),n("ul",null,[n("li",null,"分别在两台docker服务器上都创建registrator容器，注意到consul服务中心；"),n("li",null,"在docker01上运行两台nginx容器（端口81、82），在docker02上运行两台nginx容器（端口83、84）；"),n("li",null,"修改这4台nginx容器中的index.html页面内容为（docker01:81、docker01:82、docker02:83、docker02:84）"),n("li",null,"访问consul web界面验证"),n("li",null,[l("访问nginx服务器地址 "),n("a",{href:"http://172.18.18.32:8000/",target:"_blank",rel:"noreferrer"},"http://172.18.18.32:8000"),l(" 进行验证；")])],-1),n("h3",{id:"_6-1-安装docker服务",tabindex:"-1"},[l("6.1 安装docker服务 "),n("a",{class:"header-anchor",href:"#_6-1-安装docker服务","aria-label":'Permalink to "6.1 安装docker服务"'},"​")],-1),n("blockquote",null,[n("p",null,[l("安装过程省略，可参考笔者这篇文章进行安装 "),n("a",{href:"https://blog.51cto.com/ganbing/2050621",target:"_blank",rel:"noreferrer"},"《docker环境安装（Ubuntu、Centos）》")])],-1),n("h3",{id:"_6-2-创建registrator容器",tabindex:"-1"},[l("6.2 创建registrator容器 "),n("a",{class:"header-anchor",href:"#_6-2-创建registrator容器","aria-label":'Permalink to "6.2 创建registrator容器"'},"​")],-1),n("p",null,"分别在docker 01 和docker 02 上都创建：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker01 /]# docker run -d --name registrator --network=host -v /var/run/docker.sock:/tmp/docker.sock --restart=always gliderlabs/registrator:latest --ip 172.18.18.34 consul://172.18.18.33:8500")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@docker02 /]# docker run -d --name registrator --network=host -v /var/run/docker.sock:/tmp/docker.sock --restart=always gliderlabs/registrator:latest --ip 172.18.18.35 consul://172.18.18.33:8500")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"参数说明： –network：把运行的docker容器设定为host网络模式； -v /var/run/docker.sock：把宿主机的Docker守护进程(Docker daemon)默认监听的Unix域套接字挂载到容器中； –ip : 刚才把network指定了host模式，所以我们指定下IP为宿主机的IP； consul:j最后这个选项是配置consul服务器的IP和端口。",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"### 6.3 启动nginx容器")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"1、先在docker01上启动第1台nginx，也就是端口为81的容器：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker01 /]#docker run -itd --name nginx_81 -p 81:80 nginx")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"进入容器修改index.html：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker01 /]# docker exec -it nginx_81 bash")]),l(`
`),n("span",{class:"line"},[n("span",null,"root@272533504ab0:/# cd /usr/share/nginx/html/")]),l(`
`),n("span",{class:"line"},[n("span",null,'root@272533504ab0:/usr/share/nginx/html# echo  "docker01:81" > index.html')])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"在去nginx服务器上验证下vhost.conf，从下面可以看到docker01的nginx 81注册进来了：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@nginx consul]# cat vhost.conf ")]),l(`
`),n("span",{class:"line"},[n("span",null,"upstream http_backend {")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"    server 172.18.18.34:81;")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")]),l(`
`),n("span",{class:"line"},[n("span")]),l(`
`),n("span",{class:"line"},[n("span",null,"server {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    listen 8000;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    server_name localhost;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    location / {")]),l(`
`),n("span",{class:"line"},[n("span",null,"    proxy_pass http://http_backend;")]),l(`
`),n("span",{class:"line"},[n("span",null,"    }")]),l(`
`),n("span",{class:"line"},[n("span",null,"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,[l("然后访问一下nginx服务器的IP地址，"),n("a",{href:"http://172.18.18.32:8000/",target:"_blank",rel:"noreferrer"},"http://172.18.18.32:8000"),l(" ，从下图可以看出是可以访问的： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/f9e6667d74a7be1d42284ffdffb4574d.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,"2、在docker01上启动第2台nginx，也就是端口为82的容器，并修改好index.html：",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker01 /]# docker run -itd --name nginx_82 -p 82:80 nginx")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@docker /]# docker exec -it nginx_82  bash")]),l(`
`),n("span",{class:"line"},[n("span",null,"root@b66febfa0753:/# cd /usr/share/nginx/html/")]),l(`
`),n("span",{class:"line"},[n("span",null,'root@b66febfa0753:/usr/share/nginx/html# echo  "docker01:82" > index.html')])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,[l("在去nginx服务器上验证下vhost.conf，从下面可以看到docker01的nginx 82也注册进来了： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/875b40266e4604d164bde45162d241f2.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,[l("接着，我们访问下consul服务的web界面，"),n("a",{href:"http://172.18.18.33:8500/",target:"_blank",rel:"noreferrer"},"http://172.18.18.33:8500"),l(" ，从下图可以看出，在SERVICE中是不是发现多了个nginx 服务： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/e65f922f8c5d94cd4747c491c446f510.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,[l("然后，在看看NODES，从下图可以看出，刚才创建的两个nginx容器（81、82）都注册到了server01这台consul服务器，如果我们的consul是集群环境的话，可以分别注册到server02或server03中： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/75754c5d4892ed121ef07809d531bcc4.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,"3、把docker02服务器上的nginx容器83和84也创建了 创建nginx:83",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker02 /]# docker run -itd --name nginx_83 -p 83:80 nginx")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@docker02 /]# docker exec -it nginx_83 bash")]),l(`
`),n("span",{class:"line"},[n("span",null,"root@5c21ba694829:/# cd /usr/share/nginx/html/")]),l(`
`),n("span",{class:"line"},[n("span",null,'root@5c21ba694829:/usr/share/nginx/html# echo  "docker02:83" > index.html')])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,"创建nginx:84",-1),n("div",{class:"language-"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"}),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"[root@docker02 /]# docker run -itd --name nginx_84 -p 84:80 nginx")]),l(`
`),n("span",{class:"line"},[n("span",null,"[root@docker02 /]#docker exec -it nginx_84  bash")]),l(`
`),n("span",{class:"line"},[n("span",null,"root@0f9d72ff453b:/# cd /usr/share/nginx/html/")]),l(`
`),n("span",{class:"line"},[n("span",null,'root@0f9d72ff453b:/usr/share/nginx/html#  echo  "docker02:84" > index.html')])])]),n("button",{class:"code-block-unfold-btn"})],-1),n("p",null,[l("4、去nginx服务器上验证vhost.conf： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/5a805084f033178c246e11009878b25d.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" 从上图可以看出，docker02服务器上的83和84也自动注册进来了。")],-1),n("p",null,[l("5、在来看看consul服务器上的web界面： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/b01af6a525853a49150d3a9078982d78.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" 从上图可以看出，SERVICE中的nginx已经有了4个，并且还多了些其它的服务，这些服务是我docker02上跑的其它应用容器，也都会自动注册进来。")],-1),n("p",null,[l("6、访问nginx服务器做最后的验证，"),n("a",{href:"http://172.18.18.32:8000/",target:"_blank",rel:"noreferrer"},"http://172.18.18.32:8000"),l(" ，记得用f5刷新验证： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/b2ee65f22819aea534d34d1568a95310.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" F5刷新一下页面： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/843ea731f4d6f357ed22541f5a01b546.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"}),l(" 在刷新一下，是不是访问到了docker02这台主机了： "),n("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/6f08d5ad7e7369095d726a3434aad4f7.png",alt:"基于Consul+Registrator+Nginx实现容器服务自动发现的集群框架"})],-1),n("p",null,"到此，自动注册服务的过程就完成了，想要详细了解consul的朋友可以参考官方文档：",-1),n("p",null,[l("consul 官方下载："),n("a",{href:"https://www.consul.io/downloads.html",target:"_blank",rel:"noreferrer"},"https://www.consul.io/downloads.html"),l(" consul官方集群安装："),n("a",{href:"https://www.consul.io/intro/getting-started/join.html",target:"_blank",rel:"noreferrer"},"https://www.consul.io/intro/getting-started/join.html"),l(" consul github ："),n("a",{href:"https://github.com/hashicorp/consul",target:"_blank",rel:"noreferrer"},"https://github.com/hashicorp/consul"),l(" consul官方镜像： "),n("a",{href:"https://hub.docker.com/_/consul/",target:"_blank",rel:"noreferrer"},"https://hub.docker.com/_/consul/"),l(" 原作: "),n("a",{href:"https://blog.51cto.com/ganbing/2086851",target:"_blank",rel:"noreferrer"},"https://blog.51cto.com/ganbing/2086851")],-1)])]),"main-header":s(()=>[e(a.$slots,"main-header")]),"main-header-after":s(()=>[e(a.$slots,"main-header-after")]),"main-nav":s(()=>[e(a.$slots,"main-nav")]),"main-content-before":s(()=>[e(a.$slots,"main-content-before")]),"main-content":s(()=>[e(a.$slots,"main-content")]),"main-content-after":s(()=>[e(a.$slots,"main-content-after")]),"main-nav-before":s(()=>[e(a.$slots,"main-nav-before")]),"main-nav-after":s(()=>[e(a.$slots,"main-nav-after")]),comment:s(()=>[e(a.$slots,"comment")]),footer:s(()=>[e(a.$slots,"footer")]),aside:s(()=>[e(a.$slots,"aside")]),"aside-custom":s(()=>[e(a.$slots,"aside-custom")]),default:s(()=>[e(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{q as default,_ as usePageData};
