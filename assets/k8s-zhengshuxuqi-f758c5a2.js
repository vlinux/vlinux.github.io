import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang-e7d89830.js";import{_ as C,c as y,w as e,o as D,a as d,b as l,d as s,e as n,r as t,f as A,p as h}from"./app-4d89398e.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-2ca9ab31.js";import"./YunCard.vue_vue_type_style_index_0_lang-4f49289b.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-a8598bd1.js";const ul=JSON.parse('{"title":"Kubernetes 证书续期实战记录","description":"","frontmatter":{"title":"Kubernetes 证书续期实战记录","date":"2025-07-16T16:35:38.000Z","updated":"2025-07-16T16:35:38.000Z","tags":"Kubernetes","categories":null,"end":false},"headers":[{"level":2,"title":"操作环境","slug":"操作环境","link":"#操作环境","children":[]},{"level":2,"title":"完整操作流程","slug":"完整操作流程","link":"#完整操作流程","children":[{"level":3,"title":"一、准备工作","slug":"一、准备工作","link":"#一、准备工作","children":[]},{"level":3,"title":"二、证书续期操作","slug":"二、证书续期操作","link":"#二、证书续期操作","children":[]},{"level":3,"title":"4. 更新其他控制平面节点","slug":"_4-更新其他控制平面节点","link":"#_4-更新其他控制平面节点","children":[]},{"level":3,"title":"三、Worker节点处理","slug":"三、worker节点处理","link":"#三、worker节点处理","children":[]},{"level":3,"title":"四、验证结果","slug":"四、验证结果","link":"#四、验证结果","children":[]}]},{"level":2,"title":"五、恢复操作（如果续期失败）","slug":"五、恢复操作（如果续期失败）","link":"#五、恢复操作（如果续期失败）","children":[{"level":3,"title":"5.1 停止kubelet服务","slug":"_5-1-停止kubelet服务","link":"#_5-1-停止kubelet服务","children":[]},{"level":3,"title":"5.2 恢复备份的证书","slug":"_5-2-恢复备份的证书","link":"#_5-2-恢复备份的证书","children":[]},{"level":3,"title":"5.3 恢复etcd数据（如果备份了）","slug":"_5-3-恢复etcd数据（如果备份了）","link":"#_5-3-恢复etcd数据（如果备份了）","children":[]},{"level":3,"title":"5.4 重启服务","slug":"_5-4-重启服务","link":"#_5-4-重启服务","children":[]},{"level":3,"title":"5.5 验证恢复","slug":"_5-5-验证恢复","link":"#_5-5-验证恢复","children":[]}]},{"level":2,"title":"附录：常用命令速查表","slug":"附录：常用命令速查表","link":"#附录：常用命令速查表","children":[]}],"relativePath":"pages/posts/k8s-zhengshuxuqi.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/k8s-zhengshuxuqi.md","lastUpdated":1752656559000}'),c=JSON.parse('{"title":"Kubernetes 证书续期实战记录","description":"","frontmatter":{"title":"Kubernetes 证书续期实战记录","date":"2025-07-16T16:35:38.000Z","updated":"2025-07-16T16:35:38.000Z","tags":"Kubernetes","categories":null,"end":false},"headers":[{"level":2,"title":"操作环境","slug":"操作环境","link":"#操作环境","children":[]},{"level":2,"title":"完整操作流程","slug":"完整操作流程","link":"#完整操作流程","children":[{"level":3,"title":"一、准备工作","slug":"一、准备工作","link":"#一、准备工作","children":[]},{"level":3,"title":"二、证书续期操作","slug":"二、证书续期操作","link":"#二、证书续期操作","children":[]},{"level":3,"title":"4. 更新其他控制平面节点","slug":"_4-更新其他控制平面节点","link":"#_4-更新其他控制平面节点","children":[]},{"level":3,"title":"三、Worker节点处理","slug":"三、worker节点处理","link":"#三、worker节点处理","children":[]},{"level":3,"title":"四、验证结果","slug":"四、验证结果","link":"#四、验证结果","children":[]}]},{"level":2,"title":"五、恢复操作（如果续期失败）","slug":"五、恢复操作（如果续期失败）","link":"#五、恢复操作（如果续期失败）","children":[{"level":3,"title":"5.1 停止kubelet服务","slug":"_5-1-停止kubelet服务","link":"#_5-1-停止kubelet服务","children":[]},{"level":3,"title":"5.2 恢复备份的证书","slug":"_5-2-恢复备份的证书","link":"#_5-2-恢复备份的证书","children":[]},{"level":3,"title":"5.3 恢复etcd数据（如果备份了）","slug":"_5-3-恢复etcd数据（如果备份了）","link":"#_5-3-恢复etcd数据（如果备份了）","children":[]},{"level":3,"title":"5.4 重启服务","slug":"_5-4-重启服务","link":"#_5-4-重启服务","children":[]},{"level":3,"title":"5.5 验证恢复","slug":"_5-5-验证恢复","link":"#_5-5-验证恢复","children":[]}]},{"level":2,"title":"附录：常用命令速查表","slug":"附录：常用命令速查表","link":"#附录：常用命令速查表","children":[]}],"relativePath":"pages/posts/k8s-zhengshuxuqi.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/k8s-zhengshuxuqi.md","lastUpdated":1752656559000}'),u={name:"pages/posts/k8s-zhengshuxuqi.md",data(){return{data:c,frontmatter:c.frontmatter}},setup(){h("pageData",c)}},F=l("p",null,"某生产环境 Kubernetes 集群（v1.26.0）证书即将过期，具体表现为：",-1),_=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubeadm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"certs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"check-expiration"),l("span",{style:{color:"#A6ACCD"}}," ")]),s(`
`),l("span",{class:"line"})])])],-1),k=l("p",null,"输出显示多个证书剩余有效期不足7天。",-1),b={id:"操作环境",tabindex:"-1"},g=l("ul",null,[l("li",null,[l("strong",null,"集群规模"),s("：3 Master + 5 Worker Nodes")]),l("li",null,[l("strong",null,"部署方式"),s("：kubeadm")]),l("li",null,[s("证书类型 "),l("ul",null,[l("li",null,"kubelet 客户端/服务端证书"),l("li",null,"apiserver 证书"),l("li",null,"前端代理证书")])])],-1),E={id:"完整操作流程",tabindex:"-1"},f={id:"一、准备工作",tabindex:"-1"},B={id:"_1-备份关键数据",tabindex:"-1"},m=l("p",null,"在主节点（master）上执行,一个一个来",-1),v=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"BACKUP_DIR"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/opt/k8s-cert-backup-"),l("span",{style:{color:"#89DDFF"}},"$("),l("span",{style:{color:"#FFCB6B"}},"date"),l("span",{style:{color:"#C3E88D"}}," +%Y%m%d"),l("span",{style:{color:"#89DDFF"}},')"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"mkdir"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-p"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 备份证书和配置文件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-r"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 备份etcd数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"-d"),l("span",{style:{color:"#89DDFF"}},' "'),l("span",{style:{color:"#C3E88D"}},"/var/lib/etcd"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"];"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"then")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#FFCB6B"}},"tar"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-czf"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/etcd.tar.gz"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/var/lib/etcd")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF","font-style":"italic"}},"fi")]),s(`
`),l("span",{class:"line"})])])],-1),x={id:"_2-检查集群状态",tabindex:"-1"},$=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"nodes"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-o"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"wide")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"pods"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-A"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-Ev"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"Running|Completed"),l("span",{style:{color:"#89DDFF"}},"'")]),s(`
`),l("span",{class:"line"})])])],-1),K={id:"二、证书续期操作",tabindex:"-1"},w={id:"_1-续期证书",tabindex:"-1"},U=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubeadm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"certs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"renew"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"all")]),s(`
`),l("span",{class:"line"})])])],-1),P={id:"_2-更新kubeconfig文件",tabindex:"-1"},R=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 备份原有kubeconfig")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"mv"),l("span",{style:{color:"#A6ACCD"}}," $HOME"),l("span",{style:{color:"#C3E88D"}},"/.kube/config"),l("span",{style:{color:"#A6ACCD"}}," $HOME"),l("span",{style:{color:"#C3E88D"}},"/.kube/config.bak")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 获取新的kubeconfig")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/admin.conf"),l("span",{style:{color:"#A6ACCD"}}," $HOME"),l("span",{style:{color:"#C3E88D"}},"/.kube/config")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"chown"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"$("),l("span",{style:{color:"#FFCB6B"}},"id"),l("span",{style:{color:"#C3E88D"}}," -u"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#89DDFF"}},"$("),l("span",{style:{color:"#FFCB6B"}},"id"),l("span",{style:{color:"#C3E88D"}}," -g"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," $HOME"),l("span",{style:{color:"#C3E88D"}},"/.kube/config")]),s(`
`),l("span",{class:"line"})])])],-1),I={id:"_3-重启控制平面组件",tabindex:"-1"},N=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 重启kube-apiserver, kube-controller-manager, kube-scheduler")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"docker"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ps"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-E"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"kube-apiserver|kube-controller-manager|kube-scheduler"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"{print $1}"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"docker"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"restart")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 或者使用containerd")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"crictl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ps"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-E"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"kube-apiserver|kube-controller-manager|kube-scheduler"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"{print $1}"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"crictl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"stop")]),s(`
`),l("span",{class:"line"})])])],-1),z={id:"_4-更新其他控制平面节点",tabindex:"-1"},M=l("p",null,"在其他控制平面节点（master02, master03）上执行相同的操作：",-1),O=l("ol",null,[l("li",null,[s("续期证书："),l("code",null,"kubeadm certs renew all")]),l("li",null,"重启控制平面组件")],-1),q={id:"三、worker节点处理",tabindex:"-1"},V={id:"_1-更新kubelet证书",tabindex:"-1"},S=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 先验证证书是否更新，因为有的kubelet会自动加载更新")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"openssl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"x509"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-in"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/var/lib/kubelet/pki/kubelet-server-current.pem"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-text"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-noout"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-A"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"Validity")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 若已更新，则不用更了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 在所有Worker节点执行")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"sudo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"systemctl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"stop"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubelet")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"sudo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-rp"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C3E88D"}},"/var/lib/kubelet/pki"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/var/lib/kubelet/pki.bak")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"sudo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"systemctl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"start"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubelet")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 批准新CSR（在Master执行）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"watch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"csr"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"Pending"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"{print $1}"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"certificate"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"approve")]),s(`
`),l("span",{class:"line"})])])],-1),T={id:"四、验证结果",tabindex:"-1"},W=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 检查新证书有效期")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubeadm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"certs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"check-expiration")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 验证集群功能")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"nodes")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"run"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"test-pod"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"--image=nginx"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"--restart=Never"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"--"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/bin/sh"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-c"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"echo OK"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"})])])],-1),Z={id:"五、恢复操作（如果续期失败）",tabindex:"-1"},H=l("p",null,"如果证书续期过程中出现问题，可以按照以下步骤恢复：",-1),J={id:"_5-1-停止kubelet服务",tabindex:"-1"},L=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"systemctl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"stop"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubelet")]),s(`
`),l("span",{class:"line"})])])],-1),Y={id:"_5-2-恢复备份的证书",tabindex:"-1"},j=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 恢复证书目录")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"rm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-rf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/pki")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-r"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/pki"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 恢复kubeconfig文件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/admin.conf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/kubelet.conf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/controller-manager.conf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/scheduler.conf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/")]),s(`
`),l("span",{class:"line"})])])],-1),G={id:"_5-3-恢复etcd数据（如果备份了）",tabindex:"-1"},Q=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"-d"),l("span",{style:{color:"#89DDFF"}},' "'),l("span",{style:{color:"#A6ACCD"}},"$BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/etcd"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"];"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"then")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#FFCB6B"}},"rm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-rf"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/var/lib/etcd")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#FFCB6B"}},"cp"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-r"),l("span",{style:{color:"#A6ACCD"}}," $BACKUP_DIR"),l("span",{style:{color:"#C3E88D"}},"/etcd"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"/var/lib/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF","font-style":"italic"}},"fi")]),s(`
`),l("span",{class:"line"})])])],-1),X={id:"_5-4-重启服务",tabindex:"-1"},ll=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"systemctl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"restart"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kubelet")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"docker"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ps"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"grep"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-E"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"kube-apiserver|kube-controller-manager|kube-scheduler"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"awk"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"{print $1}"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"|"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"xargs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"docker"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"restart")]),s(`
`),l("span",{class:"line"})])])],-1),sl={id:"_5-5-验证恢复",tabindex:"-1"},el=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"nodes")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubeadm"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"certs"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"check-expiration")]),s(`
`),l("span",{class:"line"})])])],-1),ol=l("p",null,"文档参考：",-1),nl=l("ul",null,[l("li",null,"Kubernetes官方证书管理指南"),l("li",null,"证书轮换最佳实践")],-1),al={id:"附录：常用命令速查表",tabindex:"-1"},tl=l("table",null,[l("thead",null,[l("tr",null,[l("th",{style:{"text-align":"center"}},"功能"),l("th",{style:{"text-align":"center"}},"命令")])]),l("tbody",null,[l("tr",null,[l("td",{style:{"text-align":"center"}},"检查证书过期"),l("td",{style:{"text-align":"center"}},[l("code",null,"kubeadm certs check-expiration")])]),l("tr",null,[l("td",{style:{"text-align":"center"}},"手动批准CSR"),l("td",{style:{"text-align":"center"}},[l("code",null,"kubectl certificate approve <csr-name>")])]),l("tr",null,[l("td",{style:{"text-align":"center"}},"检查控制器选举"),l("td",{style:{"text-align":"center"}},[l("code",null,"kubectl get leases -n kube-system")])]),l("tr",null,[l("td",{style:{"text-align":"center"}},"验证证书链"),l("td",{style:{"text-align":"center"}},[l("code",null,"openssl verify -CAfile /etc/kubernetes/pki/ca.crt <cert-file>")])])])],-1);function cl(a,rl,pl,il,r,Cl){const o=A,p=i;return D(),y(p,{frontmatter:r.frontmatter,data:r.data},{"main-content-md":e(()=>[d(" more "),F,_,k,l("h2",b,[s("操作环境 "),n(o,{class:"header-anchor",href:"#操作环境","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),g,l("h2",E,[s("完整操作流程 "),n(o,{class:"header-anchor",href:"#完整操作流程","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h3",f,[s("一、准备工作 "),n(o,{class:"header-anchor",href:"#一、准备工作","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h4",B,[s("1. 备份关键数据 "),n(o,{class:"header-anchor",href:"#_1-备份关键数据","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),m,v,l("h4",x,[s("2. 检查集群状态 "),n(o,{class:"header-anchor",href:"#_2-检查集群状态","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),$,l("h3",K,[s("二、证书续期操作 "),n(o,{class:"header-anchor",href:"#二、证书续期操作","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h4",w,[s("1. 续期证书 "),n(o,{class:"header-anchor",href:"#_1-续期证书","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),U,l("h4",P,[s("2. 更新kubeconfig文件 "),n(o,{class:"header-anchor",href:"#_2-更新kubeconfig文件","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),R,l("h4",I,[s("3. 重启控制平面组件 "),n(o,{class:"header-anchor",href:"#_3-重启控制平面组件","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),N,l("h3",z,[s("4. 更新其他控制平面节点 "),n(o,{class:"header-anchor",href:"#_4-更新其他控制平面节点","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),M,O,l("h3",q,[s("三、Worker节点处理 "),n(o,{class:"header-anchor",href:"#三、worker节点处理","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h4",V,[s("1. 更新kubelet证书 "),n(o,{class:"header-anchor",href:"#_1-更新kubelet证书","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),S,l("h3",T,[s("四、验证结果 "),n(o,{class:"header-anchor",href:"#四、验证结果","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),W,l("h2",Z,[s("五、恢复操作（如果续期失败） "),n(o,{class:"header-anchor",href:"#五、恢复操作（如果续期失败）","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),H,l("h3",J,[s("5.1 停止kubelet服务 "),n(o,{class:"header-anchor",href:"#_5-1-停止kubelet服务","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),L,l("h3",Y,[s("5.2 恢复备份的证书 "),n(o,{class:"header-anchor",href:"#_5-2-恢复备份的证书","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),j,l("h3",G,[s("5.3 恢复etcd数据（如果备份了） "),n(o,{class:"header-anchor",href:"#_5-3-恢复etcd数据（如果备份了）","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),Q,l("h3",X,[s("5.4 重启服务 "),n(o,{class:"header-anchor",href:"#_5-4-重启服务","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),ll,l("h3",sl,[s("5.5 验证恢复 "),n(o,{class:"header-anchor",href:"#_5-5-验证恢复","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),el,ol,nl,l("h2",al,[s("附录：常用命令速查表 "),n(o,{class:"header-anchor",href:"#附录：常用命令速查表","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),tl]),"main-header":e(()=>[t(a.$slots,"main-header")]),"main-header-after":e(()=>[t(a.$slots,"main-header-after")]),"main-nav":e(()=>[t(a.$slots,"main-nav")]),"main-content":e(()=>[t(a.$slots,"main-content")]),"main-content-after":e(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":e(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":e(()=>[t(a.$slots,"main-nav-after")]),comment:e(()=>[t(a.$slots,"comment")]),footer:e(()=>[t(a.$slots,"footer")]),aside:e(()=>[t(a.$slots,"aside")]),"aside-custom":e(()=>[t(a.$slots,"aside-custom")]),default:e(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter","data"])}const Fl=C(u,[["render",cl]]);export{ul as __pageData,Fl as default};
