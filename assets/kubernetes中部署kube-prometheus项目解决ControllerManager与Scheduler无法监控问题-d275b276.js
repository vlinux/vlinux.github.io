import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang-d46a0622.js";import{_ as u,c as d,w as l,o as C,b as e,U as s,q as t,r as a,W as h,p as m}from"./app-f99ffcec.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-b7d30a4f.js";import"./YunCard.vue_vue_type_style_index_0_lang-3d84b3a3.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-95246a82.js";const Q=JSON.parse('{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","description":"","frontmatter":{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","categories":"Kubernetes","tags":["监控ControllerManager与Scheduler"],"date":"2021-03-02T15:26:00.000Z"},"headers":[{"level":2,"title":"一、问题描述","slug":"一、问题描述","link":"#一、问题描述","children":[]},{"level":2,"title":"二、新增、更改KubeControllerManager配置","slug":"二、新增、更改kubecontrollermanager配置","link":"#二、新增、更改kubecontrollermanager配置","children":[]},{"level":2,"title":"三、新增、更改KubeScheduler配置","slug":"三、新增、更改kubescheduler配置","link":"#三、新增、更改kubescheduler配置","children":[]},{"level":2,"title":"四、结果图","slug":"四、结果图","link":"#四、结果图","children":[]},{"level":2,"title":"五、参考信息","slug":"五、参考信息","link":"#五、参考信息","children":[]},{"level":2,"title":"六、参考Kube-prom项目（已优化）支持k8s-v1.18.0+","slug":"六、参考kube-prom项目（已优化）支持k8s-v1-18-0","link":"#六、参考kube-prom项目（已优化）支持k8s-v1-18-0","children":[]}],"relativePath":"pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md","lastUpdated":1671090556000}'),r=JSON.parse('{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","description":"","frontmatter":{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","categories":"Kubernetes","tags":["监控ControllerManager与Scheduler"],"date":"2021-03-02T15:26:00.000Z"},"headers":[{"level":2,"title":"一、问题描述","slug":"一、问题描述","link":"#一、问题描述","children":[]},{"level":2,"title":"二、新增、更改KubeControllerManager配置","slug":"二、新增、更改kubecontrollermanager配置","link":"#二、新增、更改kubecontrollermanager配置","children":[]},{"level":2,"title":"三、新增、更改KubeScheduler配置","slug":"三、新增、更改kubescheduler配置","link":"#三、新增、更改kubescheduler配置","children":[]},{"level":2,"title":"四、结果图","slug":"四、结果图","link":"#四、结果图","children":[]},{"level":2,"title":"五、参考信息","slug":"五、参考信息","link":"#五、参考信息","children":[]},{"level":2,"title":"六、参考Kube-prom项目（已优化）支持k8s-v1.18.0+","slug":"六、参考kube-prom项目（已优化）支持k8s-v1-18-0","link":"#六、参考kube-prom项目（已优化）支持k8s-v1-18-0","children":[]}],"relativePath":"pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md","lastUpdated":1671090556000}'),y={name:"pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md",data(){return{data:r,frontmatter:r.frontmatter}},setup(){m("pageData",r)}},b={id:"一、问题描述",tabindex:"-1"},k=e("hr",null,null,-1),A=e("blockquote",null,[e("p",null,"在部署kube-prometheus到kubernetes集群中总会遇到一个问题，当pod都正常运行的时候，却发现kube-controller-manager和kube-scheduler并没有正常被监控到，即使是新建了新的SVC与两个Pod进行绑定但还是不行。故有此篇文章")],-1),g=e("p",null,[e("strong",null,"原因如下")],-1),_=e("p",null,"版本1.18+现在使用更安全的https端口10257，并默认禁用http。不幸的是，kube-controller-manager和kube-scheduler都使用了--secure-port绑定到127.0.0.1而不是0.0.0.0",-1),D=e("p",null,[e("strong",null,"解决方法：")],-1),B=e("p",null,"更新/etc/kubernetes/manifests/中的清单以将--bind-address 0.0.0.0用于调度程序和控制器管理器，将使用正确的绑定地址重新启动Pod，但是这些设置将无法生存kubeadm升级",-1),F={id:"二、新增、更改kubecontrollermanager配置",tabindex:"-1"},v=e("p",null,[e("strong",null,"新增service.yaml")],-1),f=e("div",{class:"language-bash"},[e("span",{class:"copy"}),e("pre",{class:"shiki material-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"vim"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"prometheus-kubeControllerManagerService.yaml")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"apiVersion:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"v1")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"kind:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"Service")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"metadata:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"namespace:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-system")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"name:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-controller-manager")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"labels:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"k8s-app:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-controller-manager")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"spec:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"selector:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"component:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-controller-manager")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"ports:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"name:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"https-metrics")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"port:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F78C6C"}},"10257"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#676E95","font-style":"italic"}},"#端口要和你describe到的ControllerManager的Pod端口信息一致")]),s(`
`),e("span",{class:"line"})])])],-1),E=e("div",{class:"language-bash"},[e("span",{class:"copy"}),e("pre",{class:"shiki material-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"vim"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/manifests/kube-controller-manager.yaml")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"将--bind-address=127.0.0.1"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"改为"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"--bind-address=0.0.0.0")]),s(`
`),e("span",{class:"line"})])])],-1),S=e("p",null,"由于kube-controller-manager是以静态Pod运行在集群中的，所以只要修改静态Pod目录下对应的yaml文件即可。等待一会后，对应服务会自动重启",-1),M={id:"三、新增、更改kubescheduler配置",tabindex:"-1"},$=e("p",null,[e("strong",null,"新增service.yaml")],-1),K=e("p",null,"vim kube-prometheus/manifests/prometheus-serviceMonitorKubeScheduler-service.yaml 输入下面内容 ：",-1),P=e("div",{class:"language-bash"},[e("span",{class:"copy"}),e("pre",{class:"shiki material-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"apiVersion:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"v1")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"kind:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"Service")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"metadata:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"namespace:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-system")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"name:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-scheduler")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"labels:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"k8s-app:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-scheduler")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"spec:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"selector:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"component:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"kube-scheduler")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"ports:")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"name:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"https-metrics")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"port:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F78C6C"}},"10259"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#676E95","font-style":"italic"}},"#端口要和你describe到的ControllerManager的Pod端口信息一致")]),s(`
`),e("span",{class:"line"})])])],-1),x=e("div",{class:"language-bash"},[e("span",{class:"copy"}),e("pre",{class:"shiki material-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"vim"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/etc/kubernetes/manifests/kube-scheduler.yaml")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"将--bind-address=127.0.0.1"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"改为"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"--bind-address=0.0.0.0")]),s(`
`),e("span",{class:"line"})])])],-1),V=e("p",null,"由于kube-scheduler是以静态Pod运行在集群中的，所以只要修改静态Pod目录下对应的yaml文件即可。等待一会后，对应服务会自动重启",-1),w={id:"四、结果图",tabindex:"-1"},N=e("p",null,[e("img",{src:"https://vlinux-1259060227.cos.ap-shanghai.myqcloud.com/www-vlinux-cn-blog-img/gitee-backup/img-master/image/image-20210302150944346.png",alt:"image-20210302150944346"})],-1),U={id:"五、参考信息",tabindex:"-1"},q={id:"六、参考kube-prom项目（已优化）支持k8s-v1-18-0",tabindex:"-1"},T=e("p",null,'[github repo="vlinux/Kube-Prometheus" /]',-1);function J(n,O,Z,L,c,W){const o=h,p=i;return C(),d(p,{frontmatter:c.frontmatter,data:c.data},{"main-content-md":l(()=>[e("h2",b,[s("一、问题描述 "),t(o,{class:"header-anchor",href:"#一、问题描述","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),k,A,g,_,D,B,e("h2",F,[s("二、新增、更改KubeControllerManager配置 "),t(o,{class:"header-anchor",href:"#二、新增、更改kubecontrollermanager配置","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),v,f,E,S,e("h2",M,[s("三、新增、更改KubeScheduler配置 "),t(o,{class:"header-anchor",href:"#三、新增、更改kubescheduler配置","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),$,K,P,x,V,e("h2",w,[s("四、结果图 "),t(o,{class:"header-anchor",href:"#四、结果图","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),N,e("h2",U,[s("五、参考信息 "),t(o,{class:"header-anchor",href:"#五、参考信息","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),e("p",null,[t(o,{href:"https://github.com/prometheus-operator/kube-prometheus/issues/718",target:"_blank",rel:"noreferrer"},{default:l(()=>[s("https://github.com/prometheus-operator/kube-prometheus/issues/718")]),_:1})]),e("h2",q,[s("六、参考Kube-prom项目（已优化）支持k8s-v1.18.0+ "),t(o,{class:"header-anchor",href:"#六、参考kube-prom项目（已优化）支持k8s-v1-18-0","aria-hidden":"true"},{default:l(()=>[s("#")]),_:1})]),T]),"main-header":l(()=>[a(n.$slots,"main-header")]),"main-header-after":l(()=>[a(n.$slots,"main-header-after")]),"main-nav":l(()=>[a(n.$slots,"main-nav")]),"main-content":l(()=>[a(n.$slots,"main-content")]),"main-content-after":l(()=>[a(n.$slots,"main-content-after")]),"main-nav-before":l(()=>[a(n.$slots,"main-nav-before")]),"main-nav-after":l(()=>[a(n.$slots,"main-nav-after")]),comment:l(()=>[a(n.$slots,"comment")]),footer:l(()=>[a(n.$slots,"footer")]),aside:l(()=>[a(n.$slots,"aside")]),"aside-custom":l(()=>[a(n.$slots,"aside-custom")]),default:l(()=>[a(n.$slots,"default")]),_:3},8,["frontmatter","data"])}const R=u(y,[["render",J]]);export{Q as __pageData,R as default};
