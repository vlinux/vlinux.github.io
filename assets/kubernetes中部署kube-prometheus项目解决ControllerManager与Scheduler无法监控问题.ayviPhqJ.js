import{_ as c}from"./ValaxyMain.vue_vue_type_style_index_0_lang.Bth_JSAQ.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as u,u as F,a as m}from"./chunks/vue-router.DpP0leKZ.js";import{aa as g,ap as a,ag as l,af as s,ai as e,P as b,ab as y,a1 as C}from"./framework.GHZxz7jq.js";import"./index.Di1n2b66.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BWywLGB4.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.DoKt6roH.js";const B=u("/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题",async t=>JSON.parse('{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","description":"","frontmatter":{"title":"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题","categories":"Kubernetes","tags":["监控ControllerManager与Scheduler"],"date":"2021-03-02 15:26:00"},"headers":[],"relativePath":"pages/posts/kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题.md","lastUpdated":null}'),{lazy:(t,n)=>t.name===n.name}),z={__name:"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题",setup(t,{expose:n}){const{data:h}=B(),o=m(),p=F(),r=Object.assign(p.meta.frontmatter||{},h.value?.frontmatter||{});return o.currentRoute.value.data=h.value,C("valaxy:frontmatter",r),globalThis.$frontmatter=r,n({frontmatter:{title:"kubernetes中部署kube-prometheus项目解决ControllerManager与Scheduler无法监控问题",categories:"Kubernetes",tags:["监控ControllerManager与Scheduler"],date:"2021-03-02 15:26:00"}}),(i,k)=>{const d=c;return y(),g(d,{frontmatter:b(r)},{"main-content-md":a(()=>[...k[0]||(k[0]=[s("h2",{id:"一、问题描述",tabindex:"-1"},[e("一、问题描述 "),s("a",{class:"header-anchor",href:"#一、问题描述","aria-label":'Permalink to "一、问题描述"'},"​")],-1),s("hr",null,null,-1),s("blockquote",null,[s("p",null,"在部署kube-prometheus到kubernetes集群中总会遇到一个问题，当pod都正常运行的时候，却发现kube-controller-manager和kube-scheduler并没有正常被监控到，即使是新建了新的SVC与两个Pod进行绑定但还是不行。故有此篇文章")],-1),s("p",null,[s("strong",null,"原因如下")],-1),s("p",null,"版本1.18+现在使用更安全的https端口10257，并默认禁用http。不幸的是，kube-controller-manager和kube-scheduler都使用了–secure-port绑定到127.0.0.1而不是0.0.0.0",-1),s("p",null,[s("strong",null,"解决方法：")],-1),s("p",null,"更新/etc/kubernetes/manifests/中的清单以将–bind-address 0.0.0.0用于调度程序和控制器管理器，将使用正确的绑定地址重新启动Pod，但是这些设置将无法生存kubeadm升级",-1),s("h2",{id:"二、新增、更改kubecontrollermanager配置",tabindex:"-1"},[e("二、新增、更改KubeControllerManager配置 "),s("a",{class:"header-anchor",href:"#二、新增、更改kubecontrollermanager配置","aria-label":'Permalink to "二、新增、更改KubeControllerManager配置"'},"​")],-1),s("p",null,[s("strong",null,"新增service.yaml")],-1),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vim"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," prometheus-kubeControllerManagerService.yaml")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apiVersion:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," v1")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kind:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Service")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"metadata:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  namespace:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-system")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  name:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-controller-manager")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  labels:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    k8s-app:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-controller-manager")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"spec:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  selector:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    component:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-controller-manager")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  ports:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," name:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," https-metrics")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    port:"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10257"),s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," #端口要和你describe到的ControllerManager的Pod端口信息一致")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vim"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/manifests/kube-controller-manager.yaml")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"将--bind-address"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"=127.0.0.1"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 改为"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --bind-address=0.0.0.0")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"由于kube-controller-manager是以静态Pod运行在集群中的，所以只要修改静态Pod目录下对应的yaml文件即可。等待一会后，对应服务会自动重启",-1),s("h2",{id:"三、新增、更改kubescheduler配置",tabindex:"-1"},[e("三、新增、更改KubeScheduler配置 "),s("a",{class:"header-anchor",href:"#三、新增、更改kubescheduler配置","aria-label":'Permalink to "三、新增、更改KubeScheduler配置"'},"​")],-1),s("p",null,[s("strong",null,"新增service.yaml")],-1),s("p",null,"vim kube-prometheus/manifests/prometheus-serviceMonitorKubeScheduler-service.yaml 输入下面内容 ：",-1),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apiVersion:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," v1")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kind:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Service")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"metadata:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  namespace:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-system")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  name:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-scheduler")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  labels:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    k8s-app:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-scheduler")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"spec:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  selector:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    component:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kube-scheduler")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  ports:")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," name:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," https-metrics")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    port:"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10259"),s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," #端口要和你describe到的ControllerManager的Pod端口信息一致")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vim"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/manifests/kube-scheduler.yaml")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"将--bind-address"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"=127.0.0.1"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 改为"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --bind-address=0.0.0.0")])])]),s("button",{class:"code-block-unfold-btn"})],-1),s("p",null,"由于kube-scheduler是以静态Pod运行在集群中的，所以只要修改静态Pod目录下对应的yaml文件即可。等待一会后，对应服务会自动重启",-1),s("h2",{id:"四、结果图",tabindex:"-1"},[e("四、结果图 "),s("a",{class:"header-anchor",href:"#四、结果图","aria-label":'Permalink to "四、结果图"'},"​")],-1),s("figure",null,[s("img",{src:"https://cos.vlinux.cn/www-vlinux-cn-blog-img/gitee-backup/img-master/image/image-20210302150944346.png",alt:"image-20210302150944346",loading:"lazy",decoding:"async"})],-1),s("h2",{id:"五、参考信息",tabindex:"-1"},[e("五、参考信息 "),s("a",{class:"header-anchor",href:"#五、参考信息","aria-label":'Permalink to "五、参考信息"'},"​")],-1),s("p",null,[s("a",{href:"https://github.com/prometheus-operator/kube-prometheus/issues/718",target:"_blank",rel:"noreferrer"},"https://github.com/prometheus-operator/kube-prometheus/issues/718")],-1),s("h2",{id:"六、参考kube-prom项目-已优化-支持k8s-v1-18-0",tabindex:"-1"},[e("六、参考Kube-prom项目（已优化）支持k8s-v1.18.0+ "),s("a",{class:"header-anchor",href:"#六、参考kube-prom项目-已优化-支持k8s-v1-18-0","aria-label":'Permalink to "六、参考Kube-prom项目（已优化）支持k8s-v1.18.0+"'},"​")],-1),s("p",null,'[github repo="vlinux/Kube-Prometheus" /]',-1)])]),"main-header":a(()=>[l(i.$slots,"main-header")]),"main-header-after":a(()=>[l(i.$slots,"main-header-after")]),"main-nav":a(()=>[l(i.$slots,"main-nav")]),"main-content-before":a(()=>[l(i.$slots,"main-content-before")]),"main-content":a(()=>[l(i.$slots,"main-content")]),"main-content-after":a(()=>[l(i.$slots,"main-content-after")]),"main-nav-before":a(()=>[l(i.$slots,"main-nav-before")]),"main-nav-after":a(()=>[l(i.$slots,"main-nav-after")]),comment:a(()=>[l(i.$slots,"comment")]),footer:a(()=>[l(i.$slots,"footer")]),aside:a(()=>[l(i.$slots,"aside")]),"aside-custom":a(()=>[l(i.$slots,"aside-custom")]),default:a(()=>[l(i.$slots,"default")]),_:3},8,["frontmatter"])}}};export{z as default,B as usePageData};
