import{_ as g}from"./ValaxyMain.vue_vue_type_style_index_0_lang.gfo-rUCP.js";import"./chunks/@vueuse/motion.BITvz5PP.js";import{e as o,u as y,a as b}from"./chunks/vue-router.DQHxU7r6.js";import{aa as u,ap as l,ag as e,ae as C,af as i,ai as a,P as c,ab as E,a1 as B}from"./framework.GHZxz7jq.js";import"./index.CFgbcban.js";import"./chunks/dayjs.BldX5ftQ.js";import"./chunks/vue-i18n.C7V8WoQZ.js";import"./chunks/pinia.BfAlK2F6.js";import"./chunks/nprogress.BZwbcB2O.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.CU_FKKcY.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.fblE3Fel.js";import"./post.zk_xPNhE.js";const m=o("/posts/k8s-zhengshuxuqi",async k=>JSON.parse('{"title":"Kubernetes 证书续期实战记录","description":"","frontmatter":{"title":"Kubernetes 证书续期实战记录","date":"2025-07-16 16:35:38","updated":"2025-07-16 16:35:38","tags":"Kubernetes","categories":null,"end":false},"headers":[],"relativePath":"pages/posts/k8s-zhengshuxuqi.md","lastUpdated":null}'),{lazy:(k,h)=>k.name===h.name}),N={__name:"k8s-zhengshuxuqi",setup(k,{expose:h}){const{data:r}=m(),d=b(),p=y(),n=Object.assign(p.meta.frontmatter||{},r.value?.frontmatter||{});return d.currentRoute.value.data=r.value,B("valaxy:frontmatter",n),globalThis.$frontmatter=n,h({frontmatter:{title:"Kubernetes 证书续期实战记录",date:"2025-07-16 16:35:38",updated:"2025-07-16 16:35:38",tags:"Kubernetes",categories:null,end:!1}}),(t,s)=>{const F=g;return E(),u(F,{frontmatter:c(n)},{"main-content-md":l(()=>[C(" more "),s[0]||(s[0]=i("p",null,"某生产环境 Kubernetes 集群（v1.26.0）证书即将过期，具体表现为：",-1)),s[1]||(s[1]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubeadm"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," check-expiration")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2]||(s[2]=i("p",null,"输出显示多个证书剩余有效期不足7天。",-1)),s[3]||(s[3]=i("h2",{id:"操作环境",tabindex:"-1"},[a("操作环境 "),i("a",{class:"header-anchor",href:"#操作环境","aria-label":'Permalink to "操作环境"'},"​")],-1)),s[4]||(s[4]=i("ul",null,[i("li",null,[i("strong",null,"集群规模"),a("：3 Master + 5 Worker Nodes")]),i("li",null,[i("strong",null,"部署方式"),a("：kubeadm")]),i("li",null,[a("证书类型 "),i("ul",null,[i("li",null,"kubelet 客户端/服务端证书"),i("li",null,"apiserver 证书"),i("li",null,"前端代理证书")])])],-1)),s[5]||(s[5]=i("h2",{id:"完整操作流程",tabindex:"-1"},[a("完整操作流程 "),i("a",{class:"header-anchor",href:"#完整操作流程","aria-label":'Permalink to "完整操作流程"'},"​")],-1)),s[6]||(s[6]=i("h3",{id:"一、准备工作",tabindex:"-1"},[a("一、准备工作 "),i("a",{class:"header-anchor",href:"#一、准备工作","aria-label":'Permalink to "一、准备工作"'},"​")],-1)),s[7]||(s[7]=i("h4",{id:"_1-备份关键数据",tabindex:"-1"},[a("1. 备份关键数据 "),i("a",{class:"header-anchor",href:"#_1-备份关键数据","aria-label":'Permalink to "1. 备份关键数据"'},"​")],-1)),s[8]||(s[8]=i("p",null,"在主节点（master）上执行,一个一个来",-1)),s[9]||(s[9]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"BACKUP_DIR"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/opt/k8s-cert-backup-$('),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"date"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' +%Y%m%d)"')]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 备份证书和配置文件")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -r"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 备份etcd数据")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [ "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/var/lib/etcd"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ]; "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  tar"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -czf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/etcd.tar.gz"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/etcd")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"fi")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[10]||(s[10]=i("h4",{id:"_2-检查集群状态",tabindex:"-1"},[a("2. 检查集群状态 "),i("a",{class:"header-anchor",href:"#_2-检查集群状态","aria-label":'Permalink to "2. 检查集群状态"'},"​")],-1)),s[11]||(s[11]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nodes"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -o"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," wide")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pods"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -A"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Ev"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Running|Completed'")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[12]||(s[12]=i("h3",{id:"二、证书续期操作",tabindex:"-1"},[a("二、证书续期操作 "),i("a",{class:"header-anchor",href:"#二、证书续期操作","aria-label":'Permalink to "二、证书续期操作"'},"​")],-1)),s[13]||(s[13]=i("h4",{id:"_1-续期证书",tabindex:"-1"},[a("1. 续期证书 "),i("a",{class:"header-anchor",href:"#_1-续期证书","aria-label":'Permalink to "1. 续期证书"'},"​")],-1)),s[14]||(s[14]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubeadm"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," renew"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," all")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[15]||(s[15]=i("h4",{id:"_2-更新kubeconfig文件",tabindex:"-1"},[a("2. 更新kubeconfig文件 "),i("a",{class:"header-anchor",href:"#_2-更新kubeconfig文件","aria-label":'Permalink to "2. 更新kubeconfig文件"'},"​")],-1)),s[16]||(s[16]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 备份原有kubeconfig")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mv"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $HOME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.kube/config"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $HOME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.kube/config.bak")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 获取新的kubeconfig")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/admin.conf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $HOME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.kube/config")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"id"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"id"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -g"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") $HOME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.kube/config")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[17]||(s[17]=i("h4",{id:"_3-重启控制平面组件",tabindex:"-1"},[a("3. 重启控制平面组件 "),i("a",{class:"header-anchor",href:"#_3-重启控制平面组件","aria-label":'Permalink to "3. 重启控制平面组件"'},"​")],-1)),s[18]||(s[18]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 重启kube-apiserver, kube-controller-manager, kube-scheduler")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ps"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -E"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'kube-apiserver|kube-controller-manager|kube-scheduler'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," awk"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{print $1}'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 或者使用containerd")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"crictl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ps"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -E"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'kube-apiserver|kube-controller-manager|kube-scheduler'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," awk"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{print $1}'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," crictl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[19]||(s[19]=i("h3",{id:"_4-更新其他控制平面节点",tabindex:"-1"},[a("4. 更新其他控制平面节点 "),i("a",{class:"header-anchor",href:"#_4-更新其他控制平面节点","aria-label":'Permalink to "4. 更新其他控制平面节点"'},"​")],-1)),s[20]||(s[20]=i("p",null,"在其他控制平面节点（master02, master03）上执行相同的操作：",-1)),s[21]||(s[21]=i("ol",null,[i("li",null,[a("续期证书："),i("code",null,"kubeadm certs renew all")]),i("li",null,"重启控制平面组件")],-1)),s[22]||(s[22]=i("h3",{id:"三、worker节点处理",tabindex:"-1"},[a("三、Worker节点处理 "),i("a",{class:"header-anchor",href:"#三、worker节点处理","aria-label":'Permalink to "三、Worker节点处理"'},"​")],-1)),s[23]||(s[23]=i("h4",{id:"_1-更新kubelet证书",tabindex:"-1"},[a("1. 更新kubelet证书 "),i("a",{class:"header-anchor",href:"#_1-更新kubelet证书","aria-label":'Permalink to "1. 更新kubelet证书"'},"​")],-1)),s[24]||(s[24]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 先验证证书是否更新，因为有的kubelet会自动加载更新")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"openssl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," x509"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -in"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/kubelet/pki/kubelet-server-current.pem"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -text"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -noout"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -A"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Validity")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 若已更新，则不用更了")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 在所有Worker节点执行")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubelet")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cp"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  /var/lib/kubelet/pki"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/kubelet/pki.bak")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," start"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubelet")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 批准新CSR（在Master执行）")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"watch"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," csr"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Pending"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," awk"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{print $1}'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certificate"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," approve")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[25]||(s[25]=i("h3",{id:"四、验证结果",tabindex:"-1"},[a("四、验证结果 "),i("a",{class:"header-anchor",href:"#四、验证结果","aria-label":'Permalink to "四、验证结果"'},"​")],-1)),s[26]||(s[26]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 检查新证书有效期")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubeadm"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," check-expiration")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 验证集群功能")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nodes")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," test-pod"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --image=nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --restart=Never"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /bin/sh"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -c"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "echo OK"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[27]||(s[27]=i("h2",{id:"五、恢复操作-如果续期失败",tabindex:"-1"},[a("五、恢复操作（如果续期失败） "),i("a",{class:"header-anchor",href:"#五、恢复操作-如果续期失败","aria-label":'Permalink to "五、恢复操作（如果续期失败）"'},"​")],-1)),s[28]||(s[28]=i("p",null,"如果证书续期过程中出现问题，可以按照以下步骤恢复：",-1)),s[29]||(s[29]=i("h3",{id:"_5-1-停止kubelet服务",tabindex:"-1"},[a("5.1 停止kubelet服务 "),i("a",{class:"header-anchor",href:"#_5-1-停止kubelet服务","aria-label":'Permalink to "5.1 停止kubelet服务"'},"​")],-1)),s[30]||(s[30]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubelet")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[31]||(s[31]=i("h3",{id:"_5-2-恢复备份的证书",tabindex:"-1"},[a("5.2 恢复备份的证书 "),i("a",{class:"header-anchor",href:"#_5-2-恢复备份的证书","aria-label":'Permalink to "5.2 恢复备份的证书"'},"​")],-1)),s[32]||(s[32]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 恢复证书目录")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rm"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/pki")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -r"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/pki"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/")]),a(`
`),i("span",{class:"line"}),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 恢复kubeconfig文件")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/admin.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/kubelet.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/controller-manager.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/scheduler.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/kubernetes/")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[33]||(s[33]=i("h3",{id:"_5-3-恢复etcd数据-如果备份了",tabindex:"-1"},[a("5.3 恢复etcd数据（如果备份了） "),i("a",{class:"header-anchor",href:"#_5-3-恢复etcd数据-如果备份了","aria-label":'Permalink to "5.3 恢复etcd数据（如果备份了）"'},"​")],-1)),s[34]||(s[34]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [ "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'/etcd"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ]; "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    rm"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/etcd")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    cp"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -r"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $BACKUP_DIR"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/etcd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"fi")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[35]||(s[35]=i("h3",{id:"_5-4-重启服务",tabindex:"-1"},[a("5.4 重启服务 "),i("a",{class:"header-anchor",href:"#_5-4-重启服务","aria-label":'Permalink to "5.4 重启服务"'},"​")],-1)),s[36]||(s[36]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kubelet")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ps"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -E"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'kube-apiserver|kube-controller-manager|kube-scheduler'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," awk"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{print $1}'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[37]||(s[37]=i("h3",{id:"_5-5-验证恢复",tabindex:"-1"},[a("5.5 验证恢复 "),i("a",{class:"header-anchor",href:"#_5-5-验证恢复","aria-label":'Permalink to "5.5 验证恢复"'},"​")],-1)),s[38]||(s[38]=i("div",{class:"language-bash"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubectl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nodes")]),a(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kubeadm"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," check-expiration")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[39]||(s[39]=i("p",null,"文档参考：",-1)),s[40]||(s[40]=i("ul",null,[i("li",null,"Kubernetes官方证书管理指南"),i("li",null,"证书轮换最佳实践")],-1)),s[41]||(s[41]=i("h2",{id:"附录-常用命令速查表",tabindex:"-1"},[a("附录：常用命令速查表 "),i("a",{class:"header-anchor",href:"#附录-常用命令速查表","aria-label":'Permalink to "附录：常用命令速查表"'},"​")],-1)),s[42]||(s[42]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"center"}},"功能"),i("th",{style:{"text-align":"center"}},"命令")])]),i("tbody",null,[i("tr",null,[i("td",{style:{"text-align":"center"}},"检查证书过期"),i("td",{style:{"text-align":"center"}},[i("code",null,"kubeadm certs check-expiration")])]),i("tr",null,[i("td",{style:{"text-align":"center"}},"手动批准CSR"),i("td",{style:{"text-align":"center"}},[i("code",null,"kubectl certificate approve <csr-name>")])]),i("tr",null,[i("td",{style:{"text-align":"center"}},"检查控制器选举"),i("td",{style:{"text-align":"center"}},[i("code",null,"kubectl get leases -n kube-system")])]),i("tr",null,[i("td",{style:{"text-align":"center"}},"验证证书链"),i("td",{style:{"text-align":"center"}},[i("code",null,"openssl verify -CAfile /etc/kubernetes/pki/ca.crt <cert-file>")])])])],-1))]),"main-header":l(()=>[e(t.$slots,"main-header")]),"main-header-after":l(()=>[e(t.$slots,"main-header-after")]),"main-nav":l(()=>[e(t.$slots,"main-nav")]),"main-content-before":l(()=>[e(t.$slots,"main-content-before")]),"main-content":l(()=>[e(t.$slots,"main-content")]),"main-content-after":l(()=>[e(t.$slots,"main-content-after")]),"main-nav-before":l(()=>[e(t.$slots,"main-nav-before")]),"main-nav-after":l(()=>[e(t.$slots,"main-nav-after")]),comment:l(()=>[e(t.$slots,"comment")]),footer:l(()=>[e(t.$slots,"footer")]),aside:l(()=>[e(t.$slots,"aside")]),"aside-custom":l(()=>[e(t.$slots,"aside-custom")]),default:l(()=>[e(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{N as default,m as usePageData};
