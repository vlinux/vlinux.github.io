import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang-3db59c20.js";import{_ as p,c as u,w as e,o as h,a as _,b as l,d as s,e as a,r as o,f as y,p as D}from"./app-1dca60bf.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-bf269ab4.js";import"./YunCard.vue_vue_type_style_index_0_lang-e8908175.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-e033a9d7.js";const il=JSON.parse('{"title":"Solr到Elasticsearch的踩坑与优化","description":"","frontmatter":{"title":"Solr到Elasticsearch的踩坑与优化","date":"2025-07-09T09:12:31.000Z","updated":"2025-07-09T09:12:31.000Z","tags":null,"categories":"ES","end":false},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"问题发现","slug":"问题发现","link":"#问题发现","children":[{"level":3,"title":"1. 迁移速度急剧下降","slug":"_1-迁移速度急剧下降","link":"#_1-迁移速度急剧下降","children":[]},{"level":3,"title":"2. 数据混乱","slug":"_2-数据混乱","link":"#_2-数据混乱","children":[]},{"level":3,"title":"3. 迁移中断","slug":"_3-迁移中断","link":"#_3-迁移中断","children":[]},{"level":3,"title":"4. 未指定唯一键","slug":"_4-未指定唯一键","link":"#_4-未指定唯一键","children":[]}]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[{"level":3,"title":"步骤1：清理脏数据","slug":"步骤1：清理脏数据","link":"#步骤1：清理脏数据","children":[]},{"level":3,"title":"步骤2：优化迁移策略","slug":"步骤2：优化迁移策略","link":"#步骤2：优化迁移策略","children":[]},{"level":3,"title":"步骤3：避免迁移期间新数据写入（可选）","slug":"步骤3：避免迁移期间新数据写入（可选）","link":"#步骤3：避免迁移期间新数据写入（可选）","children":[]}]},{"level":2,"title":"迁移优化后的效果","slug":"迁移优化后的效果","link":"#迁移优化后的效果","children":[]},{"level":2,"title":"总结与建议","slug":"总结与建议","link":"#总结与建议","children":[]}],"relativePath":"pages/posts/solr-to-es.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/solr-to-es.md","lastUpdated":1752023798000}'),r=JSON.parse('{"title":"Solr到Elasticsearch的踩坑与优化","description":"","frontmatter":{"title":"Solr到Elasticsearch的踩坑与优化","date":"2025-07-09T09:12:31.000Z","updated":"2025-07-09T09:12:31.000Z","tags":null,"categories":"ES","end":false},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"问题发现","slug":"问题发现","link":"#问题发现","children":[{"level":3,"title":"1. 迁移速度急剧下降","slug":"_1-迁移速度急剧下降","link":"#_1-迁移速度急剧下降","children":[]},{"level":3,"title":"2. 数据混乱","slug":"_2-数据混乱","link":"#_2-数据混乱","children":[]},{"level":3,"title":"3. 迁移中断","slug":"_3-迁移中断","link":"#_3-迁移中断","children":[]},{"level":3,"title":"4. 未指定唯一键","slug":"_4-未指定唯一键","link":"#_4-未指定唯一键","children":[]}]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[{"level":3,"title":"步骤1：清理脏数据","slug":"步骤1：清理脏数据","link":"#步骤1：清理脏数据","children":[]},{"level":3,"title":"步骤2：优化迁移策略","slug":"步骤2：优化迁移策略","link":"#步骤2：优化迁移策略","children":[]},{"level":3,"title":"步骤3：避免迁移期间新数据写入（可选）","slug":"步骤3：避免迁移期间新数据写入（可选）","link":"#步骤3：避免迁移期间新数据写入（可选）","children":[]}]},{"level":2,"title":"迁移优化后的效果","slug":"迁移优化后的效果","link":"#迁移优化后的效果","children":[]},{"level":2,"title":"总结与建议","slug":"总结与建议","link":"#总结与建议","children":[]}],"relativePath":"pages/posts/solr-to-es.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/solr-to-es.md","lastUpdated":1752023798000}'),C={name:"pages/posts/solr-to-es.md",data(){return{data:r,frontmatter:r.frontmatter}},setup(){D("pageData",r)}},F={id:"背景",tabindex:"-1"},m=l("p",null,"随着业务的发展，我们决定将搜索引擎从Solr迁移到Elasticsearch（ES）。迁移的数据量如下：",-1),A=l("ul",null,[l("li",null,"数据条数：2.5亿"),l("li",null,"存储大小：约30GB")],-1),f=l("p",null,"迁移工具：阿里云推荐的开源工具 solr-to-es",-1),g=l("p",null,"初始迁移命令：",-1),v=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"nohup"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"python3."),l("span",{style:{color:"#F78C6C"}},"6"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"__main__.py"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"http://10.160.24.17:8983/solr/alert_summary/select"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"http://elastic:******@es-cn-t8j44.elasticsearch.aliyuncs.com:9200"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"rtm-prod-alert-summary "),l("span",{style:{color:"#C3E88D"}},"rtm-prod-alert-summary"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"--rows-per-page "),l("span",{style:{color:"#F78C6C"}},"2000"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"&")]),s(`
`),l("span",{class:"line"})])])],-1),k={id:"问题发现",tabindex:"-1"},E={id:"_1-迁移速度急剧下降",tabindex:"-1"},b=l("ul",null,[l("li",null,"初始速度：每秒几千条"),l("li",null,"迁移至7千万条时：降至每秒几十条")],-1),S=l("p",null,[l("strong",null,"原因分析"),s("：")],-1),x=l("ul",null,[l("li",null,[s("Solr的深分页性能问题（"),l("code",null,"start"),s("参数越大，查询越慢）")]),l("li",null,"ES索引数据量增大后写入变慢")],-1),$={id:"_2-数据混乱",tabindex:"-1"},B=l("ul",null,[l("li",null,"迁移过程中，生产环境的新数据仍在写入ES"),l("li",null,"迁移中断后，无法确定迁移进度")],-1),T={id:"_3-迁移中断",tabindex:"-1"},I=l("ul",null,[l("li",null,"Solr查询超时导致工具报错")],-1),q={id:"_4-未指定唯一键",tabindex:"-1"},N=l("ul",null,[l("li",null,[s("初始迁移未指定"),l("code",null,"--id-field"),s("参数，导致迁移的数据在ES中生成随机的"),l("code",null,"_id")]),l("li",null,[s("生产写入的数据中"),l("code",null,"_id"),s("与"),l("code",null,"alertSummaryId"),s("相等，而迁移的数据则不等")])],-1),w={id:"解决方案",tabindex:"-1"},P={id:"步骤1：清理脏数据",tabindex:"-1"},V=l("p",null,[s("使用ES的"),l("code",null,"_delete_by_query"),s("API删除迁移产生的脏数据（即"),l("code",null,"_id"),s("不等于"),l("code",null,"alertSummaryId"),s("的文档）：")],-1),O=l("div",{class:"language-json"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"POST /rtm-prod-alert-summary/_delete_by_query?scroll_size="),l("span",{style:{color:"#F78C6C"}},"10000"),l("span",{style:{color:"#A6ACCD"}},"&requests_per_second="),l("span",{style:{color:"#F78C6C"}},"10000"),l("span",{style:{color:"#A6ACCD"}},"&conflicts=proceed&wait_for_completion="),l("span",{style:{color:"#89DDFF"}},"false")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C792EA"}},"query"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#FFCB6B"}},"script"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#F78C6C"}},"script"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#F07178"}},"source"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"doc['_id'].value != doc['alertSummaryId'].value"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#F07178"}},"lang"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"painless"),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),U=l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"耗时"),s("：约3小时（7千万条数据）")])]),l("li",null,[l("p",null,"监控删除任务"),l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"GET"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"_tasks?actions="),l("span",{style:{color:"#A6ACCD"}},"*"),l("span",{style:{color:"#C3E88D"}},"delete"),l("span",{style:{color:"#A6ACCD"}},"*"),l("span",{style:{color:"#89DDFF"}},"&"),l("span",{style:{color:"#FFCB6B"}},"detailed")]),s(`
`),l("span",{class:"line"})])])])])],-1),Z={id:"步骤2：优化迁移策略",tabindex:"-1"},j={id:"关键改进1：指定唯一键",tabindex:"-1"},G=l("p",null,[s("添加"),l("code",null,"--id-field alertSummaryId"),s("参数，确保迁移数据的"),l("code",null,"_id"),s("等于"),l("code",null,"alertSummaryId"),s("，这样重复迁移时会自动覆盖。")],-1),J={id:"关键改进2：按时间范围分批迁移",tabindex:"-1"},z=l("p",null,[s("使用Solr的"),l("code",null,"fq"),s("参数按年（或月）迁移数据，避免深分页问题。示例命令：")],-1),L=l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"python3.6"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"__main__.py"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"http://10.160.24.17:8983/solr/alert_summary/select?q=*:*&fq=alertTime:[1741968000000 TO 1743436800000]"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"http://es-cn-t8j44.elasticsearch.aliyuncs.com:9200"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"rtm-prod-alert-summary \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"--es-user "),l("span",{style:{color:"#C3E88D"}},"elastic"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"--es-password "),l("span",{style:{color:"#A6ACCD"}},"*****"),l("span",{style:{color:"#A6ACCD"}}," \\")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"--id-field "),l("span",{style:{color:"#C3E88D"}},"alertSummaryId")]),s(`
`),l("span",{class:"line"})])])],-1),M={id:"步骤3：避免迁移期间新数据写入（可选）",tabindex:"-1"},H=l("ul",null,[l("li",null,"在迁移期间暂停生产写入（根据业务情况决定）"),l("li",null,"或者迁移完成后，补充迁移暂停期间的新数据")],-1),K={id:"迁移优化后的效果",tabindex:"-1"},Q=l("ol",null,[l("li",null,[l("strong",null,"迁移速度稳定"),s("：分批迁移避免了Solr深分页问题，速度保持在每秒数千条。")]),l("li",null,[l("strong",null,"数据一致性保证"),s("：使用"),l("code",null,"--id-field"),s("确保即使迁移中断重启也不会产生重复数据。")]),l("li",null,[l("strong",null,"可追踪进度"),s("：按时间范围迁移，清楚知道每个批次是否成功。")])],-1),R={id:"总结与建议",tabindex:"-1"},W=l("ul",null,[l("li",null,[l("strong",null,"核心教训"),s("：大数据迁移务必指定唯一键，避免数据混乱。")]),l("li",null,[l("strong",null,"分批策略"),s("：按时间范围（或其他有序字段）分批次迁移，避免深分页。 "),l("ul",null,[l("li",null,[s("使用ES的"),l("code",null,"_tasks"),s("API监控迁移和删除任务。")]),l("li",null,"推荐使用Elasticsearch Curator管理索引。")])]),l("li",null,[l("strong",null,"工具改进"),s("：如果迁移工具不支持断点续传，可考虑开发脚本记录最后迁移的时间戳。")])],-1);function X(t,Y,ll,sl,i,el){const n=y,c=d;return h(),u(c,{frontmatter:i.frontmatter,data:i.data},{"main-content-md":e(()=>[_(" more "),l("h2",F,[s("背景 "),a(n,{class:"header-anchor",href:"#背景","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),m,A,f,g,v,l("h2",k,[s("问题发现 "),a(n,{class:"header-anchor",href:"#问题发现","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h3",E,[s("1. 迁移速度急剧下降 "),a(n,{class:"header-anchor",href:"#_1-迁移速度急剧下降","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),b,S,x,l("h3",$,[s("2. 数据混乱 "),a(n,{class:"header-anchor",href:"#_2-数据混乱","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),B,l("h3",T,[s("3. 迁移中断 "),a(n,{class:"header-anchor",href:"#_3-迁移中断","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),I,l("h3",q,[s("4. 未指定唯一键 "),a(n,{class:"header-anchor",href:"#_4-未指定唯一键","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),N,l("h2",w,[s("解决方案 "),a(n,{class:"header-anchor",href:"#解决方案","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h3",P,[s("步骤1：清理脏数据 "),a(n,{class:"header-anchor",href:"#步骤1：清理脏数据","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),V,O,U,l("h3",Z,[s("步骤2：优化迁移策略 "),a(n,{class:"header-anchor",href:"#步骤2：优化迁移策略","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),l("h4",j,[s("关键改进1：指定唯一键 "),a(n,{class:"header-anchor",href:"#关键改进1：指定唯一键","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),G,l("h4",J,[s("关键改进2：按时间范围分批迁移 "),a(n,{class:"header-anchor",href:"#关键改进2：按时间范围分批迁移","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),z,L,l("h3",M,[s("步骤3：避免迁移期间新数据写入（可选） "),a(n,{class:"header-anchor",href:"#步骤3：避免迁移期间新数据写入（可选）","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),H,l("h2",K,[s("迁移优化后的效果 "),a(n,{class:"header-anchor",href:"#迁移优化后的效果","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),Q,l("h2",R,[s("总结与建议 "),a(n,{class:"header-anchor",href:"#总结与建议","aria-hidden":"true"},{default:e(()=>[s("#")]),_:1})]),W]),"main-header":e(()=>[o(t.$slots,"main-header")]),"main-header-after":e(()=>[o(t.$slots,"main-header-after")]),"main-nav":e(()=>[o(t.$slots,"main-nav")]),"main-content":e(()=>[o(t.$slots,"main-content")]),"main-content-after":e(()=>[o(t.$slots,"main-content-after")]),"main-nav-before":e(()=>[o(t.$slots,"main-nav-before")]),"main-nav-after":e(()=>[o(t.$slots,"main-nav-after")]),comment:e(()=>[o(t.$slots,"comment")]),footer:e(()=>[o(t.$slots,"footer")]),aside:e(()=>[o(t.$slots,"aside")]),"aside-custom":e(()=>[o(t.$slots,"aside-custom")]),default:e(()=>[o(t.$slots,"default")]),_:3},8,["frontmatter","data"])}const cl=p(C,[["render",X]]);export{il as __pageData,cl as default};
