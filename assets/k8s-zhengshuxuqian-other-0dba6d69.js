import{_ as p}from"./ValaxyMain.vue_vue_type_style_index_0_lang-ad5e9c82.js";import{_ as u,c as d,w as s,o as y,a as C,b as l,d as e,e as t,r as a,f as D,p as h}from"./app-8df0fa73.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-204785b8.js";import"./YunCard.vue_vue_type_style_index_0_lang-a0362047.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-87671209.js";const J=JSON.parse('{"title":"Kubernetes 证书续签问题分析与解决","description":"","frontmatter":{"title":"Kubernetes 证书续签问题分析与解决","date":"2025-07-19T12:10:14.000Z","updated":"2025-07-19T12:10:14.000Z","tags":"kube-controller-manager","categories":"Kubernetes","end":false},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"问题分析","slug":"问题分析","link":"#问题分析","children":[]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]},{"level":2,"title":"解决原理","slug":"解决原理","link":"#解决原理","children":[]},{"level":2,"title":"经验总结","slug":"经验总结","link":"#经验总结","children":[]},{"level":2,"title":"预防措施","slug":"预防措施","link":"#预防措施","children":[]}],"relativePath":"pages/posts/k8s-zhengshuxuqian-other.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/k8s-zhengshuxuqian-other.md","lastUpdated":1752898386000}'),r=JSON.parse('{"title":"Kubernetes 证书续签问题分析与解决","description":"","frontmatter":{"title":"Kubernetes 证书续签问题分析与解决","date":"2025-07-19T12:10:14.000Z","updated":"2025-07-19T12:10:14.000Z","tags":"kube-controller-manager","categories":"Kubernetes","end":false},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"问题分析","slug":"问题分析","link":"#问题分析","children":[]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]},{"level":2,"title":"解决原理","slug":"解决原理","link":"#解决原理","children":[]},{"level":2,"title":"经验总结","slug":"经验总结","link":"#经验总结","children":[]},{"level":2,"title":"预防措施","slug":"预防措施","link":"#预防措施","children":[]}],"relativePath":"pages/posts/k8s-zhengshuxuqian-other.md","path":"/Users/vlinux/vlinux/blog/valaxy/vlinux.github.io/pages/posts/k8s-zhengshuxuqian-other.md","lastUpdated":1752898386000}'),m={name:"pages/posts/k8s-zhengshuxuqian-other.md",data(){return{data:r,frontmatter:r.frontmatter}},setup(){h("pageData",r)}},A={id:"kubernetes-证书续签问题分析与解决笔记",tabindex:"-1"},g={id:"问题描述",tabindex:"-1"},F=l("p",null,"在续签 Kubernetes 证书时遇到了以下错误：",-1),b=l("div",{class:"language-markdown"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},'I0718 14:04:10.452667       1 tlsconfig.go:240] "Starting DynamicServingCertificateController"')]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},'E0718 14:04:11.397015       1 leaderelection.go:330] error retrieving resource lock kube-system/kube-controller-manager: leases.coordination.k8s.io "kube-controller-manager" is forbidden: User "system:kube-controller-manager" cannot get resource "leases" in API group "coordination.k8s.io" in the namespace "kube-system"')]),e(`
`),l("span",{class:"line"})])])],-1),k=l("p",null,[e("错误表明 "),l("code",null,"system:kube-controller-manager"),e(" 用户没有权限获取 "),l("code",null,"kube-system"),e(" 命名空间下的 "),l("code",null,"leases"),e(" 资源。")],-1),_={id:"问题分析",tabindex:"-1"},f=l("ol",null,[l("li",null,[l("strong",null,"背景知识"),e("： "),l("ul",null,[l("li",null,"Kubernetes 使用 leader election 机制来确保控制器管理器等高可用组件只有一个实例处于活跃状态"),l("li",null,[e("这种选举机制依赖于 "),l("code",null,"coordination.k8s.io"),e(" API 组中的 "),l("code",null,"leases"),e(" 资源")]),l("li",null,[l("code",null,"kube-controller-manager"),e(" 需要权限来创建和更新这些 lease 资源")])])]),l("li",null,[l("strong",null,"根本原因"),e("： "),l("ul",null,[l("li",null,[e("默认情况下，"),l("code",null,"system:kube-controller-manager"),e(" 用户可能缺少对 leases 资源的必要权限")]),l("li",null,"这可能是由于集群初始配置不完整或证书续签后权限重置导致的")])])],-1),v={id:"解决方案",tabindex:"-1"},E=l("p",null,"我采取了以下步骤解决问题：",-1),x=l("ol",null,[l("li",null,[l("p",null,[l("strong",null,"创建 ClusterRole 和 ClusterRoleBinding"),e("：")]),l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"apiVersion"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"rbac.authorization.k8s.io/v1")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"kind"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ClusterRoleBinding")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"metadata"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"system:kube-controller-manager-binding")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"roleRef"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"apiGroup"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"rbac.authorization.k8s.io")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"kind"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ClusterRole")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"system:kube-controller-manager")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"subjects"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"apiGroup"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"rbac.authorization.k8s.io")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"kind"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"User")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"system:kube-controller-manager")]),e(`
`),l("span",{class:"line"}),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"---")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"apiVersion"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"rbac.authorization.k8s.io/v1")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"kind"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"ClusterRole")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"metadata"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"name"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"system:kube-controller-manager-leases")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"rules"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"apiGroups"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"coordination.k8s.io")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"resources"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"leases")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"verbs"),l("span",{style:{color:"#89DDFF"}},":")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"get")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"create")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"update")]),e(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"patch")]),e(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,[l("strong",null,"创建 ServiceAccount"),e("：")]),l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"kubectl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"-n"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kube-system"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"create"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"serviceaccount"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kube-controller-manager")]),e(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,[l("strong",null,"重启 kube-controller-manager 服务"),e("：")]),l("div",{class:"language-bash"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#FFCB6B"}},"systemctl"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"restart"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"kube-controller-manager")]),e(`
`),l("span",{class:"line"})])])])])],-1),B={id:"解决原理",tabindex:"-1"},$=l("ol",null,[l("li",null,[l("strong",null,"ClusterRole"),e("： "),l("ul",null,[l("li",null,[e("创建了专门的 "),l("code",null,"system:kube-controller-manager-leases"),e(" ClusterRole")]),l("li",null,[e("授予了对 "),l("code",null,"leases"),e(" 资源的 get、create、update 和 patch 权限")])])]),l("li",null,[l("strong",null,"ClusterRoleBinding"),e("： "),l("ul",null,[l("li",null,[e("将 "),l("code",null,"system:kube-controller-manager"),e(" 用户绑定到 "),l("code",null,"system:kube-controller-manager"),e(" ClusterRole")]),l("li",null,"确保用户拥有执行其功能所需的权限")])]),l("li",null,[l("strong",null,"ServiceAccount"),e("： "),l("ul",null,[l("li",null,[e("创建了 "),l("code",null,"kube-controller-manager"),e(" ServiceAccount")]),l("li",null,"虽然错误中涉及的是 User 而非 ServiceAccount，但创建它有助于确保权限体系的完整性")])])],-1),R={id:"经验总结",tabindex:"-1"},K=l("ol",null,[l("li",null,"Kubernetes 组件需要特定的 RBAC 权限才能正常工作"),l("li",null,"证书续签或集群升级后，权限配置可能会发生变化，需要验证"),l("li",null,"控制器管理器这类核心组件需要 leases 资源权限来实现 leader election"),l("li",null,"查看组件日志是诊断权限问题的第一步"),l("li",null,"使用 RBAC 资源可以精确控制 Kubernetes 组件的访问权限")],-1),z={id:"预防措施",tabindex:"-1"},S=l("ol",null,[l("li",null,"在集群初始化时确保所有核心组件都有正确的 RBAC 配置"),l("li",null,"定期检查核心组件的日志以发现潜在问题"),l("li",null,"将关键 RBAC 配置纳入基础设施即代码(IaC)管理"),l("li",null,"在升级或证书轮换前备份关键配置")],-1),U=l("p",null,"通过这次问题解决，我对 Kubernetes 的 RBAC 系统和控制器管理器的工作原理有了更深入的理解。希望这个记录能帮助遇到类似问题的同行快速定位和解决问题。",-1);function V(n,q,N,T,c,Z){const o=D,i=p;return y(),d(i,{frontmatter:c.frontmatter,data:c.data},{"main-content-md":s(()=>[C(" more "),l("h1",A,[e("Kubernetes 证书续签问题分析与解决笔记 "),t(o,{class:"header-anchor",href:"#kubernetes-证书续签问题分析与解决笔记","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),l("h2",g,[e("问题描述 "),t(o,{class:"header-anchor",href:"#问题描述","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),F,b,k,l("h2",_,[e("问题分析 "),t(o,{class:"header-anchor",href:"#问题分析","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),f,l("h2",v,[e("解决方案 "),t(o,{class:"header-anchor",href:"#解决方案","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),E,x,l("h2",B,[e("解决原理 "),t(o,{class:"header-anchor",href:"#解决原理","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),$,l("h2",R,[e("经验总结 "),t(o,{class:"header-anchor",href:"#经验总结","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),K,l("h2",z,[e("预防措施 "),t(o,{class:"header-anchor",href:"#预防措施","aria-hidden":"true"},{default:s(()=>[e("#")]),_:1})]),S,U]),"main-header":s(()=>[a(n.$slots,"main-header")]),"main-header-after":s(()=>[a(n.$slots,"main-header-after")]),"main-nav":s(()=>[a(n.$slots,"main-nav")]),"main-content":s(()=>[a(n.$slots,"main-content")]),"main-content-after":s(()=>[a(n.$slots,"main-content-after")]),"main-nav-before":s(()=>[a(n.$slots,"main-nav-before")]),"main-nav-after":s(()=>[a(n.$slots,"main-nav-after")]),comment:s(()=>[a(n.$slots,"comment")]),footer:s(()=>[a(n.$slots,"footer")]),aside:s(()=>[a(n.$slots,"aside")]),"aside-custom":s(()=>[a(n.$slots,"aside-custom")]),default:s(()=>[a(n.$slots,"default")]),_:3},8,["frontmatter","data"])}const j=u(m,[["render",V]]);export{J as __pageData,j as default};
